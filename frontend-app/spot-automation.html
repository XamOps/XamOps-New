<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XamOps - Spot Automation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="/icons/XamOps.png" sizes="32x32" type="image/png">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js"></script>
    <script type="module" src="/src/main.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        .toggle-checkbox:checked {
            right: 0;
            border-color: #10b981;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #10b981;
        }

        [x-cloak] {
            display: none !important;
        }

        /* Pulse animation for scanning */
        @keyframes pulse-scan {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .pulse-scan {
            animation: pulse-scan 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Cost badge styling */
        .cost-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
        }

        /* Tooltip styling */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #1f2937;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            top: 125%;
            right: -10px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            line-height: 1.4;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.3);
            white-space: normal;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            bottom: 100%;
            right: 20px;
            margin-left: -5px;
            border-width: 6px;
            border-style: solid;
            border-color: transparent transparent #1f2937 transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>

<body class="bg-gray-50">
    <div class="flex h-screen overflow-hidden" x-data="autoSpottingDashboard()" x-init="initDashboard()">
        <include file="/_sidebar.html"></include>

        <div class="ml-64 flex-1 flex flex-col h-screen overflow-hidden">
            <header class="bg-white border-b border-gray-200 px-8 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Spot Automation</h1>
                    <p class="text-sm text-gray-500">Automated Spot instance management & cost optimization across all
                        regions</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button @click="registerAccount()" :disabled="registering || !accountId"
                        class="text-white bg-blue-600 hover:bg-blue-700 disabled:bg-blue-300 disabled:cursor-not-allowed focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2 transition-colors flex items-center">
                        <i class="fas fa-sync-alt mr-2" :class="{'fa-spin': registering}"></i>
                        <span x-text="registering ? 'Syncing...' : 'Sync Account'"></span>
                    </button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-8">
                <div class="max-w-7xl mx-auto space-y-6">

                    <!-- AWS Account Connection Section -->
                    <div x-show="!isAccountConnected" x-cloak class="mb-6">
                        <div
                            class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl shadow-sm overflow-hidden">
                            <div class="p-6">
                                <div class="flex items-start">
                                    <!-- Icon -->
                                    <div class="flex-shrink-0">
                                        <div
                                            class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                            <i class="fas fa-cloud-upload-alt text-blue-600 text-xl"></i>
                                        </div>
                                    </div>

                                    <!-- Content -->
                                    <div class="ml-4 flex-1">
                                        <h3 class="text-lg font-semibold text-gray-900 mb-2">
                                            Connect Your AWS Account to AutoSpotting
                                        </h3>
                                        <p class="text-sm text-gray-600 mb-4">
                                            Deploy the AutoSpotting integration stack to enable Spot instance
                                            optimization.
                                            This creates secure cross-account access and event forwarding in about 3
                                            minutes.
                                        </p>

                                        <!-- Benefits Grid -->
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-5">
                                            <div class="flex items-center text-sm text-gray-700">
                                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                                <span>Secure IAM roles</span>
                                            </div>
                                            <div class="flex items-center text-sm text-gray-700">
                                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                                <span>Event forwarding</span>
                                            </div>
                                            <div class="flex items-center text-sm text-gray-700">
                                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                                <span>Multi-region support</span>
                                            </div>
                                        </div>

                                        <!-- Region Selection -->
                                        <div class="mb-4">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                Select AWS Regions to Monitor
                                            </label>
                                            <div
                                                class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2 max-h-40 overflow-y-auto p-3 bg-white rounded-lg border border-gray-200">
                                                <label class="flex items-center text-xs hover:bg-gray-50 p-1 rounded">
                                                    <input type="checkbox" class="mr-1.5" value="us-east-1"
                                                        x-model="selectedRegions">
                                                    US East (N. Virginia)
                                                </label>
                                                <label class="flex items-center text-xs hover:bg-gray-50 p-1 rounded">
                                                    <input type="checkbox" class="mr-1.5" value="us-east-2"
                                                        x-model="selectedRegions">
                                                    US East (Ohio)
                                                </label>
                                                <label class="flex items-center text-xs hover:bg-gray-50 p-1 rounded">
                                                    <input type="checkbox" class="mr-1.5" value="us-west-1"
                                                        x-model="selectedRegions">
                                                    US West (N. California)
                                                </label>
                                                <label class="flex items-center text-xs hover:bg-gray-50 p-1 rounded">
                                                    <input type="checkbox" class="mr-1.5" value="us-west-2"
                                                        x-model="selectedRegions">
                                                    US West (Oregon)
                                                </label>
                                                <label class="flex items-center text-xs hover:bg-gray-50 p-1 rounded">
                                                    <input type="checkbox" class="mr-1.5" value="ap-south-1"
                                                        x-model="selectedRegions" checked>
                                                    Asia Pacific (Mumbai)
                                                </label>
                                                <label class="flex items-center text-xs hover:bg-gray-50 p-1 rounded">
                                                    <input type="checkbox" class="mr-1.5" value="ap-southeast-1"
                                                        x-model="selectedRegions">
                                                    Asia Pacific (Singapore)
                                                </label>
                                                <label class="flex items-center text-xs hover:bg-gray-50 p-1 rounded">
                                                    <input type="checkbox" class="mr-1.5" value="ap-southeast-2"
                                                        x-model="selectedRegions">
                                                    Asia Pacific (Sydney)
                                                </label>
                                                <label class="flex items-center text-xs hover:bg-gray-50 p-1 rounded">
                                                    <input type="checkbox" class="mr-1.5" value="ap-northeast-1"
                                                        x-model="selectedRegions">
                                                    Asia Pacific (Tokyo)
                                                </label>
                                                <label class="flex items-center text-xs hover:bg-gray-50 p-1 rounded">
                                                    <input type="checkbox" class="mr-1.5" value="eu-west-1"
                                                        x-model="selectedRegions">
                                                    Europe (Ireland)
                                                </label>
                                                <label class="flex items-center text-xs hover:bg-gray-50 p-1 rounded">
                                                    <input type="checkbox" class="mr-1.5" value="eu-central-1"
                                                        x-model="selectedRegions">
                                                    Europe (Frankfurt)
                                                </label>
                                                <label class="flex items-center text-xs hover:bg-gray-50 p-1 rounded">
                                                    <input type="checkbox" class="mr-1.5" value="eu-west-2"
                                                        x-model="selectedRegions">
                                                    Europe (London)
                                                </label>
                                                <label class="flex items-center text-xs hover:bg-gray-50 p-1 rounded">
                                                    <input type="checkbox" class="mr-1.5" value="ca-central-1"
                                                        x-model="selectedRegions">
                                                    Canada (Central)
                                                </label>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-2">
                                                <i class="fas fa-info-circle mr-1"></i>
                                                <span x-text="selectedRegions.length"></span> region(s) selected
                                            </p>
                                        </div>

                                        <!-- Deploy Region Selection -->
                                        <div class="mb-4">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                Deploy Stack In
                                            </label>
                                            <select x-model="deployRegion"
                                                class="w-full md:w-64 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                <option value="us-east-1">US East (N. Virginia)</option>
                                                <option value="us-east-2">US East (Ohio)</option>
                                                <option value="us-west-1">US West (N. California)</option>
                                                <option value="us-west-2">US West (Oregon)</option>
                                                <option value="ap-south-1" selected>Asia Pacific (Mumbai)</option>
                                                <option value="ap-southeast-1">Asia Pacific (Singapore)</option>
                                                <option value="eu-west-1">Europe (Ireland)</option>
                                                <option value="eu-central-1">Europe (Frankfurt)</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">
                                                Choose where to deploy the CloudFormation stack
                                            </p>
                                        </div>

                                        <!-- Deploy Button -->
                                        <div class="flex items-center space-x-3">
                                            <button @click="deployToAWS()"
                                                :disabled="selectedRegions.length === 0 || deployingStack"
                                                class="inline-flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-semibold rounded-lg shadow-md transition-colors">
                                                <i class="fas mr-2"
                                                    :class="deployingStack ? 'fa-spinner fa-spin' : 'fa-rocket'"></i>
                                                <span
                                                    x-text="deployingStack ? 'Generating URL...' : 'Deploy to AWS'"></span>
                                            </button>

                                            <button @click="isAccountConnected = true"
                                                class="text-sm text-gray-500 hover:text-gray-700 underline">
                                                Skip for now
                                            </button>
                                        </div>

                                        <p class="text-xs text-gray-500 mt-3 flex items-center">
                                            <i class="fas fa-info-circle mr-1.5"></i>
                                            You'll be redirected to AWS CloudFormation console. Click "Create stack" to
                                            complete deployment.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <!-- Current Cost -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Current Cost</p>
                                    <h3 class="text-3xl font-bold text-purple-600 mt-2"
                                        x-text="formatCurrency(costs.currentMonthlyCost)"></h3>
                                </div>
                                <div class="p-3 bg-purple-50 rounded-lg">
                                    <i class="fas fa-dollar-sign text-purple-600 text-xl"></i>
                                </div>
                            </div>
                            <div class="mt-4 text-sm text-gray-500">
                                <span x-text="formatHourlyCost(costs.currentHourly) + '/hr'"></span>
                            </div>
                        </div>

                        <!-- Actual Savings -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Actual Savings</p>
                                    <h3 class="text-3xl font-bold text-emerald-600 mt-2"
                                        x-text="formatCurrency(savings.actualMonthlySavings)"></h3>
                                </div>
                                <div class="p-3 bg-emerald-50 rounded-lg">
                                    <i class="fas fa-piggy-bank text-emerald-600 text-xl"></i>
                                </div>
                            </div>
                            <div class="mt-4 text-sm text-gray-500">
                                <span class="text-emerald-600 font-medium">
                                    <i class="fas fa-arrow-up"></i> Last 30 Days
                                </span>
                            </div>
                        </div>

                        <!-- Potential Savings -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Potential Savings</p>
                                    <h3 class="text-3xl font-bold text-blue-600 mt-2"
                                        x-text="formatCurrency(savings.potentialMonthlySavings)"></h3>
                                </div>
                                <div class="p-3 bg-blue-50 rounded-lg">
                                    <i class="fas fa-chart-line text-blue-600 text-xl"></i>
                                </div>
                            </div>
                            <div class="mt-4 text-sm text-gray-500">
                                Additional if all ASGs enabled
                            </div>
                        </div>

                        <!-- ASGs -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">ASGs</p>
                                    <h3 class="text-3xl font-bold text-indigo-600 mt-2">
                                        <span x-text="asgs.filter(a => a.isEnabled).length"></span>
                                        <span class="text-gray-400">/</span>
                                        <span x-text="asgs.length"></span>
                                    </h3>
                                </div>
                                <div class="p-3 bg-indigo-50 rounded-lg">
                                    <i class="fas fa-layer-group text-indigo-600 text-xl"></i>
                                </div>
                            </div>
                            <div class="mt-4 text-sm text-gray-500">
                                <span x-show="enabledRegionsCount > 0">
                                    Across <span x-text="enabledRegionsCount"></span> region<span
                                        x-show="enabledRegionsCount > 1">s</span>
                                </span>
                                <span x-show="enabledRegionsCount === 0">
                                    No regions configured
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- ASGs Table -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                            <div>
                                <h3 class="font-semibold text-gray-800">Auto Scaling Groups</h3>
                                <p class="text-xs text-gray-500 mt-1" x-show="enabledRegionsCount > 0">
                                    Real-time cost data from <span x-text="enabledRegionsCount"></span> region<span
                                        x-show="enabledRegionsCount > 1">s</span>
                                </p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <!-- Refresh Data Button -->
                                <button @click="fetchCostData()" :disabled="loading"
                                    class="text-gray-500 hover:text-indigo-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2 px-3 py-1.5 rounded-lg hover:bg-indigo-50"
                                    title="Refresh cost data from AutoSpotting API">
                                    <i class="fas fa-chart-line" :class="{'fa-spin': loading}"></i>
                                    <span class="text-sm font-medium">
                                        <span x-show="!loading">Refresh Data</span>
                                        <span x-show="loading">Loading...</span>
                                    </span>
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="bg-gray-50 text-gray-600 text-xs uppercase tracking-wider">
                                        <th class="px-6 py-4 font-semibold">ASG Name</th>
                                        <th class="px-6 py-4 font-semibold">Region</th>
                                        <th class="px-6 py-4 font-semibold">Instance Type</th>
                                        <th class="px-6 py-4 font-semibold">Instances</th>
                                        <th class="px-6 py-4 font-semibold">Spot/OD</th>
                                        <th class="px-6 py-4 font-semibold">Hourly Cost</th>
                                        <th class="px-6 py-4 font-semibold">Monthly Cost</th>
                                        <th class="px-6 py-4 font-semibold">Actual Savings/mo</th>
                                        <th class="px-6 py-4 font-semibold">
                                            <div class="flex items-center">
                                                <span>Potential Savings/mo</span>
                                                <div class="tooltip ml-1.5">
                                                    <i
                                                        class="fas fa-info-circle text-gray-400 hover:text-gray-600 cursor-help"></i>
                                                    <span class="tooltiptext">
                                                        Estimated monthly savings if all on-demand instances in this ASG
                                                        were converted to Spot instances of the same type. Uses current
                                                        spot market prices. Shows $0 for ASGs with AutoSpotting enabled
                                                        (already optimizing).
                                                    </span>
                                                </div>
                                            </div>
                                        </th>
                                        <th class="px-6 py-4 font-semibold text-center">AutoSpotting</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    <!-- Loading State -->
                                    <template x-if="loading">
                                        <tr>
                                            <td colspan="10" class="px-6 py-12 text-center">
                                                <div class="flex flex-col items-center justify-center space-y-3">
                                                    <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
                                                    <div>
                                                        <p class="text-gray-700 font-medium">Fetching real-time cost
                                                            data from AutoSpotting API...</p>
                                                        <p class="text-sm text-gray-500 mt-1">This may take a few
                                                            moments</p>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>

                                    <!-- Empty State -->
                                    <template x-if="!loading && asgs.length === 0">
                                        <tr>
                                            <td colspan="10" class="px-6 py-12">
                                                <div class="text-center">
                                                    <div class="text-yellow-500 mb-3">
                                                        <i class="fas fa-exclamation-triangle text-4xl"></i>
                                                    </div>
                                                    <p class="text-gray-700 font-semibold text-lg mb-2">No Auto Scaling
                                                        Groups Found</p>
                                                    <p class="text-sm text-gray-500 mb-4">
                                                        No ASGs were discovered for this account.
                                                    </p>
                                                    <button @click="fetchCostData()"
                                                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition-colors">
                                                        <i class="fas fa-sync-alt mr-2"></i>
                                                        Retry
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>

                                    <!-- ASG Rows -->
                                    <template x-for="asg in asgs" :key="asg.name + '-' + asg.region">
                                        <tr class="hover:bg-gray-50 transition-colors">
                                            <!-- ASG Name -->
                                            <td class="px-6 py-4">
                                                <div class="flex items-center">
                                                    <i class="fas fa-layer-group text-gray-400 mr-3"></i>
                                                    <div class="font-medium text-gray-900" x-text="asg.name"></div>
                                                </div>
                                            </td>

                                            <!-- Region -->
                                            <td class="px-6 py-4">
                                                <span
                                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                    <i class="fas fa-map-marker-alt mr-1.5"></i>
                                                    <span x-text="asg.region"></span>
                                                </span>
                                            </td>

                                            <!-- Instance Type -->
                                            <td class="px-6 py-4">
                                                <span class="text-xs text-gray-600"
                                                    x-text="asg.instanceTypes || 'N/A'"></span>
                                            </td>

                                            <!-- Instances -->
                                            <td class="px-6 py-4">
                                                <span
                                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                    <i class="fas fa-server mr-1.5 text-gray-500"></i>
                                                    <span x-text="asg.instanceCount"></span>
                                                </span>
                                            </td>

                                            <!-- Spot/OD -->
                                            <td class="px-6 py-4">
                                                <div class="text-xs text-gray-600">
                                                    <span class="text-green-600 font-medium"
                                                        x-text="asg.spotCount"></span>
                                                    /
                                                    <span class="text-orange-600 font-medium"
                                                        x-text="asg.onDemandCount"></span>
                                                </div>
                                            </td>

                                            <!-- Hourly Cost -->
                                            <td class="px-6 py-4">
                                                <span class="text-sm font-semibold text-gray-900"
                                                    x-text="formatHourlyCost(asg.currentCost || 0)"></span>
                                            </td>

                                            <!-- Monthly Cost -->
                                            <td class="px-6 py-4">
                                                <span class="text-sm font-semibold text-gray-900"
                                                    x-text="formatCurrency((asg.currentCost || 0) * 730)"></span>
                                            </td>

                                            <!-- Actual Savings/mo -->
                                            <td class="px-6 py-4">
                                                <template x-if="asg.savings && asg.savings > 0">
                                                    <span class="text-sm font-bold text-emerald-600"
                                                        x-text="formatCurrency(asg.savings * 730)"></span>
                                                </template>
                                                <template x-if="!asg.savings || asg.savings === 0">
                                                    <span class="text-xs text-gray-400">-</span>
                                                </template>
                                            </td>

                                            <!-- Potential Savings/mo -->
                                            <td class="px-6 py-4">
                                                <template x-if="asg.potentialSavings && asg.potentialSavings > 0">
                                                    <span class="text-sm font-bold text-blue-600"
                                                        x-text="formatCurrency(asg.potentialSavings * 730)"></span>
                                                </template>
                                                <template x-if="!asg.potentialSavings || asg.potentialSavings === 0">
                                                    <span class="text-xs text-gray-400">-</span>
                                                </template>
                                            </td>

                                            <!-- AutoSpotting Toggle -->
                                            <td class="px-6 py-4 text-center">
                                                <div class="flex items-center justify-center space-x-3">
                                                    <div
                                                        class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                                                        <input type="checkbox"
                                                            :id="'toggle-' + asg.name + '-' + asg.region"
                                                            class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-200"
                                                            :class="{
                                                                'right-0 border-emerald-500': asg.isEnabled,
                                                                'left-0 border-gray-300': !asg.isEnabled,
                                                                'opacity-50 cursor-not-allowed': asg.updating
                                                            }" :checked="asg.isEnabled" :disabled="asg.updating"
                                                            @change="toggleAsg(asg)">
                                                        <label :for="'toggle-' + asg.name + '-' + asg.region"
                                                            class="toggle-label block overflow-hidden h-6 rounded-full cursor-pointer transition-colors duration-200"
                                                            :class="{'bg-emerald-500': asg.isEnabled, 'bg-gray-300': !asg.isEnabled}"></label>
                                                    </div>
                                                    <div class="flex items-center space-x-1.5">
                                                        <span class="text-xs font-semibold"
                                                            :class="asg.isEnabled ? 'text-emerald-600' : 'text-gray-500'"
                                                            x-text="asg.isEnabled ? 'Enabled' : 'Disabled'"></span>
                                                        <span x-show="asg.updating">
                                                            <i class="fas fa-spinner fa-spin text-gray-400 text-xs"></i>
                                                        </span>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>

                        <!-- Footer Stats -->
                        <div x-show="asgs.length > 0" class="px-6 py-3 bg-gray-50 border-t border-gray-200">
                            <div class="flex items-center justify-between text-sm">
                                <div class="text-gray-600">
                                    <span class="font-medium" x-text="asgs.length"></span>
                                    <span>ASG<span x-show="asgs.length !== 1">s</span> ‚Ä¢ </span>
                                    <span class="font-medium" x-text="totalInstances"></span>
                                    <span>instance<span x-show="totalInstances !== 1">s</span> ‚Ä¢ </span>
                                    <span class="text-emerald-600 font-semibold"
                                        x-text="formatHourlyCost(costs.hourlyActualSavings) + '/hr saved'"></span>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-3 h-3 bg-emerald-500 rounded-full"></div>
                                        <span class="text-gray-600">
                                            <span class="font-medium"
                                                x-text="asgs.filter(a => a.isEnabled).length"></span>
                                            Enabled
                                        </span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-3 h-3 bg-gray-300 rounded-full"></div>
                                        <span class="text-gray-600">
                                            <span class="font-medium"
                                                x-text="asgs.filter(a => !a.isEnabled).length"></span>
                                            Disabled
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Notification -->
    <div x-data="{ show: false, message: '', type: 'success' }"
        @notify.window="show = true; message = $event.detail.message; type = $event.detail.type; setTimeout(() => show = false, 4000)"
        x-show="show" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform translate-y-2"
        x-transition:enter-end="opacity-100 transform translate-y-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 transform translate-y-0"
        x-transition:leave-end="opacity-0 transform translate-y-2"
        class="fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg text-white text-sm font-medium z-50 flex items-center max-w-md"
        :class="type === 'success' ? 'bg-emerald-600' : 'bg-red-600'" x-cloak>
        <i class="fas mr-2" :class="type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'"></i>
        <span x-text="message"></span>
    </div>

    <script>
        function autoSpottingDashboard() {
            const backendBaseUrl = 'http://localhost:8080';
            const tenantId = sessionStorage.getItem('tenantId') || 'customer1';

            return {
                loading: false,
                registering: false,
                accountId: null,
                asgs: [],
                savings: {
                    actualMonthlySavings: 0.0,
                    potentialMonthlySavings: 0.0
                },
                costs: {
                    currentHourly: 0.0,
                    currentMonthlyCost: 0.0,
                    onDemandHourly: 0.0,
                    hourlyActualSavings: 0.0
                },
                enabledRegionsCount: 0,
                totalInstances: 0,
                initialized: false,

                // New properties for AWS connection
                isAccountConnected: false,
                selectedRegions: ['ap-south-1'],
                deployRegion: 'ap-south-1',
                deployingStack: false,

                initDashboard() {
                    if (this.initialized) {
                        console.log('‚ö†Ô∏è Dashboard already initialized, skipping...');
                        return;
                    }
                    this.initialized = true;

                    console.log('üöÄ Initializing Spot Automation Dashboard...');

                    try {
                        const stored = sessionStorage.getItem('selectedAccountIds');
                        if (stored) {
                            const ids = JSON.parse(stored);
                            if (ids && ids.length > 0) {
                                this.accountId = ids[0];
                                console.log('‚úì Account ID from sessionStorage:', this.accountId);
                            }
                        }
                    } catch (e) {
                        console.error('Error reading selectedAccountIds from sessionStorage', e);
                    }

                    window.addEventListener('account-changed', (event) => {
                        console.log('SpotAutomation account-changed', event.detail);
                        this.accountId = event.detail.accountId;
                        if (this.accountId) {
                            this.fetchSavings();
                            this.fetchCostData();
                        }
                    }, { once: false });

                    window.addEventListener('multi-account-selection-changed', (event) => {
                        console.log('SpotAutomation multi-account-selection-changed', event.detail);
                        const ids = event.detail.accountIds || [];
                        this.accountId = ids.length > 0 ? ids[0] : null;
                        if (this.accountId) {
                            this.fetchSavings();
                            this.fetchCostData();
                        }
                    }, { once: false });

                    if (!this.accountId) {
                        this.dispatchNotification('No Account ID selected. Please select an account from the dashboard.', 'error');
                        return;
                    }

                    console.log('üìä Loading initial data for account:', this.accountId);
                    this.fetchSavings();
                    this.fetchCostData();
                },

                async deployToAWS() {
                    if (this.selectedRegions.length === 0) {
                        this.dispatchNotification('Please select at least one region', 'error');
                        return;
                    }

                    console.log('üöÄ Deploying CloudFormation stack for regions:', this.selectedRegions);
                    console.log('üìç Deploy region:', this.deployRegion);

                    this.deployingStack = true;

                    try {
                        const regions = this.selectedRegions.join(',');
                        const response = await fetch(
                            `${backendBaseUrl}/api/cloudformation/deploy-url?regions=${encodeURIComponent(regions)}&deployRegion=${this.deployRegion}`,
                            {
                                credentials: 'include',
                                headers: { 'X-Tenant-ID': tenantId }
                            }
                        );

                        if (response.ok) {
                            const data = await response.json();

                            console.log('‚úÖ CloudFormation URL generated:', data);

                            // Open AWS CloudFormation console in new tab
                            window.open(data.url, '_blank');

                            // Show success message
                            this.dispatchNotification(
                                'Redirecting to AWS CloudFormation. Click "Create stack" to complete deployment.',
                                'success'
                            );

                            // Optionally hide the connection banner after a delay
                            setTimeout(() => {
                                this.isAccountConnected = true;
                            }, 3000);

                        } else {
                            const error = await response.json();
                            console.error('‚ùå Failed to generate deployment URL:', error);
                            this.dispatchNotification('Failed to generate deployment URL', 'error');
                        }
                    } catch (error) {
                        console.error('‚ùå Error deploying stack:', error);
                        this.dispatchNotification('Error initiating deployment', 'error');
                    } finally {
                        this.deployingStack = false;
                    }
                },

                async checkAuth(response) {
                    if (response.status === 401 || response.status === 403) {
                        console.error("Unauthorized, redirecting to login.");
                        window.location.href = backendBaseUrl + '/login';
                        throw new Error("Session expired");
                    }
                    return response;
                },

                async registerAccount() {
                    if (!this.accountId) {
                        this.dispatchNotification('No Account ID selected. Please select an account from the dashboard.', 'error');
                        return;
                    }

                    this.registering = true;
                    try {
                        let response = await fetch(`${backendBaseUrl}/api/autospotting/register/${this.accountId}`, {
                            method: 'POST',
                            credentials: 'include',
                            headers: {
                                'X-Tenant-ID': tenantId
                            }
                        });
                        await this.checkAuth(response);

                        if (response.ok) {
                            this.dispatchNotification('Account successfully synced with AutoSpotting Engine', 'success');
                        } else {
                            throw new Error('Sync failed');
                        }
                    } catch (error) {
                        console.error('Error registering account:', error);
                        if (error.message !== "Session expired") {
                            this.dispatchNotification('Failed to sync account. Check console for details.', 'error');
                        }
                    } finally {
                        this.registering = false;
                    }
                },

                async fetchSavings() {
                    if (!this.accountId) return;

                    console.log('üí∞ Fetching savings for account:', this.accountId);

                    try {
                        let response = await fetch(`${backendBaseUrl}/api/autospotting/savings/${this.accountId}`, {
                            credentials: 'include',
                            headers: {
                                'X-Tenant-ID': tenantId
                            }
                        });
                        await this.checkAuth(response);

                        if (response.ok) {
                            const data = await response.json();
                            console.log('‚úì Savings data received:', data);

                            this.savings = {
                                actualMonthlySavings: data.actualMonthlySavings || 0.0,
                                potentialMonthlySavings: data.potentialMonthlySavings || 0.0
                            };

                            console.log('  - Actual monthly savings:', this.formatCurrency(this.savings.actualMonthlySavings));
                            console.log('  - Potential monthly savings:', this.formatCurrency(this.savings.potentialMonthlySavings));
                        }
                    } catch (error) {
                        console.error('‚ùå Error fetching savings:', error);
                    }
                },

                async fetchCostData() {
                    if (!this.accountId) {
                        this.dispatchNotification('No Account ID selected', 'error');
                        return;
                    }

                    if (this.loading) {
                        console.log('‚ö†Ô∏è Already loading cost data, skipping duplicate request');
                        return;
                    }

                    console.log('üìä Fetching cost data for account:', this.accountId);

                    this.loading = true;

                    try {
                        let response = await fetch(
                            `${backendBaseUrl}/api/autospotting/costs/${this.accountId}`,
                            {
                                credentials: 'include',
                                headers: {
                                    'X-Tenant-ID': tenantId
                                }
                            }
                        );
                        await this.checkAuth(response);

                        if (response.ok) {
                            const data = await response.json();
                            console.log('‚úì Cost data received:', data);

                            // Parse summary
                            if (data.summary) {
                                console.log('  - Summary data:', data.summary);

                                this.costs = {
                                    currentHourly: data.summary.total_current_hourly_cost || 0.0,
                                    currentMonthlyCost: (data.summary.total_current_hourly_cost || 0) * 730,
                                    onDemandHourly: data.summary.total_ondemand_hourly_cost || 0.0,
                                    hourlyActualSavings: data.summary.total_actual_savings || 0.0
                                };

                                this.savings = {
                                    actualMonthlySavings: (data.summary.total_actual_savings || 0) * 730,
                                    potentialMonthlySavings: (data.summary.total_potential_savings || 0) * 730
                                };

                                console.log('  - Current hourly cost:', this.formatHourlyCost(this.costs.currentHourly));
                                console.log('  - Current monthly cost:', this.formatCurrency(this.costs.currentMonthlyCost));
                                console.log('  - Hourly savings:', this.formatHourlyCost(this.costs.hourlyActualSavings));
                            }

                            // Parse ASG data
                            if (data.asgs && data.asgs.length > 0) {
                                console.log(`  - Mapping ${data.asgs.length} ASGs...`);

                                this.asgs = data.asgs.map((asg, index) => {
                                    const mapped = {
                                        name: asg.asg_name || asg.asgName || `ASG-${index}`,
                                        region: asg.region || 'unknown',
                                        isEnabled: asg.autospotting_enabled === true,
                                        instanceCount: asg.instance_count || 0,
                                        spotCount: asg.spot_instance_count || 0,
                                        onDemandCount: asg.ondemand_instance_count || 0,
                                        instanceTypes: asg.instance_types ? asg.instance_types.join(', ') : 'N/A',
                                        currentCost: asg.current_hourly_cost || 0,
                                        onDemandCost: asg.ondemand_hourly_cost || 0,
                                        savings: asg.actual_hourly_savings || 0,
                                        potentialSavings: asg.potential_hourly_savings || 0,
                                        updating: false
                                    };

                                    const toggleKey = `asg-toggle-${this.accountId}-${mapped.region}-${mapped.name}`;
                                    const stored = localStorage.getItem(toggleKey);

                                    if (stored) {
                                        try {
                                            const toggle = JSON.parse(stored);
                                            const ageMinutes = (Date.now() - toggle.timestamp) / 1000 / 60;

                                            if (ageMinutes < 5) {
                                                console.log(`  ‚ö° Using stored toggle state for ${mapped.name}: ${toggle.state}`);
                                                mapped.isEnabled = toggle.state;
                                            } else {
                                                localStorage.removeItem(toggleKey);
                                            }
                                        } catch (e) {
                                            console.error('Error parsing stored toggle', e);
                                            localStorage.removeItem(toggleKey);
                                        }
                                    }

                                    return mapped;
                                });

                                this.enabledRegionsCount = new Set(this.asgs.map(a => a.region)).size;
                                this.totalInstances = this.asgs.reduce((sum, asg) => sum + (asg.instanceCount || 0), 0);

                                const enabledCount = this.asgs.filter(a => a.isEnabled).length;
                                const disabledCount = this.asgs.filter(a => !a.isEnabled).length;

                                console.log(`‚úÖ Loaded ${this.asgs.length} ASGs (${enabledCount} enabled, ${disabledCount} disabled)`);
                            } else {
                                console.log('‚ö†Ô∏è No ASGs found in response');
                                this.asgs = [];
                            }
                        } else {
                            console.error('‚ùå Failed to fetch cost data:', response.status);
                            this.dispatchNotification('Failed to fetch cost data', 'error');
                        }
                    } catch (error) {
                        console.error('‚ùå Error fetching cost data:', error);
                        this.dispatchNotification('Error loading data', 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                async toggleAsg(asg) {
                    console.log(`üîÑ Toggling ASG: ${asg.name} (${asg.region})`);

                    asg.updating = true;
                    const newState = !asg.isEnabled;

                    try {
                        const response = await fetch(
                            `${backendBaseUrl}/api/autospotting/asg/toggle`,
                            {
                                method: 'POST',
                                credentials: 'include',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Tenant-ID': tenantId
                                },
                                body: JSON.stringify({
                                    accountId: this.accountId,
                                    region: asg.region,
                                    asgName: asg.name,
                                    enabled: newState
                                })
                            }
                        );

                        await this.checkAuth(response);

                        if (response.ok) {
                            asg.isEnabled = newState;

                            const toggleKey = `asg-toggle-${this.accountId}-${asg.region}-${asg.name}`;
                            localStorage.setItem(toggleKey, JSON.stringify({
                                state: newState,
                                timestamp: Date.now()
                            }));

                            this.dispatchNotification(
                                `AutoSpotting ${newState ? 'enabled' : 'disabled'} for ${asg.name}`,
                                'success'
                            );

                            setTimeout(() => {
                                this.fetchCostData();
                            }, 2000);
                        } else {
                            throw new Error('Toggle failed');
                        }
                    } catch (error) {
                        console.error('Error toggling ASG:', error);
                        this.dispatchNotification('Failed to toggle AutoSpotting', 'error');
                    } finally {
                        asg.updating = false;
                    }
                },

                formatCurrency(value) {
                    if (value === null || value === undefined || isNaN(value)) return '$0.00';
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    }).format(value);
                },

                formatHourlyCost(value) {
                    if (value === null || value === undefined || isNaN(value)) return '$0.0000';
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        minimumFractionDigits: 4,
                        maximumFractionDigits: 4
                    }).format(value);
                },

                dispatchNotification(message, type = 'success') {
                    window.dispatchEvent(new CustomEvent('notify', {
                        detail: { message, type }
                    }));
                }
            };
        }
    </script>
</body>

</html>