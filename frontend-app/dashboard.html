<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XamOps - Live Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>
    <script src="https://code.highcharts.com/maps/highmaps.js"></script>
    <script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/mapdata/custom/world.js"></script>
    <script type="module" src="/src/main.js"></script>


    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        :root {
            --primary-color: #4f46e5;
            --primary-dark: #4338ca;
            --primary-light: #6366f1;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --gradient-error: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        [x-cloak] { display: none !important; }

        .skeleton {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow-lg);
        }

        .gradient-bg {
            background: var(--gradient-primary);
        }

        .kpi-card {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow-md);
        }

        .kpi-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: var(--shadow-xl);
            border-color: rgba(79, 70, 229, 0.3);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .kpi-card:hover::before {
            transform: scaleX(1);
        }

        .kpi-card .main-content {
            transition: opacity 0.3s ease-in-out;
        }

        .kpi-card:hover .main-content {
            opacity: 0;
        }

        .kpi-card .sparkline-container {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }

        .kpi-card:hover .sparkline-container {
            opacity: 1;
        }

        .resource-card {
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .resource-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: rgba(79, 70, 229, 0.3);
        }

        .resource-card:hover .resource-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .resource-icon {
            transition: transform 0.3s ease;
        }

        .sortable-ghost {
            background: linear-gradient(45deg, #eef2ff 25%, transparent 25%),
                        linear-gradient(-45deg, #eef2ff 25%, transparent 25%),
                        linear-gradient(45deg, transparent 75%, #eef2ff 75%),
                        linear-gradient(-45deg, transparent 75%, #eef2ff 75%);
            background-size: 20px 20px;
            border: 2px dashed #818cf8;
            opacity: 0.7;
            transform: rotate(5deg);
        }

        .sortable-chosen {
            cursor: grabbing;
            transform: scale(1.05);
            box-shadow: var(--shadow-xl);
        }

        .widget-handle {
            cursor: grab;
            opacity: 0;
            transition: all 0.2s ease;
            color: #9ca3af;
        }

        .widget:hover .widget-handle {
            opacity: 0.6;
        }

        .widget-handle:hover {
            opacity: 1;
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .header-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .pulse-dot {
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.6s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .chart-container {
            position: relative;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow-lg);
        }

        .optimization-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
            border: 1px solid rgba(16, 185, 129, 0.2);
            transition: all 0.3s ease;
        }

        .optimization-card:hover {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .anomaly-card {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
            border: 1px solid rgba(239, 68, 68, 0.2);
            transition: all 0.3s ease;
        }

        .anomaly-card:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.2) 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .status-indicator {
            position: relative;
            display: inline-block;
        }

        .status-indicator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border-radius: 50%;
            opacity: 0.3;
            animation: pulse 2s infinite;
        }

        .status-active::before { background: #10b981; }
        .status-warning::before { background: #f59e0b; }
        .status-error::before { background: #ef4444; }
        .status-inactive::before { background: #6b7280; }

        .scroll-smooth {
            scroll-behavior: smooth;
        }

        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tooltip {
            position: relative;
        }

        .tooltip::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .tooltip:hover::before {
            opacity: 1;
            visibility: visible;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .floating-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 100;
            background: var(--gradient-primary);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: var(--shadow-xl);
            transition: all 0.3s ease;
        }

        .floating-action:hover {
            transform: scale(1.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
    </style>
</head>
<body x-data="dashboardApp()">

<div id="errorState" class="hidden fixed inset-0 flex items-center justify-center bg-red-50 text-red-700 z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full">
            <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
        </div>
        <h2 class="text-2xl font-bold text-center mb-4 text-gray-800">Connection Error</h2>
        <p id="errorMessage" class="text-center text-gray-600 mb-6"></p>
        <button onclick="location.reload()" class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
            Try Again
        </button>
    </div>
</div>

<div id="loadingNotification" class="notification bg-white border border-gray-200 shadow-lg rounded-lg p-4 flex items-center space-x-3">
    <div class="loading-spinner"></div>
    <span class="text-sm text-gray-600">Updating dashboard...</span>
</div>

<div id="successNotification" class="notification bg-green-50 border border-green-200 shadow-lg rounded-lg p-4 flex items-center space-x-3">
    <div class="w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
        <i class="fas fa-check text-white text-xs"></i>
    </div>
    <span class="text-sm text-green-800">Dashboard updated successfully!</span>
</div>

<div id="appBody" class="flex">
    <aside class="fixed top-0 left-0 h-screen w-64 bg-white border-r border-gray-200 z-20 slide-in">
        <div data-include-sidebar></div>
    </aside>

    <div class="ml-64 flex-1">
        <main class="flex-1 p-6 bg-transparent space-y-6">
            <header class="h-20 flex items-center justify-between glass-card px-6 -mx-6 -mt-6 mb-6 border-b sticky top-0 z-10 fade-in">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-cloud text-white text-lg"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">Live Dashboard</h1>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-green-500 rounded-full pulse-dot"></div>
                                <p id="updateTime" class="text-xs text-gray-500">Connected</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button
                            @click="saveLayout()"
                            x-show="layoutChanged"
                            x-cloak
                            class="flex items-center text-sm font-semibold text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 px-6 py-2.5 rounded-lg shadow-md transition-all transform hover:scale-105 hover:shadow-lg">
                        <i class="fas fa-save mr-2"></i> Save Layout
                    </button>
                    <button
                            id="refreshButton"
                            @click="loadDashboardData(true)"
                            class="flex items-center text-sm text-indigo-600 hover:text-indigo-800 px-4 py-2 rounded-lg hover:bg-indigo-50 transition-all"
                            :disabled="isRefreshing">
                        <i class="fas fa-sync-alt mr-2" :class="{'fa-spin': isRefreshing}"></i>
                        <span x-text="isRefreshing ? 'Refreshing...' : 'Refresh'"></span>
                    </button>
                </div>
            </header>

            <div x-show="selectedAccountIds.length === 0 && !isLoading" id="noAccountState" class="text-center py-32 fade-in" x-cloak>
                <div class="max-w-md mx-auto">
                    <div class="w-24 h-24 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-plus-circle text-white text-3xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Get Started with XamOps</h3>
                    <p class="text-gray-600 mb-8">It looks like you don't have any cloud accounts connected yet. Add your first account to begin monitoring your infrastructure.</p>
                    <a href="/account-manager.html" class="inline-block bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                        <i class="fas fa-users-cog mr-2"></i> Go to Account Manager
                    </a>
                </div>
            </div>

            <div x-show="isLoading" id="dashboardSkeleton" class="space-y-6 fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="glass-card p-6 rounded-xl h-32 skeleton"></div>
                    <div class="glass-card p-6 rounded-xl h-32 skeleton"></div>
                    <div class="glass-card p-6 rounded-xl h-32 skeleton"></div>
                    <div class="glass-card p-6 rounded-xl h-32 skeleton"></div>
                </div>
                <div class="glass-card p-6 rounded-xl h-96 skeleton"></div>
                <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                    <div class="lg:col-span-2 glass-card p-6 rounded-xl h-48 skeleton"></div>
                    <div class="glass-card p-6 rounded-xl h-48 skeleton"></div>
                </div>
                <div class="glass-card p-6 rounded-xl h-64 skeleton"></div>
            </div>

            <div x-show="!isLoading && selectedAccountIds.length > 0" id="dashboardContent" x-cloak>
                <div id="widgets-container" class="space-y-8">

                    <div id="widget-kpi" class="widget fade-in">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center text-gray-600">
                                <i class="fas fa-arrows-alt widget-handle mr-3 text-lg"></i>
                                <h2 class="text-lg font-bold">Key Performance Indicators</h2>
                            </div>
                            <div class="flex items-center space-x-2 text-sm text-gray-500">
                                <i class="fas fa-chart-line"></i>
                                <span>Live metrics</span>
                            </div>
                        </div>
                        <div id="kpi-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                    </div>

                    <div id="widget-map" class="widget grid gap-6 lg:grid-cols-5 fade-in">
                        <div class="lg:col-span-3 chart-container p-6 rounded-xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-arrows-alt widget-handle mr-3 text-gray-400"></i>
                                    <i class="fas fa-globe-americas mr-2 text-blue-500"></i>
                                    Active Regions
                                </h3>
                                <div class="flex items-center space-x-4 text-sm">
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                                        <span class="text-gray-600">Active</span>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                        <span class="text-gray-600">Sustainable</span>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                        <span class="text-gray-600">Issues</span>
                                    </div>
                                </div>
                            </div>
                            <div id="highcharts-map-container" style="height: 400px;" class="rounded-lg overflow-hidden"></div>
                        </div>
                        <div class="lg:col-span-2 chart-container p-6 rounded-xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-arrows-alt widget-handle mr-3 text-gray-400"></i>
                                    <i class="fas fa-server mr-2 text-purple-500"></i>
                                    Resource Inventory
                                </h3>
                                <div class="text-sm text-gray-500">
                                    <i class="fas fa-sync-alt"></i>
                                </div>
                            </div>
                            <div id="resourceInventory" class="grid grid-cols-1 gap-3 custom-scrollbar" style="max-height: 400px; overflow-y: auto;"></div>
                        </div>
                    </div>

                    <div id="widget-optimization" class="widget chart-container p-6 rounded-xl fade-in">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-gray-800 flex items-center">
                                <i class="fas fa-arrows-alt widget-handle mr-3 text-gray-400"></i>
                                <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
                                Optimization Hub
                            </h3>
                        </div>
                        <div id="optimizationHub"></div>
                    </div>

                    <div id="widget-costs" class="widget grid gap-6 lg:grid-cols-3 fade-in">
                        <div class="lg:col-span-2 chart-container p-6 rounded-xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-arrows-alt widget-handle mr-3 text-gray-400"></i>
                                    <i class="fas fa-chart-bar mr-2 text-green-500"></i>
                                    Cost History (Last 6 Months)
                                </h3>
                                <div class="flex items-center space-x-2 text-sm text-gray-500">
                                    <i class="fas fa-exclamation-triangle text-orange-500"></i>
                                    <span>Anomaly detection</span>
                                </div>
                            </div>
                            <div class="h-80 p-4 bg-gray-50 rounded-lg">
                                <canvas id="costHistoryChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container p-6 rounded-xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-arrows-alt widget-handle mr-3 text-gray-400"></i>
                                    <i class="fas fa-receipt mr-2 text-blue-500"></i>
                                    Billing Summary
                                </h3>
                                <div class="text-sm text-gray-500">MTD</div>
                            </div>
                            <div class="overflow-y-auto max-h-80 custom-scrollbar">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0 rounded-lg">
                                    <tr>
                                        <th class="px-4 py-3 rounded-l-lg">Service</th>
                                        <th class="px-4 py-3 text-right rounded-r-lg">Cost (USD)</th>
                                    </tr>
                                    </thead>
                                    <tbody id="billingSummary"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<button class="floating-action tooltip" data-tooltip="Quick Actions" @click="showQuickActions = !showQuickActions">
    <i class="fas fa-bolt"></i>
</button>


<script>
    function dashboardApp() {
        return {
            isLoading: true,
            isRefreshing: false,
            stompClient: null,
            layoutChanged: false,
            showQuickActions: false,
            selectedAccountIds: [],
            dashboardData: {},

            init() {
                console.log('[Map Debug] Initializing dashboardApp...');

                // CRITICAL CHECK: See if Highcharts is available on the window object
                if (window.Highcharts) {
                    console.log('[Map Debug] Highcharts object found on window.', window.Highcharts);
                } else {
                    console.error('[Map Debug] CRITICAL: Highcharts object NOT found on window. Map will not render. Check script loading order and for any script errors.');
                }

                const urlParams = new URLSearchParams(window.location.search);
                const accountIdsParam = urlParams.get('accountId') || urlParams.get('accountIds');

                if (accountIdsParam) {
                    this.selectedAccountIds = accountIdsParam.split(',');
                    sessionStorage.setItem('selectedAccountIds', JSON.stringify(this.selectedAccountIds));
                } else {
                    this.selectedAccountIds = JSON.parse(sessionStorage.getItem('selectedAccountIds') || '[]');
                }

                this.selectedAccountId = this.selectedAccountIds.length > 0 ? this.selectedAccountIds[0] : null;

                window.addEventListener('storage', (event) => {
                    if (event.key === 'selectedAccountIds') {
                        window.location.reload();
                    }
                });

                this.initializeDashboardLayout();
                this.loadDashboardData(false);
            },

            connectWebSocket() {
                if (!this.selectedAccountId || this.stompClient) return;

                const socket = new SockJS('/ws');
                this.stompClient = Stomp.over(socket);
                this.stompClient.debug = null;
                this.stompClient.connect({}, (frame) => {
                    this.stompClient.subscribe(`/topic/dashboard/${this.selectedAccountId}/inventory`, (message) => {
                        this.populateResourceInventory(JSON.parse(message.body));
                    });
                });
            },

            loadDashboardData(forceRefresh = false) {
                if (!this.selectedAccountId) {
                    this.isLoading = false;
                    return;
                }

                if (forceRefresh) {
                    this.isRefreshing = true;
                } else {
                    this.isLoading = true;
                }

                fetch(`/api/xamops/dashboard/data?accountId=${this.selectedAccountId}&forceRefresh=${forceRefresh}`)
                    .then(res => {
                        if (!res.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return res.json();
                    })
                    .then(data => {
                        console.log('[Map Debug] Data received from API:', data);
                        if (data && data.selectedAccount) {
                            this.dashboardData = data;
                            setTimeout(() => {
                                this.populatePage(data.selectedAccount);
                                this.renderAllCharts(data.selectedAccount);
                            }, 0);
                        } else {
                             console.error('[Map Debug] Received invalid data structure from server:', data);
                             this.showNotification('error', 'Received invalid data from server.');
                        }
                    })
                    .catch(error => {
                        console.error('Failed to load dashboard data:', error);
                        this.showNotification('error', 'Failed to update dashboard.');
                    })
                    .finally(() => {
                        this.isLoading = false;
                        this.isRefreshing = false;
                        if (forceRefresh) {
                             this.showNotification('success', 'Dashboard updated successfully!');
                        }
                    });
            },

            showNotification(type, message) {
                const notification = document.getElementById(type + 'Notification');
                 if (notification.querySelector('span')) {
                    notification.querySelector('span').textContent = message;
                }
                if (notification) {
                    notification.classList.add('show');
                    setTimeout(() => {
                        notification.classList.remove('show');
                    }, 3000);
                }
            },

            initializeDashboardLayout() {
                const container = document.getElementById('widgets-container');
                fetch('/api/xamops/dashboard/layout')
                    .then(res => res.json())
                    .then(layout => {
                        if (layout && layout.layoutConfig) {
                            const widgetOrder = JSON.parse(layout.layoutConfig);
                            if (widgetOrder && widgetOrder.length > 0) {
                                widgetOrder.forEach(widgetId => {
                                    const widget = document.getElementById(widgetId);
                                    if (widget) container.appendChild(widget);
                                });
                            }
                        }
                        new Sortable(container, {
                            animation: 200,
                            ghostClass: 'sortable-ghost',
                            chosenClass: 'sortable-chosen',
                            handle: '.widget-handle',
                            onEnd: () => { this.layoutChanged = true; }
                        });
                    }).catch(err => {
                        console.error("Failed to load layout, using default.", err);
                        new Sortable(container, {
                            animation: 200,
                            ghostClass: 'sortable-ghost',
                            chosenClass: 'sortable-chosen',
                            handle: '.widget-handle',
                            onEnd: () => { this.layoutChanged = true; }
                        });
                    });
            },

            saveLayout() {
                const container = document.getElementById('widgets-container');
                const widgetOrder = [...container.children].map(w => w.id);
                fetch('/api/xamops/dashboard/layout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(widgetOrder)
                }).then(res => {
                    if (res.ok) {
                        this.layoutChanged = false;
                        this.showNotification('success', 'Layout saved successfully!');
                    } else {
                        alert('Failed to save layout.');
                    }
                });
            },

           renderAllCharts(account) {
                console.log('[Map Debug] renderAllCharts called.');
                if (!account) {
                    console.warn('[Map Debug] renderAllCharts called with no account data. Aborting.');
                    return;
                }
                this.renderCostHistoryChart(account.costHistory);

                console.log('[Map Debug] Preparing to render map with regionStatus:', account.regionStatus);
                this.renderHighchartMap(account.regionStatus);
            },

            populatePage(data) {
                if (!data) return;
                document.getElementById('updateTime').textContent = `Updated ${new Date().toLocaleTimeString()}`;
                this.populateKpiCards(data);
                this.populateResourceInventory(data.resourceInventory);
                this.populateOptimizationHub(data.optimizationSummary, data.costAnomalies, data.ec2Recommendations, data.ebsRecommendations, data.lambdaRecommendations);
                this.populateBillingSummary(data.billingSummary);
            },

            populateKpiCards(account) {
                const kpiContainer = document.getElementById('kpi-cards');
                if (!kpiContainer || !account || !account.costHistory) return;

                const costHistory = account.costHistory;
                const mtdSpend = costHistory.costs.length > 0 ? costHistory.costs[costHistory.costs.length - 1] : 0;
                const lastMonthSpend = costHistory.costs.length > 1 ? costHistory.costs[costHistory.costs.length - 2] : 0;
                const forecastedSpend = (mtdSpend / new Date().getDate()) * new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();

                const kpis = [
                    {
                        id: 'mtdSpend',
                        title: 'Month-to-Date Spend',
                        value: this.formatCurrency(mtdSpend),
                        icon: 'fa-dollar-sign',
                        color: { iconClass: 'text-blue-500', chartColor: '#3b82f6', gradientClass: 'from-blue-500 to-blue-600' },
                        trendData: costHistory.costs,
                        change: lastMonthSpend > 0 ? ((mtdSpend - lastMonthSpend) / lastMonthSpend * 100) : 0
                    },
                    {
                        id: 'forecastedSpend',
                        title: 'Forecasted Spend',
                        value: this.formatCurrency(forecastedSpend),
                        icon: 'fa-chart-line',
                        color: { iconClass: 'text-yellow-500', chartColor: '#f59e0b', gradientClass: 'from-yellow-500 to-yellow-600' },
                        trendData: [...costHistory.costs, forecastedSpend],
                        change: mtdSpend > 0 ? ((forecastedSpend - mtdSpend) / mtdSpend * 100) : 0
                    },
                    {
                        id: 'lastMonthSpend',
                        title: 'Last Month Spend',
                        value: this.formatCurrency(lastMonthSpend),
                        icon: 'fa-calendar-alt',
                        color: { iconClass: 'text-gray-500', chartColor: '#6b7280', gradientClass: 'from-gray-500 to-gray-600' },
                        trendData: costHistory.costs.slice(0, -1),
                        change: costHistory.costs.length > 2 ? ((lastMonthSpend - costHistory.costs[costHistory.costs.length - 3]) / costHistory.costs[costHistory.costs.length - 3] * 100) : 0
                    },
                    {
                        id: 'potentialSavings',
                        title: 'Potential Savings',
                        value: this.formatCurrency(account.optimizationSummary.totalPotentialSavings),
                        icon: 'fa-piggy-bank',
                        color: { iconClass: 'text-green-500', chartColor: '#22c55e', gradientClass: 'from-green-500 to-green-600' },
                        trendData: [0, account.optimizationSummary.totalPotentialSavings],
                        change: 100
                    }
                ];

                kpiContainer.innerHTML = kpis.map(kpi => `
                    <div class="kpi-card rounded-xl p-6 group" @mouseenter="renderSparkline('sparkline-${kpi.id}', [${kpi.trendData.join(',')}], '${kpi.color.chartColor}')">
                        <div class="main-content">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="text-gray-600 text-sm font-medium mb-1">${kpi.title}</h3>
                                    <p class="text-2xl font-bold text-gray-900 mb-2">${kpi.value}</p>
                                    <div class="flex items-center text-sm">
                                        <span class="font-medium ${kpi.change >= 0 ? 'text-red-600' : 'text-green-600'}">
                                            ${kpi.change >= 0 ? '+' : ''}${kpi.change.toFixed(1)}%
                                        </span>
                                        <span class="text-gray-500 ml-1">vs last period</span>
                                    </div>
                                </div>
                                <div class="bg-gradient-to-br ${kpi.color.gradientClass} p-3 rounded-xl shadow-lg">
                                    <i class="fas ${kpi.icon} text-white text-lg"></i>
                                </div>
                            </div>
                        </div>
                        <div class="sparkline-container p-4 flex items-center justify-center">
                            <div class="w-full h-full">
                                <canvas id="sparkline-${kpi.id}"></canvas>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            populateResourceInventory(inv) {
                if (!inv) return;
                const container = document.getElementById('resourceInventory');
                const resources = [
                    { name: 'EC2 Instances', count: inv.ec2, type: 'EC2 Instance', icon: 'ec2-instances.png' },
                    { name: 'S3 Buckets', count: inv.s3Buckets, type: 'S3 Bucket', icon: 's3-bucket.png' },
                    { name: 'RDS Instances', count: inv.rdsInstances, type: 'RDS Instance', icon: 'rds-instance.png' },
                    { name: 'VPC Networks', count: inv.vpc, type: 'VPC', icon: 'vpc.png' },
                    { name: 'Lambda Functions', count: inv.lambdas, type: 'Lambda Function', icon: 'aws-lambda.png' },
                    { name: 'EBS Volumes', count: inv.ebsVolumes, type: 'EBS Volume', icon: 'aws-ebs.png' },
                    { name: 'Route 53 Zones', count: inv.route53Zones, type: 'Route 53 Zone', icon: 'aws-route53.png' },
                    { name: 'Load Balancers', count: inv.loadBalancers, type: 'Load Balancer', icon: 'load-balanceraws.png' },
                    { name: 'ECS Clusters', count: inv.ecs, type: 'ECS', icon: 'aws-ecs.png' },
                    { name: 'EKS Clusters', count: inv.kubernetes, type: 'EKS', icon: 'aws-eks.png' },
                    { name: 'Lightsail Instances', count: inv.lightsail, type: 'Lightsail Instance', icon: 'lightsail.png' },
                    { name: 'Amplify Apps', count: inv.amplify, type: 'Amplify App', icon: 'amplify.png' }
                ];

                container.innerHTML = resources.map(res => `
                    <a href="/cloudlist?service=${encodeURIComponent(res.type)}" class="resource-card flex items-center gap-4 p-4 rounded-xl hover:shadow-md transition-all group">
                        <div class="resource-icon w-10 h-10 flex-shrink-0">
                            <img src="/icons/${res.icon}" alt="${res.name}" class="w-full h-full rounded-xl object-cover">
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-gray-800 truncate">${res.name}</p>
                            <p class="text-sm text-gray-500">Active resources</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xl font-bold text-gray-900">${res.count}</p>
                            <p class="text-xs text-gray-500">total</p>
                        </div>
                    </a>
                `).join('');
            },

            populateOptimizationHub(summary, anomalies, ec2Recs, ebsRecs, lambdaRecs) {
                const container = document.getElementById('optimizationHub');
                if(!summary || !container) return;

                const recsHtml = (title, recs, icon, color, gradientClass) => {
                    if (!recs || recs.length === 0) return '';
                    return `
                        <div class="optimization-card rounded-xl p-6 border-t-4 border-${color}-500 mt-6">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-bold text-lg text-gray-800 flex items-center">
                                    <div class="w-8 h-8 bg-gradient-to-br ${gradientClass} rounded-lg flex items-center justify-center mr-3">
                                        <i class="fas ${icon} text-white text-sm"></i>
                                    </div>
                                    ${title}
                                </h4>
                                <span class="bg-${color}-100 text-${color}-800 text-xs font-semibold px-2 py-1 rounded-full">${recs.length} recommendations</span>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50 rounded-lg">
                                        <tr>
                                            <th class="px-4 py-3 text-left font-semibold text-gray-700 rounded-l-lg">Resource</th>
                                            <th class="px-4 py-3 text-left font-semibold text-gray-700">Recommendation</th>
                                            <th class="px-4 py-3 text-right font-semibold text-gray-700 rounded-r-lg">Monthly Savings</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        ${recs.slice(0, 3).map(rec => `
                                            <tr class="hover:bg-gray-50 transition-colors">
                                                <td class="px-4 py-3 font-mono text-xs text-gray-600">${rec.resourceId}</td>
                                                <td class="px-4 py-3">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="text-gray-600">${rec.currentType}</span>
                                                        <i class="fas fa-arrow-right text-gray-400"></i>
                                                        <span class="font-semibold text-${color}-600">${rec.recommendedType}</span>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3 text-right font-bold text-${color}-600">${this.formatCurrency(rec.estimatedMonthlySavings)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            ${recs.length > 3 ? `
                                <div class="mt-4 text-center">
                                    <a href="/rightsizing" class="inline-flex items-center text-sm text-${color}-600 hover:text-${color}-800 font-medium">
                                        View all ${recs.length} recommendations
                                        <i class="fas fa-arrow-right ml-1"></i>
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    `;
                };

                const anomaliesHtml = (anomalies) => {
                    if (!anomalies || anomalies.length === 0) return '';
                    return `
                        <div class="anomaly-card rounded-xl p-6 border-t-4 border-red-500 mt-6">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-bold text-lg text-gray-800 flex items-center">
                                    <div class="w-8 h-8 bg-gradient-to-br from-red-500 to-red-600 rounded-lg flex items-center justify-center mr-3">
                                        <i class="fas fa-exclamation-triangle text-white text-sm"></i>
                                    </div>
                                    Cost Anomalies
                                </h4>
                                <span class="bg-red-100 text-red-800 text-xs font-semibold px-2 py-1 rounded-full">${anomalies.length} detected</span>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50 rounded-lg">
                                        <tr>
                                            <th class="px-4 py-3 text-left font-semibold text-gray-700 rounded-l-lg">Service</th>
                                            <th class="px-4 py-3 text-left font-semibold text-gray-700">Date</th>
                                            <th class="px-4 py-3 text-right font-semibold text-gray-700 rounded-r-lg">Unexpected Spend</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        ${anomalies.slice(0, 3).map(a => `
                                            <tr class="hover:bg-gray-50 transition-colors">
                                                <td class="px-4 py-3 font-semibold text-gray-800">${a.service}</td>
                                                <td class="px-4 py-3 text-gray-600">${a.startDate}</td>
                                                <td class="px-4 py-3 text-right font-bold text-red-600">${this.formatCurrency(a.unexpectedSpend)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                };

                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 p-6 rounded-xl text-center">
                            <div class="flex items-center justify-center mb-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-piggy-bank text-white text-xl"></i>
                                </div>
                            </div>
                            <p class="text-sm text-green-700 font-semibold uppercase tracking-wide">Potential Savings</p>
                            <p class="text-3xl font-bold text-green-800 my-2">${this.formatCurrency(summary.totalPotentialSavings)}</p>
                            <p class="text-sm text-green-600">per month</p>
                        </div>
                        <div class="bg-gradient-to-br from-red-50 to-red-100 border border-red-200 p-6 rounded-xl text-center">
                            <div class="flex items-center justify-center mb-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                                </div>
                            </div>
                            <p class="text-sm text-red-700 font-semibold uppercase tracking-wide">Critical Alerts</p>
                            <p class="text-3xl font-bold text-red-800 my-2">${summary.criticalAlertsCount}</p>
                            <p class="text-sm text-red-600">items to review</p>
                        </div>
                    </div>
                    ${recsHtml('EC2 Instance Right-Sizing', ec2Recs, 'fa-server', 'orange', 'from-orange-500 to-orange-600')}
                    ${recsHtml('EBS Volume Optimization', ebsRecs, 'fa-hdd', 'purple', 'from-purple-500 to-purple-600')}
                    ${recsHtml('Lambda Function Optimization', lambdaRecs, 'fa-bolt', 'yellow', 'from-yellow-500 to-yellow-600')}
                    ${anomaliesHtml(anomalies)}
                `;
            },

            populateBillingSummary(summary) {
                const container = document.getElementById('billingSummary');
                if (!container || !summary) return;
                if (summary.length > 0) {
                    container.innerHTML = summary.sort((a,b) => b.monthToDateCost - a.monthToDateCost).map((item, index) => `
                        <tr class="border-b hover:bg-gray-50 transition-colors">
                            <th class="px-4 py-4 font-semibold text-gray-800 text-left">
                                <div class="flex items-center space-x-2">
                                    <div class="w-2 h-2 bg-indigo-${500 + (index * 100) % 400} rounded-full"></div>
                                    <span>${item.serviceName}</span>
                                </div>
                            </th>
                            <td class="px-4 py-4 text-right">
                                <span class="font-bold text-gray-900">${this.formatCurrency(item.monthToDateCost)}</span>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <tr>
                            <td colspan="2" class="px-4 py-8 text-center text-gray-500">
                                <i class="fas fa-receipt text-2xl mb-2"></i>
                                <p>No billing data available</p>
                            </td>
                        </tr>
                    `;
                }
            },

            renderCostHistoryChart(costHistory) {
                if (!costHistory || !costHistory.labels) return;
                const ctx = document.getElementById('costHistoryChart');
                if(!ctx) return;
                if (window.costHistoryChartInstance) window.costHistoryChartInstance.destroy();

                const backgroundColors = costHistory.anomalies.map(isAnomaly =>
                    isAnomaly ? 'rgba(239, 68, 68, 0.8)' : 'rgba(79, 70, 229, 0.8)'
                );
                const borderColors = costHistory.anomalies.map(isAnomaly =>
                    isAnomaly ? 'rgba(220, 38, 38, 1)' : 'rgba(79, 70, 229, 1)'
                );

                window.costHistoryChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: costHistory.labels,
                        datasets: [{
                            label: 'Monthly Cost',
                            data: costHistory.costs,
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                borderColor: 'rgba(79, 70, 229, 0.8)',
                                borderWidth: 1,
                                cornerRadius: 8,
                                callbacks: {
                                    label: (c) => `Cost: ${this.formatCurrency(c.parsed.y)}`,
                                    afterLabel: (c) => costHistory.anomalies[c.dataIndex] ? 'Anomaly detected!' : ''
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: v => this.formatCurrency(v),
                                    color: '#6b7280'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#6b7280'
                                },
                                grid: {
                                    display: false
                                }
                            }
                        },
                        onClick: (evt, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                if (costHistory.anomalies[index]) {
                                    alert(` Cost Anomaly Detected!\n\nMonth: ${costHistory.labels[index]}\nCost: ${this.formatCurrency(costHistory.costs[index])}\n\nThis cost is significantly higher than expected. Consider investigating your resource usage for this period.`);
                                }
                            }
                        }
                    }
                });
            },

            renderHighchartMap(regionStatus) {
                if (!regionStatus || !document.getElementById('highcharts-map-container')) {
                    console.warn('Map container or region data not available');
                    return;
                }

                const statusColors = {
                    'ACTIVE': '#3b82f6',
                    'SEMI_ACTIVE': '#ef4444',
                    'SUSTAINABLE': '#22c55e',
                    'NON_ACTIVE': '#6b7280'
                };

                const regionPoints = regionStatus.map(r => ({
                    name: r.regionId,
                    fullName: `${r.regionId} (${r.status})`,
                    lat: r.latitude,
                    lon: r.longitude,
                    color: statusColors[r.status] || '#6b7280',
                    id: r.regionId,
                    status: r.status
                }));

                console.log('Rendering map with', regionPoints.length, 'regions');

                //  FIX: Dynamically load world map topology
                fetch('https://code.highcharts.com/mapdata/custom/world.topo.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to fetch world map data');
                        }
                        return response.json();
                    })
                    .then(worldMap => {
                        console.log('World map data loaded successfully');

                        Highcharts.mapChart('highcharts-map-container', {
                            chart: {
                                map: worldMap,  //  Set base world map
                                backgroundColor: 'transparent',
                                style: {
                                    fontFamily: 'Inter, sans-serif'
                                }
                            },
                            title: { text: null },
                            credits: { enabled: false },
                            mapNavigation: {
                                enabled: true,
                                enableMouseWheelZoom: true,
                                buttonOptions: {
                                    verticalAlign: 'bottom',
                                    theme: {
                                        'stroke-width': 1,
                                        stroke: '#FF9900',  // AWS orange
                                        r: 4,
                                        fill: 'white'
                                    }
                                }
                            },
                            tooltip: {
                                useHTML: true,
                                backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                borderColor: 'rgba(255, 153, 0, 0.8)',
                                borderRadius: 8,
                                style: {
                                    color: 'white',
                                    fontSize: '12px'
                                },
                                pointFormat: '<div style="padding: 4px;">' +
                                             '<b>{point.fullName}</b><br/>' +
                                             '<span style="font-size: 10px;">Click to filter dashboard</span>' +
                                             '</div>'
                            },
                            plotOptions: {
                                mappoint: {
                                    point: {
                                        events: {
                                            click: (e) => {
                                                console.log('Region clicked:', e.point.id);
                                                if (this.filterByRegion) {
                                                    this.filterByRegion(e.point.id);
                                                }
                                            }
                                        }
                                    }
                                }
                            },
                            series: [
                                {
                                    //  World map base layer
                                    type: 'map',
                                    name: 'World',
                                    mapData: worldMap,  //  Explicit map data
                                    color: '#f1f5f9',   // Light gray for countries
                                    nullColor: '#e5e7eb',  //  Gray for empty countries
                                    enableMouseTracking: false,  // Don't show tooltips for countries
                                    states: {
                                        hover: {
                                            color: '#e2e8f0',
                                            brightness: 0.05
                                        }
                                    },
                                    borderColor: '#cbd5e1',
                                    borderWidth: 0.5,
                                    dataLabels: {
                                        enabled: false
                                    }
                                },
                                {
                                    //  AWS region markers layer
                                    type: 'mappoint',
                                    name: 'AWS Regions',
                                    data: regionPoints,
                                    marker: {
                                        lineWidth: 2,
                                        lineColor: '#ffffff',
                                        radius: 8,
                                        symbol: 'circle',
                                        states: {
                                            hover: {
                                                lineWidth: 3,
                                                radius: 12,
                                                animation: {
                                                    duration: 200
                                                }
                                            }
                                        }
                                    },
                                    cursor: 'pointer',
                                    dataLabels: {
                                        enabled: true,
                                        format: '{point.name}',
                                        style: {
                                            color: '#1f2937',
                                            fontSize: '10px',
                                            fontWeight: 'bold',
                                            textOutline: '2px white'
                                        },
                                        y: -15
                                    }
                                }
                            ]
                        });

                        console.log('Map rendered successfully');
                    })
                    .catch(error => {
                        console.error('Failed to load world map:', error);
                        const container = document.getElementById('highcharts-map-container');
                        if (container) {
                            container.innerHTML =
                                '<div class="flex items-center justify-center h-full">' +
                                '<div class="text-center p-8">' +
                                '<i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>' +
                                '<p class="text-red-600 font-semibold">Failed to load world map</p>' +
                                '<p class="text-sm text-gray-500 mt-2">' + error.message + '</p>' +
                                '</div></div>';
                        }
                    });
            },

            hexToRgba(hex, alpha) {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            },

            renderSparkline(canvasId, data, chartColor) {
                const ctx = document.getElementById(canvasId);
                if (!ctx || !data) return;
                if (window[canvasId+'_instance']) window[canvasId+'_instance'].destroy();

                window[canvasId+'_instance'] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map((_, i) => i),
                        datasets: [{
                            data: data,
                            borderColor: chartColor,
                            backgroundColor: this.hexToRgba(chartColor, 0.1),
                            borderWidth: 3,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: chartColor,
                            pointHoverBorderColor: '#ffffff',
                            pointHoverBorderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { display: false },
                            y: { display: false }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                borderColor: chartColor,
                                borderWidth: 1,
                                cornerRadius: 6,
                                callbacks: {
                                    label: (context) => `Value: ${context.parsed.y}`
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            },

            filterByRegion(regionId) {
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-lg shadow-lg z-50 max-w-sm';
                notification.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-filter text-blue-600"></i>
                        <div>
                            <p class="font-semibold">Region Filter Applied</p>
                            <p class="text-sm">Dashboard filtered by: ${regionId}</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 4000);
            },


            formatCurrency(num) {
                return '$' + (num != null ? num.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }) : '0.00');
            },
        }
    }

</script>
</body>
</html>