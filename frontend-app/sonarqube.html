<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XamOps - Code Quality</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="/icons/XamOps.png" sizes="32x32" type="image/png">
    <link rel="apple-touch-icon" href="/icons/XamOps.png">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 20px; }
        [x-cloak] { display: none !important; }

        .quality-gate-ok { background-color: #DEF7EC; color: #067647; }
        .quality-gate-error { background-color: #FDE2E1; color: #B42318; }
        .quality-gate-warn { background-color: #FEF0C7; color: #B54708; }
        .quality-gate-none { background-color: #F3F4F6; color: #4B5563; }
        
        .metric-value {
            font-size: 1.5rem; /* 24px */
            line-height: 2rem; /* 32px */
            font-weight: 700;
        }
        .metric-label {
            font-size: 0.875rem; /* 14px */
            line-height: 1.25rem; /* 20px */
            font-weight: 500;
            color: #6B7280;
        }
        .rating-badge {
            font-size: 1.875rem; /* 30px */
            line-height: 2.25rem; /* 36px */
            font-weight: 800;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        .rating-a { background-color: #067647; color: white; } /* Green */
        .rating-b { background-color: #B54708; color: white; } /* Orange */
        .rating-c { background-color: #F79009; color: white; } /* Yellow */
        .rating-d { background-color: #B42318; color: white; } /* Red */
        .rating-e { background-color: #B42318; color: white; } /* Red */
    </style>
</head>

<body class="bg-gray-50 flex">
    <div id="sidebar-container" class="flex-shrink-0"></div>

    <div class="flex-1 flex flex-col h-screen overflow-y-auto">

        <div th:replace="~{_header :: _header}"></div>

        <main class="flex-1 p-6 lg:p-10" x-data="sonarqubeDashboard()">
            
            <div class.="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Code Quality</h1>
                    <p class="text-lg text-gray-500 mt-1">SonarQube Project Dashboard</p>
                </div>
                <div class="flex gap-3">
                    <button @click="isManageModalOpen = true" class="flex items-center gap-2 px-4 py-2 bg-white text-gray-700 border border-gray-300 font-semibold rounded-lg shadow-sm hover:bg-gray-50 transition duration-200">
                        <i class="fas fa-cog fa-fw"></i>
                        <span>Manage Projects</span>
                    </button>
                </div>
            </div>

            <div class="mb-6 max-w-md">
                <label for="projectSelect" class="block text-sm font-medium text-gray-700">Select Project to View</label>
                <select id="projectSelect" x-model="selectedProjectId" @change="loadProjectMetrics()"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                    <option value="">-- Select a Project --</option>
                    <template x-for="project in projects" :key="project.id">
                        <option :value="project.id" x-text="project.projectName"></option>
                    </template>
                </select>
            </div>

            <div x-show="isLoading" x-cloak class="flex justify-center items-center h-64">
                <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                <p class="ml-4 text-gray-600">Loading Dashboard...</p>
            </div>

            <div x-show="error" x-cloak class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
                <strong class="font-bold">Error: </strong>
                <span class="block sm:inline" x-text="error"></span>
            </div>

            <div x-show="!isLoading && projects.length === 0" x-cloak class="text-center bg-white p-12 rounded-lg shadow-sm border">
                <i class="fas fa-search-dollar fa-3x text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-800">No Projects Configured</h3>
                <p class="text-gray-500 mt-2">Click "Manage Projects" to add your first SonarQube project.</p>
            </div>

            <div x-show="!isLoading && projects.length > 0 && !selectedProjectId" x-cloak class="text-center bg-white p-12 rounded-lg shadow-sm border">
                <i class="fas fa-mouse-pointer fa-3x text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-800">Select a Project</h3>
                <p class="text-gray-500 mt-2">Choose a project from the dropdown above to view its quality metrics.</p>
            </div>

            <div x-show="!isLoading && selectedProjectId && metrics" x-cloak class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 bg-white border border-gray-200 rounded-xl shadow-sm p-6"
                         :class="getQualityGateClass(metrics.qualityGateStatus)">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-semibold">Quality Gate</span>
                            <a :href="selectedProjectUrl" target="_blank" class="text-sm font-medium hover:underline" :class="getQualityGateTextColor(metrics.qualityGateStatus)">
                                View in SonarQube <i class="fas fa-external-link-alt fa-xs"></i>
                            </a>
                        </div>
                        <p class="mt-4 text-5xl font-bold" x-text="metrics.qualityGateStatus === 'OK' ? 'Passed' : (metrics.qualityGateStatus === 'ERROR' ? 'Failed' : 'N/A')"></p>
                    </div>
                    <div class="md:col-span-2 bg-white border border-gray-200 rounded-xl shadow-sm p-6">
                        <span class="text-lg font-semibold text-gray-900">Lines of Code</span>
                        <p class="mt-4 text-5xl font-bold text-gray-900" x-text="(metrics.linesOfCode || 0).toLocaleString()"></p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    
                    <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-5">
                        <h3 class="font-semibold text-gray-800 mb-4">Reliability</h3>
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="metric-label">Bugs</p>
                                <p class="metric-value text-orange-600" x-text="metrics.bugs || 0"></p>
                            </div>
                            <div class="text-right">
                                <p class="metric-label">Rating</p>
                                <div class="rating-badge" :class="getRatingClass(metrics.reliabilityRating)" x-text="metrics.reliabilityRating || '?'"></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-5">
                        <h3 class="font-semibold text-gray-800 mb-4">Security</h3>
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="metric-label">Vulnerabilities</p>
                                <p class="metric-value text-red-600" x-text="metrics.vulnerabilities || 0"></p>
                            </div>
                            <div class="text-right">
                                <p class="metric-label">Rating</p>
                                <div class="rating-badge" :class="getRatingClass(metrics.securityRating)" x-text="metrics.securityRating || '?'"></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-5">
                        <h3 class="font-semibold text-gray-800 mb-4">Security Hotspots</h3>
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="metric-label">Hotspots to Review</p>
                                <p class="metric-value text-yellow-600" x-text="metrics.securityHotspots || 0"></p>
                            </div>
                            <div class="text-right">
                                <p class="metric-label">Rating</p>
                                <div class="rating-badge" :class="getRatingClass(metrics.securityReviewRating)" x-text="metrics.securityReviewRating || '?'"></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-5">
                        <h3 class="font-semibold text-gray-800 mb-4">Maintainability</h3>
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="metric-label">Code Smells</p>
                                <p class="metric-value text-indigo-600" x-text="metrics.codeSmells || 0"></p>
                                <p class="metric-label mt-2">Tech Debt</p>
                                <p class="text-lg font-semibold text-gray-800" x-text="formatTechDebt(metrics.techDebt)"></p>
                            </div>
                            <div class="text-right">
                                <p class="metric-label">Rating</p>
                                <div class="rating-badge" :class="getRatingClass(metrics.maintainabilityRating)" x-text="metrics.maintainabilityRating || '?'"></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-5">
                        <h3 class="font-semibold text-gray-800 mb-4">Coverage</h3>
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="metric-label">Coverage</p>
                                <p class="metric-value text-blue-600" x-text="(metrics.coverage || 0) + '%'"></p>
                                <p class="metric-label mt-2">Lines to Cover</p>
                                <p class="text-lg font-semibold text-gray-800" x-text="(metrics.linesToCover || 0).toLocaleString()"></p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-5">
                        <h3 class="font-semibold text-gray-800 mb-4">Duplications</h3>
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="metric-label">Duplication Density</p>
                                <p class="metric-value text-gray-700" x-text="(metrics.duplicationDensity || 0) + '%'"></p>
                                <p class="metric-label mt-2">Duplicated Lines</p>
                                <p class="text-lg font-semibold text-gray-800" x-text="(metrics.duplicatedLines || 0).toLocaleString()"></p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            
            <div x-show="isManageModalOpen" x-cloak
                 class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
                 @keydown.escape.window="isManageModalOpen = false">
                <div @click.outside="isManageModalOpen = false"
                     class="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden transition-all duration-300 ease-out"
                     x-show="isManageModalOpen"
                     x-transition:enter="ease-out duration-300"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100"
                     x-transition:leave="ease-in duration-200"
                     x-transition:leave-start="opacity-100 scale-100"
                     x-transition:leave-end="opacity-0 scale-95">

                    <div class="px-6 py-5 bg-gray-50 border-b flex justify-between items-center">
                        <h3 class="text-lg font-medium text-gray-900">Manage SonarQube Projects</h3>
                        <button @click="isManageModalOpen = false" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times fa-lg"></i>
                        </button>
                    </div>
                    
                    <div class="p-6 border-b">
                        <h4 class="text-md font-semibold text-gray-800 mb-3">Configured Projects</h4>
                        <div class="max-h-48 overflow-y-auto pr-2 sidebar-scroll space-y-2">
                            <template x-if="projects.length === 0">
                                <p class="text-sm text-gray-500">No projects added yet.</p>
                            </template>
                            <template x-for="project in projects" :key="project.id">
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                    <div>
                                        <p class="font-medium text-gray-900" x-text="project.projectName"></p>
                                        <p class="text-sm text-gray-600" x-text="project.projectKey"></p>
                                    </div>
                                    <button @click="deleteProject(project.id)" class="px-3 py-1.5 text-xs font-medium text-red-600 bg-red-50 rounded-md hover:bg-red-100" title="Delete Project">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <form @submit.prevent="addProject">
                        <div class="p-6 space-y-4">
                            <h4 class="text-md font-semibold text-gray-800">Add New Project</h4>
                            <div>
                                <label for="projectName" class="block text-sm font-medium text-gray-700">Project Name</label>
                                <input type="text" x-model="newProject.projectName" id="projectName" placeholder="e.g., My Awesome App" required
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="serverUrl" class="block text-sm font-medium text-gray-700">Server URL</label>
                                <input type="url" x-model="newProject.serverUrl" id="serverUrl" placeholder="http://15.206.208.134:9000" required
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="projectKey" class="block text-sm font-medium text-gray-700">Project Key</label>
                                <input type="text" x-model="newProject.projectKey" id="projectKey" placeholder="Sonarqube-xamops" required
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="token" class="block text-sm font-medium text-gray-700">API Token</label>
                                <input type="password" x-model="newProject.token" id="token" placeholder="sqp_..." required
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            
                            <div x-show="modalError" x-cloak class="text-sm text-red-600" x-text="modalError"></div>
                        </div>
                        
                        <div class="px-6 py-4 bg-gray-50 border-t flex justify-end gap-3">
                            <button type="button" @click="isManageModalOpen = false" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50">
                                Close
                            </button>
                            <button type="submit" :disabled="isSaving" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md shadow-sm hover:bg-indigo-700 disabled:opacity-50">
                                <span x-show="!isSaving">Add Project</span>
                                <span x-show="isSaving"><i class="fas fa-spinner fa-spin mr-1"></i>Saving...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </main>
        
        <script>
            function sonarqubeDashboard() {
                return {
                    projects: [],
                    selectedProjectId: '',
                    metrics: null,
                    isLoading: true,
                    isManageModalOpen: false,
                    isSaving: false,
                    error: '',
                    modalError: '',
                    newProject: {
                        projectName: '',
                        serverUrl: 'http://15.206.208.134:9000', // Pre-fill server URL
                        projectKey: 'Sonarqube-xamops', // Pre-fill project key
                        token: ''
                    },

                    // Re-usable API fetcher
                    async apiFetch(url, options = {}) {
                        const csrfToken = document.cookie
                            .split('; ')
                            .find(row => row.startsWith('XSRF-TOKEN='))
                            ?.split('=')[1];
                        
                        const response = await fetch(url, {
                            ...options,
                            credentials: 'include', // Include cookies for auth
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                'X-XSRF-TOKEN': csrfToken,
                                ...options.headers
                            }
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('API Error:', response.status, errorText);
                            try {
                                const errorJson = JSON.parse(errorText);
                                throw new Error(errorJson.message || errorJson.error || `HTTP ${response.status}`);
                            } catch (e) {
                                throw new Error(errorText || `HTTP ${response.status}`);
                            }
                        }
                        // Handle 204 No Content for delete
                        if (response.status === 204) return null;
                        return response.json();
                    },

                    init() {
                        this.fetchProjects(true); // Load projects and then auto-select
                    },

                    fetchProjects(autoSelect = false) {
                        this.isLoading = true;
                        this.error = '';
                        this.apiFetch('/api/xamops/sonarqube/projects')
                            .then(data => {
                                this.projects = data;
                                if (autoSelect) {
                                    const savedProjectId = sessionStorage.getItem('sonarSelectedProjectId');
                                    if (savedProjectId && this.projects.some(p => p.id == savedProjectId)) {
                                        this.selectedProjectId = savedProjectId;
                                    } else if (this.projects.length > 0) {
                                        this.selectedProjectId = this.projects[0].id;
                                    }
                                    this.loadProjectMetrics(); 
                                }
                            })
                            .catch(err => {
                                this.error = 'Failed to load projects: ' + err.message;
                            })
                            .finally(() => {
                                this.isLoading = false;
                            });
                    },

                    loadProjectMetrics() {
                        if (!this.selectedProjectId) {
                            this.metrics = null;
                            this.isLoading = false;
                            sessionStorage.removeItem('sonarSelectedProjectId');
                            return;
                        }
                        sessionStorage.setItem('sonarSelectedProjectId', this.selectedProjectId);
                        this.fetchMetrics();
                    },

                    fetchMetrics() {
                        if (!this.selectedProjectId) return;
                        
                        this.isLoading = true;
                        this.error = '';
                        this.metrics = null; // Clear old data

                        this.apiFetch(`/api/xamops/sonarqube/projects/${this.selectedProjectId}/metrics`)
                            .then(data => {
                                this.metrics = data;
                            })
                            .catch(err => {
                                this.error = 'Could not load metrics for this project: ' + err.message;
                            })
                            .finally(() => {
                                this.isLoading = false;
                            });
                    },

                    addProject() {
                        this.isSaving = true;
                        this.modalError = '';
                        this.apiFetch('/api/xamops/sonarqube/projects', {
                            method: 'POST',
                            body: JSON.stringify(this.newProject)
                        })
                        .then(data => {
                            this.resetNewProjectForm();
                            this.fetchProjects(false); 
                        })
                        .catch(err => {
                            this.modalError = 'Failed to save project: ' + err.message;
                        })
                        .finally(() => {
                            this.isSaving = false;
                        });
                    },

                    deleteProject(projectId) {
                        if (!confirm('Are you sure you want to delete this project configuration?')) {
                            return;
                        }
                        this.error = '';
                        this.modalError = '';
                        this.apiFetch(`/api/xamops/sonarqube/projects/${projectId}`, {
                            method: 'DELETE'
                        })
                        .then(() => {
                            this.fetchProjects(false); 
                            if (this.selectedProjectId == projectId) {
                                this.selectedProjectId = '';
                                this.metrics = null;
                                sessionStorage.removeItem('sonarSelectedProjectId');
                            }
                        })
                        .catch(err => {
                            this.modalError = 'Failed to delete project: ' + err.message;
                        });
                    },
                    
                    resetNewProjectForm() {
                        this.newProject.projectName = '';
                        this.newProject.projectKey = '';
                        this.newProject.token = '';
                    },
                    
                    get selectedProjectUrl() {
                        if (!this.selectedProjectId) return '#';
                        const project = this.projects.find(p => p.id == this.selectedProjectId);
                        if (!project) return '#';
                        return `${project.serverUrl}/dashboard?id=${project.projectKey}`;
                    },

                    getQualityGateClass(status) {
                        if (!status) return 'quality-gate-none';
                        status = status.toUpperCase();
                        if (status === 'OK' || status === 'PASSED') return 'quality-gate-ok';
                        if (status === 'ERROR' || status === 'FAILED') return 'quality-gate-error';
                        if (status === 'WARN') return 'quality-gate-warn';
                        return 'quality-gate-none';
                    },

                    getQualityGateTextColor(status) {
                        if (!status) return 'text-gray-600';
                        status = status.toUpperCase();
                        if (status === 'OK' || status === 'PASSED') return 'text-green-700';
                        if (status === 'ERROR' || status === 'FAILED') return 'text-red-700';
                        if (status === 'WARN') return 'text-yellow-700';
                        return 'text-gray-600';
                    },

                    getRatingClass(rating) {
                        if (!rating) return 'rating-e';
                        switch(rating.toUpperCase()) {
                            case 'A': return 'rating-a';
                            case 'B': return 'rating-b';
                            case 'C': return 'rating-c';
                            case 'D': return 'rating-d';
                            case 'E': return 'rating-e';
                            default: return 'rating-e';
                        }
                    },
                    
                    formatTechDebt(minutes) {
                        if (!minutes || minutes === 0) return '0d';
                        const days = Math.floor(minutes / 480); // 8-hour days
                        const remainingMinutes = minutes % 480;
                        const hours = Math.floor(remainingMinutes / 60);
                        
                        let result = '';
                        if (days > 0) result += `${days}d `;
                        if (hours > 0) result += `${hours}h`;
                        
                        return result.trim() || '0m'; // Show 0m if less than 1 hour
                    }
                }
            }
        </script>
    </div>
</body>
</html>