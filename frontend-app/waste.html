<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XamOps - Waste Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="/icons/XamOps.png" sizes="32x32" type="image/png">
    <link rel="apple-touch-icon" href="/icons/XamOps.png">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="/src/main.js"></script>
</head>

<body class="bg-gray-50">

    <div class="flex">
        <include file="/_sidebar.html"></include>

        <div class="flex-1 pl-64">
            <main id="main-content" class="flex-1 flex flex-col min-h-screen" x-data="wasteManagement()">

                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

                    :root {
                        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        --error-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                        --glass-bg: rgba(255, 255, 255, 0.95);
                        --glass-border: rgba(229, 231, 235, 0.8);
                    }

                    .rotate-90 { transform: rotate(90deg); }
                    .transition-all { transition: all 0.3s ease-in-out; }

                    .header-gradient {
                        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%);
                        backdrop-filter: blur(10px);
                        border-bottom: 1px solid var(--glass-border);
                    }

                    .kpi-card {
                        position: relative;
                        overflow: hidden;
                        background: var(--glass-bg);
                        backdrop-filter: blur(10px);
                        border: 1px solid var(--glass-border);
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        border-radius: 1rem;
                    }

                    .kpi-card::before {
                        content: '';
                        position: absolute;
                        top: 0; left: 0; right: 0; height: 4px;
                        background: var(--error-gradient);
                        transform: scaleX(0);
                        transition: transform 0.3s ease;
                    }

                    .kpi-card:hover {
                        transform: translateY(-4px) scale(1.02);
                        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                    }

                    .kpi-card:hover::before { transform: scaleX(1); }

                    .btn-primary {
                        background: var(--primary-gradient);
                        border: none;
                        color: white;
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;
                    }

                    .btn-primary:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 10px 15px -3px rgba(102, 126, 234, 0.4);
                    }

                    .service-group {
                        background: var(--glass-bg);
                        backdrop-filter: blur(10px);
                        border: 1px solid var(--glass-border);
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        position: relative;
                        overflow: hidden;
                        border-radius: 1rem;
                    }

                    .service-group:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                    }

                    .service-icon {
                        transition: all 0.3s ease;
                        background: rgba(255, 255, 255, 0.9);
                        backdrop-filter: blur(10px);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                    }

                    .service-icon:hover {
                        transform: scale(1.1) rotate(5deg);
                        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                    }

                    .resource-counter {
                        background: var(--primary-gradient);
                        color: white;
                        border: 2px solid rgba(255, 255, 255, 0.3);
                        box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
                    }

                    .resource-row {
                        cursor: pointer;
                        transition: all 0.2s ease;
                        position: relative;
                        overflow: hidden;
                    }

                    .resource-row:hover {
                        transform: translateX(4px);
                        background: linear-gradient(90deg, rgba(102, 126, 234, 0.03) 0%, rgba(102, 126, 234, 0.08) 100%);
                    }

                    .resource-row::before {
                        content: '';
                        position: absolute;
                        left: 0; top: 0; bottom: 0; width: 4px;
                        background: var(--error-gradient);
                        transform: scaleY(0);
                        transition: transform 0.2s ease;
                    }

                    .resource-row:hover::before { transform: scaleY(1); }

                    .fade-in { animation: fadeIn 0.5s ease-in-out; }

                    @keyframes fadeIn {
                        from { opacity: 0; transform: translateY(20px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                </style>

                <header class="header-gradient h-20 flex items-center justify-between px-8 sticky top-0 z-10">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-pink-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-recycle text-white text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">Waste Management</h1>
                            <p class="text-sm text-gray-600">Identify and eliminate unused cloud resources</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                            <span class="text-sm text-gray-600">Waste detected</span>
                        </div>
                        <button @click="loadWastedResources(true)"
                            class="btn-primary flex items-center space-x-2 px-6 py-3 text-sm font-semibold rounded-lg shadow-md"
                            :disabled="isRefreshing">
                            <i class="fas fa-sync-alt" :class="{ 'fa-spin': isRefreshing }"></i>
                            <span x-text="isRefreshing ? 'Scanning...' : 'Scan Resources'"></span>
                        </button>
                    </div>
                </header>

                <div class="flex-1 p-8 space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="kpi-card p-6 fade-in">
                            <h3 class="text-gray-600 text-sm font-medium mb-2">Potential Savings</h3>
                            <p class="text-4xl font-bold text-red-600 mb-1"
                                x-text="isLoading ? '...' : '$' + potentialSavings.toFixed(2)"></p>
                            <p class="text-xs text-gray-500">per month</p>
                        </div>
                        <div class="kpi-card p-6 fade-in">
                            <h3 class="text-gray-600 text-sm font-medium mb-2">Wasted Resources</h3>
                            <p class="text-4xl font-bold text-red-600 mb-1" x-text="isLoading ? '...' : resourceCount">
                            </p>
                            <p class="text-xs text-gray-500">items found</p>
                        </div>
                        <div class="kpi-card p-6 fade-in">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Savings by Category</h3>
                            <div class="h-48">
                                <canvas id="savingsChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div x-show="isLoading" x-cloak class="w-full space-y-4">
                            <template x-for="i in 3">
                                <div class="service-group p-6">
                                    <div class="flex items-center justify-between animate-pulse">
                                        <div class="flex items-center space-x-4 flex-1">
                                            <div class="h-6 w-6 rounded bg-gray-300"></div>
                                            <div class="h-12 w-12 rounded-xl bg-gray-300"></div>
                                            <div class="h-6 w-40 rounded-lg bg-gray-300"></div>
                                            <div class="h-6 w-16 rounded-full bg-gray-300"></div>
                                        </div>
                                        <div class="h-10 w-28 rounded-lg bg-gray-300"></div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div x-show="!isLoading && groupedFilteredResources.length === 0" x-cloak
                            class="text-center py-20 px-8 rounded-2xl bg-white/80">
                            <div class="w-24 h-24 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-leaf text-white text-3xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">No Waste Found!</h3>
                            <p class="text-gray-600">Your cloud environment is perfectly optimized.</p>
                        </div>

                        <template x-for="group in groupedFilteredResources" :key="group.serviceType">
                            <div class="service-group fade-in">
                                <div @click="toggleGroup(group.serviceType)"
                                    class="flex items-center justify-between p-6 cursor-pointer">
                                    <div class="flex items-center space-x-4 flex-1">
                                        <i class="fas fa-chevron-right text-gray-400 w-5 text-center transition-all"
                                            :class="{'rotate-90': group.open}"></i>
                                        <div class="service-icon w-12 h-12 flex items-center justify-center rounded-xl">
                                            <img :src="'/icons/' + getServiceIcon(group.serviceType)"
                                                :alt="group.serviceType" class="w-full h-full rounded-xl object-cover"
                                                onerror="this.src='/icons/default-icon.png'">
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="font-bold text-gray-800 text-lg" x-text="group.serviceType"></h3>
                                            <p class="text-sm text-gray-600">Wasted Resource Category</p>
                                        </div>
                                        <div class="resource-counter text-sm font-bold px-4 py-2 rounded-full"
                                            x-text="group.resources.length"></div>
                                    </div>
                                </div>
                                <div x-show="group.open" x-cloak
                                    class="bg-gradient-to-r from-gray-50/30 to-gray-100/30">
                                    <template x-for="resource in group.resources" :key="resource.resourceId">
                                        <div class="resource-row border-t border-gray-200/50">
                                            <div @click="resource.detailsOpen = !resource.detailsOpen"
                                                class="grid grid-cols-12 items-center p-6 pl-16 text-sm">
                                                <div class="col-span-5 flex items-center space-x-4">
                                                    <i class="fas fa-chevron-right text-gray-400 w-5 text-center transition-all"
                                                        :class="{'rotate-90': resource.detailsOpen}"></i>
                                                    <div class="flex-1">
                                                        <p class="font-bold text-gray-800"
                                                            x-text="resource.resourceName || 'Untitled'"></p>
                                                        <p class="font-mono text-xs text-gray-500"
                                                            x-text="resource.resourceId"></p>
                                                    </div>
                                                </div>
                                                <div class="col-span-2 flex items-center space-x-2">
                                                    <i class="fas fa-map-marker-alt text-gray-400 text-xs"></i>
                                                    <span class="font-semibold text-gray-600"
                                                        x-text="resource.region"></span>
                                                </div>
                                                <div class="col-span-2 flex items-center space-x-1">
                                                    <i class="fas fa-dollar-sign text-red-500 text-xs"></i>
                                                    <span class="font-bold text-red-600"
                                                        x-text="resource.monthlySavings.toFixed(2)"></span>
                                                </div>
                                                <div class="col-span-3 text-right pr-4">
                                                    <div class="flex justify-end gap-2" @click.stop>
                                                        <button disabled title="Delete"
                                                            class="action-button px-3 py-2 text-xs font-semibold text-white bg-red-600 rounded-lg opacity-50 cursor-not-allowed">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </button>
                                                        <button disabled title="Archive"
                                                            class="action-button px-3 py-2 text-xs font-semibold text-gray-700 bg-gray-200 rounded-lg opacity-50 cursor-not-allowed">
                                                            <i class="fas fa-archive"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div x-show="resource.detailsOpen" x-cloak
                                                class="resource-details p-6 pl-24 text-sm text-gray-700 bg-gray-50/50 border-t border-gray-200">
                                                <h4 class="font-semibold text-base mb-3">Waste Details:</h4>
                                                <div class="grid grid-cols-2 gap-2">
                                                    <div><strong class="text-gray-600">Reason:</strong> <span
                                                            x-text="resource.reason"></span></div>
                                                    <div><strong class="text-gray-600">Monthly Cost:</strong> $<span
                                                            x-text="resource.monthlySavings.toFixed(2)"></span></div>
                                                    <div><strong class="text-gray-600">Region:</strong> <span
                                                            x-text="resource.region"></span></div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <script>
                    function wasteManagement() {
                        return {
                            isLoading: true,
                            isRefreshing: false,
                            filter: 'All',
                            wastedResources: [],
                            selectedResources: [],
                            savingsChart: null,
                            selectedAccountId: null,
                            // FIX: Added persistent state for expanded groups
                            expandedGroups: [], 
                            
                            allPossibleCategories: [
                                'All', 'EBS Volume', 'Snapshot', 'AMI', 'Elastic IP',
                                'RDS Instance', 'Load Balancer', 'Security Group', 'EC2 Instance',
                                'ENI', 'EKS Cluster', 'ECS Cluster', 'Lambda', 'DB Snapshot', 'Log Group'
                            ],

                            init() {
                                // Logic to get account ID
                                const urlParams = new URLSearchParams(window.location.search);
                                this.selectedAccountId = urlParams.get('accountIds');

                                if (!this.selectedAccountId) {
                                    const storedIds = JSON.parse(sessionStorage.getItem('selectedAccountIds') || '[]');
                                    if (storedIds.length > 0) {
                                        this.selectedAccountId = storedIds.join(',');
                                    }
                                }

                                if (this.selectedAccountId) {
                                    this.loadWastedResources(false);
                                } else {
                                    this.isLoading = false;
                                }

                                this.$watch('filteredResources', () => {
                                    this.renderSavingsChart();
                                });
                            },

                            // FIX: Helper to toggle groups reliably
                            toggleGroup(serviceType) {
                                if (this.expandedGroups.includes(serviceType)) {
                                    this.expandedGroups = this.expandedGroups.filter(t => t !== serviceType);
                                } else {
                                    this.expandedGroups.push(serviceType);
                                }
                            },

                            loadWastedResources(forceRefresh = false) {
                                if (!this.selectedAccountId) return;
                                const cacheKey = `wasteData-${this.selectedAccountId}`;
                                const cachedData = sessionStorage.getItem(cacheKey);

                                if (cachedData && !forceRefresh) {
                                    this.wastedResources = JSON.parse(cachedData);
                                    this.isLoading = false;
                                    this.renderSavingsChart();
                                    return;
                                }

                                if (!cachedData) this.isLoading = true;
                                if (forceRefresh) {
                                    this.isRefreshing = true;
                                    sessionStorage.removeItem(cacheKey);
                                }

                                fetch(`/api/xamops/waste?accountIds=${this.selectedAccountId}&forceRefresh=${forceRefresh}`)
                                    .then(res => res.json())
                                    .then(data => {
                                        this.wastedResources = Array.isArray(data) ? data : [];
                                        sessionStorage.setItem(cacheKey, JSON.stringify(this.wastedResources));
                                        this.renderSavingsChart();
                                    })
                                    .catch(err => {
                                        console.error('Failed to load waste data', err);
                                        this.wastedResources = [];
                                    })
                                    .finally(() => {
                                        this.isLoading = false;
                                        this.isRefreshing = false;
                                    });
                            },

                            get filteredResources() {
                                if (!Array.isArray(this.wastedResources)) return [];
                                if (this.filter === 'All') return this.wastedResources;
                                return this.wastedResources.filter(r => r.resourceType === this.filter);
                            },

                            get potentialSavings() {
                                if (!Array.isArray(this.filteredResources)) return 0;
                                return this.filteredResources.reduce((sum, r) => sum + r.monthlySavings, 0);
                            },

                            get resourceCount() {
                                if (!Array.isArray(this.filteredResources)) return 0;
                                return this.filteredResources.length;
                            },

                            renderSavingsChart() {
                                const ctx = document.getElementById('savingsChart');
                                if (!ctx) return;
                                
                                if (!Array.isArray(this.filteredResources)) return;

                                const savingsByCategory = this.filteredResources.reduce((acc, resource) => {
                                    acc[resource.resourceType] = (acc[resource.resourceType] || 0) + resource.monthlySavings;
                                    return acc;
                                }, {});

                                const labels = Object.keys(savingsByCategory);
                                const data = Object.values(savingsByCategory);

                                if (this.savingsChart) this.savingsChart.destroy();

                                this.savingsChart = new Chart(ctx, {
                                    type: 'doughnut',
                                    data: {
                                        labels: labels,
                                        datasets: [{
                                            data: data,
                                            backgroundColor: [
                                                '#ef4444', '#f59e0b', '#10b981', '#3b82f6',
                                                '#6366f1', '#ec4899', '#8b5cf6', '#06b6d4'
                                            ],
                                            borderWidth: 0,
                                            hoverOffset: 6
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: {
                                                position: 'bottom',
                                                labels: { boxWidth: 12, font: { size: 11 }, usePointStyle: true, padding: 12 }
                                            },
                                            tooltip: {
                                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                                titleColor: 'white',
                                                bodyColor: 'white',
                                                borderColor: 'rgba(239, 68, 68, 0.8)',
                                                borderWidth: 1,
                                                cornerRadius: 8,
                                                callbacks: {
                                                    label: function (context) {
                                                        const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                                        const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                                        return `${context.label}: $${context.parsed.toFixed(2)} (${percentage}%)`;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                });
                            },

                            get groupedFilteredResources() {
                                if (!Array.isArray(this.wastedResources)) return [];
                                const groups = this.wastedResources.reduce((acc, res) => {
                                    const key = res.resourceType || 'Other';
                                    if (!acc[key]) {
                                        acc[key] = { 
                                            serviceType: key, 
                                            resources: [], 
                                            // FIX: Read from persistent state instead of always false
                                            open: this.expandedGroups.includes(key) 
                                        };
                                    }
                                    if (typeof res.detailsOpen === 'undefined') res.detailsOpen = false;
                                    acc[key].resources.push(res);
                                    return acc;
                                }, {});
                                return Object.values(groups).sort((a, b) => a.serviceType.localeCompare(b.serviceType));
                            },

                            getServiceIcon(serviceType) {
                                const iconMap = {
                                    'EC2 Instance': 'ec2-instances.png',
                                    'EBS Volume': 'aws-ebs.png',
                                    'RDS Instance': 'rds-instance.png',
                                    'Lambda': 'aws-lambda.png',
                                    'S3 Bucket': 's3-bucket.png',
                                    'Load Balancer': 'load-balancer.png',
                                    'Auto Scaling Group': 'autoscaling.png',
                                    'VPC': 'vpc.png',
                                    'Security Group': 'security-group.png',
                                    'Route 53 Zone': 'aws-route53.png',
                                    'ElastiCache Cluster': 'elasticache-cluster.png',
                                    'DynamoDB Table': 'dynamodb-table.png',
                                    'ECR Repository': 'ecr-repository.png',
                                    'CloudTrail': 'cloudtrail.png',
                                    'Certificate Manager': 'certificate-manager.png',
                                    'CloudWatch Log Group': 'cloudwatch-log-group.png',
                                    'SNS Topic': 'sns-topic.png',
                                    'SQS Queue': 'sqs-queue.png',
                                    'Elastic IP': 'elastic-ip.png',
                                    'Snapshot': 'snapshot.png',
                                    'AMI': 'ami.png',
                                    'ENI': 'eni.png',
                                    'EKS Cluster': 'aws-eks.png',
                                    'ECS Cluster': 'aws-ecs.png',
                                    'DB Snapshot': 'rds-instance.png',
                                    'Log Group': 'cloudwatch-log-group.png'
                                };
                                return iconMap[serviceType] || 'default-icon.png';
                            }
                        };
                    }
                </script>
            </main>
        </div>
    </div>
</body>

</html>