<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XamOps - EKS Cluster Details</title>
  <link rel="icon" href="/icons/XamOps.png" sizes="32x32" type="image/png" />
  <link rel="apple-touch-icon" href="/icons/XamOps.png" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module" src="/src/main.js"></script>
</head>

<body class="bg-gray-100">
  <div class="flex">
    <include file="/_sidebar.html"></include>

    <div class="flex-1 pl-64">
      <div id="main-content" class="flex-1 p-8" x-data="eksDetails()" x-init="init()">

        <style>
          @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap");

          [x-cloak] {
            display: none !important;
          }

          .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: saturate(180%) blur(12px);
            border-radius: 1rem;
            box-shadow: 0 6px 18px rgb(0 0 0 / 0.06);
            border: 1px solid rgba(0, 0, 0, 0.08);
            padding: 1.75rem;
          }

          .data-table {
            width: 100%;
            border-collapse: collapse;
          }

          .data-table th,
          .data-table td {
            border: 1px solid #e2e8f0;
            padding: 12px 16px;
            text-align: left;
            font-size: 0.875rem;
          }

          .data-table th {
            background-color: #f8fafc;
            font-weight: 600;
            color: #4a5568;
          }

          .data-table tbody tr:nth-child(even) {
            background-color: #fdfdfe;
          }
        </style>

        <header class="flex items-center justify-between mb-8">
          <div>
            <h1 class="text-3xl font-extrabold text-gray-800" x-text="clusterName" aria-live="polite">
              EKS Cluster Details
            </h1>
            <p class="text-gray-500 mt-1">Details for your EKS cluster</p>
          </div>
          <a :href="`/cloudk8s.html?accountIds=${selectedAccountId}`"
            class="nav-item text-indigo-600 font-semibold hover:text-indigo-800 flex items-center gap-2">
            <i class="fas fa-arrow-left"></i> Back to Clusters
          </a>
        </header>

        <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" aria-label="Cluster key details">
          <div class="glass-card">
            <h3 class="font-semibold text-gray-600">Status</h3>
            <p class="text-2xl font-extrabold text-green-600" x-text="cluster.status || '...'">
              ...
            </p>
          </div>
          <div class="glass-card">
            <h3 class="font-semibold text-gray-600">Kubernetes Version</h3>
            <p class="text-2xl font-extrabold text-gray-800" x-text="cluster.version || '...'">
              ...
            </p>
          </div>
          <div class="glass-card">
            <h3 class="font-semibold text-gray-600">Region</h3>
            <p class="text-2xl font-extrabold text-gray-800" x-text="cluster.region || '...'">
              ...
            </p>
          </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8"
          x-show="!isLoading && !errorMessage && nodes.length > 0">
          <div class="glass-card">
            <h3 class="font-semibold text-gray-600 mb-4">
              Node CPU Utilization (%)
            </h3>
            <div style="height: 300px">
              <canvas id="nodeCpuChart"></canvas>
            </div>
          </div>
          <div class="glass-card">
            <h3 class="font-semibold text-gray-600 mb-4">
              Node Memory Utilization (%)
            </h3>
            <div style="height: 300px">
              <canvas id="nodeMemoryChart"></canvas>
            </div>
          </div>
        </section>

        <section class="glass-card !p-0">
          <nav class="flex space-x-4 border-b border-gray-300 px-7">
            <button @click="activeTab = 'nodes'"
              :class="{'border-indigo-600 text-indigo-600 border-b-2': activeTab === 'nodes'}"
              class="py-4 px-1 font-semibold text-gray-500 hover:text-indigo-600 focus:outline-none" role="tab"
              :aria-selected="activeTab === 'nodes'" aria-controls="nodes-panel" id="nodes-tab">
              Nodes
            </button>
            <button @click="activeTab = 'pods'"
              :class="{'border-indigo-600 text-indigo-600 border-b-2': activeTab === 'pods'}"
              class="py-4 px-1 font-semibold text-gray-500 hover:text-indigo-600 focus:outline-none" role="tab"
              :aria-selected="activeTab === 'pods'" aria-controls="pods-panel" id="pods-tab">
              Pods
            </button>
            <button @click="activeTab = 'deployments'"
              :class="{'border-indigo-600 text-indigo-600 border-b-2': activeTab === 'deployments'}"
              class="py-4 px-1 font-semibold text-gray-500 hover:text-indigo-600 focus:outline-none" role="tab"
              :aria-selected="activeTab === 'deployments'" aria-controls="deployments-panel" id="deployments-tab">
              Deployments
            </button>
            <button @click="activeTab = 'security'"
              :class="{'border-indigo-600 text-indigo-600 border-b-2': activeTab === 'security'}"
              class="py-4 px-1 font-semibold text-gray-500 hover:text-indigo-600 focus:outline-none" role="tab"
              id="security-tab">
              Security (Falco)
            </button>
            <!-- ðŸ†• NEW: Kubescape Tab -->
            <button @click="activeTab = 'kubescape'; loadKubescapeData()"
              :class="{'border-indigo-600 text-indigo-600 border-b-2': activeTab === 'kubescape'}"
              class="py-4 px-1 font-semibold text-gray-500 hover:text-indigo-600 focus:outline-none" role="tab">
              <i class="fas fa-shield-alt"></i> Security (Kubescape)
            </button>

            <!-- ðŸ†• NEW: Karpenter Tab -->
            <button @click="activeTab = 'karpenter'; loadKarpenterData()"
              :class="{'border-indigo-600 text-indigo-600 border-b-2': activeTab === 'karpenter'}"
              class="py-4 px-1 font-semibold text-gray-500 hover:text-indigo-600 focus:outline-none" role="tab">
              <i class="fas fa-layer-group"></i> Autoscaling (Karpenter)
            </button>
          </nav>

          <div class="p-7">
            <div x-show="isLoading" class="text-center py-12 text-gray-600">
              <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
              <p>Loading data...</p>
            </div>

            <div x-show="errorMessage" x-cloak class="text-center py-12 text-red-600">
              <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
              <p x-text="errorMessage"></p>
            </div>

            <div x-show="!isLoading && !errorMessage" x-cloak>
              <div x-show="activeTab === 'nodes'" id="nodes-panel" role="tabpanel" aria-labelledby="nodes-tab">
                <template x-if="nodes.length > 0">
                  <table class="data-table">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Instance Type</th>
                        <th>Zone</th>
                        <th>K8s Version</th>
                        <th>Age</th>
                        <th>CPU</th>
                        <th>Memory</th>
                      </tr>
                    </thead>
                    <tbody>
                      <template x-for="node in nodes" :key="node.name">
                        <tr>
                          <td x-text="node.name"></td>
                          <td x-text="node.status"></td>
                          <td x-text="node.instanceType || 'N/A'"></td>
                          <td x-text="node.availabilityZone || 'N/A'"></td>
                          <td x-text="node.k8sVersion || 'N/A'"></td>
                          <td x-text="node.age || 'N/A'"></td>
                          <td x-text="node.cpuUsage || 'N/A'"></td>
                          <td x-text="node.memUsage || 'N/A'"></td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </template>
                <template x-if="nodes.length === 0">
                  <p class="text-gray-700">No nodes found for this cluster.</p>
                </template>
              </div>

              <div x-show="activeTab === 'pods'" id="pods-panel" role="tabpanel" aria-labelledby="pods-tab">
                <template x-if="pods.length > 0">
                  <table class="data-table">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Restarts</th>
                        <th>Age</th>
                        <th>Node</th>
                      </tr>
                    </thead>
                    <tbody>
                      <template x-for="pod in pods" :key="pod.name">
                        <tr>
                          <td x-text="pod.name"></td>
                          <td x-text="pod.status"></td>
                          <td x-text="pod.restarts"></td>
                          <td x-text="pod.age || 'N/A'"></td>
                          <td x-text="pod.nodeName || 'N/A'"></td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </template>
                <template x-if="!isLoading && pods.length === 0">
                  <p class="text-gray-700">No pods found for this cluster.</p>
                </template>
              </div>

              <div x-show="activeTab === 'deployments'" id="deployments-panel" role="tabpanel"
                aria-labelledby="deployments-tab">
                <template x-if="deployments.length > 0">
                  <table class="data-table">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Ready</th>
                        <th>Up-to-date</th>
                        <th>Available</th>
                        <th>Age</th>
                      </tr>
                    </thead>
                    <tbody>
                      <template x-for="dep in deployments" :key="dep.name">
                        <tr>
                          <td x-text="dep.name"></td>
                          <td x-text="dep.ready"></td>
                          <td x-text="dep.upToDate"></td>
                          <td x-text="dep.available"></td>
                          <td x-text="dep.age || 'N/A'"></td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </template>
                <template x-if="!isLoading && deployments.length === 0">
                  <p class="text-gray-700">
                    No deployments found for this cluster.
                  </p>
                </template>
              </div>



              <!-- ðŸ†• NEW: Kubescape Panel -->
              <div x-show="activeTab === 'kubescape'" id="kubescape-panel" role="tabpanel">
                <div x-show="kubescapeLoading" class="text-center py-12">
                  <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                  <p>Loading Kubescape data...</p>
                </div>

                <div x-show="!kubescapeLoading && kubescapeData" x-cloak>
                  <!-- Compliance Score Card -->
                  <div class="glass-card mb-6 text-center">
                    <h3 class="text-gray-600 font-semibold mb-2">Overall Compliance Score</h3>
                    <div class="text-5xl font-extrabold" :class="{
             'text-green-600': kubescapeData.overallComplianceScore >= 80,
             'text-yellow-600': kubescapeData.overallComplianceScore >= 60 && kubescapeData.overallComplianceScore < 80,
             'text-red-600': kubescapeData.overallComplianceScore < 60
           }" x-text="kubescapeData.overallComplianceScore ? kubescapeData.overallComplianceScore.toFixed(1) + '%' : 'N/A'">
                    </div>
                    <p class="text-sm text-gray-500 mt-2"
                      x-text="'Last scan: ' + (kubescapeData.lastScanTime || 'Unknown')"></p>
                  </div>

                  <!-- Vulnerability Summary Cards -->
                  <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="glass-card text-center">
                      <i class="fas fa-exclamation-circle text-red-600 text-3xl mb-2"></i>
                      <h4 class="text-gray-600 font-semibold">Critical</h4>
                      <p class="text-3xl font-bold text-red-600" x-text="kubescapeData.totalCritical || 0"></p>
                    </div>
                    <div class="glass-card text-center">
                      <i class="fas fa-exclamation-triangle text-orange-600 text-3xl mb-2"></i>
                      <h4 class="text-gray-600 font-semibold">High</h4>
                      <p class="text-3xl font-bold text-orange-600" x-text="kubescapeData.totalHigh || 0"></p>
                    </div>
                    <div class="glass-card text-center">
                      <i class="fas fa-exclamation text-yellow-600 text-3xl mb-2"></i>
                      <h4 class="text-gray-600 font-semibold">Medium</h4>
                      <p class="text-3xl font-bold text-yellow-600" x-text="kubescapeData.totalMedium || 0"></p>
                    </div>
                    <div class="glass-card text-center">
                      <i class="fas fa-info-circle text-blue-600 text-3xl mb-2"></i>
                      <h4 class="text-gray-600 font-semibold">Low</h4>
                      <p class="text-3xl font-bold text-blue-600" x-text="kubescapeData.totalLow || 0"></p>
                    </div>
                  </div>

                  <!-- Vulnerabilities Table -->
                  <div class="glass-card">
                    <h3 class="text-lg font-semibold mb-4">Workload Vulnerabilities</h3>
                    <template x-if="kubescapeData.vulnerabilities && kubescapeData.vulnerabilities.length > 0">
                      <table class="data-table">
                        <thead>
                          <tr>
                            <th>Workload Name</th>
                            <th>Namespace</th>
                            <th>Type</th>
                            <th class="text-center">Critical</th>
                            <th class="text-center">High</th>
                            <th class="text-center">Medium</th>
                            <th class="text-center">Low</th>
                          </tr>
                        </thead>
                        <tbody>
                          <template x-for="vuln in kubescapeData.vulnerabilities" :key="vuln.workloadName">
                            <tr>
                              <td x-text="vuln.workloadName"></td>
                              <td x-text="vuln.namespace"></td>
                              <td x-text="vuln.workloadKind"></td>
                              <td class="text-center text-red-600 font-semibold" x-text="vuln.criticalCount"></td>
                              <td class="text-center text-orange-600 font-semibold" x-text="vuln.highCount"></td>
                              <td class="text-center text-yellow-600 font-semibold" x-text="vuln.mediumCount"></td>
                              <td class="text-center text-blue-600 font-semibold" x-text="vuln.lowCount"></td>
                            </tr>
                          </template>
                        </tbody>
                      </table>
                    </template>
                    <template x-if="!kubescapeData.vulnerabilities || kubescapeData.vulnerabilities.length === 0">
                      <p class="text-gray-600 text-center py-8">âœ… No vulnerabilities found - excellent security posture!
                      </p>
                    </template>
                  </div>
                </div>
              </div>

              <!-- ðŸ†• NEW: Karpenter Panel -->
              <div x-show="activeTab === 'karpenter'" id="karpenter-panel" role="tabpanel">
                <div x-show="karpenterLoading" class="text-center py-12">
                  <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                  <p>Loading Karpenter data...</p>
                </div>

                <div x-show="!karpenterLoading && karpenterData" x-cloak>
                  <!-- Node Lifecycle Summary -->
                  <div class="grid grid-cols-3 gap-4 mb-6">

                  </div>

                  <!-- Resource Utilization -->
                  <!-- <div class="grid grid-cols-2 gap-6 mb-6">
                    <div class="glass-card">
                      <h4 class="font-semibold mb-3"><i class="fas fa-microchip"></i> CPU Utilization</h4>
                      <div class="mb-2 text-sm text-gray-600">
                        <span>Allocatable: <span
                            x-text="karpenterData.metrics?.cpuAllocatable?.toFixed(1) || '0'"></span> cores</span>
                        <span class="float-right">Limit: <span
                            x-text="karpenterData.metrics?.cpuLimit?.toFixed(1) || '0'"></span> cores</span>
                      </div>
                      <div class="w-full bg-gray-200 rounded-full h-8">
                        <div
                          class="bg-green-600 h-8 rounded-full flex items-center justify-center text-white text-sm font-semibold"
                          :style="`width: ${karpenterData.metrics?.cpuLimit > 0 ? (karpenterData.metrics?.cpuAllocatable / karpenterData.metrics?.cpuLimit * 100) : 0}%`"
                          x-text="karpenterData.metrics?.cpuLimit > 0 ? ((karpenterData.metrics?.cpuAllocatable / karpenterData.metrics?.cpuLimit * 100).toFixed(1) + '%') : '0%'">
                        </div>
                      </div>
                    </div>

                    <div class="glass-card">
                      <h4 class="font-semibold mb-3"><i class="fas fa-memory"></i> Memory Utilization</h4>
                      <div class="mb-2 text-sm text-gray-600">
                        <span>Allocatable: <span
                            x-text="karpenterData.metrics?.memoryAllocatableGb?.toFixed(1) || '0'"></span> GB</span>
                        <span class="float-right">Limit: <span
                            x-text="karpenterData.metrics?.memoryLimitGb?.toFixed(1) || '0'"></span> GB</span>
                      </div>
                      <div class="w-full bg-gray-200 rounded-full h-8">
                        <div
                          class="bg-blue-600 h-8 rounded-full flex items-center justify-center text-white text-sm font-semibold"
                          :style="`width: ${karpenterData.metrics?.memoryLimitGb > 0 ? (karpenterData.metrics?.memoryAllocatableGb / karpenterData.metrics?.memoryLimitGb * 100) : 0}%`"
                          x-text="karpenterData.metrics?.memoryLimitGb > 0 ? ((karpenterData.metrics?.memoryAllocatableGb / karpenterData.metrics?.memoryLimitGb * 100).toFixed(1) + '%') : '0%'">
                        </div>
                      </div>
                    </div>
                  </div> -->

                  <!-- Node Pools Table -->
                  <div class="glass-card mb-6">
                    <h3 class="text-lg font-semibold mb-4">Node Pools</h3>
                    <template x-if="karpenterData.nodePools && karpenterData.nodePools.length > 0">
                      <table class="data-table">
                        <thead>
                          <tr>
                            <th>Pool Name</th>
                            <th>Instance Types</th>
                            <th>CPU Limit</th>
                            <th>Memory Limit</th>
                            <th>Consolidation</th>
                          </tr>
                        </thead>
                        <tbody>
                          <template x-for="pool in karpenterData.nodePools" :key="pool.poolName">
                            <tr>
                              <td x-text="pool.poolName"></td>
                              <td x-text="pool.instanceTypes ? pool.instanceTypes.join(', ') : 'N/A'"></td>
                              <td x-text="(pool.cpuLimit || 0) + ' cores'"></td>
                              <td x-text="(pool.memoryLimitGb || 0) + ' GB'"></td>
                              <td>
                                <span :class="pool.consolidationEnabled ? 'text-green-600' : 'text-gray-400'"
                                  class="font-semibold">
                                  <i
                                    :class="pool.consolidationEnabled ? 'fas fa-check-circle' : 'fas fa-times-circle'"></i>
                                  <span x-text="pool.consolidationEnabled ? 'Enabled' : 'Disabled'"></span>
                                </span>
                              </td>
                            </tr>
                          </template>
                        </tbody>
                      </table>
                    </template>
                    <template x-if="!karpenterData.nodePools || karpenterData.nodePools.length === 0">
                      <p class="text-gray-600 text-center py-8">No node pools configured</p>
                    </template>
                  </div>

                  Node Claims Table
                  <div class="glass-card">
                    <h3 class="text-lg font-semibold mb-4">Managed Nodes</h3>
                    <template x-if="karpenterData.nodeClaims && karpenterData.nodeClaims.length > 0">
                      <table class="data-table">
                        <thead>
                          <tr>
                            <th>Node Name</th>
                            <th>Pool</th>
                            <th>Instance Type</th>
                            <th>Zone</th>
                            <th>Phase</th>
                            <th>Age</th>
                          </tr>
                        </thead>
                        <tbody>
                          <template x-for="claim in karpenterData.nodeClaims" :key="claim.nodeName">
                            <tr>
                              <td x-text="claim.nodeName"></td>
                              <td x-text="claim.nodePoolName"></td>
                              <td x-text="claim.instanceType"></td>
                              <td x-text="claim.zone"></td>
                              <td>
                                <span class="px-2 py-1 rounded text-xs font-semibold bg-blue-100 text-blue-800"
                                  x-text="claim.phase"></span>
                              </td>
                              <td x-text="claim.age"></td>
                            </tr>
                          </template>
                        </tbody>
                      </table>
                    </template>
                    <template x-if="!karpenterData.nodeClaims || karpenterData.nodeClaims.length === 0">
                      <p class="text-gray-600 text-center py-8">No Karpenter-managed nodes found</p>
                    </template>
                  </div>
                </div>
              </div>

              <div x-show="activeTab === 'security'" id="security-panel" role="tabpanel" aria-labelledby="security-tab">
                <template x-if="alerts.length > 0">
                  <table class="data-table">
                    <thead>
                      <tr>
                        <th>Severity</th>
                        <th>Rule Name</th>
                        <th>Pod</th>
                        <th>Namespace</th>
                      </tr>
                    </thead>
                    <tbody>
                      <template x-for="(alert, i) in alerts" :key="i">
                        <tr>
                          <td>
                            <span x-text="alert.priority" class="px-2 py-1 rounded text-xs text-white font-bold" :class="{
                                                                    'bg-red-600': ['Critical', 'Emergency'].includes(alert.priority),
                                                                    'bg-orange-500': alert.priority === 'Error',
                                                                    'bg-yellow-500': alert.priority === 'Warning',
                                                                    'bg-blue-400': !['Critical', 'Emergency', 'Error', 'Warning'].includes(alert.priority)
                                                                  }">
                            </span>
                          </td>
                          <td x-text="alert.rule"></td>
                          <td x-text="alert.pod || 'N/A'"></td>
                          <td x-text="alert.namespace || 'N/A'"></td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </template>
                <template x-if="!isLoading && alerts.length === 0">
                  <div class="p-6 text-center text-gray-500">
                    <i class="fas fa-shield-alt text-green-500 text-2xl mb-2"></i>
                    <p class="mt-2">
                      No active security alerts found. System is secure.
                    </p>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </section>

        <script>
          function eksDetails() {
            return {
              isLoading: true,
              clusterName: "",
              cluster: {},
              activeTab: "nodes",
              selectedAccountId: null,

              nodes: [],
              pods: [],
              deployments: [],

              // ðŸ†• NEW: Kubescape properties
              kubescapeLoading: false,
              kubescapeData: null,

              // ðŸ†• NEW: Karpenter properties
              karpenterLoading: false,
              karpenterData: null,

              alerts: [],
              errorMessage: null,

              cpuChart: null,
              memoryChart: null,

              init() {
                const urlParams = new URLSearchParams(window.location.search);
                this.clusterName = urlParams.get("name");

                const storedIds = JSON.parse(
                  sessionStorage.getItem("selectedAccountIds") || "[]"
                );
                if (storedIds.length > 0) this.selectedAccountId = storedIds[0];

                this.fetchDetails();
              },

              // ðŸ†• NEW: Load Kubescape Data
              async loadKubescapeData() {
                if (this.kubescapeData) return; // Already loaded

                this.kubescapeLoading = true;
                try {
                  const response = await fetch(
                    `/api/xamops/k8s/security/kubescape?accountId=${this.selectedAccountId}&clusterName=${this.clusterName}`
                  );

                  if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                  }

                  this.kubescapeData = await response.json();
                  console.log('Kubescape data loaded:', this.kubescapeData);

                } catch (error) {
                  console.error('Failed to load Kubescape data:', error);
                  this.kubescapeData = {
                    overallComplianceScore: 0,
                    vulnerabilities: [],
                    totalCritical: 0,
                    totalHigh: 0,
                    totalMedium: 0,
                    totalLow: 0,
                    lastScanTime: 'Error loading data'
                  };
                } finally {
                  this.kubescapeLoading = false;
                }
              },

              // ðŸ†• NEW: Load Karpenter Data
              async loadKarpenterData() {
                if (this.karpenterData) return; // Already loaded

                this.karpenterLoading = true;
                try {
                  const response = await fetch(
                    `/api/xamops/k8s/security/karpenter?accountId=${this.selectedAccountId}&clusterName=${this.clusterName}`
                  );

                  if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                  }

                  this.karpenterData = await response.json();
                  console.log('Karpenter data loaded:', this.karpenterData);

                } catch (error) {
                  console.error('Failed to load Karpenter data:', error);
                  this.karpenterData = {
                    metrics: {},
                    nodePools: [],
                    nodeClaims: [],
                    totalNodesCreated24h: 0,
                    totalNodesTerminated24h: 0
                  };
                } finally {
                  this.karpenterLoading = false;
                }
              },

              async fetchDetails() {
                this.isLoading = true;
                this.errorMessage = null;

                if (!this.selectedAccountId || !this.clusterName) {
                  this.errorMessage = "Error: Account ID or Cluster Name is missing.";
                  this.isLoading = false;
                  return;
                }

                try {
                  // 1. Fetch Cluster Details
                  const detailsUrl = `/api/xamops/k8s/${this.clusterName}/details?accountId=${this.selectedAccountId}`;
                  const clusterRes = await fetch(detailsUrl);
                  if (clusterRes.ok) this.cluster = await clusterRes.json();

                  // 2. Fetch Metrics
                  const query = `?accountId=${this.selectedAccountId}&region=${this.cluster.region}`;
                  const baseUrl = `/api/xamops/eks/${this.clusterName}`;

                  const [nodesRes, podsRes, deploymentsRes, alertsRes] = await Promise.all([
                    fetch(`${baseUrl}/nodes${query}`),
                    fetch(`${baseUrl}/pods${query}`),
                    fetch(`${baseUrl}/deployments${query}`),
                    fetch(`${baseUrl}/security${query}`),
                  ]);

                  if (!nodesRes.ok) throw new Error(`Failed to fetch nodes`);

                  this.nodes = await nodesRes.json();
                  this.pods = podsRes.ok ? await podsRes.json() : [];
                  this.deployments = deploymentsRes.ok ? await deploymentsRes.json() : [];
                  this.alerts = alertsRes.ok ? await alertsRes.json() : [];

                } catch (err) {
                  console.error("Error fetching details:", err);
                  this.errorMessage = `Failed to load data: ${err.message}`;
                } finally {
                  this.isLoading = false;
                  this.$nextTick(() => {
                    this.initCharts();
                  });
                }
              },

              initCharts() {
                if (!this.nodes || this.nodes.length === 0) {
                  console.warn("No nodes available to chart.");
                  return;
                }

                const labels = this.nodes.map((n) => {
                  const name = n.name || "Unknown";
                  return name.replace(".compute.internal", "").replace(".ap-south-1", "");
                });

                const parsePercent = (val) => {
                  if (val === null || val === undefined) return 0;
                  return parseFloat(String(val).replace("%", "").trim()) || 0;
                };

                const cpuData = this.nodes.map((n) => parsePercent(n.cpuUsage));
                const memoryData = this.nodes.map((n) => parsePercent(n.memUsage));

                // âœ… MODERNIZED: Create animated gradient backgrounds
                const createAnimatedGradient = (ctx, color1, color2) => {
                  const gradient = ctx.createLinearGradient(0, 0, 400, 0);
                  gradient.addColorStop(0, color1);
                  gradient.addColorStop(1, color2);
                  return gradient;
                };

                const cpuCanvas = document.getElementById("nodeCpuChart");
                if (cpuCanvas) {
                  const ctx = cpuCanvas.getContext("2d");
                  if (this.cpuChart) this.cpuChart.destroy();

                  this.cpuChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                      labels: labels,
                      datasets: [{
                        label: "CPU Usage (%)",
                        data: cpuData,
                        backgroundColor: createAnimatedGradient(ctx,
                          "rgba(99, 102, 241, 0.8)",
                          "rgba(124, 58, 237, 0.9)"
                        ),
                        borderColor: "rgba(99, 102, 241, 1)",
                        borderWidth: 2,
                        borderRadius: 8,
                        barPercentage: 0.7,
                        hoverBackgroundColor: createAnimatedGradient(ctx,
                          "rgba(99, 102, 241, 1)",
                          "rgba(124, 58, 237, 1)"
                        ),
                      }],
                    },
                    options: this.getModernChartOptions("CPU", cpuData),
                  });
                }

                const memCanvas = document.getElementById("nodeMemoryChart");
                if (memCanvas) {
                  const ctx = memCanvas.getContext("2d");
                  if (this.memoryChart) this.memoryChart.destroy();

                  this.memoryChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                      labels: labels,
                      datasets: [{
                        label: "Memory Usage (%)",
                        data: memoryData,
                        backgroundColor: createAnimatedGradient(ctx,
                          "rgba(16, 185, 129, 0.8)",
                          "rgba(5, 150, 105, 0.9)"
                        ),
                        borderColor: "rgba(16, 185, 129, 1)",
                        borderWidth: 2,
                        borderRadius: 8,
                        barPercentage: 0.7,
                        hoverBackgroundColor: createAnimatedGradient(ctx,
                          "rgba(16, 185, 129, 1)",
                          "rgba(5, 150, 105, 1)"
                        ),
                      }],
                    },
                    options: this.getModernChartOptions("Memory", memoryData),
                  });
                }
              },

              getModernChartOptions(type, data) {
                const maxValue = Math.max(...data, 100);

                return {
                  indexAxis: "y",
                  responsive: true,
                  maintainAspectRatio: false,
                  animation: {
                    duration: 1000,
                    easing: 'easeInOutQuart',
                    onComplete: function (animation) {
                      animation.chart.options.plugins.legend.display = false;
                    }
                  },
                  plugins: {
                    legend: {
                      display: false
                    },
                    tooltip: {
                      enabled: true,
                      backgroundColor: "rgba(17, 24, 39, 0.95)",
                      titleColor: "#fff",
                      bodyColor: "#e5e7eb",
                      padding: 16,
                      cornerRadius: 12,
                      displayColors: false,
                      titleFont: {
                        size: 13,
                        weight: '600',
                        family: "'Inter', sans-serif"
                      },
                      bodyFont: {
                        size: 15,
                        weight: '700',
                        family: "'Inter', sans-serif"
                      },
                      callbacks: {
                        title: function (context) {
                          return context[0].label;
                        },
                        label: function (context) {
                          return `${type}: ${context.parsed.x.toFixed(2)}%`;
                        },
                      },
                      boxShadow: '0 10px 40px rgba(0, 0, 0, 0.3)',
                    },
                  },
                  interaction: {
                    mode: 'nearest',
                    intersect: false,
                  },
                  scales: {
                    x: {
                      beginAtZero: true,
                      max: 100,
                      grid: {
                        color: "rgba(0, 0, 0, 0.04)",
                        drawBorder: false,
                        lineWidth: 1,
                      },
                      ticks: {
                        callback: (v) => v + "%",
                        color: "#6b7280",
                        font: {
                          size: 11,
                          family: "'Inter', sans-serif"
                        }
                      },
                      border: {
                        display: false
                      }
                    },
                    y: {
                      grid: {
                        display: false,
                        drawBorder: false
                      },
                      ticks: {
                        color: "#374151",
                        font: {
                          size: 12,
                          weight: '500',
                          family: "'Inter', sans-serif"
                        },
                        padding: 8
                      },
                      border: {
                        display: false
                      }
                    },
                  },
                };
              }
            };
          }
        </script>
      </div>
    </div>
  </div>
</body>

</html>