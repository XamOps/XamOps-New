<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XamOps - CICD Pipelines</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="/icons/XamOps.png" sizes="32x32" type="image/png">
    <link rel="apple-touch-icon" href="/icons/XamOps.png">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js"></script>
    <script type="module" src="/src/main.js"></script>
</head>

<body class="bg-gray-50">
    <div class="flex h-screen overflow-hidden">
        <include file="/_sidebar.html"></include>

        <div class="flex-1 flex flex-col overflow-hidden pl-64">
            <main id="main-content" class="flex-1 overflow-y-auto p-8" x-data="cicdPipelines()">

                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

                    [x-cloak] {
                        display: none !important;
                    }

                    /* Status Text Colors */
                    .status-success {
                        color: #16a34a;
                    }

                    .status-failure {
                        color: #dc2626;
                    }

                    .status-running {
                        color: #2563eb;
                    }

                    .status-cancelled {
                        color: #6b7280;
                    }

                    .status-unknown {
                        color: #f59e0b;
                    }

                    /* Card Borders */
                    .border-success {
                        border-left-color: #16a34a;
                    }

                    .border-failure {
                        border-left-color: #dc2626;
                    }

                    .border-running {
                        border-left-color: #2563eb;
                    }

                    .border-cancelled {
                        border-left-color: #6b7280;
                    }

                    .border-unknown {
                        border-left-color: #f59e0b;
                    }

                    /* Tabs */
                    .tab-button {
                        padding: 0.75rem 1.5rem;
                        border-bottom: 3px solid transparent;
                        transition: all 0.2s ease-in-out;
                        font-weight: 600;
                        color: #4b5563;
                    }

                    .tab-button:hover {
                        color: #1f2937;
                    }

                    .tab-button.active {
                        color: #4f46e5;
                        border-bottom-color: #4f46e5;
                    }

                    /* History List */
                    .history-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 0.75rem 1rem;
                        border-bottom: 1px solid #e5e7eb;
                        cursor: pointer;
                        transition: background-color 0.15s;
                    }

                    .history-item:last-child {
                        border-bottom: none;
                    }

                    .history-item:hover {
                        background-color: #f9fafb;
                    }

                    .history-item.active-run {
                        background-color: #eff6ff;
                        border-left: 3px solid #3b82f6;
                    }

                    /* === Pipeline Visual Styles === */
                    .pipeline-container {
                        display: flex;
                        align-items: center;
                        overflow-x: auto;
                        padding: 20px 10px;
                        margin-bottom: 20px;
                        scrollbar-width: thin;
                    }

                    .pipeline-stage {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        position: relative;
                        min-width: 120px;
                        z-index: 1;
                        flex-shrink: 0;
                    }

                    .stage-node {
                        width: 32px;
                        height: 32px;
                        border-radius: 50%;
                        border: 3px solid #e5e7eb;
                        background: white;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.3s ease;
                        font-size: 14px;
                        z-index: 10;
                    }

                    /* Connector Lines */
                    .pipeline-stage:not(:last-child)::after {
                        content: '';
                        position: absolute;
                        top: 16px;
                        left: 50%;
                        width: 100%;
                        height: 3px;
                        background: #e5e7eb;
                        z-index: 0;
                    }

                    .pipeline-stage.completed:not(:last-child)::after {
                        background: #16a34a;
                    }

                    /* Node States */
                    .stage-success .stage-node {
                        border-color: #16a34a;
                        background: #16a34a;
                        color: white;
                        box-shadow: 0 2px 4px rgba(22, 163, 74, 0.2);
                    }

                    .stage-failure .stage-node {
                        border-color: #dc2626;
                        background: #dc2626;
                        color: white;
                        box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
                    }

                    .stage-running .stage-node {
                        border-color: #2563eb;
                        border-top-color: transparent;
                        color: #2563eb;
                        animation: spin 1s linear infinite;
                    }

                    .stage-skipped .stage-node {
                        border-color: #9ca3af;
                        background: #f3f4f6;
                        color: #9ca3af;
                    }

                    .stage-pending .stage-node {
                        border-color: #d1d5db;
                        border-style: dashed;
                        background: #ffffff;
                        color: #d1d5db;
                    }

                    @keyframes spin {
                        0% {
                            transform: rotate(0deg);
                        }

                        100% {
                            transform: rotate(360deg);
                        }
                    }
                </style>

                <header class="mb-8">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div
                                class="w-12 h-12 bg-gradient-to-br from-blue-500 to-sky-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-cogs text-white text-2xl"></i>
                            </div>
                            <div>
                                <h1 class="text-2xl font-bold text-gray-800">CICD Pipelines</h1>
                                <p class="text-sm text-gray-600">Status of GitHub Actions and Jenkins</p>
                            </div>
                        </div>
                        <button @click="refreshData()"
                            class="flex items-center space-x-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors shadow-md">
                            <i class="fas fa-sync-alt" :class="{ 'fa-spin': isLoadingGithub || isLoadingJenkins }"></i>
                            <span>Refresh All</span>
                        </button>
                    </div>
                </header>

                <div class="mb-6 border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button @click="activeTab = 'github'" :class="{ 'active': activeTab === 'github' }"
                            class="tab-button">
                            <i class="fab fa-github mr-2"></i> GitHub Actions
                        </button>
                        <button @click="activeTab = 'jenkins'" :class="{ 'active': activeTab === 'jenkins' }"
                            class="tab-button">
                            <i class="fab fa-jenkins mr-2"></i> Jenkins
                        </button>
                    </nav>
                </div>

                <div x-show="activeTab === 'github'">
                    <div x-show="isLoadingGithub" class="text-center py-10">
                        <i class="fas fa-spinner fa-spin text-3xl text-indigo-600"></i>
                        <p class="mt-2 text-gray-500">Loading GitHub Actions data...</p>
                    </div>

                    <div x-show="!isLoadingGithub">
                        <template x-if="githubRuns.length === 0">
                            <div class="text-center py-10 bg-white rounded-lg shadow">
                                <i class="fas fa-info-circle text-2xl text-gray-400 mb-2"></i>
                                <p class="text-gray-500">No GitHub Actions runs found.</p>
                                <p class="text-sm text-gray-400 mt-2">Have you connected a repository in the Account
                                    Manager?</p>
                            </div>
                        </template>

                        <template x-if="githubRuns.length > 0">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <template x-for="run in githubRuns" :key="run.id">
                                    <div class="bg-white p-4 rounded-lg shadow border-l-4 cursor-pointer transition-all hover:shadow-lg hover:scale-105"
                                        :class="getRunBorderColor(run.displayStatus)" @click="viewWorkflowHistory(run)">

                                        <div class="flex justify-between items-center mb-2">
                                            <span
                                                class="text-xs font-semibold bg-gray-100 text-gray-700 px-2 py-0.5 rounded"
                                                x-text="run.repository ? run.repository.full_name : 'Unknown Repo'"></span>
                                            <a :href="run.html_url" target="_blank" @click.stop
                                                class="text-xs text-indigo-500 hover:text-indigo-700 font-medium">
                                                View Run <i class="fas fa-external-link-alt ml-1"></i>
                                            </a>
                                        </div>
                                        <p class="font-semibold text-gray-900" x-text="run.name"></p>
                                        <p class="text-sm mt-2">
                                            Status: <span class="font-bold"
                                                :class="getRunStatusColor(run.displayStatus)"
                                                x-text="run.displayStatus"></span>
                                        </p>
                                        <p class="text-xs text-gray-500 mt-1"
                                            x-text="'Last updated: ' + formatTime(run.updated_at)"></p>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>

                <div x-show="activeTab === 'jenkins'">
                    <div x-show="isLoadingJenkins" class="text-center py-10">
                        <i class="fas fa-spinner fa-spin text-3xl text-indigo-600"></i>
                        <p class="mt-2 text-gray-500">Loading Jenkins data...</p>
                    </div>

                    <div x-show="!isLoadingJenkins">
                        <template x-if="jenkinsJobs.length === 0">
                            <div class="text-center py-10 bg-white rounded-lg shadow">
                                <i class="fab fa-jenkins text-4xl text-gray-400 mb-2"></i>
                                <p class="text-gray-500">No Jenkins jobs found.</p>
                                <p class="text-sm text-gray-400 mt-2">Configure your Jenkins connection in Account
                                    Manager.</p>
                            </div>
                        </template>

                        <template x-if="jenkinsJobs.length > 0">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <template x-for="job in jenkinsJobs" :key="job.url">
                                    <div class="bg-white p-4 rounded-lg shadow border-l-4 cursor-pointer transition-all hover:shadow-lg"
                                        :class="getRunBorderColor(job.displayStatus)" @click="viewWorkflowHistory(job)">

                                        <div class="flex justify-between items-center mb-2">
                                            <span
                                                class="text-xs font-semibold bg-gray-100 text-gray-700 px-2 py-0.5 rounded">Jenkins</span>
                                            <a :href="job.url" target="_blank" @click.stop
                                                class="text-xs text-indigo-500 hover:text-indigo-700 font-medium">
                                                Open in Jenkins <i class="fas fa-external-link-alt ml-1"></i>
                                            </a>
                                        </div>
                                        <p class="font-semibold text-gray-900" x-text="job.name"></p>

                                        <div class="mt-2 text-sm">
                                            <p>Status: <span class="font-bold"
                                                    :class="getRunStatusColor(job.displayStatus)"
                                                    x-text="job.displayStatus"></span></p>
                                            <template x-if="job.lastBuild">
                                                <p class="text-xs text-gray-500 mt-1"
                                                    x-text="'Build #' + job.lastBuild.number + ' â€¢ ' + formatTime(job.lastBuild.timestamp)">
                                                </p>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>

                <div x-show="selectedWorkflow" @keydown.escape.window="selectedWorkflow = null"
                    class="fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4"
                    x-cloak x-transition>
                    <div class="relative bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col"
                        @click.away="selectedWorkflow = null" x-transition>

                        <div class="sticky top-0 z-10 bg-gray-100 px-6 py-4 border-b flex justify-between items-center">
                            <div class="min-w-0">
                                <h2 class="text-lg font-bold text-gray-900" x-text="selectedWorkflow?.name"></h2>
                                <p class="text-sm text-gray-500"
                                    x-text="selectedWorkflow?.repository ? selectedWorkflow.repository.full_name : 'Jenkins Job'">
                                </p>
                            </div>
                            <button @click="selectedWorkflow = null"
                                class="w-8 h-8 rounded-full text-gray-500 hover:bg-gray-200 transition-all flex items-center justify-center">
                                <i class="fas fa-times text-lg"></i>
                            </button>
                        </div>

                        <div class="flex-1 overflow-hidden flex flex-col md:flex-row">

                            <div
                                class="w-full md:w-1/3 border-r bg-gray-50 overflow-y-auto max-h-[60vh] md:max-h-[calc(90vh-80px)]">
                                <div class="p-4 border-b bg-gray-100">
                                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">Recent Runs
                                    </h3>
                                </div>

                                <div x-show="isLoadingHistory" class="text-center py-8">
                                    <i class="fas fa-spinner fa-spin text-xl text-indigo-600"></i>
                                </div>

                                <div x-show="!isLoadingHistory">
                                    <template x-if="workflowHistory.length === 0">
                                        <p class="text-center text-gray-500 py-6 text-sm">No run history found.</p>
                                    </template>

                                    <template x-for="run in workflowHistory" :key="getRunId(run)">
                                        <div class="history-item" :class="{'active-run': isRunSelected(run)}"
                                            @click="selectRunFromHistory(run)">
                                            <div class="flex items-center w-full">
                                                <div class="mr-3">
                                                    <i class="fas fa-circle text-xs"
                                                        :class="getRunStatusIconColor(run.displayStatus || run.result)"></i>
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-sm font-medium text-gray-900 truncate">
                                                        Run #<span x-text="getRunNumber(run)"></span>
                                                    </p>
                                                    <p class="text-xs text-gray-500 truncate"
                                                        x-text="formatTime(run.updated_at || run.timestamp)"></p>
                                                </div>
                                                <div class="ml-2">
                                                    <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <div class="w-full md:w-2/3 p-6 overflow-y-auto max-h-[60vh] md:max-h-[calc(90vh-80px)]">

                                <div class="mb-6 flex justify-between items-end">
                                    <div>
                                        <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-1">
                                            Pipeline Stages</h3>
                                        <p class="text-lg font-semibold text-gray-800">
                                            Run #<span x-text="selectedRunNumber"></span> Details
                                        </p>
                                    </div>
                                    <a :href="selectedRunUrl" target="_blank" x-show="selectedRunUrl"
                                        class="text-xs text-indigo-600 hover:text-indigo-800 font-medium">
                                        Open External Logs <i class="fas fa-external-link-alt ml-1"></i>
                                    </a>
                                </div>

                                <div x-show="isStagesLoading" class="flex justify-center py-12">
                                    <div class="flex flex-col items-center">
                                        <i class="fas fa-spinner fa-spin text-3xl text-indigo-500 mb-3"></i>
                                        <span class="text-sm text-gray-500">Loading pipeline topology...</span>
                                    </div>
                                </div>

                                <div x-show="!isStagesLoading">
                                    <div x-show="pipelineStages.length === 0"
                                        class="text-center py-10 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                                        <i class="fas fa-project-diagram text-gray-300 text-4xl mb-3"></i>
                                        <p class="text-gray-500">No stage information available for this run.</p>
                                    </div>

                                    <div x-show="pipelineStages.length > 0" class="pipeline-container">
                                        <template x-for="(stage, index) in pipelineStages" :key="index">
                                            <div class="pipeline-stage" :class="{ 
                                                'completed': stage.status === 'success',
                                                'stage-success': stage.status === 'success',
                                                'stage-failure': stage.status === 'failure',
                                                'stage-running': stage.status === 'running',
                                                'stage-skipped': stage.status === 'skipped',
                                                'stage-pending': stage.status === 'pending'
                                            }">

                                                <div class="stage-node shadow-sm">
                                                    <i x-show="stage.status === 'success'" class="fas fa-check"></i>
                                                    <i x-show="stage.status === 'failure'" class="fas fa-times"></i>
                                                    <i x-show="stage.status === 'running'"
                                                        class="fas fa-sync-alt fa-spin"></i>
                                                    <i x-show="stage.status === 'skipped'" class="fas fa-slash"></i>
                                                    <i x-show="stage.status === 'pending'" class="fas fa-clock"></i>
                                                </div>

                                                <div class="mt-3 text-center px-2 w-full">
                                                    <p class="text-xs font-bold text-gray-800 whitespace-nowrap overflow-hidden text-ellipsis max-w-[120px]"
                                                        x-text="stage.name" :title="stage.name"></p>
                                                    <p class="text-[10px] text-gray-500 font-mono mt-0.5"
                                                        x-text="stage.duration !== '-' ? stage.duration : ''"></p>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                    function cicdPipelines() {
                        return {
                            activeTab: 'github',
                            isLoadingGithub: true,
                            isLoadingJenkins: true,
                            githubRuns: [],
                            jenkinsJobs: [],
                            selectedWorkflow: null,
                            isLoadingHistory: false,
                            workflowHistory: [],
                            selectedRun: null,
                            isStagesLoading: false,
                            pipelineStages: [],
                            selectedRunNumber: '',
                            selectedRunUrl: '',

                            init() {
                                this.fetchGithubData();
                                this.fetchJenkinsData();
                            },

                            fetchGithubData() {
                                this.isLoadingGithub = true;
                                fetch('/api/cicd/github/runs', { credentials: 'include' })
                                    .then(res => {
                                        if (res.status === 401 || res.status === 403) throw new Error('Authentication failed.');
                                        if (!res.ok) throw new Error('Network response was not ok.');
                                        return res.json();
                                    })
                                    .then(data => { this.githubRuns = data; })
                                    .catch(err => {
                                        console.error('Error fetching GitHub data:', err);
                                        this.githubRuns = [];
                                    })
                                    .finally(() => { this.isLoadingGithub = false; });
                            },

                            fetchJenkinsData() {
                                this.isLoadingJenkins = true;
                                fetch('/api/cicd/jenkins/jobs', { credentials: 'include' })
                                    .then(res => {
                                        if (!res.ok) throw new Error('Failed to fetch Jenkins jobs');
                                        return res.json();
                                    })
                                    .then(data => { this.jenkinsJobs = data; })
                                    .catch(err => {
                                        console.error('Error fetching Jenkins data:', err);
                                        this.jenkinsJobs = [];
                                    })
                                    .finally(() => { this.isLoadingJenkins = false; });
                            },

                            refreshData() {
                                this.fetchGithubData();
                                this.fetchJenkinsData();
                            },

                            viewWorkflowHistory(item) {
                                this.selectedWorkflow = item;
                                this.isLoadingHistory = true;
                                this.workflowHistory = [];
                                this.pipelineStages = [];
                                this.selectedRun = null;

                                if (item.repository) {
                                    if (!item.workflow_id || !item.repository.full_name) return;
                                    const [owner, repo] = item.repository.full_name.split('/');
                                    const workflowId = item.workflow_id;

                                    fetch(`/api/cicd/github/runs/${owner}/${repo}/${workflowId}?count=15`, { credentials: 'include' })
                                        .then(res => res.json())
                                        .then(data => {
                                            this.workflowHistory = data;
                                            if (data.length > 0) this.selectRunFromHistory(data[0]);
                                        })
                                        .catch(console.error)
                                        .finally(() => this.isLoadingHistory = false);

                                } else if (item.lastBuild) {
                                    fetch(`/api/cicd/jenkins/jobs/${item.name}/builds`, { credentials: 'include' })
                                        .then(res => {
                                            if (!res.ok) throw new Error("Failed to fetch Jenkins history");
                                            return res.json();
                                        })
                                        .then(data => {
                                            this.workflowHistory = data;
                                            if (data.length > 0) {
                                                this.selectRunFromHistory(data[0]);
                                            } else {
                                                const fallbackRun = {
                                                    run_number: item.lastBuild.number,
                                                    name: item.name,
                                                    displayStatus: item.displayStatus,
                                                    updated_at: item.lastBuild.timestamp,
                                                    html_url: item.lastBuild.url
                                                };
                                                this.workflowHistory = [fallbackRun];
                                                this.selectRunFromHistory(fallbackRun);
                                            }
                                        })
                                        .catch(err => {
                                            console.error(err);
                                            this.workflowHistory = [];
                                        })
                                        .finally(() => this.isLoadingHistory = false);
                                } else {
                                    this.isLoadingHistory = false;
                                }
                            },

                            selectRunFromHistory(run) {
                                this.selectedRun = run;
                                this.isStagesLoading = true;
                                this.pipelineStages = [];
                                const runNumber = this.getRunNumber(run);
                                this.selectedRunNumber = runNumber;
                                this.selectedRunUrl = run.html_url || run.url;

                                if (this.selectedWorkflow.repository) {
                                    const [owner, repo] = this.selectedWorkflow.repository.full_name.split('/');
                                    const runId = run.id;
                                    fetch(`/api/cicd/github/runs/${owner}/${repo}/${runId}/stages`, { credentials: 'include' })
                                        .then(res => res.json())
                                        .then(data => this.pipelineStages = data)
                                        .catch(console.error)
                                        .finally(() => this.isStagesLoading = false);
                                } else {
                                    const jobName = this.selectedWorkflow.name;
                                    fetch(`/api/cicd/jenkins/jobs/${jobName}/${runNumber}/stages`, { credentials: 'include' })
                                        .then(res => res.json())
                                        .then(data => this.pipelineStages = data)
                                        .catch(console.error)
                                        .finally(() => this.isStagesLoading = false);
                                }
                            },

                            getRunId(run) { return run.id || run.number || run.run_number; },
                            getRunNumber(run) { return run.run_number || run.number || run.id; },
                            isRunSelected(run) { return this.selectedRun && this.getRunId(this.selectedRun) === this.getRunId(run); },

                            formatTime(timeValue) {
                                if (!timeValue) return 'N/A';
                                try {
                                    const date = typeof timeValue === 'number' ? new Date(timeValue) : new Date(timeValue);
                                    return date.toLocaleString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                                } catch (e) { return timeValue; }
                            },

                            getRunStatusColor(status) {
                                const s = (status || '').toLowerCase();
                                if (s === 'success' || s === 'completed') return 'status-success';
                                if (s === 'failure' || s === 'failed') return 'status-failure';
                                if (s === 'in_progress' || s === 'running' || s === 'building') return 'status-running';
                                if (s === 'cancelled' || s === 'aborted') return 'status-cancelled';
                                if (s === 'unstable') return 'text-yellow-600';
                                return 'status-unknown';
                            },

                            getRunStatusIconColor(status) {
                                const s = (status || '').toLowerCase();
                                if (s === 'success' || s === 'completed') return 'text-green-600';
                                if (s === 'failure' || s === 'failed') return 'text-red-600';
                                if (s === 'in_progress' || s === 'running' || s === 'building') return 'text-blue-600';
                                if (s === 'cancelled' || s === 'aborted') return 'text-gray-500';
                                if (s === 'unstable') return 'text-yellow-500';
                                return 'text-gray-400';
                            },

                            getRunBorderColor(status) {
                                const s = (status || '').toLowerCase();
                                if (s === 'success' || s === 'completed') return 'border-success';
                                if (s === 'failure' || s === 'failed') return 'border-failure';
                                if (s === 'in_progress' || s === 'running' || s === 'building') return 'border-running';
                                if (s === 'cancelled' || s === 'aborted') return 'border-cancelled';
                                if (s === 'unstable') return 'border-l-yellow-500';
                                return 'border-unknown';
                            }
                        };
                    }
                </script>
            </main>
        </div>
    </div>
</body>

</html>