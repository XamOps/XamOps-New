<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XamOps - Review Invoice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <link rel="icon" href="/icons/XamOps.png" sizes="32x32" type="image/png">
<link rel="apple-touch-icon" href="/icons/XamOps.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/big.js@6.0.3/big.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }

        /* --- START: STYLES COPIED FOR DRILL-DOWN CONSISTENCY --- */
        .cost-breakdown-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 14px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            table-layout: fixed;
        }

        .cost-breakdown-table thead th {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #374151;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 16px 20px;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
        }

        .cost-breakdown-table tbody tr {
            transition: all 0.15s ease;
            border-bottom: 1px solid #f1f5f9;
        }

        .cost-breakdown-table tbody tr:hover {
            background-color: rgba(99, 102, 241, 0.02);
        }

        .cost-breakdown-table td {
            padding: 16px 20px;
            vertical-align: middle;
        }

        .expand-icon {
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            color: #6366f1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background: rgba(99, 102, 241, 0.1);
        }
        
        .expand-icon:hover { background: rgba(99, 102, 241, 0.2); }
        .rotate-90 { transform: rotate(90deg); }

        .drilldown-row {
            background: linear-gradient(135deg, #fafbff 0%, #f8fafc 100%);
            border-left: 4px solid #6366f1;
        }

        .nested-drilldown {
            background: linear-gradient(135deg, #f0f4ff 0%, #fafbff 100%);
            border-left: 4px solid #8b5cf6;
        }

        .amount-cell {
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            text-align: right;
            color: #059669;
        }

        .service-name { font-weight: 600; color: #1f2937; font-size: 15px; }
        .region-name { color: #6b7280; font-weight: 500; padding-left: 20px; }
        .resource-name { color: #9ca3af; font-size: 13px; padding-left: 40px; }
        /* --- END: COPIED STYLES --- */
    </style>
</head>
<body class="bg-gray-100" x-data="invoiceDetailPage()">
<div class="flex h-screen">
    <div id="sidebar-container" class="flex-shrink-0"></div>

    <div class="flex-1 flex flex-col overflow-hidden">
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6 relative">
            <div x-show="loading" class="text-center p-10"><i class="fas fa-spinner fa-spin text-3xl text-indigo-500"></i></div>
            <div x-show="error" class="text-center p-10 bg-red-50 rounded-lg"><p class="text-red-700" x-text="error"></p></div>
            
            <div x-show="!loading && invoice" class="container mx-auto" x-cloak>
                <a href="admin_invoices.html" class="text-indigo-600 hover:text-indigo-800 mb-4 inline-block"><i class="fas fa-arrow-left mr-2"></i>Back to All Invoices</a>
                <div class="bg-white rounded-lg shadow-md p-8">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-800" x-text="`Invoice #${invoice.invoiceNumber}`"></h1>
                            <p class="text-gray-600" x-text="`For: ${invoice.accountName} (${invoice.awsAccountId})`"></p>
                        </div>
                        <div class="text-right">
                            <span class="px-3 py-1 text-sm font-semibold rounded-full" :class="{ 'bg-yellow-100 text-yellow-800': invoice.status === 'DRAFT', 'bg-green-100 text-green-800': invoice.status === 'FINALIZED' }" x-text="invoice.status"></span>
                            <p class="text-gray-500 mt-2" x-text="`Period: ${invoice.billingPeriod}`"></p>
                        </div>
                    </div>

                    <div x-show="invoice.status === 'DRAFT'" class="bg-indigo-50 border border-indigo-200 p-4 rounded-lg mb-6">
                        <h3 class="font-semibold text-lg text-indigo-800 mb-3">Admin Actions</h3>
                        <div class="flex items-end justify-between">
                             <div>
                                <h4 class="font-medium text-gray-700 mb-2">Apply Discount</h4>
                                <div class="flex items-center space-x-2">
                                    <select x-model="discountService" class="block w-full text-sm border-gray-300 rounded-md">
                                        <option value="ALL">Overall Bill</option>
                                        <template x-for="service in uniqueServices" :key="service">
                                            <option :value="service" x-text="service"></option>
                                        </template>
                                    </select>
                                    <input type="number" x-model.number="discountPercentage" placeholder="%" class="w-20 text-sm border-gray-300 rounded-md">
                                    <button @click="applyDiscount()" :disabled="!discountService || !discountPercentage" class="px-4 py-2 bg-indigo-500 text-white text-sm rounded-md hover:bg-indigo-600 disabled:bg-gray-400">Apply</button>
                                </div>
                            </div>
                            <div class="flex items-end justify-end space-x-4">
                                <button @click="finalizeInvoice()" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700"><i class="fas fa-check-circle mr-2"></i>Finalize & Publish</button>
                            </div>
                        </div>
                        <div x-show="message" class="mt-3 text-sm" :class="isError ? 'text-red-600' : 'text-green-600'" x-text="message"></div>
                    </div>

                    <div>
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Invoice Details</h2>
                         <div class="border rounded-lg overflow-hidden">
                             <table class="cost-breakdown-table">
                                <colgroup>
                                    <col style="width: 60px;">
                                    <col style="width: 45%;">
                                    <col style="width: 25%;">
                                    <col style="width: 25%;">
                                </colgroup>
                                <thead>
                                <tr>
                                    <th></th>
                                    <th>Service / Resource</th>
                                    <th>Usage Quantity</th>
                                    <th>Amount (USD)</th>
                                </tr>
                                </thead>

                                <template x-for="service in detailedBreakdown" :key="service.serviceName">
                                    <tbody>
                                    <tr @click="toggleService(service.serviceName)" class="cursor-pointer">
                                        <td>
                                            <div class="expand-icon" :class="{ 'rotate-90': expandedServices[service.serviceName] }">
                                                <i class="fas fa-chevron-right text-sm"></i>
                                            </div>
                                        </td>
                                        <td><div class="service-name" x-text="service.serviceName"></div></td>
                                        <td><span class="text-gray-500">—</span></td>
                                        <td><div class="amount-cell" x-text="formatCurrency(service.totalCost)"></div></td>
                                    </tr>

                                    <template x-for="region in service.regionCosts" :key="region.regionName">
                                        <tbody x-show="expandedServices[service.serviceName]">
                                        <tr @click="toggleRegion(service.serviceName, region.regionName)" class="cursor-pointer drilldown-row">
                                            <td>
                                                <div class="expand-icon" :class="{ 'rotate-90': expandedRegions[`${service.serviceName}-${region.regionName}`] }">
                                                    <i class="fas fa-chevron-right text-xs"></i>
                                                </div>
                                            </td>
                                            <td><div class="region-name" x-text="region.regionName"></div></td>
                                            <td><span class="text-gray-500">—</span></td>
                                            <td><div class="amount-cell text-blue-600" x-text="formatCurrency(region.cost)"></div></td>
                                        </tr>

                                        <template x-for="resource in region.resources" :key="resource.resourceId">
                                            <tr x-show="expandedRegions[`${service.serviceName}-${region.regionName}`]" class="nested-drilldown">
                                                <td></td>
                                                <td><div class="resource-name" x-text="resource.resourceName"></div></td>
                                                <td class="text-right text-gray-600 text-sm" x-text="`${formatNumber(resource.usageQuantity)} ${resource.unit}`"></td>
                                                <td><div class="amount-cell text-purple-600" x-text="formatCurrency(resource.cost)"></div></td>
                                            </tr>
                                        </template>
                                        </tbody>
                                    </template>
                                    </tbody>
                                </template>
                                
                                <tfoot>
                                    <tr class="border-t-2">
                                        <td colspan="3" class="text-right font-semibold py-3">Subtotal</td>
                                        <td class="text-right font-semibold py-3" x-text="formatCurrency(invoice.preDiscountTotal)"></td>
                                    </tr>
                                     <template x-for="discount in invoice.discounts" :key="discount.id">
                                        <tr class="text-sm">
                                            <td colspan="3" class="px-4 py-1 text-right text-gray-500" x-text="discount.description"></td>
                                            <td class="px-4 py-1 text-right text-red-600 flex justify-end items-center">
                                                <span x-text="formatCurrency(calculateDiscountAmount(discount))"></span>
                                                <button x-show="invoice.status === 'DRAFT'" @click="removeDiscount(discount.id)" class="ml-2 text-gray-400 hover:text-red-500" title="Remove Discount"><i class="fas fa-trash-alt fa-xs"></i></button>
                                            </td>
                                        </tr>
                                    </template>
                                    <tr class="border-t-2 border-gray-300 bg-gray-100">
                                        <td colspan="3" class="px-4 py-3 text-right text-gray-800 font-bold text-lg">FINAL TOTAL:</td>
                                        <td class="px-4 py-3 text-right text-gray-900 font-bold text-lg" x-text="formatCurrency(invoice.amount)"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                         </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    function invoiceDetailPage() {
        return {
            invoice: null,
            loading: true,
            error: null,
            invoiceId: null,
            uniqueServices: [],
            discountService: 'ALL',
            discountPercentage: null,
            message: '',
            isError: false,

            // --- START: NEW PROPERTIES FOR DRILL-DOWN ---
            detailedBreakdown: [],
            expandedServices: {},
            expandedRegions: {},
            // --- END: NEW PROPERTIES ---

            init() {
                this.loadSidebar();
                const urlParams = new URLSearchParams(window.location.search);
                this.invoiceId = urlParams.get('id');
                if (!this.invoiceId) {
                    this.error = "No Invoice ID provided."; this.loading = false; return;
                }
                this.fetchInvoiceDetails();
            },

            fetchInvoiceDetails() {
                this.loading = true; this.error = null;
                fetch(`/api/admin/invoices/${this.invoiceId}`)
                    .then(res => res.ok ? res.json() : Promise.reject('Invoice not found.'))
                    .then(data => {
                        this.invoice = data;
                        this.detailedBreakdown = this.transformToDrilldown(data.lineItems); // Transform data
                        this.updateUniqueServices();
                    })
                    .catch(err => { this.error = err.message; })
                    .finally(() => { this.loading = false; });
            },

            // --- START: NEW DATA TRANSFORMATION FUNCTION ---
            transformToDrilldown(lineItems) {
                if (!lineItems || lineItems.length === 0) return [];
                const serviceMap = new Map();
                for (const item of lineItems) {
                    if (!serviceMap.has(item.serviceName)) {
                        serviceMap.set(item.serviceName, { serviceName: item.serviceName, totalCost: 0, regionCosts: new Map() });
                    }
                    const service = serviceMap.get(item.serviceName);
                    service.totalCost += item.cost;

                    if (!service.regionCosts.has(item.regionName)) {
                        service.regionCosts.set(item.regionName, { regionName: item.regionName, cost: 0, resources: [] });
                    }
                    const region = service.regionCosts.get(item.regionName);
                    region.cost += item.cost;
                    region.resources.push({
                        resourceId: `${item.serviceName}-${item.regionName}-${item.resourceName}-${item.cost}`,
                        resourceName: item.resourceName,
                        usageQuantity: item.usageQuantity,
                        unit: item.unit,
                        cost: item.cost
                    });
                }
                const result = [];
                for (const service of serviceMap.values()) {
                    service.regionCosts = Array.from(service.regionCosts.values());
                    result.push(service);
                }
                return result;
            },
            // --- END: NEW DATA TRANSFORMATION FUNCTION ---
            
            updateUniqueServices() {
                if (this.invoice && this.invoice.lineItems) {
                    this.uniqueServices = [...new Set(this.invoice.lineItems.map(item => item.serviceName))];
                }
            },
            
            applyDiscount() {
                this.message = ''; this.isError = false;
                fetch(`/api/admin/invoices/${this.invoiceId}/discount`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ serviceName: this.discountService, percentage: this.discountPercentage })
                })
                .then(res => res.ok ? res.json() : Promise.reject('Failed to apply discount.'))
                .then(updatedInvoice => {
                    this.invoice = updatedInvoice;
                    this.detailedBreakdown = this.transformToDrilldown(updatedInvoice.lineItems);
                    this.message = 'Discount applied successfully!';
                    this.discountPercentage = null;
                })
                .catch(err => { this.message = err.message; this.isError = true; });
            },

            removeDiscount(discountId) {
                this.message = '';
                fetch(`/api/admin/invoices/${this.invoiceId}/discounts/${discountId}`, { method: 'DELETE' })
                .then(res => res.ok ? res.json() : Promise.reject('Failed to remove discount.'))
                .then(updatedInvoice => {
                    this.invoice = updatedInvoice;
                    this.detailedBreakdown = this.transformToDrilldown(updatedInvoice.lineItems);
                    this.message = 'Discount removed successfully!';
                    this.isError = false;
                })
                .catch(err => { this.message = err; this.isError = true; });
            },

            calculateDiscountAmount(discount) {
                let amount = 0;
                const percentage = new Big(discount.percentage).div(100);
                if (discount.serviceName.toUpperCase() === 'ALL') {
                    amount = new Big(this.invoice.preDiscountTotal).times(percentage);
                } else {
                    const serviceTotal = this.invoice.lineItems
                        .filter(item => item.serviceName === discount.serviceName)
                        .reduce((sum, item) => sum.plus(new Big(item.cost)), new Big(0));
                    amount = serviceTotal.times(percentage);
                }
                return amount.times(-1).toNumber();
            },

            finalizeInvoice() {
                if (!confirm('Are you sure you want to finalize this invoice? This action cannot be undone.')) return;
                this.message = ''; this.isError = false;
                fetch(`/api/admin/invoices/${this.invoiceId}/finalize`, { method: 'POST' })
                .then(res => res.ok ? res.json() : Promise.reject('Failed to finalize invoice.'))
                .then(finalizedInvoice => {
                    this.invoice = finalizedInvoice;
                    this.detailedBreakdown = this.transformToDrilldown(finalizedInvoice.lineItems);
                    this.message = 'Invoice has been finalized and is now visible to the user.';
                })
                .catch(err => { this.message = err.message; this.isError = true; });
            },

            formatCurrency(value) {
                if (typeof value !== 'number' && typeof value !== 'string') return '$0.00';
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
            },

            formatNumber(value) {
                if (typeof value !== 'number' && typeof value !== 'string') return '0';
                const num = Number(value);
                if (isNaN(num)) return '0';
                return num.toLocaleString('en-US', { maximumFractionDigits: 3 });
            },

            // --- START: NEW TOGGLE METHODS ---
            toggleService(serviceName) {
                this.expandedServices[serviceName] = !this.expandedServices[serviceName];
            },

            toggleRegion(serviceName, regionName) {
                const key = `${serviceName}-${regionName}`;
                this.expandedRegions[key] = !this.expandedRegions[key];
            },
            // --- END: NEW TOGGLE METHODS ---

            loadSidebar() {
                fetch('/_sidebar.html')
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('sidebar-container').innerHTML = html;
                        if (window.Alpine) Alpine.start();
                    });
            }
        };
    }
    
    document.addEventListener('alpine:init', () => {
        Alpine.data('invoiceDetailPage', invoiceDetailPage);
    });
</script>
</body>
</html>