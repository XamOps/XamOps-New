<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XamOps - Review Invoice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="icon" href="/icons/XamOps.png" sizes="32x32" type="image/png">
    <link rel="apple-touch-icon" href="/icons/XamOps.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/big.js@6.0.3/big.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }

        /* --- DRILL-DOWN TABLE STYLES --- */
        .cost-breakdown-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 14px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            table-layout: fixed;
        }

        .cost-breakdown-table thead th {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #374151;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 16px 20px;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
        }

        .cost-breakdown-table tbody tr {
            transition: all 0.15s ease;
            border-bottom: 1px solid #f1f5f9;
        }

        .cost-breakdown-table tbody tr:hover {
            background-color: rgba(99, 102, 241, 0.02);
        }

        .cost-breakdown-table td {
            padding: 16px 20px;
            vertical-align: middle;
        }

        .expand-icon {
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            color: #6366f1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background: rgba(99, 102, 241, 0.1);
        }
        
        .expand-icon:hover { background: rgba(99, 102, 241, 0.2); }
        .rotate-90 { transform: rotate(90deg); }

        .drilldown-row {
            background: linear-gradient(135deg, #fafbff 0%, #f8fafc 100%);
            border-left: 4px solid #6366f1;
        }

        .nested-drilldown {
            background: linear-gradient(135deg, #f0f4ff 0%, #fafbff 100%);
            border-left: 4px solid #8b5cf6;
        }

        .amount-cell {
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            text-align: right;
            color: #059669;
        }

        .service-name { font-weight: 600; color: #1f2937; font-size: 15px; }
        .region-name { color: #6b7280; font-weight: 500; padding-left: 20px; }
        .resource-name { color: #9ca3af; font-size: 13px; padding-left: 40px; }
    </style>
</head>
<body class="bg-gray-100" x-data="invoiceDetailPage()">
<div class="flex h-screen">
  <include file="/_sidebar.html"></include>

    <div class="flex-1 flex flex-col overflow-hidden pl-64">
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6 relative">
            
            <div x-show="loading" class="text-center p-20" x-cloak>
                <i class="fas fa-circle-notch fa-spin text-4xl text-indigo-500 mb-4"></i>
                <p class="text-gray-500">Loading invoice details...</p>
            </div>
            
            <div x-show="error && !loading" class="text-center p-10 bg-red-50 rounded-lg border border-red-200 m-6" x-cloak>
                <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-2"></i>
                <p class="text-red-700 font-medium" x-text="error"></p>
                <a href="/admin_invoices.html" class="mt-4 inline-block text-indigo-600 hover:underline">Return to List</a>
            </div>
            
            <div x-show="!loading && invoice" class="container mx-auto" x-cloak>
                <a href="admin_invoices.html" class="text-indigo-600 hover:text-indigo-800 mb-4 inline-flex items-center transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Back to All Invoices
                </a>
                
                <div class="bg-white rounded-lg shadow-md p-8">
                    <div class="flex justify-between items-start mb-8 pb-6 border-b border-gray-100">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                                <span x-text="`Invoice #${invoice.invoiceNumber}`"></span>
                            </h1>
                            <p class="text-gray-600 mt-1" x-text="`Account: ${invoice.accountName} (${invoice.awsAccountId})`"></p>
                        </div>
                        <div class="text-right">
                            <span class="px-3 py-1 text-sm font-semibold rounded-full" 
                                  :class="{ 
                                      'bg-yellow-100 text-yellow-800': invoice.status === 'DRAFT', 
                                      'bg-green-100 text-green-800': invoice.status === 'FINALIZED',
                                      'bg-gray-100 text-gray-800': invoice.status === 'VOID'
                                  }" x-text="invoice.status">
                            </span>
                            <p class="text-gray-500 mt-2" x-text="`Period: ${invoice.billingPeriod}`"></p>
                            <p class="text-xs text-gray-400" x-text="`Date: ${invoice.invoiceDate}`"></p>
                        </div>
                    </div>

                    <div x-show="invoice.status === 'DRAFT'" class="bg-indigo-50 border border-indigo-200 p-5 rounded-lg mb-8 shadow-sm">
                        <h3 class="font-semibold text-lg text-indigo-900 mb-4 flex items-center">
                            <i class="fas fa-user-shield mr-2"></i> Admin Actions
                        </h3>
                        
                        <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
                            <div class="flex-1 bg-white p-4 rounded border border-indigo-100">
                                <h4 class="font-medium text-gray-700 mb-2 text-sm uppercase tracking-wide">Apply Discount</h4>
                                <div class="flex items-center space-x-2">
                                    <select x-model="discountService" class="block w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                        <option value="ALL">Entire Invoice (Overall)</option>
                                        <template x-for="service in uniqueServices" :key="service">
                                            <option :value="service" x-text="service"></option>
                                        </template>
                                    </select>
                                    <div class="relative w-24">
                                        <input type="number" x-model.number="discountPercentage" placeholder="%" min="0" max="100" class="block w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 pr-6">
                                        <div class="absolute inset-y-0 right-0 pr-2 flex items-center pointer-events-none">
                                            <span class="text-gray-500 sm:text-sm">%</span>
                                        </div>
                                    </div>
                                    <button @click="applyDiscount()" :disabled="!discountService || discountPercentage === null || discountPercentage === ''" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
                                        Apply
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex-shrink-0">
                                <button @click="finalizeInvoice()" class="px-6 py-3 bg-green-600 text-white font-bold rounded-md hover:bg-green-700 shadow-md transform transition hover:-translate-y-0.5">
                                    <i class="fas fa-check-circle mr-2"></i>Finalize Invoice
                                </button>
                            </div>
                        </div>
                        
                        <div x-show="message" class="mt-3 text-sm font-medium p-2 rounded bg-white border" :class="isError ? 'text-red-600 border-red-200' : 'text-green-600 border-green-200'" x-text="message"></div>
                    </div>

                    <div>
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Cost Breakdown</h2>
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                             <table class="cost-breakdown-table">
                                <colgroup>
                                    <col style="width: 50px;">
                                    <col style="width: 45%;">
                                    <col style="width: 25%;">
                                    <col style="width: 25%;">
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>Service / Resource</th>
                                        <th>Usage</th>
                                        <th class="text-right">Amount</th>
                                    </tr>
                                </thead>

                                <template x-for="service in detailedBreakdown" :key="service.serviceName">
                                    <tbody>
                                        <tr @click="toggleService(service.serviceName)" class="cursor-pointer group">
                                            <td>
                                                <div class="expand-icon" :class="{ 'rotate-90': expandedServices[service.serviceName] }">
                                                    <i class="fas fa-chevron-right text-xs"></i>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="service-name group-hover:text-indigo-600 transition-colors" x-text="service.serviceName"></div>
                                            </td>
                                            <td><span class="text-gray-400 text-xs">—</span></td>
                                            <td><div class="amount-cell" x-text="formatCurrency(service.totalCost)"></div></td>
                                        </tr>

                                        <template x-for="region in service.regionCosts" :key="region.regionName">
                                            <tbody x-show="expandedServices[service.serviceName]">
                                                <tr @click="toggleRegion(service.serviceName, region.regionName)" class="cursor-pointer drilldown-row group">
                                                    <td>
                                                        <div class="expand-icon ml-2" :class="{ 'rotate-90': expandedRegions[`${service.serviceName}-${region.regionName}`] }">
                                                            <i class="fas fa-chevron-right text-[10px]"></i>
                                                        </div>
                                                    </td>
                                                    <td><div class="region-name group-hover:text-indigo-600" x-text="region.regionName"></div></td>
                                                    <td><span class="text-gray-400 text-xs">—</span></td>
                                                    <td><div class="amount-cell text-blue-600 text-sm" x-text="formatCurrency(region.cost)"></div></td>
                                                </tr>

                                                <template x-for="resource in region.resources" :key="resource.resourceId">
                                                    <tr x-show="expandedRegions[`${service.serviceName}-${region.regionName}`]" class="nested-drilldown">
                                                        <td></td>
                                                        <td><div class="resource-name" x-text="resource.resourceName"></div></td>
                                                        <td class="text-right text-gray-500 text-xs font-mono" x-text="`${formatNumber(resource.usageQuantity)} ${resource.unit}`"></td>
                                                        <td><div class="amount-cell text-purple-600 text-xs" x-text="formatCurrency(resource.cost)"></div></td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </template>
                                    </tbody>
                                </template>
                                
                                <tfoot class="bg-gray-50">
                                    <tr class="border-t-2 border-gray-200">
                                        <td colspan="3" class="px-6 py-4 text-right text-gray-600 font-medium">Subtotal</td>
                                        <td class="px-6 py-4 text-right text-gray-800 font-bold" x-text="formatCurrency(invoice.preDiscountTotal)"></td>
                                    </tr>
                                    
                                    <template x-for="discount in invoice.discounts" :key="discount.id">
                                        <tr class="bg-red-50">
                                            <td colspan="3" class="px-6 py-2 text-right text-red-600 text-sm">
                                                <span x-text="discount.description"></span>
                                                <button x-show="invoice.status === 'DRAFT'" @click="removeDiscount(discount.id)" class="ml-2 text-red-400 hover:text-red-800 transition-colors" title="Remove Discount">
                                                    <i class="fas fa-times-circle"></i>
                                                </button>
                                            </td>
                                            <td class="px-6 py-2 text-right text-red-700 font-medium text-sm" x-text="formatCurrency(calculateDiscountAmount(discount))"></td>
                                        </tr>
                                    </template>

                                    <tr class="border-t border-gray-200 bg-gray-50">
                                        <td colspan="3" class="px-6 py-2 text-right text-gray-500 font-medium text-sm">Taxable Value</td>
                                        <td class="px-6 py-2 text-right text-gray-700 font-medium text-sm" 
                                            x-text="formatCurrency(invoice.preDiscountTotal - (invoice.discountAmount || 0))">
                                        </td>
                                    </tr>

                                    <tr class="bg-gray-50">
                                        <td colspan="3" class="px-6 py-2 text-right text-gray-500 font-medium text-sm">IGST (18%)</td>
                                        <td class="px-6 py-2 text-right text-gray-700 font-medium text-sm" x-text="formatCurrency(invoice.taxAmount)"></td>
                                    </tr>
                                    
                                    <tr class="border-t-2 border-indigo-100 bg-indigo-50">
                                        <td colspan="3" class="px-6 py-4 text-right text-indigo-900 font-bold text-lg">TOTAL DUE</td>
                                        <td class="px-6 py-4 text-right text-indigo-700 font-bold text-xl" x-text="formatCurrency(invoice.amount)"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    function invoiceDetailPage() {
        return {
            invoice: null,
            loading: true,
            error: null,
            invoiceId: null,
            uniqueServices: [],
            discountService: 'ALL',
            discountPercentage: null,
            message: '',
            isError: false,

            // Drill-down State
            detailedBreakdown: [],
            expandedServices: {},
            expandedRegions: {},

            init() {
                const urlParams = new URLSearchParams(window.location.search);
                this.invoiceId = urlParams.get('id');
                if (!this.invoiceId) {
                    this.error = "No Invoice ID provided."; 
                    this.loading = false; 
                    return;
                }
                this.fetchInvoiceDetails();
            },

            fetchInvoiceDetails() {
                this.loading = true; 
                this.error = null;
                
                fetch(`/api/admin/invoices/${this.invoiceId}`)
                    .then(res => {
                        if (!res.ok) throw new Error('Invoice not found.');
                        return res.json();
                    })
                    .then(data => {
                        this.invoice = data;
                        // Transform flat line items to hierarchical data
                        this.detailedBreakdown = this.transformToDrilldown(data.lineItems);
                        this.updateUniqueServices();
                    })
                    .catch(err => { this.error = err.message; })
                    .finally(() => { this.loading = false; });
            },

            // Transforms API flat list to Service -> Region -> Resource hierarchy
            transformToDrilldown(lineItems) {
                if (!lineItems || lineItems.length === 0) return [];
                
                const serviceMap = new Map();
                
                for (const item of lineItems) {
                    // 1. Service Level
                    if (!serviceMap.has(item.serviceName)) {
                        serviceMap.set(item.serviceName, { 
                            serviceName: item.serviceName, 
                            totalCost: 0, 
                            regionCosts: new Map() 
                        });
                    }
                    const service = serviceMap.get(item.serviceName);
                    // Handle String cost if necessary, though API usually returns number in BigDecimal
                    const cost = typeof item.cost === 'string' ? parseFloat(item.cost) : item.cost;
                    service.totalCost += cost;

                    // 2. Region Level
                    if (!service.regionCosts.has(item.regionName)) {
                        service.regionCosts.set(item.regionName, { 
                            regionName: item.regionName, 
                            cost: 0, 
                            resources: [] 
                        });
                    }
                    const region = service.regionCosts.get(item.regionName);
                    region.cost += cost;

                    // 3. Resource Level
                    region.resources.push({
                        resourceId: `${item.serviceName}-${item.regionName}-${item.resourceName}-${item.cost}`, 
                        resourceName: item.resourceName,
                        usageQuantity: item.usageQuantity,
                        unit: item.unit,
                        cost: cost
                    });
                }
                
                // Convert Maps to Arrays for Alpine x-for
                const result = [];
                for (const service of serviceMap.values()) {
                    service.regionCosts = Array.from(service.regionCosts.values());
                    result.push(service);
                }
                return result.sort((a, b) => b.totalCost - a.totalCost); // Sort by cost desc
            },
            
            updateUniqueServices() {
                if (this.invoice && this.invoice.lineItems) {
                    const services = new Set(this.invoice.lineItems.map(item => item.serviceName));
                    this.uniqueServices = Array.from(services).sort();
                }
            },
            
            applyDiscount() {
                this.message = ''; this.isError = false;
                fetch(`/api/admin/invoices/${this.invoiceId}/discount`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ serviceName: this.discountService, percentage: this.discountPercentage })
                })
                .then(res => {
                    if (!res.ok) throw new Error('Failed to apply discount.');
                    return res.json();
                })
                .then(updatedInvoice => {
                    // Update local data with returned invoice (totals are recalculated on backend)
                    this.invoice = updatedInvoice;
                    this.detailedBreakdown = this.transformToDrilldown(updatedInvoice.lineItems);
                    this.message = 'Discount applied successfully!';
                    this.discountPercentage = null;
                })
                .catch(err => { this.message = err.message || 'Error applying discount'; this.isError = true; });
            },

            removeDiscount(discountId) {
                if (!confirm('Remove this discount?')) return;
                this.message = '';
                fetch(`/api/admin/invoices/${this.invoiceId}/discounts/${discountId}`, { method: 'DELETE' })
                .then(res => {
                    if (!res.ok) throw new Error('Failed to remove discount.');
                    return res.json();
                })
                .then(updatedInvoice => {
                    this.invoice = updatedInvoice;
                    this.detailedBreakdown = this.transformToDrilldown(updatedInvoice.lineItems);
                    this.message = 'Discount removed successfully!';
                    this.isError = false;
                })
                .catch(err => { this.message = err.message; this.isError = true; });
            },

            // Helper purely for display logic in the footer
            calculateDiscountAmount(discount) {
                try {
                    let amount = 0;
                    const percentage = new Big(discount.percentage).div(100);
                    
                    if (discount.serviceName === 'ALL') {
                        amount = new Big(this.invoice.preDiscountTotal).times(percentage);
                    } else if (discount.serviceName === 'AWS Consumption Charge') {
                        // --- NEW LOGIC: Sum up non-CloudFront items ---
                        // Note: We do NOT exclude 'Tax' here because you want the discount to apply to the $799.91
                        const standardTotal = this.detailedBreakdown
                            .filter(s => s.serviceName !== 'Amazon CloudFront')
                            .reduce((sum, s) => sum.plus(new Big(s.totalCost)), new Big(0));
                        amount = standardTotal.times(percentage);
                    } else {
                        const service = this.detailedBreakdown.find(s => s.serviceName === discount.serviceName);
                        if (service) {
                            amount = new Big(service.totalCost).times(percentage);
                        }
                    }
                    return amount.times(-1).toNumber(); // Return negative for display
                } catch(e) { return 0; }
            },

            finalizeInvoice() {
                if (!confirm('Are you sure you want to finalize this invoice? This action cannot be undone and will notify the client.')) return;
                this.message = ''; this.isError = false;
                
                fetch(`/api/admin/invoices/${this.invoiceId}/finalize`, { method: 'POST' })
                .then(res => {
                    if (!res.ok) throw new Error('Failed to finalize invoice.');
                    return res.json();
                })
                .then(finalizedInvoice => {
                    this.invoice = finalizedInvoice;
                    this.detailedBreakdown = this.transformToDrilldown(finalizedInvoice.lineItems);
                    this.message = 'Invoice finalized successfully!';
                })
                .catch(err => { this.message = err.message; this.isError = true; });
            },

            formatCurrency(value) {
                if (typeof value !== 'number' && typeof value !== 'string') return '$0.00';
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
            },

            formatNumber(value) {
                if (value === null || value === undefined) return '0';
                const num = Number(value);
                if (isNaN(num)) return '0';
                return num.toLocaleString('en-US', { maximumFractionDigits: 3 });
            },

            toggleService(serviceName) {
                this.expandedServices[serviceName] = !this.expandedServices[serviceName];
            },

            toggleRegion(serviceName, regionName) {
                const key = `${serviceName}-${regionName}`;
                this.expandedRegions[key] = !this.expandedRegions[key];
            }
        };
    }
    
    document.addEventListener('alpine:init', () => {
        Alpine.data('invoiceDetailPage', invoiceDetailPage);
    });
</script>
</body>
</html>  