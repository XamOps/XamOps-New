<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Credits - XamOps</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .focus-visible { outline: 2px solid #4f46e5; outline-offset: 2px; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen" x-data="{
    showForm: false,
    creditRequests: [],
    selectedFilter: 'all',
    userId: 1, // Set the logged-in user ID here as per your auth system
    newRequest: {
        awsAccountId: '',
        expectedCredits: '',
        services: '',
        useCase: '',
        priority: 'medium'
    },
    notification: '',
    notificationType: '',

    init() {
        this.fetchRequests();
    },

    async fetchRequests() {
        try {
            const response = await fetch(`http://localhost:8082/api/billing/credits/user/${this.userId}`);
            if (!response.ok) throw new Error('Network response was not ok');
            this.creditRequests = await response.json();
        } catch (error) {
            console.error('Error fetching credit requests:', error);
            this.showNotification('Could not fetch credit requests from the server.', 'error');
        }
    },

    async submitRequest() {
        if (!this.validateForm()) {
            this.showNotification('Please fill all fields correctly.', 'error');
            return;
        }
        try {
            const payload = {...this.newRequest, userId: this.userId};
            const response = await fetch('http://localhost:8082/api/billing/credits', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok)
                throw new Error('Submission failed with status ' + response.status);

            await this.fetchRequests();
            this.resetForm();
            this.showForm = false;
            this.showNotification('Request submitted successfully!', 'success');
        } catch (error) {
            console.error('Error submitting credit request:', error);
            this.showNotification('Failed to submit request. Please check the console.', 'error');
        }
    },

    validateForm() {
        return this.newRequest.awsAccountId.length > 10 &&
               Number(this.newRequest.expectedCredits) > 0 &&
               this.newRequest.services.length > 3 &&
               this.newRequest.useCase.length > 5;
    },

    resetForm() {
        this.newRequest = { awsAccountId: '', expectedCredits: '', services: '', useCase: '', priority: 'medium' };
    },

    get filteredRequests() {
        if (this.selectedFilter === 'all') return this.creditRequests;
        return this.creditRequests.filter(req => req.status === this.selectedFilter);
    },

    showNotification(message, type) {
        this.notification = message;
        this.notificationType = type;
        setTimeout(() => this.notification = '', 3000);
    },

    advanceStatus(request) {
        const statuses = ['submitted', 'documentation', 'verification', 'approved', 'rejected'];
        const currentIndex = statuses.indexOf(request.status);
        if (currentIndex >= 0 && currentIndex < statuses.length - 2) {
            request.status = statuses[currentIndex + 1];
            // Optional: update status on server here via PUT
        }
    }
}" x-init="init()">

<div class="flex h-screen">
    <div id="sidebar-container" class="flex-shrink-0"></div>
    <div class="flex-1 flex flex-col overflow-hidden">
        <div class="bg-white shadow-sm border-b border-gray-200">
            <div class="container mx-auto px-6 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-gray-900 text-3xl font-bold">AWS Credits Management</h3>
                        <p class="text-gray-600 mt-1">Request and track your AWS credit applications</p>
                    </div>
                    <div class="flex items-center space-x-6">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-indigo-600" x-text="'$' + creditRequests.reduce((sum, req) => sum + parseFloat(req.expectedCredits || 0), 0).toLocaleString()"></div>
                            <div class="text-xs text-gray-500">Total Requested</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-orange-600" x-text="creditRequests.filter(req => req.status !== 'approved' && req.status !== 'rejected').length"></div>
                            <div class="text-xs text-gray-500">Pending</div>
                        </div>
                        <button @click="showForm = true" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold py-3 px-6 rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all duration-300 transform hover:scale-105 shadow-lg">
                            <i class="fas fa-plus mr-2"></i>New Request
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-8">
            <div x-show="notification" x-transition class="fixed top-6 right-6 z-50" role="alert" aria-live="polite">
                <div :class="{
              'bg-green-600': notificationType==='success',
              'bg-red-500': notificationType==='error',
              'bg-blue-600': notificationType==='info'
            }" class="text-white px-4 py-2 rounded shadow">
                    <span x-text="notification"></span>
                </div>
            </div>

            <div x-show="showForm" x-cloak class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 backdrop-blur-sm">
                <div @click.away="showForm = false" class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto animate-slide-up">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h4 class="text-2xl font-bold text-gray-900">Request AWS Credits</h4>
                            <p class="text-gray-600 mt-1">Submit a new credit application for your AWS account</p>
                        </div>
                        <button @click="showForm = false" class="text-gray-400 hover:text-gray-600 transition-colors" aria-label="Close form">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <form @submit.prevent="submitRequest">
                        <div class="space-y-4">
                            <input type="text" x-model="newRequest.awsAccountId" placeholder="AWS Account ID (e.g., 1234-5678-9012)"
                                   class="w-full p-2 border rounded focus-visible" :class="{'border-red-400': newRequest.awsAccountId && newRequest.awsAccountId.length < 11}"
                                   required aria-required="true"/>
                            <input type="number" x-model="newRequest.expectedCredits" placeholder="Expected Credits ($)"
                                   class="w-full p-2 border rounded focus-visible" :class="{'border-red-400': newRequest.expectedCredits && Number(newRequest.expectedCredits) <= 0}"
                                   required aria-required="true"/>
                            <textarea x-model="newRequest.services" placeholder="AWS Services (e.g., EC2, S3, RDS)"
                                      class="w-full p-2 border rounded focus-visible" rows="3"
                                      :class="{'border-red-400': newRequest.services && newRequest.services.length < 4}"
                                      required aria-required="true"></textarea>
                            <textarea x-model="newRequest.useCase" placeholder="Project Use Case"
                                      class="w-full p-2 border rounded focus-visible" rows="5"
                                      :class="{'border-red-400': newRequest.useCase && newRequest.useCase.length < 6}"
                                      required aria-required="true"></textarea>
                        </div>
                        <div class="mt-8 flex justify-end space-x-4 pt-6 border-t border-gray-200">
                            <button type="button" @click="showForm = false; resetForm()"
                                    class="bg-white text-gray-700 font-semibold py-3 px-6 rounded-xl border-2 border-gray-300 hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 transform hover:scale-105">
                                Cancel
                            </button>
                            <button type="submit" :disabled="!validateForm()"
                                    class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold py-3 px-8 rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all duration-300 transform hover:scale-105 shadow-lg disabled:opacity-50">
                                Submit Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="space-y-6 mt-6">
                <div class="flex items-center space-x-4 mb-6">
                    <select x-model="selectedFilter" class="p-2 border rounded w-48 focus-visible" aria-label="Filter credit requests by status">
                        <option value="all">All Statuses</option>
                        <option value="submitted">Submitted</option>
                        <option value="documentation">Documentation</option>
                        <option value="verification">Verification</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>

                <template x-for="request in filteredRequests" :key="request.id">
                    <div class="bg-white rounded-lg shadow-md p-6 animate-fade-in" :aria-label="'Request ' + request.id + ' for AWS Account ' + request.awsAccountId">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-lg font-semibold">
                                    Request for <span class="font-mono text-indigo-600" x-text="request.awsAccountId"></span>
                                </h4>
                                <p class="text-sm text-gray-500">
                                    ID: <span x-text="request.id"></span> |
                                    Status:
                                    <span class="capitalize font-semibold"
                                          :class="{
                        'text-gray-600': request.status === 'submitted',
                        'text-yellow-600': request.status === 'documentation',
                        'text-blue-600': request.status === 'verification',
                        'text-green-600': request.status === 'approved',
                        'text-red-600': request.status === 'rejected'
                      }"
                                          x-text="request.status"></span>
                                </p>
                            </div>
                            <button @click="advanceStatus(request)" class="bg-gray-200 text-xs font-semibold py-1 px-3 rounded-full hover:bg-gray-300 focus-visible" aria-label="Advance status of request">
                                Advance Status
                            </button>
                        </div>
                        <p><strong>Expected Credits: </strong>$<span x-text="request.expectedCredits"></span></p>
                        <p><strong>Services: </strong><span x-text="request.services"></span></p>
                        <p><strong>Use Case: </strong><span x-text="request.useCase"></span></p>
                    </div>
                </template>

                <div x-show="!creditRequests.length" class="text-center py-16 text-gray-500 font-semibold">
                    You haven't submitted any credit requests yet.
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    fetch('/_sidebar.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('sidebar-container').innerHTML = html;
        Alpine.initTree(document.getElementById('sidebar-container'));
      })
      .catch(error => console.error('Error loading sidebar:', error));
</script>
</body>
</html>
