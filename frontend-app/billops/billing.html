<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>XamOps - Billing Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        [x-cloak] { display: none !important; }
        .loading { text-align: center; padding: 2rem; color: #6b7280; }
        .error { text-align: center; padding: 2rem; color: #dc2626; }
        .success-msg { background-color: #ecfdf5; border-color: #10b981; color: #065f46; }
    </style>
</head>
<body class="bg-gray-100">
<div class="flex h-screen">
    <div id="sidebar-container" class="flex-shrink-0"></div>

    <div class="flex-1 flex flex-col overflow-hidden" x-data="billingDashboard()" x-init="init()">
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-8">
            <div class="flex items-center justify-between mb-8">
                <h3 class="text-gray-900 text-3xl font-bold">Billing Dashboard</h3>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600" x-text="`Account: ${selectedAccountId || 'None selected'}`"></span>
                    <button @click="fetchBillingData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition">
                        <i class="fas fa-sync-alt mr-1"></i>Refresh
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div x-show="loading" class="loading">
                <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                <p class="text-lg">Loading billing data...</p>
            </div>

            <!-- Error State -->
            <div x-show="error" class="error">
                <i class="fas fa-exclamation-triangle text-3xl mb-4"></i>
                <p class="text-lg mb-4" x-text="error"></p>
                <button @click="fetchBillingData()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition">
                    Try Again
                </button>
            </div>

            <!-- Success State - Show charts -->
            <div x-show="!loading && !error && billingData.costHistory && billingData.serviceBreakdown" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Cost History and Details -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Cost History Chart -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between mb-6">
                            <h4 class="font-semibold text-lg text-gray-800">Monthly Cost Trend</h4>
                            <span class="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-full">Last 6 Months</span>
                        </div>
                        <div class="h-80">
                            <canvas id="costHistoryChart"></canvas>
                        </div>
                    </div>

                    <!-- Detailed Billing Table -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h4 class="font-semibold text-lg text-gray-800 mb-6">Service Cost Details</h4>
                        <div x-show="billingData.serviceBreakdown && billingData.serviceBreakdown.length > 0">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Service</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                                    </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                    <template x-for="(service, index) in billingData.serviceBreakdown" :key="service.serviceName || service.name">
                                        <tr :class="index % 2 === 0 ? 'bg-white' : 'bg-gray-50'">
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="flex items-center">
                                                    <div class="w-3 h-3 rounded-full mr-3" :style="`background-color: ${getServiceColor(index)}`"></div>
                                                    <span class="text-sm font-medium text-gray-900" x-text="service.serviceName || service.name || 'Unknown Service'"></span>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900" x-text="`$${(service.cost || 0).toFixed(2)}`"></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="`${getServicePercentage(service.cost)}%`"></td>
                                        </tr>
                                    </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div x-show="!billingData.serviceBreakdown || billingData.serviceBreakdown.length === 0"
                             class="text-center py-12 text-gray-500">
                            <i class="fas fa-chart-pie text-4xl mb-4"></i>
                            <p>No service data available</p>
                        </div>
                    </div>
                </div>

                <!-- Service Breakdown Chart and Summary -->
                <div class="space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h4 class="font-semibold text-lg text-gray-800 mb-6">Service Distribution</h4>
                        <div class="h-80">
                            <canvas id="serviceBreakdownChart"></canvas>
                        </div>
                    </div>

                    <!-- Cost Summary Card -->
                    <div class="bg-gradient-to-br from-blue-500 to-purple-600 p-6 rounded-xl shadow-lg text-white">
                        <h4 class="font-semibold text-lg mb-4">Cost Summary</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span>Total Monthly Cost</span>
                                <span class="text-2xl font-bold" x-text="`$${getTotalCost().toFixed(2)}`"></span>
                            </div>
                            <div class="flex justify-between items-center text-blue-100">
                                <span>Services Count</span>
                                <span class="font-semibold" x-text="(billingData.serviceBreakdown || []).length"></span>
                            </div>
                            <div class="flex justify-between items-center text-blue-100">
                                <span>Data Period</span>
                                <span class="font-semibold">6 Months</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Debug Toggle -->
            <button @click="debugMode = !debugMode"
                    class="fixed bottom-4 right-4 bg-gray-600 text-white p-3 rounded-full shadow-lg hover:bg-gray-700 transition">
                <i class="fas fa-bug"></i>
            </button>

            <!-- Debug Info -->
            <div x-show="debugMode" class="fixed bottom-16 right-4 bg-yellow-50 p-4 rounded-lg shadow-lg border max-w-sm">
                <h5 class="font-semibold mb-2">Debug Info</h5>
                <div class="text-xs space-y-1">
                    <p><span class="font-medium">Account ID:</span> <span x-text="selectedAccountId"></span></p>
                    <p><span class="font-medium">API URL:</span> <span x-text="`/api/billing/billing/${selectedAccountId}`"></span></p>
                    <p><span class="font-medium">Cost History:</span> <span x-text="(billingData.costHistory || []).length"></span> items</p>
                    <p><span class="font-medium">Services:</span> <span x-text="(billingData.serviceBreakdown || []).length"></span> items</p>
                </div>
                <button @click="debugMode = false" class="mt-2 text-xs bg-gray-500 text-white px-2 py-1 rounded">Close</button>
            </div>
        </main>
    </div>
</div>

<script>
    function billingDashboard() {
        return {
            billingData: { costHistory: [], serviceBreakdown: [] },
            selectedAccountId: null,
            loading: true,
            error: null,
            debugMode: false,
            costHistoryChart: null,
            serviceBreakdownChart: null,

            init() {
                this.loadSidebar();
                const urlParams = new URLSearchParams(window.location.search);
                this.selectedAccountId = urlParams.get('accountIds');

                console.log('Initialized billing dashboard with account ID:', this.selectedAccountId);

                if (this.selectedAccountId) {
                    this.fetchBillingData();
                } else {
                    this.error = 'No AWS account selected. Please select an account from the sidebar.';
                    this.loading = false;
                }
            },

            async fetchBillingData() {
                if (!this.selectedAccountId) return;

                this.loading = true;
                this.error = null;

                try {
                    console.log('Fetching billing data for account:', this.selectedAccountId);

                    // Using relative URL for Vite proxy to work
                    const response = await fetch(`/api/billing/billing/${this.selectedAccountId}`);

                    console.log('API Response status:', response.status);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: Failed to fetch billing data`);
                    }

                    const data = await response.json();
                    console.log('Received billing data:', data);

                    this.billingData = data || { costHistory: [], serviceBreakdown: [] };

                    // Wait for DOM updates before initializing charts
                    this.$nextTick(() => {
                        this.initCharts();
                    });

                } catch (error) {
                    console.error("Error fetching billing data:", error);
                    this.error = `Failed to load billing data: ${error.message}`;
                } finally {
                    this.loading = false;
                }
            },

            initCharts() {
                if (this.billingData.costHistory && this.billingData.costHistory.length > 0) {
                    this.initCostHistoryChart(this.billingData.costHistory);
                }

                if (this.billingData.serviceBreakdown && this.billingData.serviceBreakdown.length > 0) {
                    this.initServiceBreakdownChart(this.billingData.serviceBreakdown);
                }
            },

            initCostHistoryChart(history) {
                const ctx = document.getElementById('costHistoryChart');
                if (!ctx) return;

                if (this.costHistoryChart) {
                    this.costHistoryChart.destroy();
                }

                this.costHistoryChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: history.map(h => {
                            try {
                                const date = new Date(h.date);
                                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                            } catch (e) {
                                return h.date;
                            }
                        }),
                        datasets: [{
                            label: 'Monthly Cost ($)',
                            data: history.map(h => h.cost || 0),
                            backgroundColor: '#3b82f6',
                            borderColor: '#1d4ed8',
                            borderWidth: 1,
                            borderRadius: 6,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Cost: $' + context.parsed.y.toLocaleString();
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            },

            initServiceBreakdownChart(services) {
                const ctx = document.getElementById('serviceBreakdownChart');
                if (!ctx) return;

                if (this.serviceBreakdownChart) {
                    this.serviceBreakdownChart.destroy();
                }

                const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'];

                this.serviceBreakdownChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: services.map(s => s.serviceName || s.name || 'Unknown Service'),
                        datasets: [{
                            data: services.map(s => s.cost || 0),
                            backgroundColor: colors.slice(0, services.length),
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: $${value.toLocaleString()} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            },

            getTotalCost() {
                if (!this.billingData.serviceBreakdown || this.billingData.serviceBreakdown.length === 0) {
                    return 0;
                }
                return this.billingData.serviceBreakdown.reduce((total, service) => total + (service.cost || 0), 0);
            },

            getServicePercentage(cost) {
                const total = this.getTotalCost();
                return total > 0 ? ((cost / total) * 100).toFixed(1) : 0;
            },

            getServiceColor(index) {
                const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'];
                return colors[index % colors.length];
            },

            loadSidebar() {
                fetch('/_sidebar.html')
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('sidebar-container').innerHTML = html;
                        if (window.Alpine) {
                            Alpine.initTree(document.getElementById('sidebar-container'));
                        }
                    })
                    .catch(error => console.error('Error loading sidebar:', error));
            }
        }
    }
</script>

</body>
</html>
