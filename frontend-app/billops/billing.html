<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>XamOps - Billing Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        [x-cloak] { display: none !important; }
        .loading { text-align: center; padding: 2rem; color: #6b7280; }
        .error { text-align: center; padding: 2rem; color: #dc2626; }
        .expand-icon { transition: transform 0.2s ease-in-out; }
        .rotate-90 { transform: rotate(90deg); }
    </style>
</head>
<body class="bg-gray-100">
<div class="flex h-screen">
    <div id="sidebar-container" class="flex-shrink-0"></div>

    <main class="flex-1 p-6 md:p-8 overflow-y-auto">
        <div x-data="billingDashboard()" x-init="init()" x-cloak>
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Billing Dashboard</h1>
                    <div class="flex items-center space-x-2">
                        <select x-model="selectedYear" @change="fetchAllData()" class="bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <template x-for="year in availableYears" :key="year">
                                <option :value="year" x-text="year"></option>
                            </template>
                        </select>
                        <select x-model="selectedMonth" @change="fetchAllData()" class="bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <template x-for="month in availableMonths" :key="month.value">
                                <option :value="month.value" x-text="month.name"></option>
                            </template>
                        </select>
                    </div>
                </div>

                <div x-show="loading" class="loading">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Loading billing data...</p>
                </div>
                <div x-show="error" class="error" x-text="error"></div>

                <div x-show="!loading && !error">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-xl font-semibold text-gray-700 mb-4">Cost Over Time</h2>
                            <div class="h-64"><canvas id="costHistoryChart"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-xl font-semibold text-gray-700 mb-4">Service Breakdown</h2>
                            <div class="h-64"><canvas id="serviceBreakdownChart"></canvas></div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <h2 class="text-xl font-semibold text-gray-700 p-6">Detailed Cost Breakdown</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th colspan="2" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Usage Quantity</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount in USD</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <template x-for="service in detailedBreakdown" :key="service.serviceName">
                                        <tbody>
                                            <tr @click="toggleService(service.serviceName)" class="cursor-pointer hover:bg-gray-50">
                                                <td class="pl-4 pr-3 py-3 w-8">
                                                    <i class="fas fa-chevron-right text-gray-400 expand-icon" :class="{ 'rotate-90': expandedServices[service.serviceName] }"></i>
                                                </td>
                                                <td class="px-3 py-3 whitespace-nowrap">
                                                    <div class="text-sm font-semibold text-gray-900" x-text="service.serviceName"></div>
                                                </td>
                                                <td class="px-6 py-3"></td>
                                                <td class="px-6 py-3 whitespace-nowrap text-right">
                                                    <div class="text-sm text-gray-800 font-bold" x-text="formatCurrency(service.totalCost)"></div>
                                                </td>
                                            </tr>
                                            <tr x-show="expandedServices[service.serviceName]" style="display: none;">
                                                <td colspan="4" class="p-0 bg-gray-50/50">
                                                    <div class="p-2">
                                                        <table class="min-w-full">
                                                            <tbody>
                                                                <template x-for="region in service.regionCosts" :key="region.regionName">
                                                                    <tbody>
                                                                        <tr @click="toggleRegion(service.serviceName, region.regionName)" class="cursor-pointer hover:bg-gray-100">
                                                                            <td class="pl-8 pr-3 py-2 w-8">
                                                                                <i class="fas fa-chevron-right text-gray-400 expand-icon text-xs" :class="{ 'rotate-90': expandedRegions[`${service.serviceName}-${region.regionName}`] }"></i>
                                                                            </td>
                                                                            <td class="px-3 py-2 whitespace-nowrap">
                                                                                <div class="text-sm text-gray-700" x-text="region.regionName"></div>
                                                                            </td>
                                                                            <td class="px-6 py-2"></td>
                                                                            <td class="px-6 py-2 whitespace-nowrap text-right">
                                                                                <div class="text-sm text-gray-600 font-medium" x-text="formatCurrency(region.cost)"></div>
                                                                            </td>
                                                                        </tr>
                                                                        <tr x-show="expandedRegions[`${service.serviceName}-${region.regionName}`]" style="display: none;">
                                                                            <td colspan="4" class="p-0">
                                                                                <div class="pl-16 pr-4 py-1">
                                                                                    <table class="min-w-full">
                                                                                        <tbody class="divide-y divide-gray-200/50">
                                                                                            <template x-for="resource in region.resources" :key="resource.resourceId">
                                                                                                <tr class="text-sm">
                                                                                                    <td class="w-8"></td>
                                                                                                    <td class="py-2 pr-3 whitespace-nowrap text-gray-600">
                                                                                                        <div x-text="resource.resourceName"></div>
                                                                                                    </td>
                                                                                                    <td class="py-2 px-6 whitespace-nowrap text-right text-gray-500" x-text="`${formatNumber(resource.quantity)} ${resource.unit}`"></td>
                                                                                                    <td class="py-2 px-6 whitespace-nowrap text-right text-gray-700" x-text="formatCurrency(resource.cost)"></td>
                                                                                                </tr>
                                                                                            </template>
                                                                                        </tbody>
                                                                                    </table>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                    </tbody>
                                                                </template>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </template>
                                </tbody>
                                <tbody x-show="detailedBreakdown.length === 0">
                                    <tr>
                                        <td colspan="4" class="text-center py-10 text-gray-500">No detailed cost data available for the selected period.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    function billingDashboard() {
        return {
            loading: true,
            error: null,
            accountId: null,
            selectedYear: new Date().getFullYear(),
            selectedMonth: new Date().getMonth() + 1,
            availableYears: [new Date().getFullYear(), new Date().getFullYear() - 1],
            availableMonths: [
                { value: 1, name: 'Jan' }, { value: 2, name: 'Feb' }, { value: 3, name: 'Mar' },
                { value: 4, name: 'Apr' }, { value: 5, name: 'May' }, { value: 6, name: 'Jun' },
                { value: 7, name: 'Jul' }, { value: 8, name: 'Aug' }, { value: 9, name: 'Sep' },
                { value: 10, name: 'Oct' }, { value: 11, name: 'Nov' }, { value: 12, name: 'Dec' }
            ],
            billingData: { costHistory: [], serviceBreakdown: [] },
            detailedBreakdown: [],
            expandedServices: {},
            expandedRegions: {},
            costHistoryChart: null,
            serviceBreakdownChart: null,

            init() {
                this.loadSidebar();
                const urlParams = new URLSearchParams(window.location.search);
                this.accountId = urlParams.get('accountId') || urlParams.get('accountIds');

                if (!this.accountId) {
                    this.error = "No AWS Account ID specified in the URL.";
                    this.loading = false;
                    return;
                }
                this.fetchAllData();
            },

            fetchAllData() {
                this.loading = true;
                this.error = null;

                const summaryUrl = `/api/billops/billing/${this.accountId}?year=${this.selectedYear}&month=${this.selectedMonth}`;
                const detailedUrl = `/api/billops/detailed-breakdown/${this.accountId}?year=${this.selectedYear}&month=${this.selectedMonth}`;

                Promise.all([
                    fetch(summaryUrl).then(res => res.ok ? res.json() : Promise.reject('Failed to fetch summary data')),
                    fetch(detailedUrl).then(res => res.ok ? res.json() : Promise.reject('Failed to fetch detailed breakdown'))
                ])
                .then(([summaryData, detailedData]) => {
                    this.billingData = summaryData;
                    this.detailedBreakdown = detailedData;
                    this.renderCharts(summaryData.costHistory, summaryData.serviceBreakdown);
                })
                .catch(err => {
                    console.error("Data fetching error:", err);
                    this.error = typeof err === 'string' ? err : 'An unknown error occurred.';
                })
                .finally(() => {
                    this.loading = false;
                });
            },

            renderCharts(history, services) {
                const historyCtx = document.getElementById('costHistoryChart').getContext('2d');
                if (this.costHistoryChart) this.costHistoryChart.destroy();
                this.costHistoryChart = new Chart(historyCtx, {
                    type: 'line',
                    data: {
                        labels: history.map(h => new Date(h.date).toLocaleString('default', { month: 'short' })),
                        datasets: [{ label: 'Monthly Cost', data: history.map(h => h.cost), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.3 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                const serviceCtx = document.getElementById('serviceBreakdownChart').getContext('2d');
                if (this.serviceBreakdownChart) this.serviceBreakdownChart.destroy();
                this.serviceBreakdownChart = new Chart(serviceCtx, {
                    type: 'doughnut',
                    data: {
                        labels: services.map(s => s.name),
                        datasets: [{ label: 'Cost', data: services.map(s => s.cost || 0), backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#6366f1', '#ec4899'], borderWidth: 2, borderColor: '#ffffff' }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            },

            formatCurrency(value) {
                if (typeof value !== 'number') return '$0.00';
                return value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            },
            
            formatNumber(value) {
                if (typeof value !== 'number') return '0';
                return value.toLocaleString('en-US', { maximumFractionDigits: 3 });
            },

            toggleService(serviceName) {
                this.expandedServices[serviceName] = !this.expandedServices[serviceName];
            },

            toggleRegion(serviceName, regionName) {
                const key = `${serviceName}-${regionName}`;
                this.expandedRegions[key] = !this.expandedRegions[key];
            },

            loadSidebar() {
                fetch('/_sidebar.html')
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('sidebar-container').innerHTML = html;
                        if (window.Alpine) Alpine.initTree(document.getElementById('sidebar-container'));
                    });
            }
        }
    }
    
    document.addEventListener('alpine:init', () => {
        Alpine.data('billingDashboard', billingDashboard);
    });
</script>
</body>
</html>