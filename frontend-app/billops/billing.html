<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>XamOps - Billing Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        [x-cloak] { display: none !important; }
        .loading { text-align: center; padding: 2rem; color: #6b7280; }
        .error { text-align: center; padding: 2rem; color: #dc2626; }
        .expand-icon { transition: transform 0.2s ease-in-out; }
        .rotate-90 { transform: rotate(90deg); }
    </style>
</head>
<body class="bg-gray-100">
<div class="flex h-screen">
    <div id="sidebar-container" class="flex-shrink-0"></div>

    <div class="flex-1 flex flex-col overflow-hidden" x-data="billingDashboard()" x-init="init()">
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-8">
            <div class="flex items-center justify-between mb-8">
                <h3 class="text-gray-900 text-3xl font-bold">Billing Dashboard</h3>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600" x-text="`Account: ${selectedAccountId || 'None selected'}`"></span>
                    <button @click="fetchBillingData(true)" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition" :disabled="loading || detailedLoading">
                        <i class="fas fa-sync-alt mr-1" :class="{'fa-spin': loading || detailedLoading}"></i>Refresh
                    </button>
                </div>
            </div>

            <div x-show="loading" class="loading" x-cloak>
                <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                <p class="text-lg">Loading billing data...</p>
            </div>

            <div x-show="error" class="error" x-cloak>
                <i class="fas fa-exclamation-triangle text-3xl mb-4"></i>
                <p class="text-lg mb-4" x-text="error"></p>
                <button @click="fetchBillingData(true)" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition">
                    Try Again
                </button>
            </div>

            <div x-show="!loading && !error" class="space-y-8" x-cloak>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h4 class="font-semibold text-gray-500">Month-to-Date Spend</h4>
                            <p class="text-3xl font-bold text-gray-800 mt-2" x-text="formatCurrency(billingData.monthToDateSpend)"></p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h4 class="font-semibold text-gray-500">Last Month Spend</h4>
                            <p class="text-3xl font-bold text-gray-800 mt-2" x-text="formatCurrency(billingData.lastMonthSpend)"></p>
                        </div>
                        <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                             <div class="flex items-center justify-between mb-6">
                                <h4 class="font-semibold text-lg text-gray-800">Monthly Cost Trend</h4>
                                <span class="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-full">Last 6 Months</span>
                            </div>
                            <div class="h-64"><canvas id="costHistoryChart"></canvas></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h4 class="font-semibold text-lg text-gray-800 mb-6">Service Distribution</h4>
                        <div class="h-96"><canvas id="serviceBreakdownChart"></canvas></div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h4 class="font-semibold text-lg text-gray-800 mb-6">Detailed Cost Breakdown</h4>
                     <div x-show="detailedLoading" class="loading" x-cloak>
                        <i class="fas fa-spinner fa-spin text-2xl"></i>
                        <p>Loading detailed breakdown...</p>
                    </div>
                    <div x-show="!detailedLoading && detailedBreakdown.length === 0" class="text-center py-12 text-gray-500" x-cloak>
                        <i class="fas fa-file-invoice-dollar text-4xl mb-4"></i>
                        <p>No detailed cost data available for this period.</p>
                    </div>

                    <div x-show="!detailedLoading && detailedBreakdown.length > 0" class="overflow-x-auto" x-cloak>
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Cost (USD)</th>
                                </tr>
                            </thead>
<tbody class="bg-white divide-y divide-gray-200">
    <template x-for="service in detailedBreakdown" :key="service.serviceName">
        <template>
            <tr @click="toggleService(service.serviceName)" class="cursor-pointer hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <i class="fas fa-chevron-right fa-fw text-gray-400 mr-2 expand-icon"
                           :class="{'rotate-90': expandedServices[service.serviceName]}"></i>
                        <span class="text-sm font-bold text-gray-900" x-text="service.serviceName"></span>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-gray-900"
                    x-text="formatCurrency(service.totalCost)"></td>
            </tr>

            <template x-for="region in service.regionCosts" :key="region.regionName">
                <template>
                    <tr x-show="expandedServices[service.serviceName]"
                        @click="toggleRegion(service.serviceName, region.regionName)"
                        class="cursor-pointer hover:bg-gray-100">
                        <td class="pl-12 pr-6 py-3 whitespace-nowrap">
                            <div class="flex items-center">
                                <i class="fas fa-chevron-right fa-fw text-gray-400 mr-2 expand-icon"
                                   :class="{'rotate-90': expandedRegions[service.serviceName + '-' + region.regionName]}"></i>
                                <span class="text-sm font-medium text-gray-700" x-text="region.regionName"></span>
                            </div>
                        </td>
                        <td class="px-6 py-3 whitespace-nowrap text-right text-sm font-medium text-gray-700"
                            x-text="formatCurrency(region.cost)"></td>
                    </tr>

                    <template x-for="resource in region.resources" :key="resource.resourceId">
                        <tr x-show="expandedServices[service.serviceName] && expandedRegions[service.serviceName + '-' + region.regionName]">
                            <td class="pl-20 pr-6 py-2 whitespace-nowrap">
                                <div class="text-sm text-gray-500 truncate"
                                     x-text="resource.resourceName"
                                     :title="resource.resourceId"></div>
                            </td>
                            <td class="px-6 py-2 whitespace-nowrap text-right text-sm text-gray-500"
                                x-text="formatCurrency(resource.cost)"></td>
                        </tr>
                    </template>
                </template>
            </template>
        </template>
    </template>
</tbody>

                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    function billingDashboard() {
        return {
            billingData: { costHistory: [], serviceBreakdown: [], monthToDateSpend: 0, lastMonthSpend: 0 },
            detailedBreakdown: [],
            selectedAccountId: null,
            loading: true,
            detailedLoading: true,
            error: null,
            costHistoryChart: null,
            serviceBreakdownChart: null,
            expandedServices: {},
            expandedRegions: {},

            init() {
                this.loadSidebar();
                const urlParams = new URLSearchParams(window.location.search);
                this.selectedAccountId = urlParams.get('accountIds')?.split(',')[0]; // Use the first account for this page

                if (this.selectedAccountId) {
                    this.fetchBillingData();
                } else {
                    this.error = 'No AWS account selected. Please select an account from the sidebar.';
                    this.loading = false;
                    this.detailedLoading = false;
                }
            },

            fetchBillingData(forceRefresh = false) {
                if (!this.selectedAccountId) return;
                this.loading = true;
                this.detailedLoading = true;
                this.error = null;

                const summaryUrl = `/api/billops/billing/${this.selectedAccountId}`;
                const detailUrl = `/api/billops/detailed-breakdown/${this.selectedAccountId}`;

                Promise.all([fetch(summaryUrl), fetch(detailUrl)])
                    .then(async ([summaryRes, detailRes]) => {
                        if (!summaryRes.ok) throw new Error(`Summary API Error: ${summaryRes.statusText}`);
                        if (!detailRes.ok) throw new Error(`Detail API Error: ${detailRes.statusText}`);

                        const summaryData = await summaryRes.json();
                        const detailData = await detailRes.json();

                        // ### THIS IS THE NEW LINE ###
                        console.log("Data received for Detailed Breakdown:", detailData);

                        this.billingData = this.processSummaryData(summaryData);
                        this.detailedBreakdown = detailData.sort((a,b) => b.totalCost - a.totalCost) || [];

                        this.$nextTick(() => {
                            this.initCharts();
                        });
                    })
                    .catch(error => {
                        console.error("Error fetching billing data:", error);
                        this.error = `Failed to load billing data: ${error.message}`;
                    })
                    .finally(() => {
                        this.loading = false;
                        this.detailedLoading = false;
                    });
            },

            processSummaryData(data) {
                const processed = { ...data };
                if (data.costHistory && data.costHistory.length > 0) {
                    processed.monthToDateSpend = data.costHistory[data.costHistory.length - 1]?.cost || 0;
                    processed.lastMonthSpend = data.costHistory[data.costHistory.length - 2]?.cost || 0;
                } else {
                    processed.monthToDateSpend = 0;
                    processed.lastMonthSpend = 0;
                }
                return processed;
            },

            initCharts() {
                if (this.billingData.costHistory && this.billingData.costHistory.length > 0) {
                    this.initCostHistoryChart(this.billingData.costHistory);
                }
                if (this.billingData.serviceBreakdown && this.billingData.serviceBreakdown.length > 0) {
                    this.initServiceBreakdownChart(this.billingData.serviceBreakdown);
                }
            },

            initCostHistoryChart(history) {
                const ctx = document.getElementById('costHistoryChart');
                if (!ctx) return;
                if (this.costHistoryChart) this.costHistoryChart.destroy();
                this.costHistoryChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: history.map(h => new Date(h.date).toLocaleDateString('en-US', { month: 'short', year: '2-digit' })),
                        datasets: [{
                            label: 'Monthly Cost ($)',
                            data: history.map(h => h.cost || 0),
                            backgroundColor: '#3b82f6',
                            borderColor: '#1d4ed8',
                            borderWidth: 1,
                            borderRadius: 6,
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            },

            initServiceBreakdownChart(services) {
                const ctx = document.getElementById('serviceBreakdownChart');
                if (!ctx) return;
                if (this.serviceBreakdownChart) this.serviceBreakdownChart.destroy();
                this.serviceBreakdownChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: services.map(s => s.name || 'Unknown'),
                        datasets: [{
                            data: services.map(s => s.cost || 0),
                            backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#6366f1', '#ec4899'],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            },

            formatCurrency(value) {
                if (typeof value !== 'number') return '$0.00';
                return value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            },

            toggleService(serviceName) {
                this.expandedServices[serviceName] = !this.expandedServices[serviceName];
            },

            toggleRegion(serviceName, regionName) {
                const key = `${serviceName}-${regionName}`;
                this.expandedRegions[key] = !this.expandedRegions[key];
            },

            loadSidebar() {
                fetch('/_sidebar.html')
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('sidebar-container').innerHTML = html;
                        if (window.Alpine) Alpine.initTree(document.getElementById('sidebar-container'));
                    });
            }
        }
    }
</script>

</body>
</html>