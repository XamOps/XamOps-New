<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XamOps - Agreement Administration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="/icons/XamOps.png" sizes="32x32" type="image/png">
    <link rel="apple-touch-icon" href="/icons/XamOps.png">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module" src="/src/main.js"></script>
</head>

<body class="bg-gray-100 font-sans leading-normal tracking-normal">

    <div class="flex h-screen overflow-hidden">
        <include file="/_sidebar.html"></include>

        <div class="flex-1 flex flex-col overflow-hidden pl-64">
            <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-6"
                x-data="agreementAdmin()">

                <style>
                    [x-cloak] {
                        display: none !important;
                    }

                    .drag-active {
                        border-color: #4f46e5;
                        background-color: #eef2ff;
                    }
                </style>

                <header
                    class="bg-white shadow p-4 border-b border-gray-200 flex justify-between items-center z-10 mb-8 rounded-lg">
                    <div class="flex items-center">
                        <h2 class="text-2xl font-bold text-gray-800">Agreement Administration</h2>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-sm text-gray-600 font-medium"
                            x-text="accountName ? `Account: ${accountName}` : 'Select an Account'"></div>
                    </div>
                </header>

                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-8" x-show="accountId">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2 flex items-center">
                        <i class="fas fa-file-upload text-indigo-500 mr-2"></i> Upload New Agreement
                    </h3>

                    <div class="flex flex-col md:flex-row gap-4 items-end">
                        <div class="flex-1 w-full">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Document
                                (PDF/Doc)</label>
                            <input type="file" x-ref="fileInput" @change="handleFileSelect" accept=".pdf,.doc,.docx"
                                class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
                        </div>
                        <button @click="uploadAgreement()" :disabled="!selectedFile || uploading"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded shadow flex items-center transition-colors disabled:opacity-50 disabled:cursor-not-allowed h-10">
                            <span x-show="uploading"><i class="fas fa-spinner fa-spin mr-2"></i>Uploading...</span>
                            <span x-show="!uploading"><i class="fas fa-cloud-upload-alt mr-2"></i>Upload Draft</span>
                        </button>
                    </div>
                    <p x-show="uploadError" class="text-red-500 text-sm mt-2" x-text="uploadError"></p>
                    <p x-show="uploadSuccess" class="text-green-600 text-sm mt-2">File uploaded successfully!</p>
                </div>

                <div x-show="!accountId" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r shadow-sm">
                    <div class="flex">
                        <div class="flex-shrink-0"><i class="fas fa-exclamation-circle text-yellow-400"></i></div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                Please select a Cloud Account from the sidebar to manage agreements.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden" x-show="accountId">
                    <div x-show="loading" class="p-6 text-center text-gray-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i> Loading agreements...
                    </div>

                    <table x-show="!loading" class="min-w-full divide-y divide-gray-200" x-cloak>
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    File Name</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Uploaded At</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Uploaded By</th>
                                <th
                                    class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Status</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="agreement in agreements" :key="agreement.id">
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <i class="fas fa-file-pdf text-red-500 mr-3 text-lg"></i>
                                            <span class="text-sm font-medium text-gray-900"
                                                x-text="agreement.fileName"></span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                        x-text="formatDate(agreement.uploadedAt)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                        x-text="agreement.uploadedBy || 'Unknown'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center">
                                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full"
                                            :class="agreement.status === 'FINALIZED' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'">
                                            <span x-text="agreement.status"></span>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                        <a :href="agreement.downloadUrl" target="_blank"
                                            class="text-indigo-600 hover:text-indigo-900" title="View">
                                            <i class="fas fa-eye"></i>
                                        </a>

                                        <button x-show="agreement.status === 'DRAFT'"
                                            @click="finalizeAgreement(agreement)"
                                            class="text-green-600 hover:text-green-900" title="Finalize">
                                            <i class="fas fa-check-circle"></i>
                                        </button>

                                        <button @click="deleteAgreement(agreement)"
                                            class="text-red-600 hover:text-red-900" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="!loading && agreements.length === 0">
                                <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                                    <i class="fas fa-folder-open text-4xl text-gray-300 mb-3"></i>
                                    <p>No agreements found for this account.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <script>
                    function agreementAdmin() {
                        return {
                            accountId: null,
                            accountName: '',
                            agreements: [],
                            loading: false,
                            selectedFile: null,
                            uploading: false,
                            uploadError: null,
                            uploadSuccess: false,

                            init() {
                                const urlParams = new URLSearchParams(window.location.search);
                                const ids = urlParams.get('accountIds') || urlParams.get('accountId');

                                if (ids) {
                                    this.accountId = ids.split(',')[0];
                                    this.fetchAccountDetails();
                                    this.fetchAgreements();
                                }

                                // Listen for sidebar account changes
                                window.addEventListener('account-changed', (e) => {
                                    if (e.detail && e.detail.accountId) {
                                        this.accountId = e.detail.accountId;
                                        this.fetchAccountDetails();
                                        this.fetchAgreements();
                                    }
                                });
                            },

                            fetchAccountDetails() {
                                // Optional: Fetch account name from your existing account API to display nicely
                                // For now, we assume sidebar handles context
                                const accounts = JSON.parse(sessionStorage.getItem('cached_accounts') || '[]');
                                const acc = accounts.find(a => String(a.id) === String(this.accountId));
                                if (acc) this.accountName = acc.name;
                            },

                            fetchAgreements() {
                                if (!this.accountId) return;
                                this.loading = true;
                                fetch(`/api/billops/agreements/account/${this.accountId}`)
                                    .then(res => res.json())
                                    .then(data => {
                                        this.agreements = data;
                                    })
                                    .catch(err => console.error("Error fetching agreements:", err))
                                    .finally(() => this.loading = false);
                            },

                            handleFileSelect(event) {
                                this.selectedFile = event.target.files[0];
                                this.uploadError = null;
                                this.uploadSuccess = false;
                            },

                            uploadAgreement() {
                                if (!this.selectedFile || !this.accountId) return;

                                this.uploading = true;
                                const formData = new FormData();
                                formData.append('file', this.selectedFile);
                                formData.append('accountId', this.accountId);

                                fetch('/api/billops/agreements/upload', {
                                    method: 'POST',
                                    body: formData
                                    // Note: Do NOT set Content-Type header manually for FormData, browser does it with boundary
                                })
                                    .then(async res => {
                                        if (!res.ok) throw new Error(await res.text());
                                        return res.json();
                                    })
                                    .then(data => {
                                        this.uploadSuccess = true;
                                        this.selectedFile = null;
                                        this.$refs.fileInput.value = ''; // Reset input
                                        this.fetchAgreements();
                                        setTimeout(() => this.uploadSuccess = false, 3000);
                                    })
                                    .catch(err => {
                                        this.uploadError = "Upload failed: " + err.message;
                                    })
                                    .finally(() => this.uploading = false);
                            },

                            finalizeAgreement(agreement) {
                                if (!confirm(`Are you sure you want to finalize "${agreement.fileName}"? This will make it visible to the user.`)) return;

                                fetch(`/api/billops/agreements/${agreement.id}/finalize`, { method: 'PUT' })
                                    .then(res => {
                                        if (!res.ok) throw new Error("Failed to finalize");
                                        this.fetchAgreements();
                                    })
                                    .catch(err => alert(err.message));
                            },

                            deleteAgreement(agreement) {
                                if (!confirm(`Delete "${agreement.fileName}"? This cannot be undone.`)) return;

                                fetch(`/api/billops/agreements/${agreement.id}`, { method: 'DELETE' })
                                    .then(res => {
                                        if (!res.ok) throw new Error("Failed to delete");
                                        this.fetchAgreements();
                                    })
                                    .catch(err => alert(err.message));
                            },

                            formatDate(dateString) {
                                if (!dateString) return '-';
                                return new Date(dateString).toLocaleDateString('en-US', {
                                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                                });
                            }
                        }
                    }
                </script>
            </main>
        </div>
    </div>
</body>

</html>