<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Details</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="icon" href="/icons/XamOps.png" sizes="32x32" type="image/png">
    <link rel="apple-touch-icon" href="/icons/XamOps.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module" src="/src/main.js"></script>
</head>

<body class="bg-gray-100 font-sans">

    <div class="flex h-screen overflow-hidden">
        <include file="/_sidebar.html"></include>

        <main id="main-content" class="flex-1 flex flex-col min-w-0 overflow-hidden pl-64" x-data="ticketDetailApp()"
            x-init="init()">

            <style>
                [x-cloak] {
                    display: none !important;
                }

                /* Quill Overrides */
                .ql-editor {
                    min-height: 120px;
                    font-family: 'Inter', sans-serif;
                    font-size: 0.95rem;
                }

                .ql-toolbar {
                    border-radius: 0.5rem 0.5rem 0 0;
                    border-color: #e5e7eb !important;
                    background-color: #f9fafb;
                }

                .ql-container {
                    border-radius: 0 0 0.5rem 0.5rem;
                    border-color: #e5e7eb !important;
                    font-size: 1rem;
                }

                .ql-editor ul {
                    list-style-type: disc !important;
                    padding-left: 1.5em !important;
                }

                .ql-editor ol {
                    list-style-type: decimal !important;
                    padding-left: 1.5em !important;
                }

                /* Chat Bubble Content Styling */
                .prose-chat {
                    max-width: none;
                    font-size: 0.95rem;
                    line-height: 1.5;
                }

                .prose-chat p {
                    margin-bottom: 0.5em;
                }

                .prose-chat p:last-child {
                    margin-bottom: 0;
                }

                .prose-chat ul,
                .prose-chat ol {
                    margin-top: 0.5em;
                    margin-bottom: 0.5em;
                }

                /* Inverse prose for user bubbles (white text) */
                .prose-chat-inverse {
                    color: white;
                }

                .prose-chat-inverse a {
                    color: #bfdbfe;
                    text-decoration: underline;
                }

                .prose-chat-inverse strong {
                    color: white;
                    font-weight: 700;
                }

                .prose-chat-inverse code {
                    color: #1e40af;
                    background-color: #dbeafe;
                    border-radius: 0.25rem;
                    padding: 0.125rem 0.25rem;
                }
            </style>

            <header class="bg-white shadow-sm z-10 border-b border-gray-200 px-6 py-4">
                <div class="max-w-5xl mx-auto flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <a href="/billops/tickets.html" class="text-gray-500 hover:text-indigo-600 transition">
                            <i class="fas fa-arrow-left"></i> Back to Tickets
                        </a>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900 flex items-center gap-3">
                                <span x-text="ticket ? ticket.subject : 'Loading...'"></span>
                                <span x-show="ticket"
                                    class="px-2.5 py-0.5 rounded-full text-xs font-medium uppercase tracking-wide"
                                    :class="{
                                        'bg-green-100 text-green-800': ticket && ticket.status === 'OPEN',
                                        'bg-yellow-100 text-yellow-800': ticket && ticket.status === 'IN_PROGRESS',
                                        'bg-gray-100 text-gray-800': ticket && ticket.status === 'CLOSED'
                                    }" x-text="ticket ? ticket.status : ''">
                                </span>
                            </h1>
                            <p class="text-xs text-gray-500 mt-1" x-show="ticket">
                                <span x-text="'#' + ticket.id"></span> &bull;
                                <span x-text="ticket.service"></span> &bull;
                                <span x-text="formatDate(ticket.createdAt)"></span>
                            </p>
                        </div>
                    </div>
                    <button x-show="ticket && ticket.status !== 'CLOSED'" @click="closeTicket()"
                        class="text-gray-500 hover:text-red-600 text-sm font-medium transition flex items-center gap-2">
                        <i class="far fa-times-circle"></i> Close Ticket
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto bg-gray-100 p-6 scroll-smooth" id="chat-container">
                <div class="max-w-5xl mx-auto space-y-6 pb-6">

                    <div x-show="loading" class="flex justify-center py-10">
                        <i class="fas fa-spinner fa-spin text-3xl text-indigo-600"></i>
                    </div>

                    <div x-show="!loading && ticket" x-cloak class="space-y-8">

                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0">
                                    <div
                                        class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold">
                                        <i class="fas fa-ticket-alt"></i>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-baseline mb-2">
                                        <h3 class="text-sm font-semibold text-gray-900">Ticket Description</h3>
                                        <span class="text-xs text-gray-400">Original Request</span>
                                    </div>
                                    <div class="prose prose-sm max-w-none text-gray-700" x-text="ticket.description">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="relative flex items-center justify-center py-2">
                            <div class="absolute inset-0 flex items-center">
                                <div class="w-full border-t border-gray-300"></div>
                            </div>
                            <span
                                class="relative bg-gray-100 px-4 text-xs text-gray-500 font-medium uppercase tracking-widest">Discussion
                                History</span>
                        </div>

                        <template x-for="reply in ticket.replies" :key="reply.id">
                            <div class="flex w-full" :class="isMe(reply) ? 'justify-end' : 'justify-start'">

                                <div class="flex max-w-[85%] md:max-w-[75%] gap-3"
                                    :class="isMe(reply) ? 'flex-row-reverse' : 'flex-row'">

                                    <div class="flex-shrink-0 mt-auto">
                                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold shadow-sm"
                                            :class="reply.admin ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-200 text-gray-600'">
                                            <template x-if="reply.admin">
                                                <i class="fas fa-headset"></i>
                                            </template>
                                            <template x-if="!reply.admin">
                                                <span x-text="getInitials(reply.authorUsername)"></span>
                                            </template>
                                        </div>
                                    </div>

                                    <div>
                                        <div class="flex items-center gap-2 mb-1 px-1"
                                            :class="isMe(reply) ? 'justify-end' : 'justify-start'">
                                            <span class="text-xs font-semibold text-gray-600"
                                                x-text="reply.admin ? 'Support Agent' : reply.authorUsername"></span>
                                            <span class="text-[10px] text-gray-400"
                                                x-text="formatDateSimple(reply.createdAt)"></span>
                                        </div>

                                        <div class="shadow-sm px-5 py-3 relative"
                                            :class="isMe(reply) 
                                                ? 'bg-indigo-600 text-white rounded-2xl rounded-tr-none' 
                                                : 'bg-white text-gray-800 border border-gray-200 rounded-2xl rounded-tl-none'">

                                            <div class="prose-chat ql-editor !p-0 !min-h-0"
                                                :class="isMe(reply) ? 'prose-chat-inverse' : ''" x-html="reply.message">
                                            </div>

                                            <template x-if="reply.attachmentUrl || reply.fileName">
                                                <div class="mt-3 flex items-center p-2 rounded-lg transition-colors cursor-pointer"
                                                    :class="isMe(reply) ? 'bg-white/20 border border-white/30 hover:bg-white/30' : 'bg-gray-50 border border-gray-200 hover:bg-gray-100'"
                                                    @click="window.open(reply.attachmentUrl, '_blank')">

                                                    <div class="p-2 rounded mr-3"
                                                        :class="isMe(reply) ? 'bg-white/20 text-white' : 'bg-white text-indigo-600 shadow-sm'">
                                                        <i class="fas fa-file-alt text-lg"></i>
                                                    </div>
                                                    <div class="flex-1 min-w-0 overflow-hidden">
                                                        <p class="text-sm font-medium truncate"
                                                            x-text="reply.fileName || 'Attached File'"></p>
                                                        <p class="text-xs opacity-80">Click to view</p>
                                                    </div>
                                                    <div class="ml-2"><i class="fas fa-download opacity-70"></i></div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <div x-show="ticket.replies.length === 0" class="text-center py-10">
                            <p class="text-gray-400 text-sm italic">No replies yet. Start the conversation below.</p>
                        </div>

                    </div>
                </div>
            </div>

            <footer class="bg-white border-t border-gray-200 p-6" x-show="ticket && ticket.status !== 'CLOSED'">
                <div class="max-w-5xl mx-auto">
                    <form @submit.prevent="submitReply">
                        <div class="mb-4 relative">
                            <div x-ref="quillEditor" class="bg-white"></div>

                            <div x-show="attachment"
                                class="absolute bottom-2 right-2 bg-indigo-50 border border-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs flex items-center shadow-sm z-10">
                                <i class="fas fa-paperclip mr-2"></i>
                                <span x-text="fileName" class="max-w-[150px] truncate"></span>
                                <button type="button" @click="clearFile"
                                    class="ml-2 text-indigo-400 hover:text-indigo-900"><i
                                        class="fas fa-times"></i></button>
                            </div>
                        </div>

                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <label
                                    class="cursor-pointer text-gray-500 hover:text-indigo-600 transition flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-50">
                                    <i class="fas fa-paperclip text-lg"></i>
                                    <span class="text-sm font-medium">Attach File</span>
                                    <input type="file" class="hidden" @change="handleFileSelect">
                                </label>
                            </div>

                            <button type="submit"
                                class="bg-indigo-600 text-white px-6 py-2.5 rounded-lg font-semibold shadow-md hover:bg-indigo-700 hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                                :disabled="isSubmitting || (!newReplyHasContent && !attachment)">
                                <span x-show="!isSubmitting">Send Reply <i class="fas fa-paper-plane ml-1"></i></span>
                                <span x-show="isSubmitting">
                                    <i class="fas fa-circle-notch fa-spin"></i> Sending...
                                </span>
                            </button>
                        </div>
                    </form>
                </div>
            </footer>

            <div x-show="ticket && ticket.status === 'CLOSED'"
                class="bg-gray-50 border-t border-gray-200 p-6 text-center">
                <div
                    class="inline-flex items-center gap-2 text-gray-500 font-medium bg-white px-4 py-2 rounded-full shadow-sm border border-gray-200">
                    <i class="fas fa-lock"></i> This ticket is closed.
                </div>
            </div>

            <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

            <script>
                function ticketDetailApp() {
                    return {
                        loading: true,
                        isSubmitting: false,
                        ticket: null,
                        newReply: '',
                        newReplyHasContent: false,
                        attachment: null,
                        fileName: '',
                        ticketId: null,
                        quillInstance: null,
                        currentUser: { id: null, username: '' },

                        init() {
                            const urlParams = new URLSearchParams(window.location.search);
                            this.ticketId = urlParams.get('id');

                            if (this.ticketId) {
                                this.fetchCurrentUser().then(() => {
                                    this.fetchTicketDetails();
                                });
                            } else {
                                window.location.href = '/billops/tickets.html';
                            }
                        },

                        async fetchCurrentUser() {
                            try {
                                const response = await fetch('/api/billops/profile', { credentials: 'include' });
                                if (response.ok) {
                                    this.currentUser = await response.json();
                                }
                            } catch (e) { console.error("User profile error", e); }
                        },

                        initQuill() {
                            if (this.quillInstance) return;

                            this.$nextTick(() => {
                                if (this.$refs.quillEditor) {
                                    this.quillInstance = new Quill(this.$refs.quillEditor, {
                                        theme: 'snow',
                                        placeholder: 'Type your message here...',
                                        modules: {
                                            toolbar: [
                                                ['bold', 'italic', 'underline', 'strike'],
                                                ['blockquote', 'code-block'],
                                                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                                                ['clean']
                                            ]
                                        }
                                    });

                                    this.quillInstance.on('text-change', () => {
                                        this.newReply = this.quillInstance.root.innerHTML;
                                        const text = this.quillInstance.getText().trim();
                                        this.newReplyHasContent = text.length > 0;
                                    });
                                }
                            });
                        },

                        async fetchTicketDetails() {
                            try {
                                const response = await fetch(`/api/billops/tickets/${this.ticketId}`, { credentials: 'include' });
                                if (!response.ok) throw new Error('Failed to fetch ticket');
                                this.ticket = await response.json();

                                if (this.ticket.status !== 'CLOSED') {
                                    this.initQuill();
                                }
                                this.$nextTick(() => {
                                    const container = document.getElementById('chat-container');
                                    if (container) container.scrollTop = container.scrollHeight;
                                });

                            } catch (error) {
                                console.error('Error:', error);
                                alert('Could not load ticket details.');
                            } finally {
                                this.loading = false;
                            }
                        },

                        isMe(reply) {
                            if (this.currentUser.id) {
                                return String(reply.authorId) === String(this.currentUser.id);
                            }
                            return false;
                        },

                        handleFileSelect(event) {
                            const file = event.target.files[0];
                            if (file) {
                                if (file.size > 10 * 1024 * 1024) {
                                    alert("File is too large. Max size is 10MB.");
                                    return;
                                }
                                this.attachment = file;
                                this.fileName = file.name;
                            }
                        },

                        clearFile() {
                            this.attachment = null;
                            this.fileName = '';
                        },

                        async submitReply() {
                            const textContent = this.quillInstance.getText().trim();

                            if (!textContent && !this.attachment) {
                                return;
                            }

                            this.isSubmitting = true;

                            try {
                                const formData = new FormData();
                                const finalMessage = textContent ? this.newReply : "";
                                formData.append('message', finalMessage);
                                formData.append('ticketId', this.ticketId);

                                if (this.currentUser.id) {
                                    formData.append('authorId', this.currentUser.id);
                                }

                                if (this.attachment) {
                                    formData.append('file', this.attachment);
                                }

                                const response = await fetch(`/api/billops/tickets/${this.ticketId}/replies`, {
                                    credentials: 'include',
                                    method: 'POST',
                                    body: formData
                                });

                                if (!response.ok) throw new Error('Failed to send reply.');

                                const updatedTicket = await response.json();
                                this.ticket = updatedTicket;

                                this.quillInstance.root.innerHTML = '';
                                this.newReply = '';
                                this.clearFile();

                                this.$nextTick(() => {
                                    const container = document.getElementById('chat-container');
                                    container.scrollTop = container.scrollHeight;
                                });

                            } catch (err) {
                                console.error('Error submitting reply:', err);
                                alert('Error sending reply. Please try again.');
                            } finally {
                                this.isSubmitting = false;
                            }
                        },

                        closeTicket() {
                            if (confirm('Are you sure you want to close this ticket?')) {
                                fetch(`/api/billops/tickets/${this.ticketId}/close`, { method: 'POST', credentials: 'include' })
                                    .then(res => res.json())
                                    .then(updatedTicket => {
                                        this.ticket = updatedTicket;
                                    });
                            }
                        },

                        formatDate(dateString) {
                            if (!dateString) return '';
                            return new Date(dateString).toLocaleString('en-US', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        },

                        formatDateSimple(dateString) {
                            if (!dateString) return '';
                            const date = new Date(dateString);
                            const today = new Date();
                            const isToday = date.toDateString() === today.toDateString();

                            if (isToday) {
                                return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                            }
                            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ', ' +
                                date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        },

                        getInitials(name) {
                            if (!name) return 'U';
                            return name.charAt(0).toUpperCase();
                        }
                    };
                }
            </script>
        </main>
    </div>
    </div>

</body>

</html>