<!-- RI/SP Coverage Tab Content -->
<div x-data="rispCoverageTab()" x-init="init()">

    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl shadow-lg p-8 mb-6 text-white">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h2 class="text-3xl font-bold mb-2">RI/SP Coverage & Utilization</h2>
                <p class="text-blue-100">Monitor Reserved Instance and Savings Plan coverage to optimize Spot/On-Demand
                    provisioning</p>
            </div>

            <div class="flex items-center gap-3">
                <button @click="loadData()" :disabled="loading"
                    class="px-6 py-2 bg-white text-blue-700 rounded-lg hover:bg-blue-50 disabled:bg-white/50 disabled:cursor-not-allowed transition-all font-semibold text-sm flex items-center shadow-lg">
                    <i class="fas mr-2" :class="loading ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
                    <span x-text="loading ? 'Loading...' : 'Refresh'"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="bg-white rounded-2xl shadow-sm border border-gray-200 p-16 text-center">
        <i class="fas fa-spinner fa-spin text-5xl text-blue-600 mb-4"></i>
        <p class="text-gray-600 font-medium text-lg">Loading coverage data...</p>
    </div>

    <div x-show="!loading" x-cloak class="space-y-6">
        <!-- Top Stats Row -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <!-- Last Checked -->
            <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                <div class="text-center">
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Last Checked</p>
                    <h3 class="text-xl font-bold text-gray-900" x-text="formatTimeAgo(data.collectedAt)"></h3>
                    <p class="text-xs text-gray-400 mt-1" x-text="'Account: ' + accountId"></p>
                </div>
            </div>

            <!-- RI Coverage -->
            <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                <div class="text-center">
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">RI Coverage</p>
                    <h3 class="text-3xl font-bold text-red-500"
                        x-text="data.totalRiUtilizationPercent.toFixed(1) + '%'"></h3>
                    <p class="text-xs text-gray-400 mt-1">Utilization: 0.0%</p>
                </div>
            </div>

            <!-- SP Coverage -->
            <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                <div class="text-center">
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">SP Coverage</p>
                    <h3 class="text-3xl font-bold text-red-500"
                        x-text="data.totalSpUtilizationPercent.toFixed(1) + '%'"></h3>
                    <p class="text-xs text-gray-400 mt-1">Utilization: 0.0%</p>
                </div>
            </div>

            <!-- Strategy -->
            <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                <div class="text-center">
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">AutoSpotting Strategy</p>
                    <h3 class="text-2xl font-bold text-emerald-500">Use Spot</h3>
                    <p class="text-[10px] text-gray-400 mt-2 leading-tight">All commitments fully utilized - will use
                        Spot for maximum savings</p>
                </div>
            </div>
        </div>

        <!-- Detailed Coverage Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- RI Coverage Details -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-gray-900">RI Coverage</h3>
                    <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-lg"
                        x-text="data.riCoverages.length + ' items'"></span>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 rounded-l-lg">Instance Type</th>
                                <th class="px-4 py-3">Region/AZ</th>
                                <th class="px-4 py-3 rounded-r-lg text-right">Coverage</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="item in data.riCoverages"
                                :key="item.instance_type + item.availability_zone">
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-4 py-3 font-medium text-gray-900" x-text="item.instance_type"></td>
                                    <td class="px-4 py-3 text-gray-500">
                                        <div x-text="item.region"></div>
                                        <div class="text-xs text-gray-400" x-text="item.availability_zone"></div>
                                    </td>
                                    <td class="px-4 py-3 text-right">
                                        <span class="font-bold"
                                            :class="item.coverage_percent > 0 ? 'text-emerald-600' : 'text-gray-400'"
                                            x-text="item.coverage_percent.toFixed(1) + '%'"></span>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="data.riCoverages.length === 0">
                                <td colspan="3" class="px-4 py-8 text-center text-gray-500 italic">
                                    No active RI coverage
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SP Coverage Details -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-gray-900">SP Coverage</h3>
                    <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-lg"
                        x-text="data.spCoverages.length + ' items'"></span>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 rounded-l-lg">Plan Type</th>
                                <th class="px-4 py-3 rounded-r-lg text-right">Coverage</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="(item, index) in data.spCoverages" :key="index">
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-4 py-3 font-medium text-gray-900" x-text="item.plan_type"></td>
                                    <td class="px-4 py-3 text-right">
                                        <span class="font-bold"
                                            :class="item.coverage_percent > 0 ? 'text-emerald-600' : 'text-gray-400'"
                                            x-text="item.coverage_percent.toFixed(1) + '%'"></span>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="data.spCoverages.length === 0">
                                <td colspan="2" class="px-4 py-8 text-center text-gray-500 italic">
                                    No active SP coverage
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Utilization Row (Placeholders as per screenshot) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 text-center py-12">
                <h4 class="text-sm font-bold text-gray-500 uppercase mb-2">RI Utilization</h4>
                <p class="text-gray-400 italic">No active Reserved Instances</p>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 text-center py-12">
                <h4 class="text-sm font-bold text-gray-500 uppercase mb-2">SP Utilization</h4>
                <p class="text-gray-400 italic">No active Savings Plans</p>
            </div>
        </div>
    </div>
</div>

<script>
    window.rispCoverageTab = function () {
        const backendBaseUrl = window.location.hostname === 'localhost'
            ? 'http://localhost:8080'
            : window.location.origin;
        const tenantId = sessionStorage.getItem('tenantId') || 'customer1';

        return {
            loading: false,
            accountId: null,
            data: {
                collectedAt: null,
                totalRiUtilizationPercent: 0,
                totalSpUtilizationPercent: 0,
                riCoverages: [],
                spCoverages: []
            },

            init() {
                console.log('üöÄ RI/SP Coverage tab initialized');

                // Get account ID
                try {
                    const stored = sessionStorage.getItem('selectedAccountIds');
                    if (stored) {
                        const ids = JSON.parse(stored);
                        if (ids && ids.length > 0) {
                            this.accountId = ids[0];
                        }
                    }
                } catch (e) {
                    console.error('Error reading account ID:', e);
                }

                if (this.accountId) {
                    this.loadData();
                }
            },

            async loadData() {
                if (!this.accountId) return;

                this.loading = true;
                try {
                    const response = await fetch(
                        `${backendBaseUrl}/api/autospotting/analytics/risp-coverage/${this.accountId}`,
                        {
                            headers: { 'X-Tenant-ID': tenantId }
                        }
                    );

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    const result = await response.json();
                    console.log('‚úÖ RI/SP Data:', result);

                    this.data = {
                        collectedAt: result.collected_at,
                        totalRiUtilizationPercent: result.total_ri_utilization_percent || 0,
                        totalSpUtilizationPercent: result.total_sp_utilization_percent || 0,
                        riCoverages: result.ri_coverages || [],
                        spCoverages: result.sp_coverages || []
                    };

                } catch (error) {
                    console.error('‚ùå Error loading RI/SP data:', error);
                    window.dispatchEvent(new CustomEvent('notify', {
                        detail: { message: 'Failed to load RI/SP data', type: 'error' }
                    }));
                } finally {
                    this.loading = false;
                }
            },

            formatTimeAgo(dateString) {
                if (!dateString) return 'Never';
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));

                if (diffHours < 1) return 'Just now';
                if (diffHours === 1) return '1 hour ago';
                return `${diffHours} hours ago`;
            }
        };
    }
</script>