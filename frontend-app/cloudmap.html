<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XamOps - Cloudmap | Cloud Infrastructure Visualization</title>
    <meta name="description" content="Visualize and explore your AWS cloud infrastructure with interactive network topology maps">
    <meta name="author" content="XamOps">
    <meta name="keywords" content="cloud infrastructure, AWS visualization, network topology, cloudmap, infrastructure mapping">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Cytoscape.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.33.1/cytoscape.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dagre@0.8.5/dist/dagre.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 20px 0 rgba(31, 38, 135, 0.1);
        }

        .gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .gradient-success {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        }

        .gradient-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        #cy {
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.05);
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .btn-ghost {
            background: transparent;
            color: #4b5563;
        }

        .btn-ghost:hover {
            background: rgba(255, 255, 255, 0.8);
        }

        .btn-icon {
            width: 2.5rem;
            height: 2.5rem;
            padding: 0;
            justify-content: center;
        }

        .select-wrapper {
            position: relative;
            display: inline-block;
        }

        select {
            appearance: none;
            padding: 0.5rem 2.5rem 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background: white;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .info-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 24rem;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            z-index: 50;
            overflow-y: auto;
        }

        .info-panel.open {
            transform: translateX(0);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            cursor: default;
        }

        .legend-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-primary {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none !important;
        }

        .icon-container {
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body>
<!-- Header -->
<header id="header" class="glass-header" style="height: auto; display: flex; align-items: center; justify-content: space-between; padding: 1rem 2rem; gap: 1rem; flex-wrap: wrap;">
    <div style="display: flex; align-items: center; gap: 1rem;">
        <div class="gradient-primary" style="width: 2.5rem; height: 2.5rem; border-radius: 0.75rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
            <i data-lucide="network" style="color: white; width: 1.25rem; height: 1.25rem;"></i>
        </div>
        <div>
            <h1 style="font-size: 1.25rem; font-weight: bold; color: #1f2937;">Cloudmap</h1>
            <p style="font-size: 0.875rem; color: #6b7280;">Visualize your cloud infrastructure</p>
        </div>
    </div>
    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <div style="width: 0.5rem; height: 0.5rem; background: #10b981; border-radius: 9999px;" class="pulse-dot"></div>
            <span style="font-size: 0.875rem; color: #6b7280;">Live topology</span>
        </div>
        <div class="glass-card" style="display: flex; align-items: center; gap: 0.75rem; border-radius: 0.75rem; padding: 0.75rem;">
            <label style="font-size: 0.875rem; font-weight: 600; color: #374151;">VPC:</label>
            <div class="select-wrapper">
                <select id="vpc-select" style="width: 250px;">
                    <option value="">üåê Global & S3</option>
                </select>
            </div>
        </div>
        <button id="export-btn" class="btn btn-primary">
            <i data-lucide="download" style="width: 1rem; height: 1rem;"></i>
            Export PNG
        </button>
    </div>
</header>

<!-- Main Content -->
<div style="position: relative; height: calc(100vh - 80px);">
    <!-- Graph Toolbar -->
    <div id="toolbar" class="hidden glass-card animate-fade-in" style="position: absolute; top: 1rem; left: 1rem; z-index: 10; border-radius: 0.75rem; padding: 0.75rem; display: flex; gap: 0.5rem;">
        <button id="fit-btn" class="btn btn-ghost btn-icon" title="Fit to view">
            <i data-lucide="maximize-2" style="width: 1rem; height: 1rem;"></i>
        </button>
        <button id="center-btn" class="btn btn-ghost btn-icon" title="Center view">
            <i data-lucide="crosshair" style="width: 1rem; height: 1rem;"></i>
        </button>
        <button id="zoom-in-btn" class="btn btn-ghost btn-icon" title="Zoom in">
            <i data-lucide="zoom-in" style="width: 1rem; height: 1rem;"></i>
        </button>
        <button id="zoom-out-btn" class="btn btn-ghost btn-icon" title="Zoom out">
            <i data-lucide="zoom-out" style="width: 1rem; height: 1rem;"></i>
        </button>
    </div>

    <!-- Graph Legend -->
    <div id="legend" class="hidden glass-card animate-fade-in" style="position: absolute; bottom: 1rem; left: 1rem; z-index: 10; border-radius: 0.75rem; padding: 1rem; max-height: 50vh; overflow-y: auto; width: 16rem;">
        <h3 style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem;">Node Types</h3>
        <div id="legend-items"></div>
    </div>

    <!-- Message Overlay -->
    <div id="overlay" class="overlay">
        <div class="glass-card animate-fade-in" style="text-align: center; padding: 2rem; border-radius: 1rem; max-width: 28rem;">
            <div id="overlay-icon" class="gradient-primary" style="width: 4rem; height: 4rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                <i data-lucide="network" style="color: white; width: 1.75rem; height: 1.75rem;"></i>
            </div>
            <h3 id="overlay-title" style="font-size: 1.125rem; font-weight: bold; color: #1f2937; margin-bottom: 0.5rem;">Ready to Visualize</h3>
            <p id="overlay-message" style="color: #6b7280;">Please select a VPC to begin mapping your infrastructure.</p>
        </div>
    </div>

    <!-- Cytoscape Graph -->
    <div id="cy" class="hidden"></div>

    <!-- Info Panel -->
    <div id="info-panel" class="info-panel">
        <div style="padding: 1.5rem;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                <h2 style="font-size: 1.25rem; font-weight: bold; color: #1f2937;">Node Details</h2>
                <button id="close-panel-btn" class="btn btn-ghost btn-icon">
                    <i data-lucide="x" style="width: 1.25rem; height: 1.25rem;"></i>
                </button>
            </div>
            <div id="panel-content"></div>
        </div>
    </div>
</div>

<script>
    // Initialize Lucide icons
    lucide.createIcons();

    // State
    let cy = null;
    let vpcs = [];
    let selectedVpc = '';
    let accountId = null;

    // Node type configurations
    const nodeTypeConfig = {
        'VPC': { icon: 'network', color: '#667eea', category: 'Network' },
        'Subnet': { icon: 'box', color: '#60a5fa', category: 'Network' },
        'EC2 Instance': { icon: 'server', color: '#f59e0b', category: 'Compute' },
        'RDS Database': { icon: 'database', color: '#10b981', category: 'Database' },
        'Load Balancer': { icon: 'shuffle', color: '#8b5cf6', category: 'Network' },
        'S3 Bucket': { icon: 'hard-drive', color: '#ec4899', category: 'Storage' },
        'Lambda Function': { icon: 'zap', color: '#f97316', category: 'Compute' },
        'Security Group': { icon: 'shield', color: '#ef4444', category: 'Security' },
        'Route Table': { icon: 'route', color: '#14b8a6', category: 'Network' },
        'Internet Gateway': { icon: 'globe', color: '#3b82f6', category: 'Network' },
        'NAT Gateway': { icon: 'arrow-right-left', color: '#6366f1', category: 'Network' }
    };

    // DOM Elements
    const vpcSelect = document.getElementById('vpc-select');
    const exportBtn = document.getElementById('export-btn');
    const fitBtn = document.getElementById('fit-btn');
    const centerBtn = document.getElementById('center-btn');
    const zoomInBtn = document.getElementById('zoom-in-btn');
    const zoomOutBtn = document.getElementById('zoom-out-btn');
    const overlay = document.getElementById('overlay');
    const overlayIcon = document.getElementById('overlay-icon');
    const overlayTitle = document.getElementById('overlay-title');
    const overlayMessage = document.getElementById('overlay-message');
    const cyContainer = document.getElementById('cy');
    const toolbar = document.getElementById('toolbar');
    const legend = document.getElementById('legend');
    const legendItems = document.getElementById('legend-items');
    const infoPanel = document.getElementById('info-panel');
    const panelContent = document.getElementById('panel-content');
    const closePanelBtn = document.getElementById('close-panel-btn');

    // Initialize
    async function init() {
        // Get account ID from URL or session storage
        const urlParams = new URLSearchParams(window.location.search);
        accountId = urlParams.get('account') || sessionStorage.getItem('selectedAccount');

        if (!accountId) {
            showOverlay('no-account', 'Account Required', 'Please select an account to begin mapping your infrastructure.');
            return;
        }

        sessionStorage.setItem('selectedAccount', accountId);
        await loadVpcs();
        renderLegend();
    }

    // Load VPCs
    async function loadVpcs() {
        try {
            showOverlay('loading', 'Loading VPCs', 'Fetching your VPC list...');
            const response = await fetch(`https://b5tq7xsrwv7hyvbmnzylz3jhmi0rvvvc.lambda-url.us-east-1.on.aws/?account=${accountId}`);

            if (!response.ok) throw new Error('Failed to load VPCs');

            const data = await response.json();
            vpcs = data.vpcs || [];

            // Populate VPC select
            vpcSelect.innerHTML = '<option value="">üåê Global & S3</option>';
            vpcs.forEach(vpc => {
                const option = document.createElement('option');
                option.value = `${vpc.id}|${vpc.region}`;
                option.textContent = `${vpc.name} (${vpc.id} - ${vpc.region})`;
                vpcSelect.appendChild(option);
            });

            showOverlay('ready', 'Ready to Visualize', 'Please select a VPC to begin mapping your infrastructure.');
        } catch (error) {
            console.error('Error loading VPCs:', error);
            showOverlay('error', 'Load Error', 'Could not load VPC data. Please try again.');
        }
    }

    // Load graph for VPC
    async function loadGraph(vpcValue) {
        try {
            showOverlay('loading', 'Loading Infrastructure', 'Analyzing your cloud topology...');

            let url = `https://b5tq7xsrwv7hyvbmnzylz3jhmi0rvvvc.lambda-url.us-east-1.on.aws/?account=${accountId}`;

            if (vpcValue) {
                const [vpcId, region] = vpcValue.split('|');
                url += `&vpc=${vpcId}&region=${region}`;
            }

            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to load graph');

            const data = await response.json();
            renderGraph(data);
            hideOverlay();
        } catch (error) {
            console.error('Error loading graph:', error);
            showOverlay('error', 'Load Error', 'Could not load graph data. Please try again.');
        }
    }

    // Render graph
    function renderGraph(data) {
        const elements = [];

        // Add nodes
        if (data.nodes) {
            data.nodes.forEach(node => {
                const config = nodeTypeConfig[node.type] || { icon: 'circle', color: '#6b7280' };
                elements.push({
                    data: {
                        id: node.id,
                        label: node.label,
                        type: node.type,
                        ...node.attributes,
                        color: config.color
                    }
                });
            });
        }

        // Add edges
        if (data.edges) {
            data.edges.forEach(edge => {
                elements.push({
                    data: {
                        id: `${edge.source}-${edge.target}`,
                        source: edge.source,
                        target: edge.target,
                        label: edge.label || ''
                    }
                });
            });
        }

        // Initialize Cytoscape
        if (cy) {
            cy.destroy();
        }

        cy = cytoscape({
            container: cyContainer,
            elements: elements,
            style: [
                {
                    selector: 'node',
                    style: {
                        'background-color': 'data(color)',
                        'label': 'data(label)',
                        'color': '#1f2937',
                        'font-size': '12px',
                        'text-valign': 'bottom',
                        'text-margin-y': 5,
                        'width': 50,
                        'height': 50,
                        'border-width': 2,
                        'border-color': '#ffffff',
                        'box-shadow': '0 4px 15px rgba(0, 0, 0, 0.2)'
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 2,
                        'line-color': '#cbd5e1',
                        'target-arrow-color': '#cbd5e1',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier',
                        'label': 'data(label)',
                        'font-size': '10px',
                        'color': '#6b7280',
                        'text-background-color': '#ffffff',
                        'text-background-opacity': 0.8,
                        'text-background-padding': '3px'
                    }
                }
            ],
            layout: {
                name: 'dagre',
                rankDir: 'TB',
                nodeSep: 100,
                rankSep: 150,
                padding: 50
            }
        });

        // Event handlers
        cy.on('tap', 'node', (event) => {
            const nodeData = event.target.data();
            showNodeInfo(nodeData);
        });

        cy.on('tap', (event) => {
            if (event.target === cy) {
                closePanel();
            }
        });

        cyContainer.classList.remove('hidden');
        toolbar.classList.remove('hidden');
        legend.classList.remove('hidden');
    }

    // Show node info
    function showNodeInfo(nodeData) {
        const config = nodeTypeConfig[nodeData.type] || { icon: 'circle', color: '#6b7280' };

        let html = `
            <div style="margin-bottom: 1.5rem;">
                <div class="icon-container gradient-primary" style="margin-bottom: 1rem;">
                    <i data-lucide="${config.icon}" style="color: white; width: 1.25rem; height: 1.25rem;"></i>
                </div>
                <h3 style="font-size: 1.125rem; font-weight: bold; color: #1f2937; margin-bottom: 0.5rem;">${nodeData.label}</h3>
                <span class="badge badge-primary">${nodeData.type}</span>
            </div>
            <div style="margin-bottom: 1rem;">
                <p style="font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 0.25rem;">ID</p>
                <p style="color: #1f2937; font-family: monospace; font-size: 0.875rem;">${nodeData.id}</p>
            </div>
        `;

        // Add attributes
        const excludeKeys = ['id', 'label', 'type', 'color'];
        const attributes = Object.keys(nodeData).filter(key => !excludeKeys.includes(key));

        if (attributes.length > 0) {
            html += '<div style="border-top: 1px solid #e5e7eb; padding-top: 1rem;"><h4 style="font-size: 0.875rem; font-weight: 600; color: #1f2937; margin-bottom: 0.75rem;">Attributes</h4>';

            attributes.forEach(key => {
                const value = nodeData[key];
                if (value !== undefined && value !== null) {
                    html += `
                        <div style="margin-bottom: 0.75rem;">
                            <p style="font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 0.25rem;">${key}</p>
                            <p style="color: #1f2937; font-size: 0.875rem;">${value}</p>
                        </div>
                    `;
                }
            });

            html += '</div>';
        }

        panelContent.innerHTML = html;
        infoPanel.classList.add('open');
        lucide.createIcons();
    }

    // Close panel
    function closePanel() {
        infoPanel.classList.remove('open');
    }

    // Render legend
    function renderLegend() {
        const categories = {};

        Object.entries(nodeTypeConfig).forEach(([type, config]) => {
            if (!categories[config.category]) {
                categories[config.category] = [];
            }
            categories[config.category].push({ type, ...config });
        });

        let html = '';
        Object.entries(categories).forEach(([category, items]) => {
            html += `<div style="margin-bottom: 1rem;">`;
            html += `<p style="font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 0.5rem;">${category}</p>`;

            items.forEach(item => {
                html += `
                    <div class="legend-item">
                        <div class="icon-container" style="background: ${item.color};">
                            <i data-lucide="${item.icon}" style="color: white; width: 1rem; height: 1rem;"></i>
                        </div>
                        <span style="font-size: 0.875rem; color: #374151;">${item.type}</span>
                    </div>
                `;
            });

            html += '</div>';
        });

        legendItems.innerHTML = html;
        lucide.createIcons();
    }

    // Show/hide overlay
    function showOverlay(type, title, message) {
        const configs = {
            'ready': { icon: 'network', gradient: 'gradient-primary', spin: false },
            'loading': { icon: 'loader-2', gradient: 'gradient-primary', spin: true },
            'error': { icon: 'alert-triangle', gradient: 'from-red-500 to-pink-600', spin: false },
            'no-account': { icon: 'alert-triangle', gradient: 'from-red-500 to-pink-600', spin: false }
        };

        const config = configs[type];
        overlayIcon.className = config.gradient;
        overlayIcon.style.width = '4rem';
        overlayIcon.style.height = '4rem';
        overlayIcon.style.borderRadius = '9999px';
        overlayIcon.style.display = 'flex';
        overlayIcon.style.alignItems = 'center';
        overlayIcon.style.justifyContent = 'center';
        overlayIcon.style.margin = '0 auto 1rem';
        overlayIcon.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.4)';

        overlayIcon.innerHTML = `<i data-lucide="${config.icon}" style="color: white; width: 1.75rem; height: 1.75rem;" class="${config.spin ? 'spinner' : ''}"></i>`;
        overlayTitle.textContent = title;
        overlayMessage.textContent = message;

        overlay.classList.remove('hidden');
        cyContainer.classList.add('hidden');
        toolbar.classList.add('hidden');
        legend.classList.add('hidden');

        lucide.createIcons();
    }

    function hideOverlay() {
        overlay.classList.add('hidden');
    }

    // Event listeners
    vpcSelect.addEventListener('change', (e) => {
        selectedVpc = e.target.value;
        loadGraph(selectedVpc);
    });

    exportBtn.addEventListener('click', () => {
        if (cy) {
            const png = cy.png({ full: true, scale: 2 });
            const link = document.createElement('a');
            link.href = png;
            link.download = `cloudmap-${selectedVpc || 'global'}-${Date.now()}.png`;
            link.click();
        }
    });

    fitBtn.addEventListener('click', () => {
        if (cy) cy.fit();
    });

    centerBtn.addEventListener('click', () => {
        if (cy) cy.center();
    });

    zoomInBtn.addEventListener('click', () => {
        if (cy) cy.zoom(cy.zoom() * 1.2);
    });

    zoomOutBtn.addEventListener('click', () => {
        if (cy) cy.zoom(cy.zoom() * 0.8);
    });

    closePanelBtn.addEventListener('click', closePanel);

    // Initialize app
    init();
</script>
</body>
</html>