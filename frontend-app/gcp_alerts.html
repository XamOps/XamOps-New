<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XamOps - GCP Alerts</title> <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="/icons/XamOps.png" sizes="32x32" type="image/png">
    <link rel="apple-touch-icon" href="/icons/XamOps.png">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script type="module" src="/src/main.js"></script> <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        --error-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        --glass-bg: rgba(255, 255, 255, 0.95);
        --glass-border: rgba(255, 255, 255, 0.2);
    }

    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        min-height: 100vh;
    }

    [x-cloak] { display: none !important; }

    .glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .glass-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .quota-card {
        position: relative;
        overflow: hidden;
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .quota-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }

    .quota-card:hover::before {
        transform: scaleX(1);
    }

    .quota-card:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .skeleton {
        background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 8px;
    }

    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }

    .header-gradient {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(229, 231, 235, 0.8);
    }

    .btn-primary {
        background: var(--primary-gradient);
        border: none;
        color: white;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .btn-primary::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
    }

    .btn-primary:hover::before {
        left: 100%;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(102, 126, 234, 0.4);
    }

    .form-select {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border);
        transition: all 0.3s ease;
    }

    .form-select:focus {
        background: rgba(255, 255, 255, 1);
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .progress-bar {
        background: linear-gradient(90deg, #e5e7eb 0%, #f3f4f6 100%);
        border-radius: 12px;
        overflow: hidden;
        height: 12px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .progress-bar-fill {
        height: 100%;
        transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 12px;
        position: relative;
    }

    .progress-bar-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: shimmer-progress 2s infinite;
    }

    @keyframes shimmer-progress {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    .table-enhanced {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--glass-border);
    }

    .table-enhanced thead {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    }

    .table-enhanced tr {
        transition: all 0.2s ease;
    }

    .table-enhanced tr:hover {
        background: rgba(102, 126, 234, 0.05);
        transform: translateX(2px);
    }

    .quota-cell-indicator {
        position: relative;
    }

    .quota-cell-indicator::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        transform: scaleY(0);
        transition: transform 0.2s ease;
    }

    tr.critical .quota-cell-indicator::before {
        background: var(--error-gradient);
    }

    tr.warning .quota-cell-indicator::before {
        background: var(--warning-gradient);
    }

    tr.normal .quota-cell-indicator::before {
        background: var(--success-gradient);
    }

    tr:hover .quota-cell-indicator::before {
        transform: scaleY(1);
    }

    .empty-state {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border: 2px dashed rgba(16, 185, 129, 0.3);
        transition: all 0.3s ease;
    }

    .empty-state:hover {
        border-color: rgba(16, 185, 129, 0.5);
        background: rgba(255, 255, 255, 0.98);
    }

    .filter-section {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(102, 126, 234, 0.1) 100%);
        border: 1px solid rgba(102, 126, 234, 0.2);
    }

    .pulse-dot {
        animation: pulse-dot 2s infinite;
    }

    @keyframes pulse-dot {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .loading-spinner {
        border: 3px solid #f3f4f6;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .fade-in {
        animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .usage-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .service-icon {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border);
        transition: all 0.3s ease;
    }

    .service-icon:hover {
        transform: scale(1.1) rotate(5deg);
    }

    .gradient-text {
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .summary-metrics {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.9) 100%);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(229, 231, 235, 0.5);
    }
</style>
</head>
<body class="bg-gray-50">
<div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
  <include file="/_sidebar.html"></include>


    <div class="flex-1 pl-64">
        <main class="flex-1 flex flex-col min-h-screen" x-data="gcpAlerts()"> <header class="header-gradient h-20 flex items-center justify-between px-8 sticky top-0 z-10">
            <div class="flex items-center space-x-4">
                <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-red-600 rounded-xl flex items-center justify-center">
                    <i class="fab fa-google text-white text-xl"></i> </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">GCP Alerts</h1> <p class="text-sm text-gray-600">Monitor critical GCP alerts that require attention</p> </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 bg-orange-500 rounded-full pulse-dot"></div>
                    <span class="text-sm text-gray-600">Active monitoring</span>
                </div>
                <button @click="loadAlerts(true)" class="btn-primary flex items-center space-x-2 px-6 py-3 text-sm font-semibold rounded-lg shadow-md" :disabled="isRefreshing">
                    <i class="fas fa-sync-alt" :class="{ 'fa-spin': isRefreshing }"></i>
                    <span x-text="isRefreshing ? 'Scanning...' : 'Refresh Alerts'"></span>
                </button>
            </div>
        </header>

            <div class="flex-1 p-8 space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div x-show="isLoading" x-cloak class="skeleton h-36"></div>
                    <div x-show="isLoading" x-cloak class="skeleton h-36"></div>
                    <div x-show="isLoading" x-cloak class="skeleton h-36"></div>
                    <div x-show="isLoading" x-cloak class="skeleton h-36"></div>

                    <div x-show="!isLoading" class="quota-card rounded-2xl p-6 fade-in">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h3 class="text-gray-600 text-sm font-medium mb-2">Total Alerts</h3>
                                <p class="text-4xl font-bold gradient-text mb-1" x-text="alerts.length"></p>
                                <p class="text-xs text-gray-500">monitored services</p>
                            </div>
                            <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-list text-white text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <div x-show="!isLoading" class="quota-card rounded-2xl p-6 fade-in">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h3 class="text-gray-600 text-sm font-medium mb-2">Critical Usage</h3>
                                <p class="text-4xl font-bold text-red-600 mb-1" x-text="getCriticalCount()"></p>
                                <p class="text-xs text-gray-500">issues requiring attention</p> </div>
                            <div class="w-14 h-14 bg-gradient-to-br from-red-500 to-red-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <div x-show="!isLoading" class="quota-card rounded-2xl p-6 fade-in">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h3 class="text-gray-600 text-sm font-medium mb-2">Warning</h3>
                                <p class="text-4xl font-bold text-yellow-500 mb-1" x-text="getWarningCount()"></p>
                                <p class="text-xs text-gray-500">potential issues</p> </div>
                            <div class="w-14 h-14 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-exclamation-circle text-white text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <div x-show="!isLoading" class="quota-card rounded-2xl p-6 fade-in">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h3 class="text-gray-600 text-sm font-medium mb-2">Healthy</h3>
                                <p class="text-4xl font-bold text-green-600 mb-1" x-text="getHealthyCount()"></p>
                                <p class="text-xs text-gray-500">monitored items OK</p> </div>
                            <div class="w-14 h-14 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-check-circle text-white text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-card rounded-2xl p-8 fade-in">
                    <div class="flex items-center justify-between mb-8">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-chart-bar text-white text-lg"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">GCP Alerts Overview</h2> <p class="text-sm text-gray-600">Monitor quotas, cost anomalies, and security findings</p> </div>
                        </div>
                    </div>

                    <div class="filter-section rounded-xl p-4 mb-8">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-filter text-indigo-600"></i>
                                    <label for="service-filter" class="text-sm font-semibold text-gray-700">Filter by Service/Category:</label> </div>
                                <select id="service-filter" x-model="selectedService" class="form-select px-4 py-2 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200">
                                    <option value="All">All Services/Categories</option> <template x-for="service in services" :key="service">
                                    <option :value="service" x-text="service"></option>
                                </template>
                                </select>
                            </div>
                            <div class="text-sm text-gray-600">
                                <span x-text="filteredAlerts.length"></span> alert<span x-show="filteredAlerts.length !== 1">s</span> shown
                            </div>
                        </div>
                    </div>


                    <div x-show="isLoading" x-cloak class="table-enhanced">
                        <table class="w-full text-sm">
                            <thead class="text-xs text-gray-700 uppercase bg-gradient-to-r from-gray-50 to-gray-100">
                            <tr>
                                <th class="px-6 py-4"><div class="h-4 skeleton rounded w-32"></div></th>
                                <th class="px-6 py-4"><div class="h-4 skeleton rounded w-48"></div></th>
                                <th class="px-6 py-4"><div class="h-4 skeleton rounded w-full"></div></th>
                                <th class="px-6 py-4"><div class="h-4 skeleton rounded w-24"></div></th>
                            </tr>
                            </thead>
                            <tbody>
                            <template x-for="i in 8" :key="i">
                                <tr class="border-b border-gray-200">
                                    <td class="px-6 py-4"><div class="h-4 skeleton rounded w-24"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 skeleton rounded w-full"></div></td>
                                    <td class="px-6 py-4"><div class="h-3 skeleton rounded-full w-full"></div></td>
                                    <td class="px-6 py-4"><div class="h-8 skeleton rounded-md w-32"></div></td>
                                </tr>
                            </template>
                            </tbody>
                        </table>
                    </div>


                    <div x-show="!isLoading && filteredAlerts.length === 0" x-cloak class="empty-state text-center py-20 px-8 rounded-2xl">
                        <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-check-circle text-white text-3xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">All Clear!</h3>
                        <p class="text-gray-600 mb-6">No critical alerts found for the selected filter.</p>
                        <button @click="loadAlerts(true)" class="btn-primary px-6 py-3 text-sm font-semibold rounded-lg">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh Check
                        </button>
                    </div>

                    <div x-show="!isLoading && filteredAlerts.length > 0" x-cloak class="table-enhanced">
                        <table class="w-full text-sm">
                            <thead class="text-xs text-gray-700 uppercase bg-gradient-to-r from-gray-50 to-gray-100">
                            <tr>
                                <th class="px-6 py-4 text-left font-bold">Service / Category</th> <th class="px-6 py-4 text-left font-bold">Alert Type</th>
                                <th class="px-6 py-4 text-left font-bold">Alert / Finding</th> <th class="px-6 py-4 text-left font-bold">Details / Usage</th> <th class="px-6 py-4 text-center font-bold">Action</th>
                            </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                            <template x-for="alert in filteredAlerts" :key="alert.id">
                                <tr class="hover:bg-gray-50 transition-all" :class="getAlertClass(alert)">
                                    <td class="px-6 py-4 quota-cell-indicator">
                                        <div class="flex items-center space-x-3">
                                            <div class="service-icon w-8 h-8 rounded-lg flex items-center justify-center" :class="getServiceIconClass(alert.service)">
                                                <i class="fas" :class="getGcpServiceIcon(alert.service)"></i>
                                            </div>
                                            <span class="font-semibold text-gray-800" x-text="alert.service"></span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <span class="font-medium text-gray-700" x-text="alert.type"></span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div>
                                            <p class="font-medium text-gray-800" x-text="alert.name"></p>
                                            <p class="text-xs text-gray-500" x-text="alert.description"></p>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div x-show="alert.type === 'QUOTA'">
                                            <div class="space-y-2">
                                                <div class="flex items-center justify-between">
                                                    <span class="usage-badge" :class="getUsageBadgeClass(alert)" x-text="`${getUsagePercentage(alert).toFixed(1)}%`"></span>
                                                    <span class="text-xs text-gray-600" x-text="`${alert.usage.toLocaleString()} / ${alert.limit.toLocaleString()}`"></span>
                                                </div>
                                                <div class="progress-bar">
                                                    <div class="progress-bar-fill" :class="getUsageColor(alert)" :style="`width: ${getUsagePercentage(alert)}%`"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div x-show="alert.type === 'ANOMALY'">
                                            <p class="font-bold text-red-600" x-text="`$` + alert.usage.toFixed(2)"></p>
                                            <p class="text-xs text-gray-500">Anomalous Spend</p>
                                        </div>
                                        <div x-show="alert.type === 'SECURITY'">
                                             <span class="usage-badge" :class="getSecurityBadgeClass(alert.status)">
                                                 <span x-text="alert.status"></span>
                                             </span>
                                            <p class="text-xs text-gray-500 mt-1" x-text="alert.region || 'global'"></p>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <a :href="getGcpConsoleLink(alert)" target="_blank" class="btn-primary inline-flex items-center space-x-2 px-4 py-2 text-xs font-semibold rounded-lg shadow-md hover:shadow-lg transition-all">
                                            <i class="fas fa-external-link-alt"></i>
                                            <span x-text="getGcpActionText(alert)"></span>
                                        </a>
                                    </td>
                                </tr>
                            </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    function gcpAlerts() { // Changed function name
        return {
            isLoading: true,
            isRefreshing: false,
            alerts: [],
            selectedService: 'All',
            selectedGcpProjectId: null, // Store GCP Project ID

            init() {
                 const urlParams = new URLSearchParams(window.location.search);
                // Use 'accountId' from URL for GCP Project ID
                this.selectedGcpProjectId = urlParams.get('accountId');

                if (!this.selectedGcpProjectId) {
                    // Fallback to sessionStorage if needed (adjust key if necessary)
                    const storedIds = JSON.parse(sessionStorage.getItem('selectedAccountIds') || '[]');
                    // Assuming the first ID is the GCP Project ID if in single-select mode for GCP
                    if (storedIds.length > 0) {
                        this.selectedGcpProjectId = storedIds[0];
                    }
                }
                 if (this.selectedGcpProjectId) {
                    this.loadAlerts(false);
                } else {
                    console.error('GCP Project ID not found in URL or sessionStorage.');
                    this.isLoading = false;
                    // Optionally show an error message to the user
                }
            },

            loadAlerts(forceRefresh = false) {
                 if (!this.selectedGcpProjectId) {
                    this.isLoading = false;
                    console.warn('No GCP Project ID selected. Cannot fetch alert data.');
                    return;
                }

                 // Changed cache key
                const cacheKey = `gcpAlertsData-${this.selectedGcpProjectId}`;
                const cachedData = sessionStorage.getItem(cacheKey);

                if (cachedData && !forceRefresh) {
                    this.processAlerts(JSON.parse(cachedData));
                    this.isLoading = false;
                    return;
                }

                if (!cachedData || forceRefresh) { // Simplified condition
                    this.isLoading = true; // Always show loading when fetching
                }

                if (forceRefresh) {
                    this.isRefreshing = true;
                    sessionStorage.removeItem(cacheKey); // Clear cache on force refresh
                }

                 // Changed API endpoint and parameter name
                fetch(`/api/xamops/gcp/cloudguard/alerts?accountId=${this.selectedGcpProjectId}&forceRefresh=${forceRefresh}`)
                    .then(res => {
                        if (!res.ok) throw new Error(`Failed to fetch GCP alert data (${res.status})`);
                        return res.json();
                    })
                    .then(data => {
                         // Process list of AlertDto objects directly
                         const processedAlerts = (data || []).map(alert => ({ // Add null check
                            id: alert.id || `gcp-alert-${Math.random()}`, // Ensure ID
                            service: alert.service || 'Unknown',
                            type: alert.type || 'UNKNOWN',
                            name: alert.name || 'Unnamed Alert',
                            limit: alert.limit || 0,
                            usage: alert.usage || 0,
                            description: alert.description || 'No description available.',
                            region: alert.region || 'global',
                            status: alert.status || 'UNKNOWN' // Added status field from DTO
                        }));

                        sessionStorage.setItem(cacheKey, JSON.stringify(processedAlerts));
                        this.processAlerts(processedAlerts);
                    })
                    .catch(err => {
                        console.error('Failed to load GCP alert data', err);
                        this.alerts = [];
                        // Optionally show a user-friendly error message
                    })
                    .finally(() => {
                        this.isLoading = false;
                        this.isRefreshing = false;
                    });
            },

             processAlerts(data) {
                this.alerts = (data || []).sort((a, b) => { // Add null check and sort
                    // Prioritize Critical, then Warning, then Anomalies/Security, then Quotas
                    const severityOrder = { 'CRITICAL': 0, 'HIGH': 1, 'WARNING': 2, 'OK': 3, 'UNKNOWN': 4 };
                    const typeOrder = { 'ANOMALY': 0, 'SECURITY': 1, 'QUOTA': 2 };

                    const severityA = severityOrder[a.status] ?? 99;
                    const severityB = severityOrder[b.status] ?? 99;
                    if (severityA !== severityB) return severityA - severityB;

                    const typeA = typeOrder[a.type] ?? 99;
                    const typeB = typeOrder[b.type] ?? 99;
                    if (typeA !== typeB) return typeA - typeB;

                    // For quotas, sort by highest percentage
                    const percentageA = a.type === 'QUOTA' ? (a.usage / a.limit) || 0 : 0;
                    const percentageB = b.type === 'QUOTA' ? (b.usage / b.limit) || 0 : 0;
                    return percentageB - percentageA;
                 });
            },


            // services getter remains similar
            get services() {
                const serviceNames = (this.alerts || []).map(q => q.service); // Add null check
                return [...new Set(serviceNames)].sort();
            },


            // filteredAlerts getter remains similar
            get filteredAlerts() {
                if (this.selectedService === 'All') {
                    return this.alerts || []; // Add null check
                }
                return (this.alerts || []).filter(q => q.service === this.selectedService); // Add null check
            },


            // getUsagePercentage remains the same
             getUsagePercentage(alert) {
                 // Check type and ensure limit is not zero
                if (alert.type !== 'QUOTA' || !alert.limit || alert.limit === 0) return 0;
                return (alert.usage / alert.limit) * 100;
            },


            // getUsageColor remains the same logic
            getUsageColor(alert) {
                const status = alert.status;
                if (status === 'CRITICAL') return 'bg-gradient-to-r from-red-500 to-red-600';
                if (status === 'WARNING') return 'bg-gradient-to-r from-yellow-500 to-yellow-600';
                return 'bg-gradient-to-r from-green-500 to-green-600';
            },


            // getUsageBadgeClass remains the same logic
            getUsageBadgeClass(alert) {
                const status = alert.status;
                if (status === 'CRITICAL') return 'bg-red-100 text-red-800 border-red-200';
                if (status === 'WARNING') return 'bg-yellow-100 text-yellow-800 border-yellow-200';
                 if (status === 'OK') return 'bg-green-100 text-green-800 border-green-200';
                return 'bg-gray-100 text-gray-800 border-gray-200';
            },

             // New badge class for security alerts
            getSecurityBadgeClass(status) {
                 status = (status || '').toUpperCase();
                 if (status === 'CRITICAL') return 'bg-red-100 text-red-800 border-red-200';
                 if (status === 'HIGH') return 'bg-orange-100 text-orange-800 border-orange-200'; // Using orange for HIGH
                 if (status === 'MEDIUM') return 'bg-yellow-100 text-yellow-800 border-yellow-200';
                 if (status === 'LOW') return 'bg-blue-100 text-blue-800 border-blue-200';
                 return 'bg-gray-100 text-gray-800 border-gray-200';
             },


            // getAlertClass adapted for GCP statuses
            getAlertClass(alert) {
                const status = (alert.status || '').toUpperCase();
                if (status === 'CRITICAL' || alert.type === 'ANOMALY') return 'critical';
                if (status === 'WARNING' || status === 'HIGH') return 'warning'; // Treat HIGH security as warning row style
                return 'normal'; // OK, MEDIUM, LOW, UNKNOWN
            },

             // Updated icons for GCP services
            getGcpServiceIcon(serviceName) {
                const icons = {
                    'VPC Network': 'fa-network-wired',
                    'Billing': 'fa-dollar-sign',
                    'Compute Engine': 'fa-server',
                    'Cloud Storage': 'fa-database', // Or fa-hdd
                    'Cloud SQL': 'fa-database',
                    'Kubernetes Engine': 'fa-dharmachakra', // Or fa-ship
                    'Cloud Functions': 'fa-bolt',
                    'IAM': 'fa-users-cog',
                    'Security Command Center': 'fa-shield-alt', // Default for security
                    // Add more GCP service mappings
                };
                 // Default security icon if category is generic security
                 if(alert.type === 'SECURITY' && !icons[serviceName]) return 'fa-shield-alt';
                return icons[serviceName] || 'fa-cloud'; // Default cloud icon
            },

            // getServiceIconClass remains similar, using GCP icons map
             getServiceIconClass(serviceName) {
                 // Use more distinct colors for GCP if desired
                const serviceColors = {
                    'VPC Network': 'bg-blue-500',
                    'Billing': 'bg-green-500',
                    'Compute Engine': 'bg-indigo-500',
                    'Security Command Center': 'bg-red-500', // Default security color
                     'IAM': 'bg-red-600',
                     // Add more
                };
                return serviceColors[serviceName] || 'bg-gray-500'; // Default gray
            },


            // Counting logic adapted for GCP alert statuses/types
            getCriticalCount() {
                return (this.alerts || []).filter(q => q.type === 'ANOMALY' || (q.status && q.status.toUpperCase() === 'CRITICAL')).length;
            },

            getWarningCount() {
                return (this.alerts || []).filter(q => q.status && (q.status.toUpperCase() === 'WARNING' || q.status.toUpperCase() === 'HIGH')).length;
            },

            getHealthyCount() {
                 // Count 'OK' Quotas and non-critical/warning security findings
                return (this.alerts || []).filter(q => {
                    const status = (q.status || '').toUpperCase();
                    return status === 'OK' || (q.type === 'SECURITY' && status !== 'CRITICAL' && status !== 'HIGH');
                }).length;
            },

            // --- NEW: GCP Console Link Logic ---
            getGcpConsoleLink(alert) {
                const projectId = this.selectedGcpProjectId;
                 if (!projectId) return '#'; // No project ID

                switch (alert.type) {
                    case 'QUOTA':
                         // General Quotas page
                        return `https://console.cloud.google.com/iam-admin/quotas?project=${projectId}`;
                    case 'ANOMALY':
                        // Billing overview, anomalies are often highlighted here
                        return `https://console.cloud.google.com/billing/projects/${projectId}/overview`;
                    case 'SECURITY':
                        // Security Command Center Findings page
                         return `https://console.cloud.google.com/security/command-center/findings?project=${projectId}`;
                    default:
                        // Default to project dashboard
                        return `https://console.cloud.google.com/home/dashboard?project=${projectId}`;
                }
            },

             // --- NEW: GCP Action Text Logic ---
             getGcpActionText(alert) {
                switch (alert.type) {
                     case 'QUOTA': return 'View Quotas';
                     case 'ANOMALY': return 'View Billing';
                     case 'SECURITY': return 'View Finding';
                     default: return 'Investigate';
                 }
             }

        }
    }
</script>

</body>
</html>