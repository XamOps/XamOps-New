<div x-data="actionsHistoryTab()" x-init="init()">

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Filters</h3>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">From</label>
                <input type="date" x-model="filters.startDate"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">To</label>
                <input type="date" x-model="filters.endDate"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                <select x-model="filters.eventType"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                    <option value="">All Events</option>
                    <option value="instance_replacement">Replacements</option>
                    <option value="spot_interruption">Interruptions</option>
                    <option value="launch_success">Launch Success</option>
                    <option value="launch_failure">Launch Failure</option>
                    <option value="asg_run">ASG Run</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ASG Name</label>
                <input type="text" x-model="filters.asgName" placeholder="Filter by ASG..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
            </div>
        </div>

        <div class="flex gap-3 mt-4">
            <button @click="loadEvents()" :disabled="loading"
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-blue-400 disabled:cursor-not-allowed transition-colors font-medium text-sm flex items-center">
                <i class="fas mr-2" :class="loading ? 'fa-spinner fa-spin' : 'fa-search'"></i>
                <span x-text="loading ? 'Loading...' : 'Load History'"></span>
            </button>
            <button @click="resetFilters()"
                class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium text-sm">
                <i class="fas fa-undo mr-2"></i>
                Reset
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Replacements</p>
                    <p class="text-2xl font-bold text-green-600 mt-1" x-text="summary.total_replacements || 0"></p>
                    <p class="text-xs text-gray-500 mt-1">on-demand → spot</p>
                </div>
                <div class="bg-green-100 rounded-full p-3">
                    <i class="fas fa-sync-alt text-green-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Spot Interruptions</p>
                    <p class="text-2xl font-bold text-orange-600 mt-1" x-text="summary.total_interruptions || 0"></p>
                    <p class="text-xs text-gray-500 mt-1">handled</p>
                </div>
                <div class="bg-orange-100 rounded-full p-3">
                    <i class="fas fa-exclamation-triangle text-orange-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Est. Hourly Savings</p>
                    <p class="text-2xl font-bold text-purple-600 mt-1">
                        $<span x-text="(summary.total_estimated_savings || 0).toFixed(4)"></span>
                    </p>
                    <p class="text-xs text-gray-500 mt-1">from replacements</p>
                </div>
                <div class="bg-purple-100 rounded-full p-3">
                    <i class="fas fa-dollar-sign text-purple-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Stability Score (MTBI)</p>
                    <p class="text-2xl font-bold mt-1" :class="summary.mtbiColor || 'text-gray-800'"
                        x-text="summary.mtbi || '-'">
                    </p>
                    <p class="text-xs text-gray-500 mt-1">Mean time b/w interruptions</p>
                </div>
                <div class="bg-indigo-100 rounded-full p-3">
                    <i class="fas fa-heartbeat text-indigo-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <h3 class="font-semibold text-gray-800">Events Timeline</h3>
            <p class="text-xs text-gray-500 mt-1">
                Showing <span x-text="events.length"></span> event<span x-show="events.length !== 1">s</span>
                from <span x-text="formatDateShort(filters.startDate)"></span> to <span
                    x-text="formatDateShort(filters.endDate)"></span>
            </p>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse min-w-max">
                <thead>
                    <tr class="bg-gray-50 text-gray-600 text-xs uppercase tracking-wider">
                        <th class="px-4 py-3 font-semibold whitespace-nowrap">Timestamp</th>
                        <th class="px-4 py-3 font-semibold whitespace-nowrap">Type</th>
                        <th class="px-4 py-3 font-semibold whitespace-nowrap">ASG Name</th>
                        <th class="px-4 py-3 font-semibold whitespace-nowrap">Region</th>
                        <th class="px-4 py-3 font-semibold whitespace-nowrap">Old Instance</th>
                        <th class="px-4 py-3 font-semibold whitespace-nowrap">Old Type</th>
                        <th class="px-4 py-3 font-semibold whitespace-nowrap">New Instance</th>
                        <th class="px-4 py-3 font-semibold whitespace-nowrap">New Type</th>
                        <th class="px-4 py-3 font-semibold whitespace-nowrap">Impact</th>
                        <th class="px-4 py-3 font-semibold min-w-[200px]">Reason</th>
                    </tr>
                </thead>

                <tbody class="divide-y divide-gray-100" x-show="loading">
                    <template x-for="i in 5" :key="i">
                        <tr class="animate-pulse">
                            <td class="px-4 py-4">
                                <div class="h-4 bg-gray-200 rounded w-24"></div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="h-6 bg-gray-200 rounded-full w-24"></div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="h-4 bg-gray-200 rounded w-32"></div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="h-4 bg-gray-200 rounded w-16"></div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="h-4 bg-gray-200 rounded w-20 mb-1"></div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="h-4 bg-gray-200 rounded w-16"></div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="h-4 bg-gray-200 rounded w-20 mb-1"></div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="h-4 bg-gray-200 rounded w-16"></div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="h-4 bg-gray-200 rounded w-12"></div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="h-4 bg-gray-200 rounded w-full"></div>
                            </td>
                        </tr>
                    </template>
                </tbody>

                <tbody class="divide-y divide-gray-100" x-show="!loading && events.length > 0">
                    <template x-for="(event, index) in events" :key="index">
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-4 text-sm text-gray-900 whitespace-nowrap">
                                <div x-text="formatDateTime(event.timestamp)"></div>
                            </td>

                            <td class="px-4 py-4 whitespace-nowrap">
                                <span
                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium whitespace-nowrap"
                                    :class="getEventTypeClass(event.event_type)">
                                    <i class="fas mr-1.5" :class="getEventTypeIcon(event.event_type)"></i>
                                    <span x-text="formatEventType(event.event_type)"></span>
                                </span>
                            </td>

                            <td class="px-4 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900 truncate w-40" :title="event.asg_name"
                                    x-text="event.asg_name"></div>
                            </td>

                            <td class="px-4 py-4 whitespace-nowrap">
                                <span
                                    class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                    <span x-text="event.region"></span>
                                </span>
                            </td>

                            <td class="px-4 py-4 whitespace-nowrap">
                                <div class="text-xs font-mono text-gray-600" x-text="event.old_instance_id || '-'">
                                </div>
                                <div class="text-[10px] text-gray-500 mt-0.5" x-show="event.old_lifecycle">
                                    <span class="px-1.5 py-0.5 rounded"
                                        :class="event.old_lifecycle === 'on-demand' ? 'bg-blue-100 text-blue-700' : 'bg-yellow-100 text-yellow-700'"
                                        x-text="event.old_lifecycle"></span>
                                </div>
                            </td>

                            <td class="px-4 py-4 whitespace-nowrap">
                                <div class="text-xs font-medium text-gray-700" x-text="event.old_instance_type || '-'">
                                </div>
                                <div class="text-[10px] text-gray-500" x-show="event.old_hourly_price">
                                    $<span x-text="(event.old_hourly_price || 0).toFixed(4)"></span>
                                </div>
                            </td>

                            <td class="px-4 py-4 whitespace-nowrap">
                                <div class="text-xs font-mono text-gray-600" x-text="event.new_instance_id || '-'">
                                </div>
                                <div class="text-[10px] text-gray-500 mt-0.5" x-show="event.new_lifecycle">
                                    <span class="px-1.5 py-0.5 rounded"
                                        :class="event.new_lifecycle === 'on-demand' ? 'bg-blue-100 text-blue-700' : 'bg-yellow-100 text-yellow-700'"
                                        x-text="event.new_lifecycle"></span>
                                </div>
                            </td>

                            <td class="px-4 py-4 whitespace-nowrap">
                                <div class="text-xs font-medium text-gray-700" x-text="event.new_instance_type || '-'">
                                </div>
                                <div class="text-[10px] text-gray-500" x-show="event.new_hourly_price">
                                    $<span x-text="(event.new_hourly_price || 0).toFixed(4)"></span>
                                </div>
                            </td>

                            <td class="px-4 py-4 whitespace-nowrap">
                                <div class="text-sm font-bold text-green-600" x-show="event.estimated_savings > 0">
                                    $<span x-text="(event.estimated_savings || 0).toFixed(4)"></span>
                                </div>
                                <span class="text-xs text-gray-400"
                                    x-show="!event.estimated_savings || event.estimated_savings <= 0">-</span>
                            </td>

                            <td class="px-4 py-4">
                                <div class="text-xs text-gray-600 max-w-xs break-words" x-text="event.reason || '-'">
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>

                <tbody class="divide-y divide-gray-100" x-show="!loading && events.length === 0">
                    <tr>
                        <td colspan="10" class="px-6 py-12 text-center text-gray-500 bg-white">
                            <div class="flex flex-col items-center justify-center">
                                <i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i>
                                <p class="text-lg font-medium text-gray-900">No Events Found</p>
                                <p class="text-sm text-gray-500 mb-4">Try adjusting your filters or date range.</p>
                                <button @click="resetFilters(); loadEvents();"
                                    class="px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors text-sm font-medium">
                                    <i class="fas fa-undo mr-2"></i> Reset Filters
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    window.actionsHistoryTab = function () {
        const backendBaseUrl = window.location.hostname === 'localhost'
            ? 'http://localhost:8080'
            : window.location.origin;

        const tenantId = sessionStorage.getItem('tenantId') || 'customer1';

        return {
            loading: true, // Start loading immediately
            events: [],
            summary: {},
            filters: {
                startDate: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                endDate: new Date().toISOString().split('T')[0],
                eventType: '',
                asgName: ''
            },
            accountId: null,
            abortController: null,

            init() {
                try {
                    const stored = sessionStorage.getItem('selectedAccountIds');
                    if (stored) {
                        const ids = JSON.parse(stored);
                        if (ids && ids.length > 0) this.accountId = ids[0];
                    }
                } catch (e) { console.error(e); }

                if (this.accountId) {
                    this.loadEvents();
                } else {
                    this.dispatchNotification('No account selected', 'error');
                    this.loading = false;
                }
            },

            async loadEvents() {
                if (!this.accountId) return;

                if (this.abortController) this.abortController.abort();
                this.abortController = new AbortController();

                this.loading = true; // FORCE LOADING

                try {
                    const params = new URLSearchParams({
                        start: new Date(this.filters.startDate + 'T00:00:00Z').toISOString(),
                        end: new Date(this.filters.endDate + 'T23:59:59Z').toISOString()
                    });

                    if (this.filters.eventType) params.append('eventType', this.filters.eventType);
                    if (this.filters.asgName) params.append('asgName', this.filters.asgName);

                    const response = await fetch(
                        `${backendBaseUrl}/api/autospotting/events/${this.accountId}?${params}`,
                        {
                            signal: this.abortController.signal,
                            credentials: 'include',
                            headers: { 'X-Tenant-ID': tenantId }
                        }
                    );

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    const data = await response.json();

                    this.events = data.events || [];
                    this.summary = data.summary || {
                        total_replacements: 0,
                        total_interruptions: 0,
                        total_estimated_savings: 0.0
                    };

                    this.calculateMTBI();

                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error('❌ Error loading events:', error);
                        this.dispatchNotification('Failed to load events', 'error');
                    }
                } finally {
                    if (this.abortController && !this.abortController.signal.aborted) {
                        this.loading = false; // STOP LOADING ONLY AFTER DONE
                    }
                }
            },

            calculateMTBI() {
                const interruptions = this.events
                    .filter(e => e.event_type === 'spot_interruption')
                    .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                let mtbiText = "N/A";
                let mtbiColor = "text-gray-400";

                if (interruptions.length > 1) {
                    let totalDiffHours = 0;
                    for (let i = 1; i < interruptions.length; i++) {
                        const diffMs = new Date(interruptions[i].timestamp) - new Date(interruptions[i - 1].timestamp);
                        totalDiffHours += diffMs / (1000 * 60 * 60);
                    }
                    const avgHours = totalDiffHours / (interruptions.length - 1);

                    if (avgHours < 24) {
                        mtbiText = `${avgHours.toFixed(1)} hrs`;
                        mtbiColor = "text-red-600";
                    } else {
                        mtbiText = `${(avgHours / 24).toFixed(1)} days`;
                        mtbiColor = "text-emerald-600";
                    }
                } else if (interruptions.length === 1) {
                    mtbiText = "Single Event";
                    mtbiColor = "text-blue-600";
                } else {
                    // Only say "Stable" if there are other events but NO interruptions
                    mtbiText = this.events.length > 0 ? "Stable" : "N/A";
                    mtbiColor = this.events.length > 0 ? "text-emerald-600" : "text-gray-400";
                }

                this.summary.mtbi = mtbiText;
                this.summary.mtbiColor = mtbiColor;
            },

            resetFilters() {
                this.filters.startDate = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                this.filters.endDate = new Date().toISOString().split('T')[0];
                this.filters.eventType = '';
                this.filters.asgName = '';
                this.loadEvents();
            },

            getEventTypeClass(type) {
                switch (type) {
                    case 'instance_replacement': return 'bg-green-100 text-green-800';
                    case 'spot_interruption': return 'bg-orange-100 text-orange-800';
                    case 'launch_success': return 'bg-emerald-100 text-emerald-800';
                    case 'launch_failure': return 'bg-red-100 text-red-800';
                    case 'launch_attempt': return 'bg-blue-100 text-blue-700';
                    case 'asg_run': return 'bg-gray-100 text-gray-700';
                    case 'asg_enabled': return 'bg-teal-100 text-teal-800';
                    case 'asg_disabled': return 'bg-gray-200 text-gray-600';
                    default: return 'bg-gray-100 text-gray-800';
                }
            },

            getEventTypeIcon(type) {
                switch (type) {
                    case 'instance_replacement': return 'fa-sync-alt';
                    case 'spot_interruption': return 'fa-exclamation-triangle';
                    case 'launch_success': return 'fa-check-circle';
                    case 'launch_failure': return 'fa-times-circle';
                    case 'launch_attempt': return 'fa-rocket';
                    case 'asg_run': return 'fa-play-circle';
                    case 'asg_enabled': return 'fa-toggle-on';
                    case 'asg_disabled': return 'fa-toggle-off';
                    default: return 'fa-info-circle';
                }
            },

            formatEventType(type) {
                if (!type) return '';
                return type.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            },

            formatDateTime(ts) {
                if (!ts) return '-';
                return new Date(ts).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            },

            formatDateShort(dateStr) {
                if (!dateStr) return '';
                return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            },

            dispatchNotification(message, type = 'success') {
                window.dispatchEvent(new CustomEvent('notify', { detail: { message, type } }));
            }
        };
    };
</script>