<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XamOps - Grafana Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="icon" href="/icons/XamOps.png" sizes="32x32" type="image/png" />
  <link rel="apple-touch-icon" href="/icons/XamOps.png" />
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script type="module" src="/src/main.js"></script>
</head>

<body class="bg-gray-50">
  <div class="flex">
    <include file="/_sidebar.html"></include>

    <div class="flex-1 pl-64">
      <main id="main-content" class="flex-1 flex flex-col min-h-screen" x-data="grafanaDashboard()">

        <style>
          @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap");

          [x-cloak] {
            display: none !important;
          }

          .header-gradient {
            background: linear-gradient(135deg,
                rgba(255, 255, 255, 0.95) 0%,
                rgba(248, 250, 252, 0.95) 100%);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(229, 231, 235, 0.8);
          }

          .fade-in {
            animation: fadeIn 0.5s ease-in-out;
          }

          @keyframes fadeIn {
            from {
              opacity: 0;
            }

            to {
              opacity: 1;
            }
          }

          .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
          }

          .modal-content {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.8);
          }

          .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: "Courier New", Courier, monospace;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 40vh;
            overflow-y: auto;
          }

          .placeholder-highlight {
            background-color: #fef3c7;
            color: #92400e;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
          }
        </style>

        <header class="header-gradient h-20 flex items-center justify-between px-8 sticky top-0 z-10">
          <div class="flex items-center space-x-4">
            <div
              class="w-12 h-12 bg-gradient-to-br from-orange-400 to-orange-600 rounded-xl flex items-center justify-center">
              <i class="fas fa-chart-line text-white text-xl"></i>
            </div>
            <div>
              <h1 class="text-2xl font-bold text-gray-800">
                Infrastructure Monitoring
              </h1>
              <p class="text-sm text-gray-600" :class="{ 'text-red-500 font-semibold': errorMessage }"
                x-text="subtitleText">
              </p>
            </div>
          </div>
          <a x-show="grafanaUrl" :href="grafanaUrl" target="_blank"
            class="flex items-center space-x-2 px-4 py-2 text-sm font-semibold text-gray-700 bg-white rounded-lg border hover:bg-gray-50 transition-all">
            <span>View in Grafana</span>
            <i class="fas fa-external-link-alt text-xs"></i>
          </a>
        </header>

        <div class="flex-1 p-2 bg-gray-200">
          <iframe :src="iframeSrc" class="w-full h-[calc(100vh-6rem)] border-0 rounded-lg fade-in"></iframe>
        </div>

        <div @click="isHelpModalOpen = true"
          class="fixed bottom-8 right-8 w-14 h-14 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white text-2xl shadow-lg cursor-pointer hover:scale-110 transition-transform z-30">
          <i class="fas fa-question"></i>
        </div>

        <div x-show="isHelpModalOpen" x-cloak class="fixed inset-0 z-50 flex items-center justify-center p-4">
          <div @click="isHelpModalOpen = false" class="modal-overlay fixed inset-0"></div>
          <div class="modal-content rounded-2xl p-8 w-full max-w-4xl mx-auto max-h-[90vh] overflow-y-auto fade-in"
            @click.stop>
            <div class="flex items-center justify-between pb-4 border-b">
              <h3 class="font-bold text-xl text-gray-800">
                Setup Instructions for AWS Monitoring
              </h3>
              <button @click="isHelpModalOpen = false" class="text-gray-400 hover:text-gray-600 text-2xl">
                &times;
              </button>
            </div>
            <div class="space-y-6 mt-6 text-sm text-gray-700">
              <div>
                <h4 class="font-semibold text-lg text-gray-800">
                  Part A: Create the Required IAM Role
                </h4>
                <ol class="list-decimal list-inside mt-2 space-y-1">
                  <li>Navigate to the IAM service...</li>
                </ol>
                <div class="code-block mt-2 text-xs">
                  <pre><code>{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowResourceCreation",
            "Effect": "Allow",
            "Action": [ "ec2:*" ],
            "Resource": "*"
        }
    ]
}</code></pre>
                </div>
              </div>
            </div>
          </div>
        </div>

        <script>
          function grafanaDashboard() {
            return {
              isHelpModalOpen: false,
              iframeSrc: 'about:blank',
              subtitleText: 'Live Grafana Dashboard',
              errorMessage: false,
              grafanaUrl: null,
              dashboardUid: "a953939e-450f-4835-9190-26514f77a760",

              init() {
                // CHANGE: Replaced DOMContentLoaded with Alpine init()
                const selectedIds = JSON.parse(
                  sessionStorage.getItem("selectedAccountIds") || "[]"
                );

                if (selectedIds.length > 0) {
                  fetch("/api/xamops/account-manager/accounts")
                    .then((res) => res.json())
                    .then((accounts) => {
                      const selectedAccount = accounts.find(
                        (acc) => acc.id === selectedIds[0]
                      );
                      if (selectedAccount) {
                        this.loadDashboardFor(selectedAccount);
                      } else {
                        this.showError("Selected account not found.");
                      }
                    })
                    .catch(() => this.showError("Could not load account details."));
                } else {
                  this.showError("No account selected.");
                }
              },

              loadDashboardFor(account) {
                let grafanaIp = account.grafanaIp;

                // Environment-aware fallback logic
                if (!grafanaIp) {
                  console.warn(
                    `Grafana IP for "${account.name}" is missing from API. Using environment-aware fallback.`
                  );

                  const currentHost = window.location.hostname;
                  const isLive = currentHost.includes("live.xamops.com");
                  const accountName = account.name.toLowerCase();

                  if (accountName.includes("xammer")) {
                    grafanaIp = isLive
                      ? "grafana-xam.live.xamops.com"
                      : "grafana-xam.uat.xamops.com";
                  } else if (accountName.includes("marketplace")) {
                    grafanaIp = isLive
                      ? "grafana-mkt.live.xamops.com"
                      : "grafana-mkt.uat.xamops.com";
                  }
                }

                if (grafanaIp) {
                  const baseUrl = `https://${grafanaIp}`;
                  const iframeUrl = new URL(
                    `${baseUrl}/d/${this.dashboardUid}/aws-infrastructure-overview`
                  );
                  iframeUrl.searchParams.append("orgId", "1");
                  iframeUrl.searchParams.append("kiosk", "true");
                  this.iframeSrc = iframeUrl.toString();

                  const externalUrl = new URL(
                    `${baseUrl}/d/${this.dashboardUid}/aws-infrastructure-overview`
                  );
                  externalUrl.searchParams.append("orgId", "1");
                  externalUrl.searchParams.append("refresh", "10s");
                  this.grafanaUrl = externalUrl.toString();

                  this.subtitleText = `Live Grafana Dashboard for ${account.name}`;
                  this.errorMessage = false;
                } else {
                  this.showError(
                    `No Grafana instance is configured for the account: "${account.name}".`
                  );
                }
              },

              showError(message) {
                this.subtitleText = message;
                this.errorMessage = true;
                this.iframeSrc = "about:blank";
                this.grafanaUrl = null;
              }
            };
          }
        </script>
      </main>
    </div>
  </div>
</body>

</html>