<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="/icons/XamOps.png">
    <style>
        [x-cloak] { display: none !important; }
        .sidebar-scroll::-webkit-scrollbar { width: 6px; }
        .sidebar-scroll::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .sidebar-scroll::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .account-avatar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .dropdown-animation { animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .connection-indicator { position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; background: #10b981; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3); animation: pulse-dot 2s infinite; }
        @keyframes pulse-dot { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .account-status { display: inline-block; width: 6px; height: 6px; background: #10b981; border-radius: 50%; margin-right: 6px; animation: pulse-dot 2s infinite; }
    </style>
</head>
<body>
<div class="h-screen flex flex-col bg-white shadow-xl z-30" x-data="{
        open: false,
        accounts: [],
        selectedAccountIds: [],
        searchTerm: '',
        isLoading: true,
        userRoles: [],

        init() {
            const selectedIds = JSON.parse(sessionStorage.getItem('selectedAccountIds') || '[]');
            this.selectedAccountIds = selectedIds;
            this.fetchAccounts();
            this.fetchUserRoles();
            window.addEventListener('account-changed', () => this.fetchAccounts());
        },

        fetchAccounts() {
            this.isLoading = true;
            fetch('/api/xamops/account-manager/accounts')
                .then(res => res.ok ? res.json() : Promise.reject('Failed to fetch'))
                .then(data => {
                    this.accounts = data.filter(acc => acc.status === 'CONNECTED');
                })
                .catch(err => {
                    console.error('Failed to fetch accounts:', err);
                    this.accounts = [];
                })
                .finally(() => this.isLoading = false);
        },

        fetchUserRoles() {
            fetch('/api/xamops/user/profile')
                .then(res => {
                    if (!res.ok) return Promise.reject('Not authenticated');
                    return res.json();
                })
                .then(data => {
                    this.userRoles = data.roles || [];
                })
                .catch(err => {
                    console.error('Could not fetch user profile:', err);
                });
        },

        hasAnyRole(requiredRoles) {
            return requiredRoles.some(role => this.userRoles.includes(role));
        },

        applySelection() {
            sessionStorage.setItem('selectedAccountIds', JSON.stringify(this.selectedAccountIds));
            this.open = false;

            if (this.selectedAccountIds.length > 0) {
                const firstSelectedId = this.selectedAccountIds[0];
                const account = this.accounts.find(a => a.id === firstSelectedId);

                let targetPage;

                if (this.hasAnyRole(['ROLE_BILLOPS']) && !this.hasAnyRole(['ROLE_XAMOPS'])) {
                    targetPage = '/billops/billing.html';
                } else {
                    targetPage = '/dashboard.html';
                    if (account && account.provider === 'GCP') {
                        targetPage = '/gcp_dashboard.html';
                    }
                }

                const targetUrl = `${targetPage}?accountIds=${this.selectedAccountIds.join(',')}`;
                window.location.href = targetUrl;
            } else {
                sessionStorage.removeItem('selectedAccountIds');
                window.location.href = '/account-manager.html';
            }
        },

        get selectedAccountDisplay() {
            if (this.selectedAccountIds.length === 0) return { name: 'Select Accounts', id: this.accounts.length === 0 && !this.isLoading ? 'No accounts connected' : 'No account selected' };
            if (this.selectedAccountIds.length === 1) {
                const account = this.accounts.find(a => a.id === this.selectedAccountIds[0]);
                return { name: account?.name || 'Loading...', id: account?.id || '', provider: account?.provider || 'AWS' };
            }
            return { name: `${this.selectedAccountIds.length} AWS Accounts Selected`, id: 'Aggregated View', provider: 'AWS' };
        },

        toggleAccount(accountId) {
            const account = this.accounts.find(a => a.id === accountId);
            if (!account) return;
            const isGcp = account.provider === 'GCP';
            const index = this.selectedAccountIds.indexOf(accountId);
            if (isGcp) {
                this.selectedAccountIds = index > -1 ? [] : [accountId];
            } else {
                const gcpSelected = this.selectedAccountIds.some(id => this.accounts.find(a => a.id === id)?.provider === 'GCP');
                if (gcpSelected) {
                    this.selectedAccountIds = [accountId];
                } else {
                    index > -1 ? this.selectedAccountIds.splice(index, 1) : this.selectedAccountIds.push(accountId);
                }
            }
        },

        isSelectionDisabled(accountProvider) {
            if (this.selectedAccountIds.length === 0) return false;
            const isGcpSelected = this.selectedAccountIds.some(id => this.accounts.find(a => a.id === id)?.provider === 'GCP');
            return isGcpSelected ? true : accountProvider === 'GCP';
        },

        get filteredAccounts() {
            if (this.searchTerm === '') return this.accounts;
            const term = this.searchTerm.toLowerCase();
            return this.accounts.filter(account => account.name.toLowerCase().includes(term) || (account.id && account.id.toLowerCase().includes(term)));
        },

        getProviderIcon(provider) {
             if (provider === 'GCP') return '/icons/gcp-icon.png';
             return '/icons/default-icon.png';
        },

        isActive(path) {
            return window.location.pathname.startsWith(path);
        },

        getLink(basePath) {
            const selectedIds = JSON.parse(sessionStorage.getItem('selectedAccountIds') || '[]');
            if (selectedIds.length === 0) {
                if (basePath.includes('account-manager.html') || basePath.includes('dashboard.html')) return basePath;
                return '#'; 
            }
            const url = new URL(window.location.origin + basePath);
            url.searchParams.append('accountIds', selectedIds.join(','));
            return url.toString();
        }
    }">
        <div class="flex-shrink-0 flex items-center justify-center h-16 border-b bg-white">
            <a href="/dashboard.html"><img src="/icons/XamOps.png" alt="XamOps Logo" class="h-10 w-auto"></a>
        </div>

        <div class="p-4 border-b bg-gradient-to-r from-gray-50 to-white flex-shrink-0">
            <div class="relative">
                <div @click="open = !open" class="flex items-center justify-between p-3 rounded-xl bg-white border border-gray-200 hover:border-indigo-300 cursor-pointer transition-all duration-200 hover:shadow-md">
                    <div class="flex items-center min-w-0">
                        <div class="relative flex-shrink-0">
                            <div class="w-10 h-10 account-avatar rounded-full flex items-center justify-center text-white font-bold text-sm mr-3" x-show="selectedAccountIds.length === 0" x-text="'X'"></div>
                            <div class="w-10 h-10 account-avatar rounded-full flex items-center justify-center text-white font-bold text-lg mr-3" x-show="selectedAccountIds.length > 1" x-text="selectedAccountIds.length"></div>
                            <img :src="getProviderIcon(selectedAccountDisplay.provider)" class="w-10 h-10 rounded-full mr-3 object-cover" x-show="selectedAccountIds.length === 1">
                            <div class="connection-indicator" x-show="selectedAccountIds.length > 0"></div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2">
                                <span class="account-status" x-show="selectedAccountIds.length > 0"></span>
                                <span class="text-sm font-semibold text-gray-800 truncate" x-text="selectedAccountDisplay.name"></span>
                            </div>
                            <p class="text-xs text-gray-500 truncate" x-text="selectedAccountDisplay.id"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div x-show="isLoading" class="w-4 h-4 border-2 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                        <i class="fas fa-chevron-down text-gray-400 text-xs transition-transform duration-200" :class="{ 'rotate-180': open }"></i>
                    </div>
                </div>

                <div x-show="open" x-transition @click.outside="open = false" x-cloak class="absolute left-0 right-0 mt-2 bg-white border border-gray-200 rounded-xl shadow-xl z-50 overflow-hidden dropdown-animation">
                    <div class="p-3 border-b bg-gray-50">
                        <input type="text" x-model="searchTerm" placeholder="Search accounts..." class="w-full px-3 py-2 text-sm rounded-lg focus:outline-none border">
                    </div>
                    <div class="py-1 max-h-60 overflow-y-auto sidebar-scroll">
                        <template x-for="account in filteredAccounts" :key="account.dbId">
                            <div @click="toggleAccount(account.id)" class="flex items-center px-4 py-3 text-sm hover:bg-indigo-50 cursor-pointer" :class="{ 'bg-indigo-50': selectedAccountIds.includes(account.id), 'opacity-50 cursor-not-allowed': isSelectionDisabled(account.provider) && !selectedAccountIds.includes(account.id) }">
                                <input type="checkbox" :checked="selectedAccountIds.includes(account.id)" class="mr-3 rounded text-indigo-600" :disabled="isSelectionDisabled(account.provider) && !selectedAccountIds.includes(account.id)">
                                <img :src="getProviderIcon(account.provider)" class="w-8 h-8 rounded-full mr-3 flex-shrink-0 object-cover">
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-gray-900 truncate" x-text="account.name"></div>
                                    <div class="text-xs text-gray-500 truncate" x-text="account.id"></div>
                                </div>
                            </div>
                        </template>
                        <div x-show="filteredAccounts.length === 0 && !isLoading" class="px-4 py-3 text-sm text-gray-500 text-center">
                            <p class="mb-2">No connected accounts found.</p>
                            <a href="/account-manager.html" class="text-indigo-600 hover:underline font-semibold">Add an Account</a>
                        </div>
                    </div>
                    <div class="p-3 bg-gray-50 border-t">
                        <button @click="applySelection()" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700">Apply Selection</button>
                    </div>
                </div>
            </div>
        </div>

        <nav class="flex-1 px-3 py-4 space-y-2 text-sm overflow-y-auto sidebar-scroll">
            <div x-show="hasAnyRole(['ROLE_XAMOPS', 'ROLE_ADMIN'])" x-cloak>
                 </div>

            <div x-show="hasAnyRole(['ROLE_BILLOPS', 'ROLE_ADMIN', 'ROLE_BILLOPS_ADMIN'])" x-cloak>
                <div class="sidebar-section" :class="{'active': isActive('/billops/')}">
                    <div x-data="{ open: isActive('/billops/') }">
                        <button @click="open = !open" class="nav-item w-full flex items-center justify-between gap-3 rounded-xl px-4 py-3 font-semibold" :class="isActive('/billops/') ? 'bg-gradient-to-r from-cyan-500 to-blue-600 text-white shadow-lg' : 'text-gray-600 hover:bg-cyan-50'">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-file-invoice-dollar fa-fw w-5 text-center"></i>
                                <span>BillOps</span>
                            </div>
                            <i class="fas fa-chevron-down text-xs" :class="open && 'rotate-180'"></i>
                        </button>
                        <div x-show="open" class="ml-6 mt-2 space-y-1">
                            <a :href="getLink('/billops/billing.html')" :class="{'text-cyan-600 font-bold bg-cyan-50': isActive('/billops/billing')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-cyan-600">Billing</a>
                            <a :href="getLink('/billops/invoices.html')" :class="{'text-cyan-600 font-bold bg-cyan-50': isActive('/billops/invoices')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-cyan-600">Invoices</a>
                            <a :href="getLink('/billops/credits.html')" :class="{'text-cyan-600 font-bold bg-cyan-50': isActive('/billops/credits')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-cyan-600">Credits</a>
                            <a :href="getLink('/billops/tickets.html')" :class="{'text-cyan-600 font-bold bg-cyan-50': isActive('/billops/tickets')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-cyan-600">Tickets</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div x-show="hasAnyRole(['ROLE_BILLOPS_ADMIN'])" x-cloak>
                <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase">Admin Tools</div>
                <div class="sidebar-section mt-2" :class="{'active': isActive('/admin/')}">
                    <a href="/admin/admin_invoices.html" class="nav-item flex items-center gap-3 rounded-xl px-4 py-3 font-semibold" :class="isActive('/admin/admin_invoices') ? 'bg-gradient-to-r from-gray-700 to-gray-800 text-white shadow-lg' : 'text-gray-600 hover:bg-gray-100'">
                        <i class="fas fa-user-shield fa-fw w-5 text-center"></i>
                        <span>Invoice Admin</span>
                    </a>
                </div>
            </div>


            <div class="pt-4 mt-4 border-t">
                 <div class="sidebar-section" :class="{'active': isActive('/account-manager.html')}">
                    <a href="/account-manager.html" class="nav-item flex items-center gap-3 rounded-xl px-4 py-3 font-semibold" :class="isActive('/account-manager.html') ? 'bg-gradient-to-r from-purple-500 to-pink-600 text-white shadow-lg' : 'text-gray-600 hover:bg-purple-50'">
                        <i class="fas fa-users-cog fa-fw w-5 text-center"></i>
                        <span>Account Manager</span>
                    </a>
                </div>
            </div>
        </nav>

        <div class="flex-shrink-0 p-4 border-t bg-gradient-to-r from-gray-50 to-white">
            <form action="/logout" method="post" class="w-full">
                <button type="submit" class="nav-item flex items-center gap-3 rounded-xl px-4 py-3 font-semibold text-gray-600 hover:bg-red-50 w-full text-left">
                    <i class="fas fa-sign-out-alt fa-fw w-5 text-center"></i>
                    <span>Logout</span>
                </button>
            </form>
        </div>
    </div>
</body>
</html>