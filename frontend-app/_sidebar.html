<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="/icons/XamOps.png">
    <style>
        [x-cloak] { display: none !important; }
        .sidebar-scroll::-webkit-scrollbar { width: 6px; }
        .sidebar-scroll::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .sidebar-scroll::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .account-avatar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .dropdown-animation { animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .connection-indicator { position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; background: #10b981; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3); animation: pulse-dot 2s infinite; }
        @keyframes pulse-dot { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .account-status { display: inline-block; width: 6px; height: 6px; background: #10b981; border-radius: 50%; margin-right: 6px; animation: pulse-dot 2s infinite; }
    </style>
</head>
<body>
<div class="h-screen flex flex-col bg-white shadow-xl z-30" x-data="{
        open: false,
        accounts: [],
        selectedAccountIds: [],
        searchTerm: '',
        isLoading: true,
        userRoles: [],

        init() {
            const selectedIds = JSON.parse(sessionStorage.getItem('selectedAccountIds') || '[]');
            this.selectedAccountIds = selectedIds;
            this.fetchAccounts();
            this.fetchUserRoles();
            window.addEventListener('account-changed', () => this.fetchAccounts());
        },

        fetchAccounts() {
            this.isLoading = true;
            fetch('/api/xamops/account-manager/accounts')
                .then(res => res.ok ? res.json() : Promise.reject('Failed to fetch'))
                .then(data => {
                    this.accounts = data.filter(acc => acc.status === 'CONNECTED');
                })
                .catch(err => {
                    console.error('Failed to fetch accounts:', err);
                    this.accounts = [];
                })
                .finally(() => this.isLoading = false);
        },

        fetchUserRoles() {
            fetch('/api/xamops/user/profile')
                .then(res => {
                    if (!res.ok) return Promise.reject('Not authenticated');
                    return res.json();
                })
                .then(data => {
                    this.userRoles = data.roles || [];
                })
                .catch(err => {
                    console.error('Could not fetch user profile:', err);
                });
        },

        hasAnyRole(requiredRoles) {
            if (!Array.isArray(requiredRoles)) {
                requiredRoles = [requiredRoles];
            }
            return requiredRoles.some(role => this.userRoles.includes(role));
        },

        applySelection() {
            sessionStorage.setItem('selectedAccountIds', JSON.stringify(this.selectedAccountIds));
            this.open = false;

            if (this.selectedAccountIds.length > 0) {
                const firstSelectedId = this.selectedAccountIds[0];
                const account = this.accounts.find(a => a.id === firstSelectedId);
                const provider = account ? account.provider : 'AWS'; // Default to AWS if account not found
                
                let targetPage;
                
                switch (provider) {
                    case 'GCP':
                        targetPage = '/gcp_dashboard.html';
                        break;
                    case 'Azure':
                        targetPage = '/azure_dashboard.html';
                        break;
                    case 'AWS':
                    default:
                        if (this.hasAnyRole(['ROLE_BILLOPS', 'ROLE_BILLOPS_ADMIN'])) {
                           targetPage = '/billops/billing.html';
                        } else {
                           targetPage = '/dashboard.html';
                        }
                        break;
                }
                const targetUrl = `${targetPage}?accountIds=${this.selectedAccountIds.join(',')}`;
                window.location.href = targetUrl;
            } else {
                sessionStorage.removeItem('selectedAccountIds');
                window.location.href = '/account-manager.html';
            }
        },

        get selectedAccountDisplay() {
            if (this.selectedAccountIds.length === 0) return { name: 'Select Accounts', id: this.accounts.length === 0 && !this.isLoading ? 'No accounts connected' : 'No account selected' };
            if (this.selectedAccountIds.length === 1) {
                const account = this.accounts.find(a => a.id === this.selectedAccountIds[0]);
                return { name: account?.name || 'Loading...', id: account?.id || '', provider: account?.provider || 'AWS' };
            }
            return { name: `${this.selectedAccountIds.length} AWS Accounts Selected`, id: 'Aggregated View', provider: 'AWS' };
        },

        toggleAccount(accountId) {
            const account = this.accounts.find(a => a.id === accountId);
            if (!account) return;

            const isSingleSelect = account.provider === 'GCP' || account.provider === 'Azure';
            const index = this.selectedAccountIds.indexOf(accountId);

            if (isSingleSelect) {
                this.selectedAccountIds = index > -1 ? [] : [accountId];
            } else {
                const nonAwsSelected = this.selectedAccountIds.some(id => this.accounts.find(a => a.id === id)?.provider !== 'AWS');
                if (nonAwsSelected) {
                    this.selectedAccountIds = [accountId];
                } else {
                    index > -1 ? this.selectedAccountIds.splice(index, 1) : this.selectedAccountIds.push(accountId);
                }
            }
        },

        isSelectionDisabled(accountProvider) {
            if (this.selectedAccountIds.length === 0) return false;
            const nonAwsSelected = this.selectedAccountIds.some(id => this.accounts.find(a => a.id === id)?.provider !== 'AWS');
            return nonAwsSelected ? true : (accountProvider !== 'AWS');
        },

        get filteredAccounts() {
            if (this.searchTerm === '') return this.accounts;
            const term = this.searchTerm.toLowerCase();
            return this.accounts.filter(account => account.name.toLowerCase().includes(term) || (account.id && account.id.toLowerCase().includes(term)));
        },

        getProviderIcon(provider) {
             switch(provider) {
                case 'GCP': return '/icons/gcp-icon.png';
                case 'Azure': return '/icons/azure-icon.png';
                case 'AWS':
                default:
                    return '/icons/default-icon.png';
             }
        },

        isActive(path) {
            const currentPath = window.location.pathname;
            if (currentPath.startsWith('/gcp_')) {
                return path.startsWith('/gcp_') && currentPath.includes(path.split('/').pop().split('.')[0]);
            }
            return currentPath.startsWith(path);
        },
        
        getLink(basePath) {
            const selectedIds = JSON.parse(sessionStorage.getItem('selectedAccountIds') || '[]');
            if (selectedIds.length === 0) {
                if (basePath.includes('account-manager.html') || basePath.includes('dashboard.html')) return basePath;
                return '#';
            }

            const firstAccountId = selectedIds[0];
            const account = this.accounts.find(a => a.id === firstAccountId);
            const provider = account ? account.provider : 'AWS';

            let finalPath = basePath;
            if (provider === 'GCP') {
                finalPath = basePath.replace('.html', '').replace('/', '/gcp_') + '.html';
            } else if (provider === 'Azure') {
                finalPath = '/azure_dashboard.html'; 
            }
            
            const url = new URL(window.location.origin + finalPath);
            url.searchParams.append('accountIds', selectedIds.join(','));
            return url.toString();
        }
    }">
    <div class="flex-shrink-0 flex items-center justify-center h-16 border-b bg-white">
        <a href="/dashboard.html"><img src="/icons/XamOps.png" alt="XamOps Logo" class="h-10 w-auto"></a>
    </div>

    <div class="p-4 border-b bg-gradient-to-r from-gray-50 to-white flex-shrink-0">
        <div class="relative">
            <div @click="open = !open" class="flex items-center justify-between p-3 rounded-xl bg-white border border-gray-200 hover:border-indigo-300 cursor-pointer transition-all duration-200 hover:shadow-md">
                <div class="flex items-center min-w-0">
                    <div class="relative flex-shrink-0">
                        <div class="w-10 h-10 account-avatar rounded-full flex items-center justify-center text-white font-bold text-sm mr-3" x-show="selectedAccountIds.length === 0" x-text="'X'"></div>
                        <div class="w-10 h-10 account-avatar rounded-full flex items-center justify-center text-white font-bold text-lg mr-3" x-show="selectedAccountIds.length > 1" x-text="selectedAccountIds.length"></div>
                        <img :src="getProviderIcon(selectedAccountDisplay.provider)" class="w-10 h-10 rounded-full mr-3 object-cover" x-show="selectedAccountIds.length === 1">
                        <div class="connection-indicator" x-show="selectedAccountIds.length > 0"></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2">
                            <span class="account-status" x-show="selectedAccountIds.length > 0"></span>
                            <span class="text-sm font-semibold text-gray-800 truncate" x-text="selectedAccountDisplay.name"></span>
                        </div>
                        <p class="text-xs text-gray-500 truncate" x-text="selectedAccountDisplay.id"></p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div x-show="isLoading" class="w-4 h-4 border-2 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                    <i class="fas fa-chevron-down text-gray-400 text-xs transition-transform duration-200" :class="{ 'rotate-180': open }"></i>
                </div>
            </div>

            <div x-show="open" x-transition @click.outside="open = false" x-cloak class="absolute left-0 right-0 mt-2 bg-white border border-gray-200 rounded-xl shadow-xl z-50 overflow-hidden dropdown-animation">
                <div class="p-3 border-b bg-gray-50">
                    <input type="text" x-model="searchTerm" placeholder="Search accounts..." class="w-full px-3 py-2 text-sm rounded-lg focus:outline-none border">
                </div>
                <div class="py-1 max-h-60 overflow-y-auto sidebar-scroll">
                    <template x-for="account in filteredAccounts" :key="account.dbId">
                        <div @click="toggleAccount(account.id)" class="flex items-center px-4 py-3 text-sm hover:bg-indigo-50 cursor-pointer" :class="{ 'bg-indigo-50': selectedAccountIds.includes(account.id) }">
                            <input type="checkbox" :checked="selectedAccountIds.includes(account.id)" class="mr-3 rounded text-indigo-600">
                            <img :src="getProviderIcon(account.provider)" class="w-8 h-8 rounded-full mr-3 flex-shrink-0 object-cover">
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-gray-900 truncate" x-text="account.name"></div>
                                <div class="text-xs text-gray-500 truncate" x-text="account.id"></div>
                            </div>
                        </div>
                    </template>
                </div>
                <div class="p-3 bg-gray-50 border-t">
                    <button @click="applySelection()" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700">Apply Selection</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="flex-1 px-3 py-4 space-y-2 text-sm overflow-y-auto sidebar-scroll">

        <div x-show="hasAnyRole(['ROLE_XAMOPS', 'ROLE_ADMIN'])" x-cloak>
            <div class="sidebar-section" :class="{'active': isActive('/dashboard.html') || isActive('/gcp_dashboard.html')}">
                <a :href="getLink('/dashboard.html')" class="nav-item flex items-center gap-3 rounded-xl px-4 py-3 font-semibold" :class="isActive('/dashboard.html') || isActive('/gcp_dashboard.html') ? 'bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg' : 'text-gray-600 hover:bg-indigo-50'">
                    <i class="fas fa-tachometer-alt fa-fw w-5 text-center"></i>
                    <span>Dashboard</span>
                </a>
            </div>

            <div class="sidebar-section" :class="{'active': isActive('/cloudlist') || isActive('/cloudmap') || isActive('/gcp_cloudlist') || isActive('/gcp_cloudmap')}">
                 <div x-data="{ open: isActive('/cloudlist') || isActive('/cloudmap') || isActive('/gcp_cloudlist') || isActive('/gcp_cloudmap') }">
                    <button @click="open = !open" class="nav-item w-full flex items-center justify-between gap-3 rounded-xl px-4 py-3 font-semibold" :class="isActive('/cloudlist') || isActive('/cloudmap') || isActive('/gcp_cloudlist') || isActive('/gcp_cloudmap') ? 'bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg' : 'text-gray-600 hover:bg-indigo-50'">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-cloud fa-fw w-5 text-center"></i>
                            <span>Cloudview</span>
                        </div>
                        <i class="fas fa-chevron-down text-xs" :class="open && 'rotate-180'"></i>
                    </button>
                    <div x-show="open" class="ml-6 mt-2 space-y-1">
                        <a :href="getLink('/cloudlist.html')" :class="{'text-indigo-600 font-bold bg-indigo-50': isActive('/cloudlist.html') || isActive('/gcp_cloudlist.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">Cloudlist</a>
                        <a :href="getLink('/cloudmap.html')" :class="{'text-indigo-600 font-bold bg-indigo-50': isActive('/cloudmap.html') || isActive('/gcp_cloudmap.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">Cloudmap</a>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section" :class="{'active': isActive('/finops') || isActive('/cost') || isActive('/waste') || isActive('/rightsizing') || isActive('/reservation') || isActive('/gcp_finops') || isActive('/gcp_cost') || isActive('/gcp_waste') || isActive('/gcp_rightsizing') || isActive('/gcp_reservations')}">
                <div x-data="{ open: isActive('/finops') || isActive('/cost') || isActive('/waste') || isActive('/rightsizing') || isActive('/reservation') || isActive('/gcp_finops') || isActive('/gcp_cost') || isActive('/gcp_waste') || isActive('/gcp_rightsizing') || isActive('/gcp_reservations') }">
                    <button @click="open = !open" class="nav-item w-full flex items-center justify-between gap-3 rounded-xl px-4 py-3 font-semibold" :class="isActive('/finops') || isActive('/cost') || isActive('/waste') || isActive('/rightsizing') || isActive('/reservation') || isActive('/gcp_finops') || isActive('/gcp_cost') || isActive('/gcp_waste') || isActive('/gcp_rightsizing') || isActive('/gcp_reservations') ? 'bg-gradient-to-r from-green-500 to-teal-600 text-white shadow-lg' : 'text-gray-600 hover:bg-green-50'">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-cogs fa-fw w-5 text-center"></i>
                            <span>Optimization</span>
                        </div>
                        <i class="fas fa-chevron-down text-xs" :class="open && 'rotate-180'"></i>
                    </button>
                    <div x-show="open" class="ml-6 mt-2 space-y-1">
                        <a :href="getLink('/finops.html')" :class="{'text-green-600 font-bold bg-green-50': isActive('/finops.html') || isActive('/gcp_finops.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-green-600">FinOps Report</a>
                        <a :href="getLink('/cost.html')" :class="{'text-green-600 font-bold bg-green-50': isActive('/cost.html') || isActive('/gcp_cost.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-green-600">Costs Overview</a>
                        <a :href="getLink('/waste.html')" :class="{'text-green-600 font-bold bg-green-50': isActive('/waste.html') || isActive('/gcp_waste.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-green-600">Waste</a>
                        <a :href="getLink('/rightsizing.html')" :class="{'text-green-600 font-bold bg-green-50': isActive('/rightsizing.html') || isActive('/gcp_rightsizing.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-green-600">Rightsizing</a>
                        <a :href="getLink('/reservation.html')" :class="{'text-green-600 font-bold bg-green-50': isActive('/reservation.html') || isActive('/gcp_reservations.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-green-600">Reservations</a>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section" :class="{'active': isActive('/security') || isActive('/performance') || isActive('/alerts') || isActive('/gcp_security') || isActive('/gcp_performance')}">
                <div x-data="{ open: isActive('/security') || isActive('/performance') || isActive('/alerts') || isActive('/gcp_security') || isActive('/gcp_performance') }">
                    <button @click="open = !open" class="nav-item w-full flex items-center justify-between gap-3 rounded-xl px-4 py-3 font-semibold" :class="isActive('/security') || isActive('/performance') || isActive('/alerts') || isActive('/gcp_security') || isActive('/gcp_performance') ? 'bg-gradient-to-r from-red-500 to-orange-600 text-white shadow-lg' : 'text-gray-600 hover:bg-red-50'">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-shield-alt fa-fw w-5 text-center"></i>
                            <span>Cloudguard</span>
                        </div>
                        <i class="fas fa-chevron-down text-xs" :class="open && 'rotate-180'"></i>
                    </button>
                    <div x-show="open" class="ml-6 mt-2 space-y-1">
                        <a :href="getLink('/security.html')" :class="{'text-red-600 font-bold bg-red-50': isActive('/security.html') || isActive('/gcp_security.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-red-600">Security</a>
                        <a :href="getLink('/performance.html')" :class="{'text-red-600 font-bold bg-red-50': isActive('/performance.html') || isActive('/gcp_performance.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-red-600">Performance</a>
                        <a :href="getLink('/alerts.html')" :class="{'text-red-600 font-bold bg-red-50': isActive('/alerts.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-red-600">Alerts</a>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="hasAnyRole('ROLE_BILLOPS') && !hasAnyRole('ROLE_BILLOPS_ADMIN')" x-cloak>
            <div class="sidebar-section" :class="{'active': isActive('/billops/')}">
                <div x-data="{ open: isActive('/billops/') }">
                    <button @click="open = !open" class="nav-item w-full flex items-center justify-between gap-3 rounded-xl px-4 py-3 font-semibold" :class="isActive('/billops/') ? 'bg-gradient-to-r from-cyan-500 to-blue-600 text-white shadow-lg' : 'text-gray-600 hover:bg-cyan-50'">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-file-invoice-dollar fa-fw w-5 text-center"></i>
                            <span>BillOps</span>
                        </div>
                        <i class="fas fa-chevron-down text-xs" :class="open && 'rotate-180'"></i>
                    </button>
                    <div x-show="open" class="ml-6 mt-2 space-y-1">
                        <a :href="getLink('/billops/billing.html')" :class="{'text-cyan-600 font-bold bg-cyan-50': isActive('/billops/billing')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-cyan-600">Billing</a>
                        <a :href="getLink('/billops/invoices.html')" :class="{'text-cyan-600 font-bold bg-cyan-50': isActive('/billops/invoices')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-cyan-600">Invoices</a>
                        <a :href="getLink('/billops/credits.html')" :class="{'text-cyan-600 font-bold bg-cyan-50': isActive('/billops/credits')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-cyan-600">Credits</a>
                        <a :href="getLink('/billops/tickets.html')" :class="{'text-cyan-600 font-bold bg-cyan-50': isActive('/billops/tickets')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-cyan-600">Tickets</a>
                    </div>
                </div>
            </div>
        </div>
        <div x-show="hasAnyRole('ROLE_BILLOPS_ADMIN')" x-cloak>
            <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase">Admin Tools</div>
            <div class="sidebar-section mt-2">
                <div x-data="{ open: isActive('/billops/admin_') }">
                    <button @click="open = !open" class="nav-item w-full flex items-center justify-between gap-3 rounded-xl px-4 py-3 font-semibold" :class="isActive('/billops/admin_') ? 'bg-gradient-to-r from-gray-700 to-gray-800 text-white shadow-lg' : 'text-gray-600 hover:bg-gray-100'">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-user-shield fa-fw w-5 text-center"></i>
                            <span>Admin Console</span>
                        </div>
                        <i class="fas fa-chevron-down text-xs" :class="open && 'rotate-180'"></i>
                    </button>
                    <div x-show="open" class="ml-6 mt-2 space-y-1">
                        <a href="/billops/admin_invoices.html" :class="{'text-gray-800 font-bold bg-gray-100': isActive('/billops/admin_invoices')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-gray-800">Invoice Admin</a>
                        <a href="/billops/admin_credits.html" :class="{'text-gray-800 font-bold bg-gray-100': isActive('/billops/admin_credits')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-gray-800">Credit Admin</a>
                        <a href="/billops/admin_tickets.html" :class="{'text-gray-800 font-bold bg-gray-100': isActive('/billops/admin_tickets')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-gray-800">Ticket Admin</a>
                    </div>
                </div>
            </div>
            <div class="sidebar-section mt-4" :class="{'active': isActive('/billops/billing')}">
                <a :href="getLink('/billops/billing.html')" class="nav-item flex items-center gap-3 rounded-xl px-4 py-3 font-semibold" :class="isActive('/billops/billing') ? 'bg-gradient-to-r from-cyan-500 to-blue-600 text-white shadow-lg' : 'text-gray-600 hover:bg-cyan-50'">
                    <i class="fas fa-file-invoice-dollar fa-fw w-5 text-center"></i>
                    <span>Billing</span>
                </a>
            </div>
        </div>
        <div class="pt-4 mt-4 border-t">
            <div class="sidebar-section" :class="{'active': isActive('/account-manager.html')}">
                <a href="/account-manager.html" class="nav-item flex items-center gap-3 rounded-xl px-4 py-3 font-semibold" :class="isActive('/account-manager.html') ? 'bg-gradient-to-r from-purple-500 to-pink-600 text-white shadow-lg' : 'text-gray-600 hover:bg-purple-50'">
                    <i class="fas fa-users-cog fa-fw w-5 text-center"></i>
                    <span>Account Manager</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="flex-shrink-0 p-4 border-t bg-gradient-to-r from-gray-50 to-white">
        <form action="/logout" method="post" class="w-full">
            <button type="submit" class="nav-item flex items-center gap-3 rounded-xl px-4 py-3 font-semibold text-gray-600 hover:bg-red-50 w-full text-left">
                <i class="fas fa-sign-out-alt fa-fw w-5 text-center"></i>
                <span>Logout</span>
            </button>
        </form>
    </div>
</div>
</body>
</html>