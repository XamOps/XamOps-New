<div class="w-64 fixed top-0 left-0 h-screen flex flex-col bg-white shadow-xl z-30" x-data="{
        open: false,
        accounts: [],
        selectedAccountIds: [],
        tempSelectedAccounts: [],
        searchTerm: '',
        isLoading: true,
        userRoles: [],
        multiAccountMode: false,
        isDashboardPage: false,
        isBillingPage: false,


        async apiFetch(url, options = {}) {
            const csrfToken = document.cookie
                .split('; ')
                .find(row => row.startsWith('XSRF-TOKEN='))
                ?.split('=')[1];

            const response = await fetch(url, {
                ...options,
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'X-XSRF-TOKEN': csrfToken,
                    ...options.headers
                }
            });

            if (!response.ok) {
                console.error('API Error:', response.status, await response.text());
                throw new Error(`HTTP ${response.status}`);
            }
            return response;
        },

        init() {
            const selectedIds = JSON.parse(sessionStorage.getItem('selectedAccountIds') || '[]');
            this.selectedAccountIds = selectedIds;
            this.tempSelectedAccounts = [...selectedIds];
            this.multiAccountMode = sessionStorage.getItem('multiAccountMode') === 'true';
            this.checkCurrentPage();
            this.fetchAccounts();
            this.fetchUserRoles();
            window.addEventListener('account-changed', () => this.fetchAccounts());
        },

        checkCurrentPage() {
            const path = window.location.pathname;
            this.isDashboardPage = path.includes('dashboard');
            this.isBillingPage = path.includes('billing');
        },

        fetchAccounts() {
            this.isLoading = true;
            this.apiFetch('/api/xamops/account-manager/accounts')
                .then(res => res.json())
                .then(data => {
                    this.accounts = data.filter(acc => acc.status === 'CONNECTED');
                    if (this.selectedAccountIds.length === 0 && this.accounts.length > 0) {
                        this.selectedAccountIds = [this.accounts[0].id];
                        this.tempSelectedAccounts = [this.accounts[0].id];
                    }
                })
                .catch(err => {
                    console.error('Failed to fetch accounts:', err);
                    this.accounts = [];
                })
                .finally(() => this.isLoading = false);
        },

        fetchUserRoles() {
            this.apiFetch('/api/xamops/user/profile')
                .then(res => res.json())
                .then(data => {
                    this.userRoles = data.roles || [];
                })
                .catch(err => {
                    console.error('Could not fetch user profile:', err);
                });
        },

        hasAnyRole(requiredRoles) {
            if (!Array.isArray(requiredRoles)) {
                requiredRoles = [requiredRoles];
            }
            return requiredRoles.some(role => this.userRoles.includes(role));
        },

        toggleMultiAccountMode() {
            this.multiAccountMode = !this.multiAccountMode;
            sessionStorage.setItem('multiAccountMode', this.multiAccountMode);
            
            if (!this.multiAccountMode && this.selectedAccountIds.length > 1) {
                this.tempSelectedAccounts = [this.selectedAccountIds[0]];
            } else if (this.multiAccountMode) {
                this.tempSelectedAccounts = [...this.selectedAccountIds];
            }
        },

        toggleAccount(accountId) {
            const account = this.accounts.find(a => a.id === accountId);
            if (!account) return;

            if (this.multiAccountMode && this.isDashboardPage) {
                if (account.provider !== 'AWS') return;
                
                const index = this.tempSelectedAccounts.indexOf(accountId);
                if (index > -1) {
                    this.tempSelectedAccounts.splice(index, 1);
                } else {
                    if (this.tempSelectedAccounts.length >= 10) {
                        alert('Maximum 10 accounts can be selected');
                        return;
                    }
                    this.tempSelectedAccounts.push(accountId);
                }
            } else {
                this.tempSelectedAccounts = [accountId];
            }
        },

        isAccountSelected(accountId) {
            return this.tempSelectedAccounts.includes(accountId);
        },

        selectAllAws() {
            const awsIds = this.accounts
                .filter(acc => acc.provider === 'AWS')
                .map(acc => acc.id)
                .slice(0, 10);
            this.tempSelectedAccounts = awsIds;
        },

        clearAllSelections() {
            this.tempSelectedAccounts = [];
        },

        applySelection() {
            if (this.tempSelectedAccounts.length === 0) {
                alert('Please select at least one account');
                return;
            }

        this.selectedAccountIds = [...this.tempSelectedAccounts];
        sessionStorage.setItem('selectedAccountIds', JSON.stringify(this.selectedAccountIds));
        sessionStorage.setItem('multiAccountMode', this.multiAccountMode);
        this.open = false;

            if (this.multiAccountMode && this.selectedAccountIds.length > 1 && this.isDashboardPage) {
                window.dispatchEvent(new CustomEvent('multi-account-selection-changed', {
                    detail: { accountIds: this.selectedAccountIds }
                }));
            } else {
                const firstSelectedId = this.selectedAccountIds[0];
                const account = this.accounts.find(a => a.id === firstSelectedId);
                const provider = account ? account.provider : 'AWS';

                let targetPage;
                const isBillOpsUser = this.hasAnyRole(['ROLE_BILLOPS', 'ROLE_BILLOPS_ADMIN']);
                
                if (isBillOpsUser) {
                    switch (provider) {
                        case 'GCP':
                            targetPage = '/billops/gcp-billing.html';
                            break;
                        case 'AZURE':
                            targetPage = '/billops/azure-billing.html';
                            break;
                        case 'AWS':
                        default:
                            targetPage = '/billops/billing.html';
                            break;
                    }
                } else {
                    switch (provider) {
                        case 'GCP':
                            targetPage = '/gcp_dashboard.html';
                            break;
                        case 'AZURE':
                            targetPage = '/azure_dashboard.html';
                            break;
                        case 'AWS':
                        default:
                            targetPage = '/dashboard.html';
                            break;
                    }
                }
                
                const targetUrl = `${targetPage}?accountIds=${this.selectedAccountIds.join(',')}`;
                window.location.href = targetUrl;
            }
        },

        get selectedAccountDisplay() {
            if (this.selectedAccountIds.length === 0) {
                return { name: 'Select Accounts', id: this.accounts.length === 0 && !this.isLoading ? 'No accounts connected' : 'No account selected' };
            }
            if (this.selectedAccountIds.length === 1) {
                const account = this.accounts.find(a => a.id === this.selectedAccountIds[0]);
                return { name: account?.name || 'Loading...', id: account?.id || '', provider: account?.provider || 'AWS' };
            }
            return { name: `${this.selectedAccountIds.length} AWS Accounts`, id: 'Multi-Account View', provider: 'AWS' };
        },

        get filteredAccounts() {
            if (this.searchTerm === '') return this.accounts;
            const term = this.searchTerm.toLowerCase();
            return this.accounts.filter(account => 
                account.name.toLowerCase().includes(term) || 
                (account.id && account.id.toLowerCase().includes(term))
            );
        },

        get awsAccounts() {
            return this.filteredAccounts.filter(acc => acc.provider === 'AWS');
        },

        get gcpAccounts() {
            return this.filteredAccounts.filter(acc => acc.provider === 'GCP');
        },

        getProviderIcon(provider) {
            switch(provider) {
                case 'GCP': return '/icons/gcp-icon.png';
                case 'Azure': return '/icons/azure-icon.png';
                case 'AWS':
                default:
                    return '/icons/default-icon.png';
            }
        },

        isActive(path) {
            const currentPath = window.location.pathname;
            if (currentPath.startsWith('/gcp_')) {
                return path.startsWith('/gcp_') && currentPath.includes(path.split('/').pop().split('.')[0]);
            }
            return currentPath.startsWith(path);
        },

        getLink(basePath) {
            const selectedIds = this.selectedAccountIds;
            if (selectedIds.length === 0) {
                if (basePath.includes('account-manager.html') || basePath.includes('dashboard.html')) return basePath;
                return '#';
            }

            const firstAccountId = selectedIds[0];
            const account = this.accounts.find(a => a.id === firstAccountId);
            const provider = account ? account.provider : 'AWS';

            let finalPath = basePath;
            
            if (basePath.includes('/billops/')) {
                if (basePath.includes('billing.html')) {
                    switch (provider) {
                        case 'GCP':
                            finalPath = '/billops/gcp-billing.html';
                            break;
                        case 'AZURE':
                            finalPath = '/billops/azure-billing.html';
                            break;
                        case 'AWS':
                        default:
                            finalPath = '/billops/billing.html';
                            break;
                    }
                }
            } else {
                if (provider === 'GCP') {
                    if (basePath === '/reservation.html') {
                        finalPath = '/gcp_reservations.html';
                    } else {
                        finalPath = basePath.replace('.html', '').replace('/', '/gcp_') + '.html';
                    }
                } else if (provider === 'Azure') {
                    finalPath = '/azure_dashboard.html';
                }
            }

            const url = new URL(window.location.origin + finalPath);
            url.searchParams.append('accountIds', selectedIds.join(','));
            return url.toString();
        }
    }">
    
    <!-- Logo -->
    <div class="flex-shrink-0 flex items-center justify-center h-16 border-b bg-white">
        <a href="/dashboard.html"><img src="/icons/XamOps.png" alt="XamOps Logo" class="h-10 w-auto"></a>
    </div>

    <!-- Account Selector -->
    <div class="p-4 border-b bg-gradient-to-r from-gray-50 to-white flex-shrink-0">
        <div class="relative">
            <div @click="open = !open" class="flex items-center justify-between p-3 rounded-xl bg-white border border-gray-200 hover:border-indigo-300 cursor-pointer transition-all duration-200 hover:shadow-md">
                <div class="flex items-center min-w-0">
                    <div class="relative flex-shrink-0">
                        <div class="w-10 h-10 account-avatar rounded-full flex items-center justify-center text-white font-bold text-sm mr-3" x-show="selectedAccountIds.length === 0" x-text="'X'"></div>
                        <div class="w-10 h-10 account-avatar rounded-full flex items-center justify-center text-white font-bold text-lg mr-3" x-show="selectedAccountIds.length > 1" x-text="selectedAccountIds.length"></div>
                        <img :src="getProviderIcon(selectedAccountDisplay.provider)" class="w-10 h-10 rounded-full mr-3 object-cover" x-show="selectedAccountIds.length === 1">
                        <div class="connection-indicator" x-show="selectedAccountIds.length > 0"></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2">
                            <span class="account-status" x-show="selectedAccountIds.length > 0"></span>
                            <span class="text-sm font-semibold text-gray-800 truncate" x-text="selectedAccountDisplay.name"></span>
                        </div>
                        <p class="text-xs text-gray-500 truncate" x-text="selectedAccountDisplay.id"></p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div x-show="isLoading" class="w-4 h-4 border-2 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                    <i class="fas fa-chevron-down text-gray-400 text-xs transition-transform duration-200" :class="{ 'rotate-180': open }"></i>
                </div>
            </div>

            <!-- Dropdown -->
            <div x-show="open" x-transition @click.outside="open = false" x-cloak class="absolute left-0 right-0 mt-2 bg-white border border-gray-200 rounded-xl shadow-xl z-50 overflow-hidden">
                
                <div x-show="isDashboardPage" class="p-3 border-b bg-gray-50">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-700">Multi-Account Mode</p>
                            <p class="text-xs text-gray-500">AWS accounts only</p>
                        </div>
                        <div @click="toggleMultiAccountMode()" class="toggle-switch" :class="{'active': multiAccountMode}">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>

                <!-- Search -->
                <div class="p-3 border-b bg-gray-50">
                    <input type="text" x-model="searchTerm" placeholder="Search accounts..." class="w-full px-3 py-2 text-sm rounded-lg focus:outline-none border">
                </div>

                <!-- Quick Actions (Multi-Account Mode) -->
                <div x-show="multiAccountMode && isDashboardPage" class="p-2 border-b bg-gray-50 flex gap-2">
                    <button @click="selectAllAws()" class="flex-1 px-3 py-1.5 text-xs font-medium text-indigo-600 hover:bg-indigo-50 rounded-md transition-colors">
                        Select All AWS
                    </button>
                    <button @click="clearAllSelections()" class="flex-1 px-3 py-1.5 text-xs font-medium text-gray-600 hover:bg-gray-100 rounded-md transition-colors">
                        Clear All
                    </button>
                </div>

                <!-- Accounts List -->
                <div class="py-1 max-h-60 overflow-y-auto sidebar-scroll">
                    <template x-if="awsAccounts.length > 0">
                        <div>
                            <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase bg-gray-50">
                                AWS Accounts (<span x-text="awsAccounts.length"></span>)
                            </div>
                            <template x-for="account in awsAccounts" :key="account.id">
                                <div @click="toggleAccount(account.id)" 
                                     class="flex items-center px-4 py-3 text-sm hover:bg-indigo-50 cursor-pointer transition-colors"
                                     :class="{ 'bg-indigo-50': isAccountSelected(account.id) }">
                                    <input type="checkbox" 
                                           :checked="isAccountSelected(account.id)" 
                                           class="mr-3 rounded text-indigo-600"
                                           x-show="multiAccountMode && isDashboardPage">
                                    <img :src="getProviderIcon(account.provider)" class="w-8 h-8 rounded-full mr-3 flex-shrink-0 object-cover">
                                    <div class="flex-1 min-w-0">
                                        <div class="font-medium text-gray-900 truncate" x-text="account.name"></div>
                                        <div class="text-xs text-gray-500 truncate" x-text="account.id"></div>
                                    </div>
                                    <i class="fas fa-check text-indigo-600" x-show="!multiAccountMode && isAccountSelected(account.id)"></i>
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- GCP Accounts -->
                    <template x-if="gcpAccounts.length > 0">
                        <div>
                            <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase bg-gray-50">
                                GCP Projects (<span x-text="gcpAccounts.length"></span>)
                            </div>
                            <template x-for="account in gcpAccounts" :key="account.id">
                                <div @click="toggleAccount(account.id)" 
                                     class="flex items-center px-4 py-3 text-sm hover:bg-blue-50 cursor-pointer transition-colors"
                                     :class="{ 'bg-blue-50': isAccountSelected(account.id) }">
                                    <img :src="getProviderIcon(account.provider)" class="w-8 h-8 rounded-full mr-3 flex-shrink-0 object-cover">
                                    <div class="flex-1 min-w-0">
                                        <div class="font-medium text-gray-900 truncate" x-text="account.name"></div>
                                        <div class="text-xs text-gray-500 truncate" x-text="account.id"></div>
                                    </div>
                                    <i class="fas fa-check text-blue-600" x-show="isAccountSelected(account.id)"></i>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>

                <!-- Apply Button -->
                <div class="p-3 bg-gray-50 border-t">
                    <button @click="applySelection()" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                        Apply Selection
                        <span x-show="multiAccountMode && tempSelectedAccounts.length > 0" class="ml-1">
                            (<span x-text="tempSelectedAccounts.length"></span>)
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Menu -->
    <nav class="flex-1 px-3 py-4 space-y-2 text-sm overflow-y-auto sidebar-scroll">

        <!-- XamOps Admin Menu -->
        <div x-show="hasAnyRole(['ROLE_XAMOPS', 'ROLE_ADMIN'])" x-cloak>
            <div class="sidebar-section" :class="{'active': isActive('/dashboard.html') || isActive('/gcp_dashboard.html')}">
                <a :href="getLink('/dashboard.html')" class="nav-item flex items-center gap-3 rounded-xl px-4 py-3 font-semibold" :class="isActive('/dashboard.html') || isActive('/gcp_dashboard.html') ? 'bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg' : 'text-gray-600 hover:bg-indigo-50'">
                    <i class="fas fa-tachometer-alt fa-fw w-5 text-center"></i>
                    <span>Dashboard</span>
                </a>
            </div>

            <div class="sidebar-section" :class="{'active': isActive('/finops') || isActive('/cost') || isActive('/waste') || isActive('/rightsizing') || isActive('/reservation') || isActive('/gcp_finops') || isActive('/gcp_cost') || isActive('/gcp_waste') || isActive('/gcp_rightsizing') || isActive('/gcp_reservations')}">
                <div x-data="{ open: isActive('/finops') || isActive('/cost') || isActive('/waste') || isActive('/rightsizing') || isActive('/reservation') || isActive('/gcp_finops') || isActive('/gcp_cost') || isActive('/gcp_waste') || isActive('/gcp_rightsizing') || isActive('/gcp_reservations') }">
                    <button @click="open = !open" class="nav-item w-full flex items-center justify-between gap-3 rounded-xl px-4 py-3 font-semibold" :class="isActive('/finops') || isActive('/cost') || isActive('/waste') || isActive('/rightsizing') || isActive('/reservation') || isActive('/gcp_finops') || isActive('/gcp_cost') || isActive('/gcp_waste') || isActive('/gcp_rightsizing') || isActive('/gcp_reservations') ? 'bg-gradient-to-r from-green-500 to-teal-600 text-white shadow-lg' : 'text-gray-600 hover:bg-green-50'">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-cogs fa-fw w-5 text-center"></i>
                            <span>FinOps</span>
                        </div>
                        <i class="fas fa-chevron-down text-xs transition-transform" :class="open && 'rotate-180'"></i>
                    </button>
                    <div x-show="open" class="ml-6 mt-2 space-y-1">
                        <a :href="getLink('/finops.html')" :class="{'text-green-600 font-bold bg-green-50': isActive('/finops.html') || isActive('/gcp_finops.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-green-600">FinOps Report</a>
                        <a :href="getLink('/cost.html')" :class="{'text-green-600 font-bold bg-green-50': isActive('/cost.html') || isActive('/gcp_cost.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-green-600">Costs Overview</a>
                        <a :href="getLink('/waste.html')" :class="{'text-green-600 font-bold bg-green-50': isActive('/waste.html') || isActive('/gcp_waste.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-green-600">Waste</a>
                        <a :href="getLink('/rightsizing.html')" :class="{'text-green-600 font-bold bg-green-50': isActive('/rightsizing.html') || isActive('/gcp_rightsizing.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-green-600">Rightsizing</a>
                        <a :href="getLink('/reservation.html')" :class="{'text-green-600 font-bold bg-green-50': isActive('/reservation.html') || isActive('/gcp_reservations.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-green-600">Reservations</a>
                    </div>
                </div>
            </div>


            <div class="sidebar-section mt-2" :class="{'active': isActive('/grafana') || isActive('/grafana-dashboard') || isActive('/devops_in_the_box.html') || isActive('/cloudk8s.html')}">
                <div x-data="{ open: isActive('/grafana') || isActive('/grafana-dashboard') || isActive('/devops_in_the_box.html') || isActive('/cloudk8s.html') }">
                    <button @click="open = !open" class="nav-item w-full flex items-center justify-between gap-3 rounded-xl px-4 py-3 font-semibold" :class="isActive('/grafana') || isActive('/grafana-dashboard') || isActive('/devops_in_the_box.html') ? 'bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg' : 'text-gray-600 hover:bg-indigo-50'">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-chart-line fa-fw w-5 text-center"></i>
                            <span>CloudOps</span>
                        </div>
                        <i class="fas fa-chevron-down text-xs transition-transform" :class="open && 'rotate-180'"></i>
                    </button>
                    <div x-show="open" class="ml-6 mt-2 space-y-1">
                        <a :href="getLink('/grafana-dashboard.html')" :class="{'text-indigo-600 font-bold bg-indigo-50': isActive('/grafana-dashboard.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">Grafana</a>
                        <a :href="getLink('/xamops_tickets.html')" :class="{'text-indigo-600 font-bold bg-indigo-50': isActive('/xamops_tickets.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">Tickets</a>
                        <a :href="getLink('/devops_in_the_box.html')" :class="{'text-red-600 font-bold bg-red-50': isActive('/devops_in_the_box.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-cyan-600">DevOps In The Box</a>
                        <a :href="getLink('/cloudk8s.html')" :class="{'text-indigo-600 font-bold bg-indigo-50': isActive('/cloudk8s.html') || isActive('/gcp_cloudk8s.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">CloudK8s</a>
                        <a :href="getLink('/cicd_pipelines.html')" :class="{'text-indigo-600 font-bold bg-indigo-50': isActive('/cicd_pipelines')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">CICD Pipelines</a>
                    </div>
                </div>
            </div>

            <div class="sidebar-section" :class="{'active': isActive('/security') || isActive('/performance') || isActive('/alerts') || isActive('/gcp_security') || isActive('/gcp_performance')}">
                <div x-data="{ open: isActive('/security') || isActive('/performance') || isActive('/alerts') || isActive('/gcp_security') || isActive('/gcp_performance') }">
                    <button @click="open = !open" class="nav-item w-full flex items-center justify-between gap-3 rounded-xl px-4 py-3 font-semibold" :class="isActive('/security') || isActive('/performance') || isActive('/alerts') || isActive('/gcp_security') || isActive('/gcp_performance') ? 'bg-gradient-to-r from-red-500 to-orange-600 text-white shadow-lg' : 'text-gray-600 hover:bg-red-50'">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-shield-alt fa-fw w-5 text-center"></i>
                            <span>SecOps</span>
                        </div>
                        <i class="fas fa-chevron-down text-xs transition-transform" :class="open && 'rotate-180'"></i>
                    </button>
                    <div x-show="open" class="ml-6 mt-2 space-y-1">
                        <a :href="getLink('/security.html')" :class="{'text-red-600 font-bold bg-red-50': isActive('/security.html') || isActive('/gcp_security.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-red-600">Security</a>
                        <a :href="getLink('/performance.html')" :class="{'text-red-600 font-bold bg-red-50': isActive('/performance.html') || isActive('/gcp_performance.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-red-600">Performance</a>
                        <a :href="getLink('/alerts.html')" :class="{'text-red-600 font-bold bg-red-50': isActive('/alerts.html')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-red-600">Alerts</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Bottom Fixed Section: BillOps, Account Management, User Management, Logout -->
    <div class="flex-shrink-0 border-t bg-white p-3 space-y-2">

        <!-- BillOps for XAMOPS (non-admin) -->
        <div x-show="hasAnyRole('ROLE_XAMOPS') && !hasAnyRole('ROLE_BILLOPS_ADMIN')" x-cloak>
            <div class="sidebar-section" :class="{'active': isActive('/billops/')}">
                <div x-data="{ open: isActive('/billops/') }">
                    <button @click="open = !open" class="nav-item w-full flex items-center justify-between gap-3 rounded-xl px-4 py-3 font-semibold" :class="isActive('/billops/') ? 'bg-gradient-to-r from-cyan-500 to-blue-600 text-white shadow-lg' : 'text-gray-600 hover:bg-cyan-50'">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-file-invoice-dollar fa-fw w-5 text-center"></i>
                            <span>BillOps</span>
                        </div>
                        <i class="fas fa-chevron-down text-xs transition-transform" :class="open && 'rotate-180'"></i>
                    </button>
                    <div x-show="open" class="ml-6 mt-2 space-y-1">
                        <a :href="getLink('/billops/billing.html')" :class="{'text-cyan-600 font-bold bg-cyan-50': isActive('/billops/billing') || isActive('/billops/gcp-billing')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-cyan-600">Billing</a>
                        <a :href="getLink('/billops/invoices.html')" :class="{'text-cyan-600 font-bold bg-cyan-50': isActive('/billops/invoices')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-cyan-600">Invoices</a>
                        <a :href="getLink('/billops/credits.html')" :class="{'text-cyan-600 font-bold bg-cyan-50': isActive('/billops/credits')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-cyan-600">Credits</a>
                        <a :href="getLink('/billops/tickets.html')" :class="{'text-cyan-600 font-bold bg-cyan-50': isActive('/billops/tickets')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-cyan-600">Tickets</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Tools for BILLOPS_ADMIN -->
        <div x-show="hasAnyRole('ROLE_BILLOPS_ADMIN')" x-cloak>
            <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase">Admin Tools</div>
            <div class="sidebar-section mt-2">
                <div x-data="{ open: isActive('/billops/admin_') }">
                    <button @click="open = !open" class="nav-item w-full flex items-center justify-between gap-3 rounded-xl px-4 py-3 font-semibold" :class="isActive('/billops/admin_') ? 'bg-gradient-to-r from-gray-700 to-gray-800 text-white shadow-lg' : 'text-gray-600 hover:bg-gray-100'">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-user-shield fa-fw w-5 text-center"></i>
                            <span>Admin Console</span>
                        </div>
                        <i class="fas fa-chevron-down text-xs transition-transform" :class="open && 'rotate-180'"></i>
                    </button>
                    <div x-show="open" class="ml-6 mt-2 space-y-1">
                        <a :href="getLink('/billops/admin_invoices.html')" :class="{'text-gray-800 font-bold bg-gray-100': isActive('/billops/admin_invoices')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-gray-800">Invoice Admin</a>
                        <a :href="getLink('/billops/admin_credits.html')" :class="{'text-gray-800 font-bold bg-gray-100': isActive('/billops/admin_credits')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-gray-800">Credit Admin</a>
                        <a :href="getLink('/billops/admin_tickets.html')" :class="{'text-gray-800 font-bold bg-gray-100': isActive('/billops/admin_tickets')}" class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-gray-800">Ticket Admin</a>
                    </div>
                </div>
            </div>
            <div class="sidebar-section mt-4" :class="{'active': isActive('/billops/billing') || isActive('/billops/gcp-billing')}">
                <a :href="getLink('/billops/billing.html')" class="nav-item flex items-center gap-3 rounded-xl px-4 py-3 font-semibold" :class="isActive('/billops/billing') || isActive('/billops/gcp-billing') ? 'bg-gradient-to-r from-cyan-500 to-blue-600 text-white shadow-lg' : 'text-gray-600 hover:bg-cyan-50'">
                    <i class="fas fa-file-invoice-dollar fa-fw w-5 text-center"></i>
                    <span>Billing</span>
                </a>
            </div>
        </div>

        <!-- Account Management -->
        <div class="sidebar-section" :class="{'active': isActive('/account-manager.html')}">
            <a href="/account-manager.html" class="nav-item flex items-center gap-3 rounded-xl px-4 py-3 font-semibold" :class="isActive('/account-manager.html') ? 'bg-gradient-to-r from-purple-500 to-pink-600 text-white shadow-lg' : 'text-gray-600 hover:bg-purple-50'">
                <i class="fas fa-users-cog fa-fw w-5 text-center"></i>
                <span class="whitespace-nowrap">Account Management</span>
            </a>
        </div>

        <!-- User Management (XamOps + Admin + BillOps Admin) -->
        <div x-show="hasAnyRole(['ROLE_XAMOPS', 'ROLE_ADMIN', 'ROLE_BILLOPS_ADMIN'])" x-cloak class="sidebar-section" :class="{'active': isActive('/Xamops_user_management.html') || isActive('/user-manager.html')}">
            <a href="/Xamops_user_management.html" class="nav-item flex items-center gap-3 rounded-xl px-4 py-3 font-semibold" :class="isActive('/Xamops_user_management.html') || isActive('/user-manager.html') ? 'bg-gradient-to-r from-purple-500 to-pink-600 text-white shadow-lg' : 'text-gray-600 hover:bg-purple-50'">
                <i class="fas fa-users fa-fw w-5 text-center"></i>
                <span class="whitespace-nowrap">User Management</span>
            </a>
        </div>

        <!-- Logout -->
        <div>
            <form id="logoutForm" action="/logout" method="POST" class="w-full">
                <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" x-ref="csrf">
                <button type="submit" 
                        onclick="return confirm('Are you sure you want to log out?')" 
                        class="nav-item flex items-center gap-3 rounded-xl px-4 py-3 font-semibold text-gray-600 hover:bg-red-50 w-full text-left">
                    <i class="fas fa-sign-out-alt fa-fw w-5 text-center"></i>
                    <span>Logout</span>
                </button>
            </form>
        </div>
    </div>
</div>
</body>
</html>