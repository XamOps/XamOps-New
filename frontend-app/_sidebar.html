<script>
    (function () {
        // Store the original browser fetch function
        const originalFetch = window.fetch;

        // Override fetch with our smart wrapper
        window.fetch = async function (url, options = {}) {
            // 1. Get Context from Session
            const tenantId = sessionStorage.getItem('selectedTenantId');
            const impersonateId = sessionStorage.getItem('impersonateUserId');

            // 2. Get CSRF Token
            const csrfToken = document.cookie
                .split('; ')
                .find(row => row.startsWith('XSRF-TOKEN='))
                ?.split('=')[1];

            // 3. Initialize headers if they don't exist
            if (!options.headers) {
                options.headers = {};
            }

            // 4. Helper to add headers safely
            const addHeader = (key, value) => {
                if (value) {
                    if (options.headers instanceof Headers) {
                        options.headers.set(key, value);
                    } else {
                        options.headers[key] = value;
                    }
                }
            };

            // 5. Inject Headers (Only for internal API calls)
            const urlStr = url.toString();
            const isInternal = urlStr.startsWith('/') || urlStr.includes(window.location.origin);

            if (isInternal) {
                if (!options.headers['Content-Type'] && !(options.body instanceof FormData)) {
                    addHeader('Content-Type', 'application/json');
                }
                addHeader('X-XSRF-TOKEN', csrfToken);
                addHeader('X-Tenant-ID', tenantId);
                addHeader('X-Impersonate-User', impersonateId);

                if (urlStr.includes('/api/xamops/superadmin/tenants')) {
                    if (options.headers instanceof Headers) {
                        options.headers.delete('X-Tenant-ID');
                    } else {
                        delete options.headers['X-Tenant-ID'];
                    }
                }
            }

            // 6. Execute the request
            try {
                const response = await originalFetch(url, options);
                if (response.status === 401 && !urlStr.includes('/login')) {
                    console.warn('Global Interceptor: Session expired or unauthorized.');
                }
                return response;
            } catch (error) {
                throw error;
            }
        };
        console.log("✅ Global Multi-Tenant Interceptor Activated");
    })();
</script>

<style>
    /* Toggle Switch Styles */
    .toggle-switch {
        position: relative;
        width: 48px;
        height: 24px;
        background-color: #cbd5e1;
        border-radius: 12px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .toggle-switch.active {
        background-color: #4f46e5;
    }

    .toggle-slider {
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background-color: white;
        border-radius: 50%;
        transition: transform 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch.active .toggle-slider {
        transform: translateX(24px);
    }

    /* Account Avatar Styles */
    .account-avatar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .connection-indicator {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 10px;
        height: 10px;
        background-color: #10b981;
        border: 2px solid white;
        border-radius: 50%;
    }

    .account-status {
        width: 8px;
        height: 8px;
        background-color: #10b981;
        border-radius: 50%;
        display: inline-block;
    }
</style>

<div class="w-64 fixed top-0 left-0 h-screen flex flex-col bg-white shadow-xl z-30" x-data="{
    open: false,
    // 1. OPTIMIZATION: Load from cache immediately to prevent flicker
    accounts: JSON.parse(sessionStorage.getItem('cached_accounts') || '[]'),
    selectedAccountIds: [],
    tempSelectedAccounts: [],
    searchTerm: '',
    isLoading: false, 
    // 2. OPTIMIZATION: Load roles from cache so menus appear instantly
    userRoles: JSON.parse(sessionStorage.getItem('cached_user_roles') || '[]'),
    multiAccountMode: false,
    isDashboardPage: false,
    isBillingPage: false,
    
    // SuperAdmin Specific State
    tenantList: [],
    tenantUsers: [],
    selectedTenant: sessionStorage.getItem('selectedTenantId') || '',
    impersonateUser: sessionStorage.getItem('impersonateUserId') || '',

    async apiFetch(url, options = {}) {
        const response = await fetch(url, {
            ...options,
            credentials: 'include'
        });

        if (!response.ok) {
            console.error('API Error:', response.status, await response.text());
            throw new Error(`HTTP ${response.status}`);
        }
        return response;
    },

    init() {
        // --- 3. OPTIMIZATION: Restore Scroll Position ---
        const savedScroll = sessionStorage.getItem('sidebar_scroll_pos');
        if (savedScroll) {
            this.$nextTick(() => {
                const scrollContainer = document.querySelector('.sidebar-scroll');
                if (scrollContainer) scrollContainer.scrollTop = parseInt(savedScroll);
            });
        }
        
        // Save scroll position before navigating away
        window.addEventListener('beforeunload', () => {
            const scrollContainer = document.querySelector('.sidebar-scroll');
            if (scrollContainer) {
                sessionStorage.setItem('sidebar_scroll_pos', scrollContainer.scrollTop);
            }
        });
        // -----------------------------------------------

        // 4. Standard Init
        const urlParams = new URLSearchParams(window.location.search);
        const urlAccountId = urlParams.get('accountId') || urlParams.get('accountIds');
        const urlProjectId = urlParams.get('projectId');

        let selectedIds = [];

        if (urlAccountId) {
            selectedIds = urlAccountId.split(',');
        } else if (urlProjectId) {
             selectedIds = [urlProjectId];
        }
        
        if (selectedIds.length === 0) {
            selectedIds = JSON.parse(sessionStorage.getItem('selectedAccountIds') || '[]');
        }

        this.selectedAccountIds = selectedIds;
        this.tempSelectedAccounts = [...selectedIds];
        
        if (selectedIds.length > 0) {
            sessionStorage.setItem('selectedAccountIds', JSON.stringify(selectedIds));
        }

        this.multiAccountMode = sessionStorage.getItem('multiAccountMode') === 'true';
        
        this.checkCurrentPage();
        
        // Fetch fresh data in background (UI is already rendered from cache)
        this.fetchAccounts();
        this.fetchUserRoles();
        
        window.addEventListener('account-changed', () => this.fetchAccounts());

        // 5. Soft Navigation: Handle Browser Back/Forward Buttons
        window.addEventListener('popstate', (event) => {
            console.log('[Sidebar] Popstate event detected:', window.location.href);
            
            const urlParams = new URLSearchParams(window.location.search);
            const urlAccountIds = urlParams.get('accountIds');
            const urlAccountId = urlParams.get('accountId');
            const urlProjectId = urlParams.get('projectId');
            
            let recoveredIds = [];
            
            if (urlAccountIds) {
                recoveredIds = urlAccountIds.split(',');
            } else if (urlAccountId) {
                recoveredIds = [urlAccountId];
            } else if (urlProjectId) {
                recoveredIds = [urlProjectId];
            }
            
            if (recoveredIds.length > 0) {
                console.log('[Sidebar] Restoring selection from history:', recoveredIds);
                this.selectedAccountIds = recoveredIds;
                this.tempSelectedAccounts = [...recoveredIds];
                
                // Update Storage
                sessionStorage.setItem('selectedAccountIds', JSON.stringify(this.selectedAccountIds));
                
                // Dispatch Event so Dashboard/Page refreshes
                window.dispatchEvent(new CustomEvent('account-changed', {
                    detail: { 
                        accountId: recoveredIds[0], 
                        accountIds: recoveredIds 
                    }
                }));
            }
        });
    },

    checkCurrentPage() {
        const path = window.location.pathname;
        this.isDashboardPage = path.includes('dashboard');
        this.isBillingPage = path.includes('billing');
    },

    fetchAccounts() {
        if (this.accounts.length === 0) {
            this.isLoading = true;
        }
        
        this.apiFetch('/api/xamops/account-manager/accounts')
            .then(res => res.json())
            .then(data => {
                this.accounts = data.filter(acc => acc.status === 'CONNECTED');
                sessionStorage.setItem('cached_accounts', JSON.stringify(this.accounts));

                if (this.selectedAccountIds.length === 0 && this.accounts.length > 0) {
                    this.selectedAccountIds = [this.accounts[0].id];
                    this.tempSelectedAccounts = [this.accounts[0].id];
                }
            })
            .catch(err => {
                console.error('Failed to fetch accounts:', err);
            })
            .finally(() => this.isLoading = false);
    },

    fetchUserRoles() {
        this.apiFetch('/api/xamops/user/profile')
            .then(res => res.json())
            .then(data => {
                let roles = [];
                if (data.roles) {
                    roles = data.roles;
                } else if (data.authorities) {
                    roles = data.authorities;
                }
                
                this.userRoles = roles;
                sessionStorage.setItem('cached_user_roles', JSON.stringify(this.userRoles));

                if (this.hasAnyRole('ROLE_SUPER_ADMIN')) {
                    this.fetchTenants();
                    if (this.selectedTenant) {
                        this.fetchTenantUsers(this.selectedTenant);
                    }
                } 
            })
            .catch(err => {
                console.error('Could not fetch user profile:', err);
            });
    },

    // --- SuperAdmin Functions ---
    async fetchTenants() {
        try {
            const response = await fetch('/api/xamops/superadmin/tenants');
            if (response.ok) {
                this.tenantList = await response.json();
            }
        } catch (e) {
            console.error('Failed to load tenants', e);
        }
    },

    async fetchTenantUsers(tenantId) {
        try {
            const res = await this.apiFetch('/api/xamops/superadmin/users');
            this.tenantUsers = await res.json();
        } catch (e) {
            console.error('Failed to load tenant users', e);
        }
    },

    switchTenant() {
        if (this.selectedTenant) {
            sessionStorage.setItem('selectedTenantId', this.selectedTenant);
            sessionStorage.removeItem('impersonateUserId');
            window.location.reload();
        } else {
            this.resetContext();
        }
    },

    switchUser() {
        if (this.impersonateUser) {
            sessionStorage.setItem('impersonateUserId', this.impersonateUser);
            window.location.reload();
        }
    },

    resetContext() {
        sessionStorage.removeItem('selectedTenantId');
        sessionStorage.removeItem('impersonateUserId');
        this.selectedTenant = '';
        this.impersonateUser = '';
        window.location.reload();
    },
    // ---------------------------

    hasAnyRole(requiredRoles) {
        if (!Array.isArray(requiredRoles)) {
            requiredRoles = [requiredRoles];
        }
        
        if (!this.userRoles || this.userRoles.length === 0) return false;

        return requiredRoles.some(role => {
            if (this.userRoles.includes(role)) return true;
            return this.userRoles.some(r => (r.authority === role) || (r.role === role));
        });
    },

    toggleMultiAccountMode() {
        this.multiAccountMode = !this.multiAccountMode;
        sessionStorage.setItem('multiAccountMode', this.multiAccountMode);
        
        if (!this.multiAccountMode && this.selectedAccountIds.length > 1) {
            this.tempSelectedAccounts = [this.selectedAccountIds[0]];
        } else if (this.multiAccountMode) {
            this.tempSelectedAccounts = [...this.selectedAccountIds];
        }
    },

    toggleAccount(accountId) {
        const account = this.accounts.find(a => a.id === accountId);
        if (!account) return;

        // ✅ Check if account is disabled
        if (this.isAccountDisabled(accountId)) {
            const firstAccount = this.accounts.find(a => a.id === this.tempSelectedAccounts[0]);
            alert(`Cannot select ${account.provider} accounts. You have already selected ${firstAccount.provider} accounts. Please clear your selection first.`);
            return;
        }

        if (this.multiAccountMode && this.isDashboardPage) {
            const index = this.tempSelectedAccounts.indexOf(accountId);
            if (index > -1) {
                this.tempSelectedAccounts.splice(index, 1);
            } else {
                if (this.tempSelectedAccounts.length >= 10) {
                    alert('Maximum 10 accounts can be selected');
                    return;
                }
                this.tempSelectedAccounts.push(accountId);
            }
        } else {
            this.tempSelectedAccounts = [accountId];
        }
    },

    isAccountDisabled(accountId) {
        // Only disable in multi-account mode on dashboard page
        if (!this.multiAccountMode || !this.isDashboardPage) return false;
        if (this.tempSelectedAccounts.length === 0) return false;
        
        const account = this.accounts.find(a => a.id === accountId);
        const firstAccount = this.accounts.find(a => a.id === this.tempSelectedAccounts[0]);
        
        // Disable if different provider than first selected account
        return account && firstAccount && account.provider !== firstAccount.provider;
    },

    isAccountSelected(accountId) {
        return this.tempSelectedAccounts.includes(accountId);
    },

    selectAllAws() {
        const awsIds = this.accounts
            .filter(acc => acc.provider === 'AWS')
            .map(acc => acc.id)
            .slice(0, 10);
        this.tempSelectedAccounts = awsIds;
    },

    selectAllGcp() {
        const gcpIds = this.accounts
            .filter(acc => acc.provider === 'GCP')
            .map(acc => acc.id)
            .slice(0, 10);
        this.tempSelectedAccounts = gcpIds;
    },

    clearAllSelections() {
        this.tempSelectedAccounts = [];
    },

    applySelection() {
        console.log('[Sidebar] applySelection called');
        if (this.tempSelectedAccounts.length === 0) {
            alert('Please select at least one account');
            return;
        }

        this.selectedAccountIds = [...this.tempSelectedAccounts];
        sessionStorage.setItem('selectedAccountIds', JSON.stringify(this.selectedAccountIds));
        sessionStorage.setItem('multiAccountMode', this.multiAccountMode);
        this.open = false;

        // 1. Determine Provider Context (All selected accounts are guaranteed to be same provider by toggleAccount)
        const firstSelectedId = this.selectedAccountIds[0];
        const account = this.accounts.find(a => a.id === firstSelectedId);
        const provider = account ? account.provider : 'AWS';
        console.log('[Sidebar] Selected Provider:', provider);

        let targetPage;
        const isBillOpsUser = this.hasAnyRole(['ROLE_BILLOPS', 'ROLE_BILLOPS_ADMIN']);
        
        if (isBillOpsUser) {
            switch (provider) {
                case 'GCP': targetPage = '/billops/gcp-billing.html'; break;
                case 'Azure': targetPage = '/billops/azure-billing.html'; break;
                case 'AWS': default: targetPage = '/billops/billing.html'; break;
            }
        } else {
            switch (provider) {
                case 'GCP': targetPage = '/gcp_dashboard.html'; break;
                case 'Azure': targetPage = '/azure_dashboard.html'; break;
                case 'AWS': default: targetPage = '/dashboard.html'; break;
            }

            // Exception: Allow CloudShell to stay on page (supports soft nav)
            if (window.location.pathname === '/cloudshell.html') {
                targetPage = '/cloudshell.html';
            }
        }
        console.log('[Sidebar] Target Page:', targetPage);

        // 2. Handle Multi-Account Mode (Dispatch event if on same dashboard type)
        if (this.multiAccountMode && this.selectedAccountIds.length > 1 && this.isDashboardPage) {
             // Check if we are already on the correct provider's dashboard
             if (window.location.pathname === targetPage) {
                console.log('[Sidebar] Multi-account soft update. Dispatching event.');
                window.dispatchEvent(new CustomEvent('multi-account-selection-changed', {
                    detail: { accountIds: this.selectedAccountIds }
                }));
                return;
             }
        }
        
        // 3. Construct URL
        const urlParams = new URLSearchParams();
        urlParams.set('accountIds', this.selectedAccountIds.join(','));
        
        if (account && this.selectedAccountIds.length === 1) {
             if (account.provider === 'Azure' && account.azureSubscriptionId) {
                urlParams.set('subscriptionId', account.azureSubscriptionId);
             } else if (account.provider === 'GCP') {
                urlParams.set('projectId', account.id);
             } else if (account.provider === 'AWS') {
                 urlParams.set('accountId', account.id);
             }
        }

        const targetUrl = `${targetPage}?${urlParams.toString()}`;
        console.log('[Sidebar] Constructed Target URL:', targetUrl);

        // 4. SMART NAVIGATION CHECK
        if (window.location.pathname === targetPage) {
            console.log('[Sidebar] Soft navigation detected. Updating state and dispatching account-changed.');
            
            // Push new state to history so back button works expectedly
            window.history.pushState(null, '', targetUrl);
            
            // Critical: Dispatch event so Dashboard reloads data
            window.dispatchEvent(new CustomEvent('account-changed', {
                detail: { accountId: firstSelectedId, accountIds: this.selectedAccountIds }
            }));
        } else {
            console.log('[Sidebar] Hard navigation required. Redirecting...');
            window.location.href = targetUrl;
        }
    },

    get selectedAccountDisplay() {
        if (this.selectedAccountIds.length === 0) {
            return { name: 'Select Accounts', id: this.accounts.length === 0 && !this.isLoading ? 'No accounts connected' : 'No account selected' };
        }
        if (this.selectedAccountIds.length === 1) {
            const account = this.accounts.find(a => a.id === this.selectedAccountIds[0]);
            return { name: account?.name || 'Loading...', id: account?.id || '', provider: account?.provider || 'AWS' };
        }
        
        // Multi-Account Display
        const firstAccount = this.accounts.find(a => a.id === this.selectedAccountIds[0]);
        const provider = firstAccount ? firstAccount.provider : 'AWS';
        return { name: `${this.selectedAccountIds.length} ${provider} Accounts`, id: 'Multi-Account View', provider: provider };
    },

    get filteredAccounts() {
        if (this.searchTerm === '') return this.accounts;
        const term = this.searchTerm.toLowerCase();
        return this.accounts.filter(account => 
            account.name.toLowerCase().includes(term) || 
            (account.id && account.id.toLowerCase().includes(term))
        );
    },

    get awsAccounts() { return this.filteredAccounts.filter(acc => acc.provider === 'AWS'); },
    get gcpAccounts() { return this.filteredAccounts.filter(acc => acc.provider === 'GCP'); },
    get azureAccounts() { return this.filteredAccounts.filter(acc => acc.provider === 'Azure'); },

    getProviderIcon(provider) {
        switch(provider) {
            case 'GCP': return '/icons/gcp-icon.png';
            case 'Azure': return '/icons/azure-icon.png';
            case 'AWS': default: return '/icons/default-icon.png';
        }
    },

    isActive(path) {
        const currentPath = window.location.pathname;
        if (currentPath === path) return true;

        if (path === '/dashboard.html') {
            return currentPath === '/dashboard.html' || currentPath === '/gcp_dashboard.html' || currentPath === '/azure_dashboard.html';
        }
        if (path === '/finops.html') {
            return currentPath === '/finops.html' || currentPath === '/gcp_finops.html' || currentPath === '/azure-finops-report.html';
        }
        if (path === '/cost.html') {
            return currentPath === '/cost.html' || currentPath === '/gcp_cost.html';
        }
        if (path === '/waste.html') {
            return currentPath === '/waste.html' || currentPath === '/gcp_waste.html';
        }
        if (path === '/rightsizing.html') {
            return currentPath === '/rightsizing.html' || currentPath === '/rightsizing.html' || currentPath === '/gcp_rightsizing.html';
        }
        if (path === '/reservation.html') {
            return currentPath === '/reservation.html' || currentPath === '/gcp_reservations.html';
        }
        if (path === '/cloudk8s.html') {
            return currentPath === '/cloudk8s.html' || currentPath === '/gcp_cloudk8s.html';
        }
        if (path === '/security.html') {
            return currentPath === '/security.html' || currentPath === '/gcp_security.html';
        }
        if (path === '/performance.html') {
            return currentPath === '/performance.html' || currentPath === '/gcp_performance.html';
        }
        if (path === '/alerts.html') {
            return currentPath === '/alerts.html' || currentPath === '/gcp_alerts.html';
        }
        if (path === '/billops/billing.html') {
            return currentPath === '/billops/billing.html' || currentPath === '/billops/gcp-billing.html' || currentPath === '/billops/azure-billing.html';
        }
        
        if (path === '/finops') {
             return currentPath.includes('finops') || 
                    currentPath.includes('cost') || 
                    currentPath.includes('waste') || 
                    currentPath.includes('rightsizing') || 
                    currentPath.includes('reservation') || 
                    currentPath.includes('azure-finops') ||
                    currentPath.includes('spot-automation');
        }
        if (path === '/cloudk8s') {
            return currentPath.includes('cloudk8s');
        }
        if (path === '/security') {
             return currentPath.includes('security') || 
                    currentPath.includes('performance') || 
                    currentPath.includes('alerts') ||
                    currentPath.includes('complianceops');
        }
        if (path === '/billops/') {
            return currentPath.startsWith('/billops/');
        }
        if (path === '/billops/admin_') {
            return currentPath.startsWith('/billops/admin_');
        }
        if (path === '/cloudops') {
            return currentPath.includes('grafana') ||
                   currentPath.includes('devops_in_the_box') ||
                   currentPath.includes('cloudk8s') ||
                   currentPath.includes('cicd_pipelines') ||
                   currentPath.includes('sonarqube') ||
                   currentPath.includes('aiops') ||
                   currentPath.includes('dataops');
        }

        return currentPath.startsWith(path) && path !== '/';
    },

    getLink(basePath) {
        const selectedIds = this.selectedAccountIds;
        if (selectedIds.length === 0) {
            if (basePath.includes('account-manager.html') || basePath.includes('dashboard.html') || basePath.includes('Xamops_user_management.html')) return basePath;
            return '#';
        }

        const firstAccountId = selectedIds[0];
        const account = this.accounts.find(a => a.id === firstAccountId);
        const provider = account ? account.provider : 'AWS';

        let finalPath = basePath;
        
        if (basePath.includes('/billops/')) {
            if (basePath.startsWith('/billops/admin_')) {
                finalPath = basePath;
            } else if (basePath === '/billops/billing.html') { 
                switch (provider) {
                    case 'GCP': finalPath = '/billops/gcp-billing.html'; break;
                    case 'Azure': finalPath = '/billops/azure-billing.html'; break;
                    case 'AWS': default: finalPath = '/billops/billing.html'; break;
                }
            }
        } else {
            const gcpExcludedPages = [
                '/cicd_pipelines.html',
                '/xamops_tickets.html',
                '/devops_in_the_box.html',
                '/grafana-dashboard.html',
                '/sonarqube.html',
                '/aiops.html',
                '/dataops.html',
                '/complianceops.html',
                '/spot-automation.html'
            ];
            
            const shouldExclude = gcpExcludedPages.some(page => basePath.includes(page));
            
            if (provider === 'GCP' && !shouldExclude) {
                if (basePath === '/reservation.html') finalPath = '/gcp_reservations.html';
                else if (basePath === '/cloudk8s.html') finalPath = '/gcp_cloudk8s.html';
                else if (['/dashboard.html', '/finops.html', '/cost.html', '/waste.html', '/rightsizing.html', '/security.html', '/performance.html', '/alerts.html'].includes(basePath)) {
                    finalPath = basePath.replace('.html', '').replace('/', '/gcp_') + '.html';
                } else {
                    finalPath = basePath;
                }
            } else if (provider === 'Azure') {
                if (basePath === '/dashboard.html') finalPath = '/azure_dashboard.html';
                else if (basePath === '/finops.html') finalPath = '/azure-finops-report.html';
                else if (basePath === '/account-manager.html') finalPath = basePath;
                else {
                    const awsGcpPages = ['/cost.html', '/waste.html', '/rightsizing.html', '/reservation.html', '/grafana-dashboard.html', '/xamops_tickets.html', '/devops_in_the_box.html', '/cloudk8s.html', '/cicd_pipelines.html', '/security.html', '/performance.html', '/alerts.html', '/sonarqube.html'];
                    if (awsGcpPages.includes(basePath)) finalPath = '/azure_dashboard.html';
                    else finalPath = basePath;
                }
            } else {
                finalPath = basePath;
            }
        }

        const url = new URL(window.location.origin + finalPath);
        url.searchParams.append('accountIds', selectedIds.join(','));
        
        if (selectedIds.length === 1 && account) {
             if (account.provider === 'Azure' && account.azureSubscriptionId) {
                url.searchParams.append('subscriptionId', account.azureSubscriptionId);
             } else if (account.provider === 'GCP') {
                url.searchParams.append('projectId', account.id);
             } else if (account.provider === 'AWS') {
                 url.searchParams.append('accountId', account.id);
             }
        }
        return url.toString();
    }
}">

    <div class="flex-shrink-0 flex items-center justify-center h-16 border-b bg-white">
        <a href="/dashboard.html"><img src="/icons/xlogo.png" alt="XamOps Logo" class="h-40 w-100"></a>
    </div>

    <div class="p-4 border-b bg-gradient-to-r from-gray-50 to-white flex-shrink-0">
        <div class="relative">
            <div @click="open = !open"
                class="flex items-center justify-between p-3 rounded-xl bg-white border border-gray-200 hover:border-indigo-300 cursor-pointer transition-all duration-200 hover:shadow-md">
                <div class="flex items-center min-w-0">
                    <div class="relative flex-shrink-0">
                        <div class="w-10 h-10 account-avatar rounded-full flex items-center justify-center text-white font-bold text-sm mr-3"
                            x-show="selectedAccountIds.length === 0" x-text="'X'"></div>
                        <div class="w-10 h-10 account-avatar rounded-full flex items-center justify-center text-white font-bold text-lg mr-3"
                            x-show="selectedAccountIds.length > 1" x-text="selectedAccountIds.length"></div>
                        <img :src="getProviderIcon(selectedAccountDisplay.provider)"
                            class="w-10 h-10 rounded-full mr-3 object-cover" x-show="selectedAccountIds.length === 1">
                        <div class="connection-indicator" x-show="selectedAccountIds.length > 0"></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2">
                            <span class="account-status" x-show="selectedAccountIds.length > 0"></span>
                            <span class="text-sm font-semibold text-gray-800 truncate"
                                x-text="selectedAccountDisplay.name"></span>
                        </div>
                        <p class="text-xs text-gray-500 truncate" x-text="selectedAccountDisplay.id"></p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div x-show="isLoading"
                        class="w-4 h-4 border-2 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                    <i class="fas fa-chevron-down text-gray-400 text-xs transition-transform duration-200"
                        :class="{ 'rotate-180': open }"></i>
                </div>
            </div>

            <div x-show="open" x-transition @click.outside="open = false" x-cloak
                class="absolute left-0 right-0 mt-2 bg-white border border-gray-200 rounded-xl shadow-xl z-50 overflow-hidden">

                <div x-show="isDashboardPage" class="p-3 border-b bg-gray-50">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-700">Multi-Account Mode</p>
                            <p class="text-xs text-gray-500">AWS or GCP accounts</p>
                        </div>
                        <div @click="toggleMultiAccountMode()" class="toggle-switch"
                            :class="{'active': multiAccountMode}">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>

                <div class="p-3 border-b bg-gray-50">
                    <input type="text" x-model="searchTerm" placeholder="Search accounts..."
                        class="w-full px-3 py-2 text-sm rounded-lg focus:outline-none border">
                </div>

                <div x-show="multiAccountMode && isDashboardPage" class="p-2 border-b bg-gray-50 flex flex-col gap-2">
                    <div class="flex gap-2">
                        <button @click="selectAllAws()"
                            class="flex-1 px-3 py-1.5 text-xs font-medium text-indigo-600 hover:bg-indigo-50 rounded-md transition-colors border border-indigo-200">
                            <i class="fab fa-aws mr-1"></i> Select All AWS
                        </button>
                        <button @click="selectAllGcp()"
                            class="flex-1 px-3 py-1.5 text-xs font-medium text-blue-600 hover:bg-blue-50 rounded-md transition-colors border border-blue-200">
                            <i class="fab fa-google mr-1"></i> Select All GCP
                        </button>
                    </div>
                    <button @click="clearAllSelections()"
                        class="w-full px-3 py-1.5 text-xs font-medium text-gray-600 hover:bg-gray-100 rounded-md transition-colors border border-gray-200">
                        <i class="fas fa-times mr-1"></i> Clear All
                    </button>
                </div>

                <div class="py-1 max-h-60 overflow-y-auto sidebar-scroll">
                    <template x-if="awsAccounts.length > 0">
                        <div>
                            <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase bg-gray-50">
                                AWS Accounts (<span x-text="awsAccounts.length"></span>)
                            </div>
                            <template x-for="account in awsAccounts" :key="account.id">
                                <div @click="toggleAccount(account.id)"
                                    class="flex items-center px-4 py-3 text-sm transition-colors" :class="{
                                        'bg-indigo-50': isAccountSelected(account.id),
                                        'hover:bg-indigo-50 cursor-pointer': !isAccountDisabled(account.id),
                                        'opacity-40 cursor-not-allowed': isAccountDisabled(account.id)
                                    }">
                                    <input type="checkbox" :checked="isAccountSelected(account.id)"
                                        :disabled="isAccountDisabled(account.id)" class="mr-3 rounded text-indigo-600"
                                        x-show="multiAccountMode && isDashboardPage">
                                    <img :src="getProviderIcon(account.provider)"
                                        class="w-8 h-8 rounded-full mr-3 flex-shrink-0 object-cover">
                                    <div class="flex-1 min-w-0">
                                        <div class="font-medium text-gray-900 truncate" x-text="account.name"></div>
                                        <div class="text-xs text-gray-500 truncate" x-text="account.id"></div>
                                    </div>
                                    <i class="fas fa-lock text-gray-400 text-xs"
                                        x-show="isAccountDisabled(account.id)"></i>
                                    <i class="fas fa-check text-indigo-600"
                                        x-show="!multiAccountMode && isAccountSelected(account.id)"></i>
                                </div>
                            </template>
                        </div>
                    </template>

                    <template x-if="gcpAccounts.length > 0">
                        <div>
                            <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase bg-gray-50">
                                GCP Projects (<span x-text="gcpAccounts.length"></span>)
                            </div>
                            <template x-for="account in gcpAccounts" :key="account.id">
                                <div @click="toggleAccount(account.id)"
                                    class="flex items-center px-4 py-3 text-sm transition-colors" :class="{
                                        'bg-blue-50': isAccountSelected(account.id),
                                        'hover:bg-blue-50 cursor-pointer': !isAccountDisabled(account.id),
                                        'opacity-40 cursor-not-allowed': isAccountDisabled(account.id)
                                    }">
                                    <input type="checkbox" :checked="isAccountSelected(account.id)"
                                        :disabled="isAccountDisabled(account.id)" class="mr-3 rounded text-blue-600"
                                        x-show="multiAccountMode && isDashboardPage">
                                    <img :src="getProviderIcon(account.provider)"
                                        class="w-8 h-8 rounded-full mr-3 flex-shrink-0 object-cover">
                                    <div class="flex-1 min-w-0">
                                        <div class="font-medium text-gray-900 truncate" x-text="account.name"></div>
                                        <div class="text-xs text-gray-500 truncate" x-text="account.id"></div>
                                    </div>
                                    <i class="fas fa-lock text-gray-400 text-xs"
                                        x-show="isAccountDisabled(account.id)"></i>
                                    <i class="fas fa-check text-blue-600"
                                        x-show="!multiAccountMode && isAccountSelected(account.id)"></i>
                                </div>
                            </template>
                        </div>
                    </template>

                    <template x-if="azureAccounts.length > 0">
                        <div>
                            <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase bg-gray-50">
                                Azure Subscriptions (<span x-text="azureAccounts.length"></span>)
                            </div>
                            <template x-for="account in azureAccounts" :key="account.id">
                                <div @click="toggleAccount(account.id)"
                                    class="flex items-center px-4 py-3 text-sm hover:bg-blue-50 cursor-pointer transition-colors"
                                    :class="{ 'bg-blue-50': isAccountSelected(account.id) }">
                                    <img :src="getProviderIcon(account.provider)"
                                        class="w-8 h-8 rounded-full mr-3 flex-shrink-0 object-cover">
                                    <div class="flex-1 min-w-0">
                                        <div class="font-medium text-gray-900 truncate" x-text="account.name"></div>
                                        <div class="text-xs text-gray-500 truncate"
                                            x-text="account.azureSubscriptionId || account.id"></div>
                                    </div>
                                    <i class="fas fa-check text-blue-600" x-show="isAccountSelected(account.id)"></i>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>

                <div class="p-3 bg-gray-50 border-t">
                    <button @click="applySelection()"
                        class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                        Apply Selection
                        <span x-show="multiAccountMode && tempSelectedAccounts.length > 0" class="ml-1">
                            (<span x-text="tempSelectedAccounts.length"></span>)
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <nav class="flex-1 px-3 py-4 space-y-2 text-sm overflow-y-auto sidebar-scroll">
        <div x-show="hasAnyRole(['ROLE_XAMOPS', 'ROLE_ADMIN', 'ROLE_SUPER_ADMIN'])" x-cloak>
            <div class="sidebar-section" :class="{'active': isActive('/unified-dashboard.html')}">
                <a href="/unified-dashboard.html"
                    class="nav-item flex items-center gap-3 rounded-xl px-4 py-3 font-semibold"
                    :class="isActive('/unified-dashboard.html') ? 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg' : 'text-gray-600 hover:bg-indigo-50'">
                    <i class="fas fa-layer-group fa-fw w-5 text-center"></i>
                    <span>Unified Dashboard</span>
                </a>
            </div>

            <div class="sidebar-section" :class="{'active': isActive('/dashboard.html')}">
                <a :href="getLink('/dashboard.html')"
                    class="nav-item flex items-center gap-3 rounded-xl px-4 py-3 font-semibold"
                    :class="isActive('/dashboard.html') ? 'bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg' : 'text-gray-600 hover:bg-indigo-50'">
                    <i class="fas fa-tachometer-alt fa-fw w-5 text-center"></i>
                    <span>Dashboard</span>
                </a>
            </div>

            <div class="sidebar-section" :class="{'active': isActive('/finops')}">
                <div x-data="{ open: isActive('/finops') }">
                    <button @click="open = !open"
                        class="nav-item w-full flex items-center justify-between gap-3 rounded-xl px-4 py-3 font-semibold"
                        :class="isActive('/finops') ? 'bg-gradient-to-r from-green-500 to-teal-600 text-white shadow-lg' : 'text-gray-600 hover:bg-green-50'">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-cogs fa-fw w-5 text-center"></i>
                            <span>FinOps</span>
                        </div>
                        <i class="fas fa-chevron-down text-xs transition-transform" :class="open && 'rotate-180'"></i>
                    </button>
                    <div x-show="open" class="ml-6 mt-2 space-y-1">
                        <a :href="getLink('/finops.html')"
                            :class="{'text-green-600 font-bold bg-green-50': isActive('/finops.html')}"
                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-green-600">FinOps
                            Report</a>
                        <a :href="getLink('/cost.html')"
                            :class="{'text-green-600 font-bold bg-green-50': isActive('/cost.html')}"
                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-green-600">Costs
                            Overview</a>
                        <a :href="getLink('/waste.html')"
                            :class="{'text-green-600 font-bold bg-green-50': isActive('/waste.html')}"
                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-green-600">Waste</a>
                        <a :href="getLink('/rightsizing.html')"
                            :class="{'text-green-600 font-bold bg-green-50': isActive('/rightsizing.html')}"
                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-green-600">Rightsizing</a>
                        <a :href="getLink('/reservation.html')"
                            :class="{'text-green-600 font-bold bg-green-50': isActive('/reservation.html')}"
                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-green-600">Reservations</a>
                        <a :href="getLink('/spot-automation.html')" x-show="selectedAccountDisplay.provider === 'AWS'"
                            :class="{'text-green-600 font-bold bg-green-50': isActive('/spot-automation.html')}"
                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-green-600">Spot
                            Automation</a>
                    </div>
                </div>
            </div>

            <div class="sidebar-section" :class="{'active': isActive('/cloudops')}">
                <div x-data="{ open: isActive('/cloudops') }">
                    <button @click="open = !open"
                        class="nav-item w-full flex items-center justify-between gap-3 rounded-xl px-4 py-3 font-semibold"
                        :class="isActive('/cloudops') ? 'bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg' : 'text-gray-600 hover:bg-indigo-50'">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-chart-line fa-fw w-5 text-center"></i>
                            <span>CloudOps</span>
                        </div>
                        <i class="fas fa-chevron-down text-xs transition-transform" :class="open && 'rotate-180'"></i>
                    </button>
                    <div x-show="open" class="ml-6 mt-2 space-y-1">
                        <a :href="getLink('/grafana-dashboard.html')"
                            :class="{'text-indigo-600 font-bold bg-indigo-50': isActive('/grafana-dashboard.html')}"
                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">Grafana</a>
                        <a :href="getLink('/xamops_tickets.html')"
                            :class="{'text-indigo-600 font-bold bg-indigo-50': isActive('/xamops_tickets.html')}"
                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">Tickets</a>
                        <a :href="getLink('/devops_in_the_box.html')"
                            :class="{'text-red-600 font-bold bg-red-50': isActive('/devops_in_the_box.html')}"
                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-cyan-600">DevOps
                            In The Box</a>
                        <a :href="getLink('/cloudk8s.html')"
                            :class="{'text-indigo-600 font-bold bg-indigo-50': isActive('/cloudk8s.html')}"
                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">CloudK8s</a>
                        <a :href="getLink('/cicd_pipelines.html')"
                            :class="{'text-indigo-600 font-bold bg-indigo-50': isActive('/cicd_pipelines')}"
                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">CICD
                            Pipelines</a>
                        <a :href="getLink('/sonarqube.html')"
                            :class="{'text-indigo-600 font-bold bg-indigo-50': isActive('/sonarqube.html')}"
                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">Code
                            Quality</a>
                        <a :href="getLink('/aiops.html')"
                            :class="{'text-indigo-600 font-bold bg-indigo-50': isActive('/aiops.html')}"
                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">AIOps</a>
                        <a :href="getLink('/dataops.html')"
                            :class="{'text-indigo-600 font-bold bg-indigo-50': isActive('/dataops.html')}"
                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">DataOps</a>
                    </div>
                </div>
            </div>

            <div class="sidebar-section" :class="{'active': isActive('/security')}">
                <div x-data="{ open: isActive('/security') }">
                    <button @click="open = !open"
                        class="nav-item w-full flex items-center justify-between gap-3 rounded-xl px-4 py-3 font-semibold"
                        :class="isActive('/security') ? 'bg-gradient-to-r from-red-500 to-orange-600 text-white shadow-lg' : 'text-gray-600 hover:bg-red-50'">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-shield-alt fa-fw w-5 text-center"></i>
                            <span>SecOps</span>
                        </div>
                        <i class="fas fa-chevron-down text-xs transition-transform" :class="open && 'rotate-180'"></i>
                    </button>
                    <div x-show="open" class="ml-6 mt-2 space-y-1">
                        <a :href="getLink('/security.html')"
                            :class="{'text-red-600 font-bold bg-red-50': isActive('/security.html')}"
                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-red-600">Security</a>
                        <a :href="getLink('/performance.html')"
                            :class="{'text-red-600 font-bold bg-red-50': isActive('/performance.html')}"
                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-red-600">Performance</a>
                        <a :href="getLink('/alerts.html')"
                            :class="{'text-red-600 font-bold bg-red-50': isActive('/alerts.html')}"
                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-red-600">Alerts</a>
                        <a :href="getLink('/complianceops.html')"
                            :class="{'text-red-600 font-bold bg-red-50': isActive('/complianceops.html')}"
                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-red-600">ComplianceOps</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex-shrink-0 border-t bg-white">
        <div x-show="hasAnyRole(['ROLE_XAMOPS', 'ROLE_BILLOPS', 'ROLE_SUPER_ADMIN']) && !hasAnyRole(['ROLE_BILLOPS_ADMIN'])"
            x-cloak class="relative">
            <div class="sidebar-section" :class="{'active': isActive('/billops/')}">
                <div x-data="{ open: isActive('/billops/') }">
                    <div x-show="open" x-transition:enter="transition ease-out duration-200"
                        x-transition:enter-start="opacity-0 -translate-y-2"
                        x-transition:enter-end="opacity-100 translate-y-0"
                        x-transition:leave="transition ease-in duration-150"
                        x-transition:leave-start="opacity-100 translate-y-0"
                        x-transition:leave-end="opacity-0 -translate-y-2"
                        class="absolute bottom-full left-0 right-0 bg-white border-t border-gray-200 py-2 px-3 shadow-lg">
                        <div class="space-y-1">
                            <a :href="getLink('/billops/billing.html')"
                                :class="{'text-cyan-600 font-bold bg-cyan-50': isActive('/billops/billing.html')}"
                                class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-cyan-600">Billing</a>
                            <a :href="getLink('/billops/invoices.html')"
                                :class="{'text-cyan-600 font-bold bg-cyan-50': isActive('/billops/invoices')}"
                                class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-cyan-600">Invoices</a>
                            <a :href="getLink('/billops/credits.html')"
                                :class="{'text-cyan-600 font-bold bg-cyan-50': isActive('/billops/credits')}"
                                class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-cyan-600">Credits</a>
                            <a :href="getLink('/billops/tickets.html')"
                                :class="{'text-cyan-600 font-bold bg-cyan-50': isActive('/billops/tickets')}"
                                class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-cyan-600">Tickets</a>
                            <a :href="getLink('/billops/agreements.html')"
                                :class="{'text-cyan-600 font-bold bg-cyan-50': isActive('/billops/agreements')}"
                                class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-cyan-600">Agreements</a>
                        </div>
                    </div>

                    <button @click="open = !open"
                        class="nav-item w-full flex items-center justify-between rounded-xl px-7 py-3 font-semibold"
                        :class="isActive('/billops/') ? 'bg-gradient-to-r from-cyan-500 to-blue-600 text-white shadow-lg' : 'text-gray-600 hover:bg-cyan-50'">
                        <div class="flex items-center">
                            <i class="fas fa-file-invoice-dollar fa-fw w-5 text-center"></i>
                            <span>BillOps</span>
                        </div>
                        <i class="fas fa-chevron-down text-xs transition-transform" :class="open && 'rotate-180'"></i>
                    </button>
                </div>
            </div>
        </div>
        <div x-show="hasAnyRole('ROLE_BILLOPS_ADMIN')" x-cloak class="relative">

            <div class="sidebar-section">
                <div x-data="{ open: isActive('/billops/admin_') }">
                    <div x-show="open" x-transition:enter="transition ease-out duration-200"
                        x-transition:enter-start="opacity-0 -translate-y-2"
                        x-transition:enter-end="opacity-100 translate-y-0"
                        x-transition:leave="transition ease-in duration-150"
                        x-transition:leave-start="opacity-100 translate-y-0"
                        x-transition:leave-end="opacity-0 -translate-y-2"
                        class="absolute bottom-full left-0 right-0 bg-white border-t border-gray-200 py-2 px-3 shadow-lg">
                        <div class="space-y-1">
                            <a :href="getLink('/billops/admin_invoices.html')"
                                :class="{'text-gray-800 font-bold bg-gray-100': isActive('/billops/admin_invoices')}"
                                class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-gray-800">Invoice
                                Admin</a>
                            <a :href="getLink('/billops/admin_cloudfront_billing.html')"
                                :class="{'text-gray-800 font-bold bg-gray-100': isActive('/billops/admin_cloudfront_billing')}"
                                class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-gray-800">CloudFront
                                Billing</a>
                            <a :href="getLink('/billops/admin_credits.html')"
                                :class="{'text-gray-800 font-bold bg-gray-100': isActive('/billops/admin_credits')}"
                                class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-gray-800">Credit
                                Admin</a>
                            <a :href="getLink('/billops/admin_tickets.html')"
                                :class="{'text-gray-800 font-bold bg-gray-100': isActive('/billops/admin_tickets')}"
                                class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-gray-800">Ticket
                                Admin</a>
                            <a :href="getLink('/billops/admin_agreements.html')"
                                :class="{'text-gray-800 font-bold bg-gray-100': isActive('/billops/admin_agreements')}"
                                class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-gray-800">Agreements
                                Admin</a>
                        </div>
                    </div>

                    <button @click="open = !open"
                        class="nav-item w-full flex items-center justify-between gap-3 rounded-xl px-4 py-3 font-semibold mx-3"
                        :class="isActive('/billops/admin_') ? 'bg-gradient-to-r from-gray-700 to-gray-800 text-white shadow-lg' : 'text-gray-600 hover:bg-gray-100'">
                        <div x-show="hasAnyRole('ROLE_BILLOPS_ADMIN')" x-cloak>
                            <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase">Admin Tools</div>

                            <div class="sidebar-section">
                                <div x-data="{ open: isActive('/billops/admin_') }">
                                    <button @click="open = !open"
                                        class="nav-item w-full flex items-center justify-between gap-3 rounded-xl px-4 py-3 font-semibold mx-3"
                                        :class="isActive('/billops/admin_') ? 'bg-gradient-to-r from-gray-700 to-gray-800 text-white shadow-lg' : 'text-gray-600 hover:bg-gray-100'">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-user-shield fa-fw w-5 text-center"></i>
                                            <span>Admin Console</span>
                                        </div>
                                        <i class="fas fa-chevron-down text-xs transition-transform"
                                            :class="open && 'rotate-180'"></i>
                                    </button>

                                    <div x-show="open" x-transition:enter="transition ease-out duration-200"
                                        x-transition:enter-start="opacity-0 -translate-y-2"
                                        x-transition:enter-end="opacity-100 translate-y-0"
                                        x-transition:leave="transition ease-in duration-150"
                                        x-transition:leave-start="opacity-100 translate-y-0"
                                        x-transition:leave-end="opacity-0 -translate-y-2" class="ml-6 mt-2 space-y-1">
                                        <a :href="getLink('/billops/admin_invoices.html')"
                                            :class="{'text-gray-800 font-bold bg-gray-100': isActive('/billops/admin_invoices')}"
                                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-gray-800">Invoice
                                            Admin</a>
                                        <a :href="getLink('/billops/admin_cloudfront_billing.html')"
                                            :class="{'text-gray-800 font-bold bg-gray-100': isActive('/billops/admin_cloudfront_billing')}"
                                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-gray-800">CloudFront
                                            Billing</a>
                                        <a :href="getLink('/billops/admin_credits.html')"
                                            :class="{'text-gray-800 font-bold bg-gray-100': isActive('/billops/admin_credits')}"
                                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-gray-800">Credit
                                            Admin</a>
                                        <a :href="getLink('/billops/admin_tickets.html')"
                                            :class="{'text-gray-800 font-bold bg-gray-100': isActive('/billops/admin_tickets')}"
                                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-gray-800">Ticket
                                            Admin</a>
                                        <a :href="getLink('/billops/admin_agreements.html')"
                                            :class="{'text-gray-800 font-bold bg-gray-100': isActive('/billops/admin_agreements')}"
                                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-gray-800">Agreements
                                            Admin</a>
                                    </div>
                                </div>

                                <div x-data="{ open: isActive('/billops/licenses_') }" class="mt-2">
                                    <button @click="open = !open"
                                        class="nav-item w-full flex items-center justify-between gap-3 rounded-xl px-4 py-3 font-semibold mx-3"
                                        :class="isActive('/billops/licenses_') ? 'bg-gradient-to-r from-gray-700 to-gray-800 text-white shadow-lg' : 'text-gray-600 hover:bg-gray-100'">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-key fa-fw w-5 text-center"></i>
                                            <span>Licenses</span>
                                        </div>
                                        <i class="fas fa-chevron-down text-xs transition-transform"
                                            :class="open && 'rotate-180'"></i>
                                    </button>

                                    <div x-show="open" x-transition:enter="transition ease-out duration-200"
                                        x-transition:enter-start="opacity-0 -translate-y-2"
                                        x-transition:enter-end="opacity-100 translate-y-0"
                                        x-transition:leave="transition ease-in duration-150"
                                        x-transition:leave-start="opacity-100 translate-y-0"
                                        x-transition:leave-end="opacity-0 -translate-y-2" class="ml-6 mt-2 space-y-1">
                                        <a :href="getLink('/billops/workspace-licenses.html')"
                                            :class="{'text-gray-800 font-bold bg-gray-100': isActive('/billops/workspace-licenses')}"
                                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-gray-800">Workspace
                                            Licenses</a>
                                        <a :href="getLink('/billops/marketplace-purchases.html')"
                                            :class="{'text-gray-800 font-bold bg-gray-100': isActive('/billops/marketplace-purchases')}"
                                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-gray-800">Marketplace
                                            Purchases</a>
                                        <a :href="getLink('/billops/thirdparty-tools.html')"
                                            :class="{'text-gray-800 font-bold bg-gray-100': isActive('/billops/thirdparty-tools')}"
                                            class="nav-item block rounded-lg px-4 py-2 font-medium text-gray-500 hover:text-gray-800">Thirdparty
                                            Tools</a>
                                    </div>
                                </div>
                            </div>

                            <div class="sidebar-section mt-2" :class="{'active': isActive('/billops/billing.html')}">
                                <a :href="getLink('/billops/billing.html')"
                                    class="nav-item flex items-center gap-3 rounded-xl px-4 py-3 font-semibold mx-3"
                                    :class="isActive('/billops/billing.html') ? 'bg-gradient-to-r from-cyan-500 to-blue-600 text-white shadow-lg' : 'text-gray-600 hover:bg-cyan-50'">
                                    <i class="fas fa-file-invoice-dollar fa-fw w-5 text-center"></i>

                                    <span>Billing</span>
                                </a>
                            </div>
                        </div>

                        </nav>

                        <div class="flex-shrink-0 border-t bg-white">
                            <div x-show="hasAnyRole('ROLE_XAMOPS') && !hasAnyRole('ROLE_BILLOPS_ADMIN')" x-cloak
                                class="relative">
                                <div class="sidebar-section" :class="{'active': isActive('/billops/')}">
                                </div>
                            </div>



                            <div class="p-3 space-y-2">
                                <div class="sidebar-section" :class="{'active': isActive('/account-manager.html')}">
                                    <a href="/account-manager.html"
                                        class="nav-item flex items-center gap-3 rounded-xl px-4 py-3 font-semibold"
                                        :class="isActive('/account-manager.html') ? 'bg-gradient-to-r from-purple-500 to-pink-600 text-white shadow-lg' : 'text-gray-600 hover:bg-purple-50'">
                                        <i class="fas fa-users-cog fa-fw w-5 text-center"></i>
                                        <span class="whitespace-nowrap">Account Management</span>
                                    </a>
                                </div>


                                <div x-show="hasAnyRole(['ROLE_BILLOPS_ADMIN'])" x-cloak class="sidebar-section"
                                    :class="{'active': isActive('/user-manager.html') || isActive('/user-manager.html')}">
                                    <a href="/user-manager.html"
                                        class="nav-item flex items-center gap-3 rounded-xl px-4 py-3 font-semibold"
                                        :class="isActive('/user-manager.html') || isActive('/user-manager.html') ? 'bg-gradient-to-r from-purple-500 to-pink-600 text-white shadow-lg' : 'text-gray-600 hover:bg-purple-50'">
                                        <i class="fas fa-users fa-fw w-5 text-center"></i>
                                        <span class="whitespace-nowrap">User Management</span>
                                    </a>
                                </div>

                                <div x-show="hasAnyRole(['ROLE_XAMOPS'])" x-cloak class="sidebar-section"
                                    :class="{'active': isActive('/Xamops_User_management.html') || isActive('/user-manager.html')}">
                                    <a href="/Xamops_User_management.html"
                                        class="nav-item flex items-center gap-3 rounded-xl px-4 py-3 font-semibold"
                                        :class="isActive('Xamops_User_management.html') || isActive('/Xamops_User_management.html') ? 'bg-gradient-to-r from-purple-500 to-pink-600 text-white shadow-lg' : 'text-gray-600 hover:bg-purple-50'">
                                        <i class="fas fa-users fa-fw w-5 text-center"></i>
                                        <span class="whitespace-nowrap">User Management</span>
                                    </a>
                                </div>

                                <div x-show="hasAnyRole('ROLE_SUPER_ADMIN')" x-cloak class="sidebar-section"
                                    :class="{'active': isActive('/superadmin_customers.html')}">
                                    <a href="/superadmin_customers.html"
                                        class="nav-item flex items-center gap-3 rounded-xl px-4 py-3 font-semibold text-gray-600 hover:bg-gray-100">
                                        <i class="fas fa-building fa-fw w-5 text-center"></i>
                                        <span class="whitespace-nowrap">Customer Management</span>
                                    </a>
                                </div>

                                <div>
                                    <form id="logoutForm" action="/logout" method="POST" class="w-full">
                                        <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"
                                            x-ref="csrf">
                                        <button type="submit"
                                            onclick="return confirm('Are you sure you want to log out?')"
                                            class="nav-item flex items-center gap-3 rounded-xl px-4 py-3 font-semibold text-gray-600 hover:bg-red-50 w-full text-left">
                                            <i class="fas fa-sign-out-alt fa-fw w-5 text-center"></i>
                                            <span>Logout</span>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                </div>
            </div>
            <script>
                // Standard navigation is now used instead of soft-navigation interception
                // to ensure reliable page loads and script constraints.
            </script>