<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XamOps - User Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="/icons/XamOps.png" sizes="32x32" type="image/png">
    <link rel="apple-touch-icon" href="/icons/XamOps.png">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js"></script>
    <script type="module" src="/src/main.js"></script>
</head>

<body class="bg-gray-50 text-gray-800">

    <div class="flex h-screen overflow-hidden">
        <include file="/_sidebar.html"></include>

        <div class="flex-1 flex flex-col h-screen overflow-hidden pl-64">

            <main id="main-content" class="flex-1 flex flex-col h-screen overflow-hidden" x-data="userManager()"
                x-init="initData()">

                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

                    [x-cloak] {
                        display: none !important;
                    }

                    .custom-scrollbar::-webkit-scrollbar {
                        height: 8px;
                        width: 8px;
                    }

                    .custom-scrollbar::-webkit-scrollbar-track {
                        background: #f1f1f1;
                    }

                    .custom-scrollbar::-webkit-scrollbar-thumb {
                        background: #cbd5e0;
                        border-radius: 4px;
                    }

                    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                        background: #a0aec0;
                    }
                </style>

                <header class="bg-white shadow-sm z-10 p-6 flex justify-between items-center border-b border-gray-200">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-users-cog text-purple-600 mr-2"></i> User Management
                        </h1>
                        <p class="text-sm text-gray-500 mt-1">Manage IAM Users, Roles, and Permissions</p>
                    </div>
                    <div class="flex space-x-3 items-center">
                        <div class="text-right mr-4">
                            <p class="text-sm font-semibold text-gray-700" x-text="accountName || 'Select an Account'">
                                Account Name</p>
                            <p class="text-xs text-gray-500" x-text="accountId || '...'">ID</p>
                        </div>

                        <button @click="fetchData(true)" :disabled="loading || !accountId"
                            class="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition text-sm font-medium disabled:opacity-50 flex items-center">
                            <i class="fas fa-sync-alt mr-2" :class="{'fa-spin': loading}"></i>
                            <span x-text="loading ? 'Refreshing...' : 'Refresh Data'"></span>
                        </button>
                    </div>
                </header>

                <div class="flex-1 overflow-y-auto p-6 bg-gray-50">

                    <div x-show="error" x-transition x-cloak
                        class="mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded-r shadow-sm">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-circle text-red-500"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-red-700 font-semibold">Status</p>
                                <p class="text-sm text-red-600" x-text="error"></p>
                            </div>
                        </div>
                    </div>

                    <div x-show="loading && !users.length" class="flex flex-col justify-center items-center h-96">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mb-4"></div>
                        <p class="text-gray-500 text-sm">Fetching IAM details from <span x-text="provider"></span>...
                        </p>
                        <p class="text-xs text-gray-400 mt-2">Account ID: <span x-text="accountId"></span></p>
                    </div>

                    <div x-show="!loading || users.length > 0" x-cloak>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-500 mb-1"
                                            x-text="'Total ' + usersLabel">Total IAM Users</p>
                                        <h3 class="text-2xl font-bold text-gray-800" x-text="users.length">0</h3>
                                    </div>
                                    <div
                                        class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                                        <i class="fas fa-user"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-500 mb-1">Total IAM Roles</p>
                                        <h3 class="text-2xl font-bold text-gray-800" x-text="roles.length">0</h3>
                                    </div>
                                    <div
                                        class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-purple-600">
                                        <i class="fas fa-user-shield"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100" x-show="isAws">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-500 mb-1">MFA Status</p>
                                        <h3 class="text-2xl font-bold text-gray-800" x-text="countNoMfa(users)">0
                                        </h3>
                                        <p class="text-xs text-red-500 mt-1" x-show="countNoMfa(users) > 0">Users
                                            potentially missing MFA</p>
                                    </div>
                                    <div
                                        class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center text-red-600">
                                        <i class="fas fa-shield-alt"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden min-h-[600px]">
                            <div class="border-b border-gray-200 bg-gray-50 px-6">
                                <nav class="flex space-x-8 -mb-px" aria-label="Tabs">
                                    <button @click="activeTab = 'users'"
                                        :class="activeTab === 'users' ? 'border-purple-500 text-purple-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                        class="py-4 px-1 text-center border-b-2 font-medium text-sm transition-colors duration-200 flex items-center">
                                        <i class="fas fa-user mr-2"></i> <span x-text="usersLabel">IAM Users</span>
                                        <span class="ml-2 bg-gray-200 text-gray-600 py-0.5 px-2 rounded-full text-xs"
                                            x-text="users.length"></span>
                                    </button>
                                    <button @click="activeTab = 'roles'"
                                        :class="activeTab === 'roles' ? 'border-purple-500 text-purple-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                        class="py-4 px-1 text-center border-b-2 font-medium text-sm transition-colors duration-200 flex items-center">
                                        <i class="fas fa-user-shield mr-2"></i> IAM Roles
                                        <span class="ml-2 bg-gray-200 text-gray-600 py-0.5 px-2 rounded-full text-xs"
                                            x-text="roles.length"></span>
                                    </button>
                                </nav>
                            </div>

                            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white">
                                <div class="relative w-64">
                                    <input type="text" x-model="searchQuery" placeholder="Search name or ID..."
                                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-search text-gray-400"></i>
                                    </div>
                                </div>
                            </div>

                            <div x-show="activeTab === 'users'" class="transition-opacity duration-300">
                                <div class="overflow-x-auto custom-scrollbar">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                    x-text="userIdentityLabel">
                                                    User Identity</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Groups</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Attached Policies</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Activity</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            <template x-for="user in filteredUsers" :key="user.userId">
                                                <tr class="hover:bg-gray-50 transition duration-150">
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="flex items-center">
                                                            <div
                                                                class="flex-shrink-0 h-10 w-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold shadow-sm">
                                                                <span
                                                                    x-text="user.userName.substring(0,2).toUpperCase()"></span>
                                                            </div>
                                                            <div class="ml-4">
                                                                <div class="text-sm font-semibold text-gray-900"
                                                                    x-text="user.userName"></div>
                                                                <div class="text-xs text-gray-500 truncate max-w-[150px]"
                                                                    :title="user.arn" x-text="user.userId"></div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <div class="flex flex-wrap gap-1.5">
                                                            <template x-if="user.groups && user.groups.length > 0">
                                                                <template x-for="group in user.groups">
                                                                    <span
                                                                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">
                                                                        <i class="fas fa-users mr-1 text-[10px]"></i>
                                                                        <span x-text="group"></span>
                                                                    </span>
                                                                </template>
                                                            </template>
                                                            <template x-if="!user.groups || user.groups.length === 0">
                                                                <span class="text-xs text-gray-400 italic">No
                                                                    Groups</span>
                                                            </template>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <div class="flex flex-col gap-1">
                                                            <template
                                                                x-if="user.attachedPolicies && user.attachedPolicies.length > 0">
                                                                <template x-for="policy in user.attachedPolicies">
                                                                    <div class="flex items-center group relative">
                                                                        <i
                                                                            class="fas fa-file-contract text-gray-400 mr-1.5"></i>
                                                                        <span class="text-sm text-gray-700 font-medium"
                                                                            x-text="policy.policyName"></span>

                                                                        <span x-show="policy.type === 'Managed'"
                                                                            class="ml-2 px-1.5 py-0.5 bg-green-100 text-green-800 text-[10px] rounded border border-green-200">Managed</span>
                                                                        <span x-show="policy.type === 'Inline'"
                                                                            class="ml-2 px-1.5 py-0.5 bg-yellow-100 text-yellow-800 text-[10px] rounded border border-yellow-200">Inline</span>
                                                                    </div>
                                                                </template>
                                                            </template>
                                                            <template
                                                                x-if="!user.attachedPolicies || user.attachedPolicies.length === 0">
                                                                <span class="text-xs text-gray-400 italic">No direct
                                                                    policies</span>
                                                            </template>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="text-xs text-gray-500">
                                                            <div class="mb-1"><span
                                                                    class="font-medium text-gray-600">Created:</span>
                                                                <span x-text="formatDate(user.createDate)"></span>
                                                            </div>
                                                            <div><span class="font-medium text-gray-600">Last Pwd
                                                                    Use:</span> <span
                                                                    x-text="formatDate(user.passwordLastUsed)"
                                                                    :class="isOld(user.passwordLastUsed) ? 'text-red-500 font-semibold' : ''"></span>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </template>

                                            <tr x-show="filteredUsers.length === 0 && users.length > 0">
                                                <td colspan="4" class="px-6 py-10 text-center text-gray-500">
                                                    No users match your search.
                                                </td>
                                            </tr>
                                            <tr x-show="users.length === 0">
                                                <td colspan="4" class="px-6 py-10 text-center text-gray-500">
                                                    <div class="flex flex-col items-center justify-center">
                                                        <i class="fas fa-ghost text-4xl text-gray-300 mb-2"></i>
                                                        <p class="font-semibold text-gray-600">No IAM Users found
                                                        </p>
                                                        <button @click="showDebug = true"
                                                            class="text-xs text-indigo-500 mt-2 hover:underline">
                                                            Check Debug Info
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div x-show="activeTab === 'roles'" class="transition-opacity duration-300" x-cloak>
                                <div class="overflow-x-auto custom-scrollbar">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Role Details</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Description</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Attached Policies</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Created</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            <template x-for="role in filteredRoles" :key="role.roleId">
                                                <tr class="hover:bg-gray-50 transition duration-150">
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="flex items-center">
                                                            <div
                                                                class="flex-shrink-0 h-9 w-9 bg-purple-100 rounded-lg flex items-center justify-center text-purple-600">
                                                                <i class="fas fa-robot"></i>
                                                            </div>
                                                            <div class="ml-4">
                                                                <div class="text-sm font-semibold text-gray-900"
                                                                    x-text="role.roleName"></div>
                                                                <div class="text-xs text-gray-500 cursor-pointer hover:text-indigo-600 truncate max-w-[200px]"
                                                                    :title="role.arn"
                                                                    @click="copyToClipboard(role.arn)">
                                                                    <i class="far fa-copy mr-1"></i> <span
                                                                        x-text="role.arn.split('/').pop()"></span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <div class="text-xs text-gray-600 max-w-xs break-words"
                                                            x-text="role.description || '-'"></div>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <div class="flex flex-col gap-1.5">
                                                            <template
                                                                x-if="role.attachedPolicies && role.attachedPolicies.length > 0">
                                                                <template x-for="policy in role.attachedPolicies">
                                                                    <div class="flex items-center">
                                                                        <i
                                                                            class="fas fa-shield-alt text-gray-400 mr-2 text-xs"></i>
                                                                        <span class="text-sm text-gray-700"
                                                                            x-text="policy.policyName"></span>
                                                                        <span x-show="policy.type === 'Managed'"
                                                                            class="ml-2 px-1.5 py-0.5 bg-gray-100 text-gray-600 text-[10px] rounded">AWS</span>
                                                                    </div>
                                                                </template>
                                                            </template>
                                                            <template
                                                                x-if="!role.attachedPolicies || role.attachedPolicies.length === 0">
                                                                <span class="text-xs text-gray-400 italic">No
                                                                    policies
                                                                    attached</span>
                                                            </template>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                        <span x-text="formatDate(role.createDate)"></span>
                                                    </td>
                                                </tr>
                                            </template>

                                            <tr x-show="filteredRoles.length === 0 && roles.length > 0">
                                                <td colspan="4" class="px-6 py-10 text-center text-gray-500">
                                                    No roles match your search.
                                                </td>
                                            </tr>
                                            <tr x-show="roles.length === 0">
                                                <td colspan="4" class="px-6 py-10 text-center text-gray-500">
                                                    <div class="flex flex-col items-center justify-center">
                                                        <i class="fas fa-ghost text-4xl text-gray-300 mb-2"></i>
                                                        <p class="font-semibold text-gray-600">No IAM Roles found
                                                        </p>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <script>
                    function userManager() {
                        return {
                            loading: false,
                            error: null,
                            activeTab: 'users',
                            accountName: '',
                            accountId: '',
                            provider: 'AWS', // Default to AWS
                            searchQuery: '',
                            users: [],
                            roles: [],
                            showDebug: false,
                            debugInfo: '',
                            lastUrl: '',

                            get isAws() { return this.provider === 'AWS'; },
                            get isGcp() { return this.provider === 'GCP'; },
                            get isAzure() { return this.provider === 'Azure'; },

                            get usersLabel() {
                                if (this.isGcp) return 'Service Accounts';
                                if (this.isAzure) return 'Principals';
                                return 'IAM Users';
                            },

                            get rolesLabel() {
                                return 'IAM Roles'; // Pretty standard across all
                            },

                            get userIdentityLabel() {
                                if (this.isGcp) return 'Service Account';
                                if (this.isAzure) return 'Principal Name';
                                return 'User Identity';
                            },

                            async initData() {
                                this.loadAccountFromStorage();
                                window.addEventListener('account-changed', () => this.loadAccountFromStorage());
                            },


                            determineProvider(accountId) {
                                try {
                                    const cached = sessionStorage.getItem('cached_accounts');
                                    if (cached) {
                                        const accounts = JSON.parse(cached);
                                        const account = accounts.find(a => a.id === accountId);
                                        if (account && account.provider) {
                                            this.provider = account.provider;
                                            return;
                                        }
                                    }
                                } catch (e) { console.error("Error determining provider", e); }
                                // Fallback: Don't reset to AWS here if we don't know, keep previous or default
                            },

                            loadAccountFromStorage() {
                                let targetId = null;
                                const storedIds = sessionStorage.getItem('selectedAccountIds');
                                if (storedIds) {
                                    try {
                                        const ids = JSON.parse(storedIds);
                                        if (Array.isArray(ids) && ids.length > 0) targetId = ids[0];
                                    } catch (e) { console.error("Error parsing IDs", e); }
                                }

                                if (!targetId) targetId = localStorage.getItem('selectedAccountId');
                                if (!targetId) targetId = new URLSearchParams(window.location.search).get('accountId');

                                if (targetId) {
                                    if (this.accountId !== targetId || this.users.length === 0) {
                                        this.accountId = targetId;
                                        this.determineProvider(targetId); // Update provider before fetch
                                        this.fetchData(false, targetId);
                                    }
                                } else {
                                    this.error = "Please select an account from the sidebar.";
                                    this.users = [];
                                    this.roles = [];
                                }
                            },

                            async fetchData(forceRefresh = false, specificAccountId = null) {
                                const idToFetch = specificAccountId || this.accountId;
                                if (!idToFetch) return;

                                this.loading = true;
                                this.error = null;
                                if (forceRefresh) this.debugInfo = 'Fetching fresh data...';

                                try {
                                    const url = `/api/xamops/dashboard/data?accountId=${idToFetch}&forceRefresh=${forceRefresh}&_t=${new Date().getTime()}`;
                                    this.lastUrl = url;
                                    console.log("Fetching:", url);

                                    const response = await fetch(url, {
                                        method: 'GET',
                                        headers: { 'Content-Type': 'application/json' }
                                    });

                                    if (!response.ok) {
                                        const text = await response.text();
                                        this.debugInfo = `Error ${response.status}: ${text.substring(0, 500)}`;
                                        throw new Error(`Status: ${response.status}`);
                                    }

                                    const data = await response.json();

                                    this.debugInfo = JSON.stringify(data.selectedAccount ? (data.selectedAccount.iamDetails || 'iamDetails is Missing') : 'No Account Data', null, 2);

                                    if (data) {
                                        // Capture Provider
                                        this.provider = data.selectedProvider || 'AWS';

                                        if (data.selectedAccount) {
                                            this.accountName = data.selectedAccount.name;
                                            this.accountId = data.selectedAccount.id;

                                            if (!data.selectedAccount.iamDetails && !forceRefresh) {
                                                console.warn("Stale cache detected (missing iamDetails). Auto-refreshing...");
                                                await this.fetchData(true, idToFetch);
                                                return;
                                            }

                                            if (data.selectedAccount.iamDetails) {
                                                this.users = data.selectedAccount.iamDetails.users || [];
                                                this.roles = data.selectedAccount.iamDetails.roles || [];
                                            } else {
                                                console.warn("IAM Details missing even after refresh.");
                                                this.users = [];
                                                this.roles = [];
                                                if (forceRefresh) this.error = "Backend returned incomplete data (iamDetails is null). Check Debug Info.";
                                            }
                                        }
                                    } else {
                                        throw new Error("Invalid response format");
                                    }

                                } catch (err) {
                                    console.error('Fetch error:', err);
                                    this.error = "Failed to load data. See Debug Info.";
                                } finally {
                                    this.loading = false;
                                }
                            },

                            get filteredUsers() {
                                if (!this.searchQuery) return this.users;
                                const lower = this.searchQuery.toLowerCase();
                                return this.users.filter(u =>
                                    (u.userName && u.userName.toLowerCase().includes(lower)) ||
                                    (u.userId && u.userId.toLowerCase().includes(lower))
                                );
                            },

                            get filteredRoles() {
                                if (!this.searchQuery) return this.roles;
                                const lower = this.searchQuery.toLowerCase();
                                return this.roles.filter(r =>
                                    r.roleName.toLowerCase().includes(lower)
                                );
                            },

                            formatDate(dateString) {
                                if (!dateString || dateString === 'Never') return 'Never';
                                try {
                                    const date = new Date(dateString);
                                    if (isNaN(date.getTime())) return dateString;
                                    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                                } catch (e) { return dateString; }
                            },

                            isOld(dateString) {
                                if (!dateString || dateString === 'Never') return true;
                                const date = new Date(dateString);
                                const ninetyDaysAgo = new Date();
                                ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
                                return date < ninetyDaysAgo;
                            },

                            countNoMfa(users) {
                                if (!this.isAws) return 0; // Not applicable or not fetched for GCP/Azure yet
                                return 0; // The logic for checking MFA was likely missing in backend or not exposed in IamUserDetail. Returning 0 to be safe.
                            },

                            async copyToClipboard(text) {
                                try { await navigator.clipboard.writeText(text); } catch (e) { }
                            }
                        }
                    }
                </script>
            </main>

        </div>
    </div>

</body>

</html>