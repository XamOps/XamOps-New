<div x-data="launchAnalyticsTab()" x-init="init()">

    <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl shadow-lg p-8 mb-6 text-white">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h2 class="text-3xl font-bold mb-2">Launch Analytics</h2>
                <p class="text-blue-100">Spot instance launch success metrics and recommendations</p>
            </div>

            <div class="flex flex-wrap items-end gap-3">
                <div>
                    <label class="block text-xs font-medium text-blue-100 mb-1">From</label>
                    <input type="date" x-model="filters.startDate"
                        class="px-4 py-2 bg-white/10 backdrop-blur-sm border border-white/20 rounded-lg text-white placeholder-blue-200 focus:ring-2 focus:ring-white/50 focus:border-transparent text-sm">
                </div>
                <div>
                    <label class="block text-xs font-medium text-blue-100 mb-1">To</label>
                    <input type="date" x-model="filters.endDate"
                        class="px-4 py-2 bg-white/10 backdrop-blur-sm border border-white/20 rounded-lg text-white placeholder-blue-200 focus:ring-2 focus:ring-white/50 focus:border-transparent text-sm">
                </div>

                <button @click="loadAnalytics()" :disabled="loading"
                    class="px-6 py-2 bg-white text-blue-700 rounded-lg hover:bg-blue-50 disabled:bg-white/50 disabled:cursor-not-allowed transition-all font-semibold text-sm flex items-center shadow-lg">
                    <i class="fas mr-2" :class="loading ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
                    <span x-text="loading ? 'Loading...' : 'Refresh'"></span>
                </button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-blue-50 rounded-xl">
                    <i class="fas fa-rocket text-blue-600 text-2xl"></i>
                </div>
                <div class="text-right">
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Total Attempts</p>
                    <h3 class="text-4xl font-bold text-gray-900 mt-1" x-text="analytics.totalAttempts"></h3>
                </div>
            </div>
            <div class="flex items-center text-xs text-gray-500">
                <i class="fas fa-calendar-alt mr-2"></i>
                <span>Selected Period</span>
            </div>
        </div>

        <div
            class="bg-gradient-to-br from-emerald-500 to-green-600 rounded-2xl shadow-sm p-6 text-white hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-white/20 backdrop-blur-sm rounded-xl">
                    <i class="fas fa-check-circle text-white text-2xl"></i>
                </div>
                <div class="text-right">
                    <p class="text-xs font-medium text-emerald-100 uppercase tracking-wide">Success Rate</p>
                    <h3 class="text-4xl font-bold mt-1" x-text="analytics.successRate.toFixed(1) + '%'"></h3>
                </div>
            </div>
            <div class="w-full bg-white/20 rounded-full h-2">
                <div class="bg-white rounded-full h-2 transition-all duration-500"
                    :style="`width: ${analytics.successRate}%`"></div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-green-50 rounded-xl">
                    <i class="fas fa-thumbs-up text-green-600 text-2xl"></i>
                </div>
                <div class="text-right">
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Successful</p>
                    <h3 class="text-4xl font-bold text-green-600 mt-1" x-text="analytics.successful"></h3>
                </div>
            </div>
            <div class="text-xs text-green-600 font-semibold" x-show="analytics.totalAttempts > 0">
                <i class="fas fa-arrow-up mr-1"></i>
                <span x-text="((analytics.successful / analytics.totalAttempts) * 100).toFixed(1) + '%'"></span>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-red-50 rounded-xl">
                    <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                </div>
                <div class="text-right">
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Failed</p>
                    <h3 class="text-4xl font-bold text-red-600 mt-1" x-text="analytics.failed"></h3>
                </div>
            </div>
            <div class="text-xs text-red-600 font-semibold" x-show="analytics.failed > 0">
                <i class="fas fa-arrow-down mr-1"></i>
                <span x-text="((analytics.failed / analytics.totalAttempts) * 100).toFixed(1) + '%'"></span>
            </div>
        </div>
    </div>

    <div x-show="loading" class="bg-white rounded-2xl shadow-sm border border-gray-200 p-16 text-center">
        <i class="fas fa-spinner fa-spin text-5xl text-blue-600 mb-4"></i>
        <p class="text-gray-600 font-medium text-lg">Loading analytics data...</p>
    </div>

    <div x-show="!loading" x-cloak class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Spot Market Heatmap</h3>
                    <p class="text-xs text-gray-500 mt-1">Instance Type Success Rates</p>
                </div>
                <div class="p-2 bg-blue-50 rounded-lg">
                    <i class="fas fa-th text-blue-600"></i>
                </div>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                <template x-for="(item, index) in analytics.byInstanceType" :key="index">
                    <div class="p-3 rounded-xl border transition-all duration-200 hover:shadow-md flex flex-col justify-between group"
                        :class="{
                            'bg-emerald-50 border-emerald-100': item.successRate >= 95,
                            'bg-yellow-50 border-yellow-100': item.successRate >= 80 && item.successRate < 95,
                            'bg-red-50 border-red-100': item.successRate < 80
                         }">
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-mono text-xs font-bold text-gray-700 truncate"
                                x-text="item.instanceType"></span>

                            <div class="relative flex h-2.5 w-2.5">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full opacity-75"
                                    :class="{
                                        'bg-emerald-400': item.successRate >= 95,
                                        'bg-yellow-400': item.successRate >= 80 && item.successRate < 95,
                                        'bg-red-400': item.successRate < 80
                                    }" x-show="item.attempts > 10"></span>
                                <span class="relative inline-flex rounded-full h-2.5 w-2.5" :class="{
                                        'bg-emerald-500': item.successRate >= 95,
                                        'bg-yellow-500': item.successRate >= 80 && item.successRate < 95,
                                        'bg-red-500': item.successRate < 80
                                    }"></span>
                            </div>
                        </div>

                        <div class="text-right">
                            <div class="text-lg font-bold" :class="{
                                    'text-emerald-700': item.successRate >= 95,
                                    'text-yellow-700': item.successRate >= 80 && item.successRate < 95,
                                    'text-red-700': item.successRate < 80
                                 }" x-text="item.successRate.toFixed(0) + '%'"></div>
                            <div class="text-[10px] text-gray-500 font-medium" x-text="item.attempts + ' launches'">
                            </div>
                        </div>
                    </div>
                </template>

                <div x-show="analytics.byInstanceType.length === 0"
                    class="col-span-full text-center py-8 text-gray-400">
                    <i class="fas fa-inbox text-3xl mb-2"></i>
                    <p class="text-sm">No instance type data available</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Success Rate by Region</h3>
                    <p class="text-xs text-gray-500 mt-1">Geographic distribution of launch success</p>
                </div>
                <div class="p-2 bg-purple-50 rounded-lg">
                    <i class="fas fa-globe text-purple-600"></i>
                </div>
            </div>

            <div class="space-y-4">
                <template x-for="(item, index) in analytics.byRegion" :key="index">
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-map-marker-alt text-purple-500 text-xs"></i>
                                <span class="text-sm font-semibold text-gray-700" x-text="item.region"></span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-gray-500" x-text="item.attempts + ' attempts'"></span>
                                <span class="text-sm font-bold text-purple-600"
                                    x-text="item.successRate.toFixed(1) + '%'"></span>
                            </div>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden">
                            <div class="h-3 rounded-full transition-all duration-500 flex items-center justify-end pr-2"
                                :class="item.successRate >= 95 ? 'bg-gradient-to-r from-purple-400 to-indigo-500' : item.successRate >= 80 ? 'bg-gradient-to-r from-yellow-400 to-orange-500' : 'bg-gradient-to-r from-red-400 to-red-600'"
                                :style="`width: ${item.successRate}%`">
                                <span class="text-[10px] font-bold text-white" x-show="item.successRate > 15"
                                    x-text="item.successRate.toFixed(0) + '%'"></span>
                            </div>
                        </div>
                    </div>
                </template>

                <div x-show="analytics.byRegion.length === 0" class="text-center py-8 text-gray-400">
                    <i class="fas fa-inbox text-3xl mb-2"></i>
                    <p class="text-sm">No region data available</p>
                </div>
            </div>
        </div>
    </div>

    <div x-show="!loading" x-cloak class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Top Failure Reasons</h3>
                    <p class="text-xs text-gray-500 mt-1">Most common causes of launch failures</p>
                </div>
                <div class="p-2 bg-red-50 rounded-lg">
                    <i class="fas fa-bug text-red-600"></i>
                </div>
            </div>

            <div class="space-y-3">
                <template x-for="(reason, index) in analytics.failureReasons" :key="index">
                    <div
                        class="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="flex items-center justify-center w-8 h-8 rounded-full bg-red-100 text-red-600 font-bold text-sm"
                                x-text="index + 1"></div>
                            <div>
                                <p class="text-sm font-semibold text-gray-900" x-text="reason.reason"></p>
                                <p class="text-xs text-gray-500" x-text="reason.count + ' occurrences'"></p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-lg font-bold text-red-600"
                                x-text="reason.percentage.toFixed(1) + '%'"></span>
                        </div>
                    </div>
                </template>

                <div x-show="analytics.failureReasons.length === 0" class="text-center py-12">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-green-100 mb-3">
                        <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                    </div>
                    <p class="text-gray-700 font-semibold">No failures recorded</p>
                    <p class="text-sm text-gray-500 mt-1">All launches successful! ðŸŽ‰</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Recommended Instance Types</h3>
                    <p class="text-xs text-gray-500 mt-1">Highest success rate and availability</p>
                </div>
                <div class="p-2 bg-emerald-50 rounded-lg">
                    <i class="fas fa-star text-emerald-600"></i>
                </div>
            </div>

            <div class="space-y-3">
                <template x-for="(rec, index) in analytics.recommendations" :key="index">
                    <div
                        class="p-4 border-2 border-emerald-100 rounded-xl hover:border-emerald-300 hover:bg-emerald-50/30 transition-all">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-emerald-100 rounded-lg">
                                    <i class="fas fa-server text-emerald-600 text-sm"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-bold text-gray-900" x-text="rec.instanceType"></p>
                                    <p class="text-xs text-gray-500" x-text="rec.region"></p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-bold"
                                    x-text="rec.successRate.toFixed(1) + '%'"></span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span><i class="fas fa-bolt mr-1 text-yellow-500"></i><span
                                    x-text="rec.avgLaunchTime"></span></span>
                            <span><i class="fas fa-check-circle mr-1 text-emerald-500"></i><span
                                    x-text="rec.attempts + ' attempts'"></span></span>
                        </div>
                    </div>
                </template>

                <div x-show="analytics.recommendations.length === 0" class="text-center py-12">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-3">
                        <i class="fas fa-lightbulb text-gray-400 text-2xl"></i>
                    </div>
                    <p class="text-gray-700 font-semibold">No recommendations available</p>
                    <p class="text-sm text-gray-500 mt-1">Need more data to generate insights</p>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // Define in window scope so it's accessible when loaded dynamically
    window.launchAnalyticsTab = function () {
        const backendBaseUrl = window.location.hostname === 'localhost'
            ? 'http://localhost:8080'
            : window.location.origin;
        const tenantId = sessionStorage.getItem('tenantId') || 'customer1';

        return {
            loading: false,
            accountId: null,
            filters: {
                startDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                endDate: new Date().toISOString().split('T')[0]
            },
            analytics: {
                totalAttempts: 0,
                successRate: 0,
                successful: 0,
                failed: 0,
                byInstanceType: [],
                byRegion: [],
                failureReasons: [],
                recommendations: []
            },

            init() {
                console.log('ðŸš€ Launch Analytics tab initialized');

                // Get account ID from sessionStorage
                try {
                    const stored = sessionStorage.getItem('selectedAccountIds');
                    if (stored) {
                        const ids = JSON.parse(stored);
                        if (ids && ids.length > 0) {
                            this.accountId = ids[0];
                            console.log('âœ“ Account ID:', this.accountId);
                        }
                    }
                } catch (e) {
                    console.error('Error reading account ID:', e);
                }

                if (!this.accountId) {
                    this.dispatchNotification('No account selected', 'error');
                    return;
                }

                // Auto-load analytics on init
                this.loadAnalytics();
            },

            async loadAnalytics() {
                if (!this.accountId) {
                    this.dispatchNotification('No account ID found', 'error');
                    return;
                }

                this.loading = true;
                console.log('ðŸ“Š Loading launch analytics for account:', this.accountId);

                try {
                    const params = new URLSearchParams({
                        start: this.filters.startDate,
                        end: this.filters.endDate
                    });

                    console.log(` Fetching: ${backendBaseUrl}/api/autospotting/analytics/launches/${this.accountId}?${params}`);

                    const response = await fetch(
                        `${backendBaseUrl}/api/autospotting/analytics/launches/${this.accountId}?${params}`,
                        {
                            credentials: 'include',
                            headers: { 'X-Tenant-ID': tenantId }
                        }
                    );

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('âœ… Analytics data received:', data);

                    // Transform backend data to match frontend structure
                    this.analytics = {
                        totalAttempts: data.total_attempts || 0,
                        successRate: data.success_rate || 0,
                        successful: data.total_successes || 0,
                        failed: data.total_failures || 0,
                        byInstanceType: Object.entries(data.by_instance_type || {}).map(([type, stats]) => ({
                            instanceType: type,
                            attempts: stats.attempts,
                            successes: stats.successes,
                            failures: stats.failures,
                            successRate: stats.success_rate
                        })),
                        byRegion: Object.entries(data.by_region || {}).map(([region, stats]) => ({
                            region: region,
                            attempts: stats.attempts,
                            successes: stats.successes,
                            failures: stats.failures,
                            successRate: stats.success_rate
                        })),
                        failureReasons: (data.top_failure_reasons || []).map(reason => ({
                            reason: reason.reason,
                            count: reason.count,
                            percentage: reason.percentage
                        })),
                        recommendations: (data.recommended_types || []).map(rec => ({
                            instanceType: rec.instance_type,
                            region: 'Global',
                            successRate: rec.success_rate,
                            avgLaunchTime: '< 2 min',
                            attempts: rec.total_launches + ' attempts'
                        }))
                    };

                    console.log('ðŸ“Š Processed analytics:', this.analytics);
                    this.dispatchNotification(`Loaded analytics: ${this.analytics.totalAttempts} attempts`, 'success');

                } catch (error) {
                    console.error('âŒ Error loading analytics:', error);
                    this.dispatchNotification('Failed to load analytics: ' + error.message, 'error');
                } finally {
                    this.loading = false;
                }
            },

            dispatchNotification(message, type = 'success') {
                window.dispatchEvent(new CustomEvent('notify', {
                    detail: { message, type }
                }));
            }
        };
    }
</script>