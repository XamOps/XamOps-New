<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XamOps - Cloud Shell</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

    * {
      font-family: 'Inter', sans-serif;
    }

    .glass-header {
      background: rgba(17, 24, 39, 0.7);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
  </style>
</head>

<body class="bg-gray-900 text-white h-screen overflow-hidden">

  <div class="flex h-full">
    <include file="/_sidebar.html"></include>

    <div class="flex-1 pl-64 flex flex-col h-full">

      <main id="main-content" class="flex-1 flex flex-col min-h-0 relative bg-gray-900">

        <!-- Top Navigation Bar -->
        <header
          class="bg-[#232f3e] border-b border-gray-700 px-4 py-3 flex justify-between items-center shrink-0 z-20 shadow-md">
          <div class="flex items-center gap-4">
            <div class="flex items-center gap-3 text-white">
              <i class="fas fa-terminal text-orange-500 text-lg"></i>
              <h1 class="text-lg font-bold tracking-tight">CloudShell</h1>
            </div>
            <div class="h-6 w-px bg-gray-600 mx-2"></div>
            <div class="flex items-center gap-2 text-gray-300 text-sm">
              <span class="font-medium text-white"
                x-text="selectedAccountDisplay ? selectedAccountDisplay.name : 'Unknown Account'"></span>
              <span class="text-xs text-gray-500"
                x-text="selectedAccountDisplay ? '(' + selectedAccountDisplay.id + ')' : ''"></span>
            </div>
          </div>

          <div class="flex items-center gap-4">
            <div id="connection-status"
              class="px-3 py-1 rounded text-xs font-semibold bg-gray-800 text-gray-400 border border-gray-600 flex items-center gap-2">
              <div class="w-1.5 h-1.5 rounded-full bg-gray-500"></div>
              <span>Initializing...</span>
            </div>

            <div class="flex gap-2">
              <!-- <button onclick="term && term.clear()"
                class="text-gray-400 hover:text-white hover:bg-gray-700 p-2 rounded transition-colors"
                title="Clear Terminal">
                <i class="fas fa-eraser"></i>
              </button> -->
              <button onclick="window.location.href='/dashboard.html'"
                class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-1.5 rounded text-sm font-medium transition-colors border border-gray-600 flex items-center gap-2">
                <i class="fas fa-sign-out-alt text-xs"></i>
                Exit
              </button>
            </div>
          </div>
        </header>

        <!-- Tab/Toolbar Area -->
        <div class="bg-[#161b22] px-4 py-1 flex items-center border-b border-gray-800 shrink-0">
          <div
            class="flex items-center bg-[#0d1117] border-t border-l border-r border-orange-500 text-white px-4 py-2 text-sm font-medium rounded-t-md relative -mb-1.5 z-10">
            <i class="fab fa-linux mr-2 text-gray-400"></i>
            <span>bash</span>
            <span class="ml-2 w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
          </div>
        </div>

        <div id="terminal" class="flex-1 bg-black overflow-hidden relative"></div>

        <script>
          (function () {
            let term;
            let socket;
            let fitAddon;
            let accountId = null;
            let resizeListener;
            let accountChangeListener;

            function cleanup() {
              if (socket) {
                socket.close();
                socket = null;
              }
              if (term) {
                term.dispose();
                term = null;
              }
              if (resizeListener) {
                window.removeEventListener('resize', resizeListener);
                resizeListener = null;
              }
              if (accountChangeListener) {
                window.removeEventListener('account-changed', accountChangeListener);
                accountChangeListener = null;
              }
              const container = document.getElementById("terminal");
              if (container) container.innerHTML = '';
            }

            function getAccountId() {
              const urlParam = new URLSearchParams(window.location.search).get("accountId");
              if (urlParam) return urlParam;

              const saved = JSON.parse(sessionStorage.getItem("selectedAccountIds") || "[]");
              if (saved.length > 0) return saved[0];

              return null;
            }

            function initWebSocket() {
              const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
              const host = window.location.host;
              const tenantId = sessionStorage.getItem("selectedTenantId") || 'customer1';

              // Construct WebSocket URL
              const wsUrl = `${protocol}//${host}/terminal?accountId=${accountId}&tenantId=${tenantId}`;

              const status = document.getElementById("connection-status");
              if (status) {
                status.textContent = "Connecting...";
                status.className = "px-3 py-1 rounded text-xs font-medium bg-yellow-600";
              }

              socket = new WebSocket(wsUrl);

              socket.onopen = () => {
                console.log('WebSocket Connected');
                if (status) {
                  status.textContent = `Connected: ${accountId}`;
                  status.className = "px-3 py-1 rounded text-xs font-medium bg-green-600";
                }
                if (term) {
                  term.focus();
                  // Removed automatic connection message for cleaner UI
                }
              };

              socket.onmessage = (event) => {
                let data = event.data;

                // Filter out common bash non-TTY warnings that appear on startup
                if (data.includes("cannot set terminal process group") ||
                  data.includes("no job control in this shell")) {
                  return;
                }

                if (term) term.write(data);
              };

              socket.onclose = (event) => {
                console.warn('WebSocket Closed', event);
                if (status) {
                  status.textContent = "Disconnected";
                  status.className = "px-3 py-1 rounded text-xs font-medium bg-red-600";
                }
                if (term) term.writeln("\r\n\x1b[31mConnection closed. Select a different account or refresh.\x1b[0m");
              };

              socket.onerror = (error) => {
                console.error('WebSocket Error:', error);
                if (status) {
                  status.textContent = "Connection Error";
                  status.className = "px-3 py-1 rounded text-xs font-medium bg-red-600";
                }
              };
            }

            function initTerminal() {
              cleanup();

              accountId = getAccountId();

              if (!accountId) {
                const container = document.getElementById("terminal");
                if (container) container.innerHTML = '<div class="p-8 text-red-400 font-mono">No account selected. Please select an account from the sidebar.</div>';
                return;
              }

              term = new Terminal({
                cursorBlink: true,
                cursorStyle: "bar",
                fontSize: 13,
                lineHeight: 1.0, // Reduced from 1.2 to remove gaps
                letterSpacing: 0, // Ensure no extra spacing
                fontFamily: 'Menlo, Monaco, "Courier New", monospace', // Simplified stack for consistency
                convertEol: true,
                theme: {
                  background: "#0d1117", // GitHub/AWS Dark Tone
                  foreground: "#e6edf3",
                  cursor: "#2f81f7",
                  selection: "#264f78",
                  black: "#484f58",
                  red: "#ff7b72",
                  green: "#3fb950",
                  yellow: "#d29922",
                  blue: "#58a6ff",
                  magenta: "#bc8cff",
                  cyan: "#39c5cf",
                  white: "#b1bac4",
                  brightBlack: "#6e7681",
                  brightRed: "#ffa198",
                  brightGreen: "#56d364",
                  brightYellow: "#e3b341",
                  brightBlue: "#79c0ff",
                  brightMagenta: "#d2a8ff",
                  brightCyan: "#56d4dd",
                  brightWhite: "#f0f6fc"
                },
                scrollback: 10000,
                allowProposedApi: true
              });

              fitAddon = new FitAddon.FitAddon();
              term.loadAddon(fitAddon);

              const container = document.getElementById("terminal");
              if (container) {
                term.open(container);
                setTimeout(() => {
                  fitAddon.fit();
                  term.focus();
                }, 100);

                container.addEventListener("click", () => {
                  if (term) term.focus();
                });
              }

              resizeListener = () => {
                if (fitAddon) fitAddon.fit();
              };
              window.addEventListener("resize", resizeListener);

              term.writeln("\x1b[1;36mXamOps CloudShell v2.0\x1b[0m");
              term.writeln(`Target Account: \x1b[1;33m${accountId}\x1b[0m`);
              term.writeln("Initializing secure connection...\r\n");

              term.onData((data) => {
                if (socket && socket.readyState === WebSocket.OPEN) {
                  socket.send(data);
                }
              });

              term.attachCustomKeyEventHandler((e) => {
                if (e.type === "keydown") {
                  if (e.ctrlKey && e.shiftKey && e.key === "C") {
                    const selection = term.getSelection();
                    if (selection) {
                      navigator.clipboard.writeText(selection);
                      return false;
                    }
                  }
                  if (e.ctrlKey && e.shiftKey && e.key === "V") {
                    navigator.clipboard.readText().then(text => {
                      if (socket) socket.send(text);
                    });
                    return false;
                  }
                  if (e.ctrlKey && e.key === "l") {
                    term.clear();
                    return false;
                  }
                }
                return true;
              });

              initWebSocket();

              accountChangeListener = (e) => {
                console.log("CloudShell: Account change detected", e.detail);
                if (e.detail && e.detail.accountId) {
                  accountId = e.detail.accountId;
                  const newUrl = new URL(window.location);
                  newUrl.searchParams.set('accountId', accountId);
                  window.history.replaceState(null, '', newUrl);
                }
                term.writeln("\r\n\x1b[33mSwitching accounts...\x1b[0m");
                setTimeout(() => initTerminal(), 500);
              };

              window.addEventListener('account-changed', accountChangeListener);
            }

            initTerminal();
          })();
        </script>
      </main>
    </div>
  </div>
</body>

</html>