<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>XamOps - Cloud Shell</title>

    <!-- Tailwind & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <!-- Xterm.js -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

    <!-- Alpine.js (only needed for sidebar) -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
  </head>

  <body class="bg-gray-900 text-white flex h-screen overflow-hidden">
    <include file="_sidebar.html"></include>

    <!-- Main Terminal Area -->
    <div class="flex-1 flex flex-col ml-64">
      <!-- Header -->
      <div
        class="bg-gray-800 px-6 py-4 flex items-center justify-between shadow-lg"
      >
        <h1 class="text-xl font-bold flex items-center gap-3">
          <i class="fas fa-terminal"></i>
          AWS CloudShell
        </h1>
        <div
          id="connection-status"
          class="px-3 py-1 rounded text-xs font-medium bg-yellow-600"
        >
          Connecting...
        </div>
      </div>

      <!-- Terminal -->
      <div id="terminal" class="flex-1 bg-black"></div>
    </div>

    <script>
      // Global variables
      let term;
      let socket;
      let accountId = null;

      // Extract accountId from URL → sessionStorage → sidebar (in that order)
      function getAccountId() {
        // Priority 1: URL param (works when opened from sidebar)
        const urlParam = new URLSearchParams(window.location.search).get(
          "accountId"
        );
        if (urlParam) return urlParam;

        // Priority 2: sessionStorage (works on refresh)
        const saved = JSON.parse(
          sessionStorage.getItem("selectedAccountIds") || "[]"
        );
        if (saved.length > 0) return saved[0];

        // Priority 3: Try to read from Alpine sidebar (last resort)
        const sidebar = document.querySelector("[x-data]");
        if (sidebar && sidebar.__x) {
          const data = sidebar.__x.$data;
          if (data.selectedAccountIds?.length > 0)
            return data.selectedAccountIds[0];
        }

        return null;
      }

      // Main init
      function initTerminal() {
        accountId = getAccountId();

        if (!accountId) {
          document.getElementById("terminal").innerHTML =
            '<div class="p-8 text-red-400">No AWS account selected. Go back to dashboard and pick one.</div>';
          return;
        }

        // Save for future refreshes
        sessionStorage.setItem(
          "selectedAccountIds",
          JSON.stringify([accountId])
        );

        // Initialize Xterm
        term = new Terminal({
          cursorBlink: true,
          cursorStyle: "block",
          fontSize: 14,
          fontFamily: 'Menlo, Monaco, "Courier New", monospace',
          theme: {
            background: "#000000",
            foreground: "#00ff00",
            cursor: "#00ff00",
            selection: "#ffffff33",
          },
          scrollback: 10000,
        });

        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);

        const container = document.getElementById("terminal");
        term.open(container);
        fitAddon.fit();

        // Make sure terminal gets focus
        term.focus();
        container.addEventListener("click", () => term.focus());

        // Resize handler
        window.addEventListener("resize", () => fitAddon.fit());

        // Welcome message
        term.writeln("\x1b[1;36mXamOps CloudShell\x1b[0m");
        term.writeln(`Connected to AWS Account: \x1b[1;33m${accountId}\x1b[0m`);
        term.writeln("");
        term.write("$ ");

        // WebSocket connection
        // const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        // const wsUrl = `${protocol}//${location.host}/ws/terminal?accountId=${accountId}`;

        const protocol = location.protocol === "https:" ? "wss:" : "ws:";
        // FIX: Retrieve tenantId from storage
        const tenantId = sessionStorage.getItem("selectedTenantId");
        // FIX: Append tenantId to the URL
        const wsUrl = `${protocol}//${location.host}/ws/terminal?accountId=${accountId}&tenantId=${tenantId}`;

        socket = new WebSocket(wsUrl);

        const status = document.getElementById("connection-status");

        socket.onopen = () => {
          status.textContent = `Connected: ${accountId}`;
          status.className =
            "px-3 py-1 rounded text-xs font-medium bg-green-600";
        };

        socket.onmessage = (event) => {
          term.write(event.data);
        };

        socket.onclose = () => {
          status.textContent = "Disconnected";
          status.className = "px-3 py-1 rounded text-xs font-medium bg-red-600";
          term.writeln(
            "\r\n\x1b[31mConnection closed. Refresh page to reconnect.\x1b[0m"
          );
        };

        socket.onerror = () => {
          term.writeln("\r\n\x1b[31mWebSocket error\x1b[0m");
        };

        // Send every keystroke to backend
        term.onData((data) => {
          if (socket.readyState === WebSocket.OPEN) {
            socket.send(data);
          }
        });
      }

      // Start when page is fully loaded
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initTerminal);
      } else {
        initTerminal();
      }

      // Optional: Ctrl+C, Ctrl+D handling (nice to have)
      term.attachCustomKeyEventHandler((e) => {
        if (e.type === "keydown") {
          if (e.ctrlKey && e.key === "c") {
            socket.send("\x03"); // Send ETX
            term.write("^C\r\n$ ");
            return false;
          }
          if (e.ctrlKey && e.key === "d") {
            socket.send("\x04"); // Send EOT
            return false;
          }
          if (e.ctrlKey && e.key === "l") {
            term.clear();
            return false;
          }
        }
        return true;
      });
    </script>
  </body>
</html>
