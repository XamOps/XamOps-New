<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xammer - Azure Cloudlist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="/icons/XamOps.png" sizes="32x32" type="image/png">
    <link rel="apple-touch-icon" href="/icons/XamOps.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script type="module" src="/src/main.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        .hidden { display: none !important; }
        .rotate-90 { transform: rotate(90deg); }
        .transition-all { transition: all 0.3s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        main {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 0 0 0 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .form-input, .form-select {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.8);
        }
        .form-input:focus, .form-select:focus {
            background: rgba(255, 255, 255, 1);
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        .service-group {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .service-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            border-color: rgba(102, 126, 234, 0.3);
        }
        .btn-primary {
            background: linear-gradient(135deg, #0078D4 0%, #50E6FF 100%);
            border: none;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 120, 212, 0.4);
        }
        .state-badge {
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="antialiased">

<div class="flex h-screen">
    <include file="/_sidebar.html"></include>

    <main class="flex-1 flex flex-col pl-64">
        <header class="h-20 flex-shrink-0 flex items-center justify-between px-8 sticky top-0 z-10 bg-white/80 backdrop-blur-sm border-b">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-xl flex items-center justify-center">
                    <i class="fab fa-windows text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Azure Cloudlist</h1>
                    <p class="text-sm text-gray-600">Manage your Azure cloud resources</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button id="refresh-button" class="group flex items-center space-x-2 px-4 py-2 text-sm font-semibold text-blue-600 hover:text-white bg-white hover:bg-blue-600 rounded-lg border border-blue-200 hover:border-blue-600 transition-all duration-200 hover:shadow-md">
                    <i class="fas fa-sync-alt transition-transform group-hover:rotate-180"></i>
                    <span id="refresh-button-text">Refresh</span>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8">
            <div id="resource-list-container" class="space-y-6">
                <div class="text-center py-20">
                    <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                    <p class="text-gray-600">Loading resources...</p>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const app = {
            allGroups: [],
            selectedAccountId: null,
            dom: {
                listContainer: document.getElementById('resource-list-container'),
                refreshButton: document.getElementById('refresh-button'),
            },

            init() {
                const urlParams = new URLSearchParams(window.location.search);
                this.selectedAccountId = urlParams.get('accountId');

                if (!this.selectedAccountId) {
                    // ✅ FIXED: Corrected 'selectedAccountIdaccountId' to 'selectedAccountIds'
                    const storedIds = JSON.parse(sessionStorage.getItem('selectedAccountIds') || '[]');
                    if (storedIds.length > 0) {
                        this.selectedAccountId = storedIds[0]; // Use first account
                    }
                }

                this.setupEventListeners();
                this.loadResources(false);
            },

            setupEventListeners() {
                this.dom.refreshButton.addEventListener('click', () => this.loadResources(true));
            },

            loadResources(forceRefresh = false) {
                if (!this.selectedAccountId) {
                    this.dom.listContainer.innerHTML = `
                        <div class="text-center py-20">
                            <i class="fas fa-exclamation-circle text-yellow-600 text-5xl mb-4"></i>
                            <p class="text-gray-600 text-lg">No Azure account selected.</p>
                            <p class="text-gray-500 mt-2">Please select an account from the dashboard.</p>
                        </div>
                    `;
                    return;
                }

                // Show loading state
                this.dom.listContainer.innerHTML = `
                    <div class="text-center py-20">
                        <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                        <p class="text-gray-600 text-lg">Loading Azure resources...</p>
                    </div>
                `;

                // ✅ FIXED: Corrected API endpoint to use query parameter 'accountIds' instead of 'accountId'
                const apiUrl = `/api/azure/cloudlist/resources?accountIds=${this.selectedAccountId}`;
                
                console.log('Fetching Azure resources from:', apiUrl);

                fetch(apiUrl)
                    .then(response => {
                        console.log('Response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Received data:', data);
                        this.allGroups = Array.isArray(data) ? data : [];
                        this.render();
                    })
                    .catch(error => {
                        console.error('Error fetching Azure resources:', error);
                        this.dom.listContainer.innerHTML = `
                            <div class="text-center py-20">
                                <i class="fas fa-exclamation-triangle text-red-600 text-5xl mb-4"></i>
                                <p class="text-red-600 text-lg font-semibold mb-2">Error loading resources</p>
                                <p class="text-gray-600 mb-6">${error.message}</p>
                                <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg">
                                    <i class="fas fa-redo mr-2"></i>
                                    Try Again
                                </button>
                            </div>
                        `;
                    });
            },

            render() {
                this.dom.listContainer.innerHTML = '';

                if (this.allGroups.length === 0) {
                    this.dom.listContainer.innerHTML = `
                        <div class="text-center py-20">
                            <i class="fas fa-inbox text-gray-400 text-5xl mb-4"></i>
                            <p class="text-gray-600 text-lg">No resources found for the selected account.</p>
                        </div>
                    `;
                    return;
                }

                this.allGroups.forEach(group => {
                    const groupElement = this.createGroupElement(group);
                    this.dom.listContainer.appendChild(groupElement);
                });
            },

            createGroupElement(group) {
                const container = document.createElement('div');
                container.className = 'service-group rounded-2xl shadow-lg overflow-hidden border border-gray-200/50';

                let resourcesHtml = group.resources.map(res => this.createResourceRow(res)).join('');

                container.innerHTML = `
                    <div class="flex items-center justify-between p-6 bg-white">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-lg flex items-center justify-center">
                                <i class="fas ${this.getServiceIconClass(group.serviceType)} text-white"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg">${group.serviceType}</h3>
                                <p class="text-sm text-gray-600">${group.resources.length} resources</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50/50">
                        ${resourcesHtml}
                    </div>
                `;
                return container;
            },

            createResourceRow(resource) {
                return `
                    <div class="grid grid-cols-12 items-center p-4 pl-16 text-sm border-t border-gray-200/80 hover:bg-white/50 transition-colors">
                        <div class="col-span-5 font-semibold text-gray-700">${resource.name || 'N/A'}</div>
                        <div class="col-span-3 text-gray-600 text-xs truncate" title="${resource.id || 'N/A'}">${resource.id || 'N/A'}</div>
                        <div class="col-span-2 text-gray-600">${resource.region || 'Global'}</div>
                        <div class="col-span-2">
                            <span class="state-badge px-3 py-1 text-xs font-bold rounded-full ${this.getStateClass(resource.state)}">
                                ${resource.state || 'Unknown'}
                            </span>
                        </div>
                    </div>
                `;
            },

            getStateClass(state) {
                const s = (state || '').toLowerCase();
                if (s.includes('running') || s.includes('succeeded') || s.includes('available') || s.includes('active') || s.includes('online')) {
                    return 'bg-green-100 text-green-800';
                }
                if (s.includes('stopped') || s.includes('deallocated') || s.includes('failed') || s.includes('deleted')) {
                    return 'bg-red-100 text-red-800';
                }
                if (s.includes('pending') || s.includes('updating') || s.includes('creating') || s.includes('starting')) {
                    return 'bg-yellow-100 text-yellow-800';
                }
                return 'bg-gray-100 text-gray-800';
            },

            getServiceIconClass(serviceType) {
                const iconMap = {
                    'Virtual Machines': 'fa-server',
                    'Storage Accounts': 'fa-database',
                    'SQL Databases': 'fa-table',
                    'Virtual Networks': 'fa-network-wired',
                    'Functions': 'fa-bolt',
                    'Disks': 'fa-hdd',
                    'DNS Zones': 'fa-globe',
                    'Load Balancers': 'fa-balance-scale',
                    'Container Instances': 'fa-box',
                    'Kubernetes Services': 'fa-dharmachakra',
                    'App Services': 'fa-code',
                    'Public IP Addresses': 'fa-wifi'
                };
                return iconMap[serviceType] || 'fa-cloud';
            },
        };

        app.init();
    });
</script>

</body>
</html>
