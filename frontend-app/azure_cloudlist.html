<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xammer - Azure Cloudlist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script type="module" src="/src/main.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        .hidden { display: none !important; }
        .rotate-90 { transform: rotate(90deg); }
        .transition-all { transition: all 0.3s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        main {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 0 0 0 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .form-input, .form-select {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.8);
        }
        .form-input:focus, .form-select:focus {
            background: rgba(255, 255, 255, 1);
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        .service-group {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .service-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            border-color: rgba(102, 126, 234, 0.3);
        }
        .btn-primary {
            background: linear-gradient(135deg, #0078D4 0%, #50E6FF 100%);
            border: none;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 120, 212, 0.4);
        }
        .state-badge {
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="antialiased">

<div class="flex h-screen">
    <div data-include-sidebar></div>

    <main class="flex-1 flex flex-col">
        <header class="h-20 flex-shrink-0 flex items-center justify-between px-8 sticky top-0 z-10 bg-white/80 backdrop-blur-sm border-b">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-xl flex items-center justify-center">
                    <i class="fab fa-windows text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Azure Cloudlist</h1>
                    <p class="text-sm text-gray-600">Manage your Azure cloud resources</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button id="refresh-button" class="group flex items-center space-x-2 px-4 py-2 text-sm font-semibold text-blue-600 hover:text-white bg-white hover:bg-blue-600 rounded-lg border border-blue-200 hover:border-blue-600 transition-all duration-200 hover:shadow-md">
                    <i class="fas fa-sync-alt transition-transform group-hover:rotate-180"></i>
                    <span id="refresh-button-text">Refresh</span>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8">
            <div id="resource-list-container" class="space-y-6">
            </div>
        </div>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const app = {
            allGroups: [],
            selectedAccountId: null,
            dom: {
                listContainer: document.getElementById('resource-list-container'),
                refreshButton: document.getElementById('refresh-button'),
            },

            init() {
                const urlParams = new URLSearchParams(window.location.search);
                this.selectedAccountId = urlParams.get('accountIds');

                if (!this.selectedAccountId) {
                    const storedIds = JSON.parse(sessionStorage.getItem('selectedAccountIds') || '[]');
                    if (storedIds.length > 0) {
                        this.selectedAccountId = storedIds.join(',');
                    }
                }

                this.setupEventListeners();
                this.loadResources(false);
            },

            setupEventListeners() {
                this.dom.refreshButton.addEventListener('click', () => this.loadResources(true));
            },

            loadResources(forceRefresh = false) {
                if (!this.selectedAccountId) {
                    this.dom.listContainer.innerHTML = `<p>No Azure account selected.</p>`;
                    return;
                }

                const apiUrl = `/api/azure/cloudlist/resources?accountIds=${this.selectedAccountId}&forceRefresh=${forceRefresh}`;

                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        this.allGroups = Array.isArray(data) ? data : [];
                        this.render();
                    })
                    .catch(error => {
                        console.error('Error fetching Azure resources:', error);
                        this.dom.listContainer.innerHTML = `<p>Error loading resources.</p>`;
                    });
            },

            render() {
                this.dom.listContainer.innerHTML = '';

                if (this.allGroups.length === 0) {
                    this.dom.listContainer.innerHTML = `<p>No resources found for the selected account.</p>`;
                    return;
                }

                this.allGroups.forEach(group => {
                    const groupElement = this.createGroupElement(group);
                    this.dom.listContainer.appendChild(groupElement);
                });
            },

            createGroupElement(group) {
                const container = document.createElement('div');
                container.className = 'service-group rounded-2xl shadow-lg overflow-hidden border border-gray-200/50';

                let resourcesHtml = group.resources.map(res => this.createResourceRow(res)).join('');

                container.innerHTML = `
                    <div class="flex items-center justify-between p-6 bg-white">
                        <div class="flex items-center space-x-4">
                            <img src="/icons/${this.getServiceIcon(group.serviceType)}" alt="${group.serviceType}" class="w-10 h-10">
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg">${group.serviceType}</h3>
                                <p class="text-sm text-gray-600">${group.resources.length} resources</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50/50">
                        ${resourcesHtml}
                    </div>
                `;
                return container;
            },

            createResourceRow(resource) {
                return `
                    <div class="grid grid-cols-12 items-center p-4 pl-16 text-sm border-t border-gray-200/80">
                        <div class="col-span-5 font-semibold text-gray-700">${resource.name || 'N/A'}</div>
                        <div class="col-span-3 text-gray-600">${resource.id || 'N/A'}</div>
                        <div class="col-span-2 text-gray-600">${resource.region || 'Global'}</div>
                        <div class="col-span-2">
                            <span class="state-badge px-3 py-1 text-xs font-bold rounded-full ${this.getStateClass(resource.state)}">
                                ${resource.state || 'Unknown'}
                            </span>
                        </div>
                    </div>
                `;
            },

            getStateClass(state) {
                const s = (state || '').toLowerCase();
                if (['running', 'succeeded', 'available', 'active'].includes(s)) return 'bg-green-100 text-green-800';
                if (['stopped', 'deallocated', 'failed', 'deleted'].includes(s)) return 'bg-red-100 text-red-800';
                if (['pending', 'updating', 'creating'].includes(s)) return 'bg-yellow-100 text-yellow-800';
                return 'bg-gray-100 text-gray-800';
            },

            getServiceIcon(serviceType) {
                const iconMap = {
                    'Virtual Machines': 'azure-vm.png',
                    'Storage Accounts': 'azure-storage.png',
                    'SQL Databases': 'azure-sql-db.png',
                    'Virtual Networks': 'azure-vnet.png',
                    'Functions': 'azure-functions.png',
                    'Disks': 'azure-disk.png',
                    'DNS Zones': 'azure-dns.png',
                    'Load Balancers': 'azure-lb.png',
                    'Container Instances': 'azure-aci.png',
                    'Kubernetes Services': 'azure-aks.png',
                    'App Services': 'azure-app-service.png'
                };
                return iconMap[serviceType] || 'default-icon.png';
            },
        };

        app.init();
    });
</script>

</body>
</html>