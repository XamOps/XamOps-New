<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xammer - Azure Cloudlist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="/icons/XamOps.png" sizes="32x32" type="image/png">
    <link rel="apple-touch-icon" href="/icons/XamOps.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script type="module" src="/src/main.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        .hidden { display: none !important; }
        .rotate-90 { transform: rotate(90deg); }
        .transition-all { transition: all 0.3s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        main {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 0 0 0 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .service-group {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.6);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .service-group:hover {
            border-color: rgba(59, 130, 246, 0.4);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }
        
        .service-header {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
        }
        
        .service-header:hover {
            background: rgba(249, 250, 251, 0.8);
        }
        
        .service-header:active {
            transform: scale(0.995);
        }
        
        .chevron-icon {
            transition: transform 0.3s ease;
        }
        
        .chevron-icon.rotated {
            transform: rotate(90deg);
        }
        
        .resources-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .resources-container.expanded {
            max-height: 2000px;
        }
        
        .resource-row {
            transition: all 0.2s ease;
        }
        
        .resource-row:hover {
            background: rgba(245, 247, 250, 0.8);
            border-left: 3px solid #3b82f6;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0078D4 0%, #50E6FF 100%);
            border: none;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 120, 212, 0.4);
        }
        
        .state-badge {
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .resource-count-badge {
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
            padding: 0.25rem 0.625rem;
            border-radius: 9999px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        
        .service-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }
        
        .service-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }
    </style>
</head>
<body class="antialiased">

<div class="flex h-screen">
    <include file="/_sidebar.html"></include>

    <main class="flex-1 flex flex-col pl-64">
        <header class="h-20 flex-shrink-0 flex items-center justify-between px-8 sticky top-0 z-10 bg-white/80 backdrop-blur-sm border-b">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-xl flex items-center justify-center">
                    <i class="fab fa-windows text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Azure Cloudlist</h1>
                    <p class="text-sm text-gray-600">Manage your Azure cloud resources</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button id="refresh-button" class="group flex items-center space-x-2 px-4 py-2 text-sm font-semibold text-blue-600 hover:text-white bg-white hover:bg-blue-600 rounded-lg border border-blue-200 hover:border-blue-600 transition-all duration-200 hover:shadow-md">
                    <i class="fas fa-sync-alt transition-transform group-hover:rotate-180"></i>
                    <span id="refresh-button-text">Refresh</span>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8">
            <div id="resource-list-container" class="space-y-4">
                <div class="text-center py-20">
                    <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                    <p class="text-gray-600">Loading resources...</p>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const app = {
            allGroups: [],
            selectedAccountId: null,
            expandedGroups: new Set(),
            dom: {
                listContainer: document.getElementById('resource-list-container'),
                refreshButton: document.getElementById('refresh-button'),
            },

            init() {
                const urlParams = new URLSearchParams(window.location.search);
                this.selectedAccountId = urlParams.get('accountId');

                if (!this.selectedAccountId) {
                    const storedIds = JSON.parse(sessionStorage.getItem('selectedAccountIds') || '[]');
                    if (storedIds.length > 0) {
                        this.selectedAccountId = storedIds[0];
                    }
                }

                this.setupEventListeners();
                this.loadResources(false);
            },

            setupEventListeners() {
                this.dom.refreshButton.addEventListener('click', () => this.loadResources(true));
            },

            loadResources(forceRefresh = false) {
                if (!this.selectedAccountId) {
                    this.dom.listContainer.innerHTML = `
                        <div class="text-center py-20">
                            <i class="fas fa-exclamation-circle text-yellow-600 text-5xl mb-4"></i>
                            <p class="text-gray-600 text-lg">No Azure account selected.</p>
                            <p class="text-gray-500 mt-2">Please select an account from the dashboard.</p>
                        </div>
                    `;
                    return;
                }

                this.dom.listContainer.innerHTML = `
                    <div class="text-center py-20">
                        <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                        <p class="text-gray-600 text-lg">Loading Azure resources...</p>
                    </div>
                `;

                const apiUrl = `/api/azure/cloudlist/resources?accountIds=${this.selectedAccountId}`;
                console.log('Fetching Azure resources from:', apiUrl);

                fetch(apiUrl)
                    .then(response => {
                        console.log('Response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Received data:', data);
                        this.allGroups = Array.isArray(data) ? data : [];
                        this.render();
                    })
                    .catch(error => {
                        console.error('Error fetching Azure resources:', error);
                        this.dom.listContainer.innerHTML = `
                            <div class="text-center py-20">
                                <i class="fas fa-exclamation-triangle text-red-600 text-5xl mb-4"></i>
                                <p class="text-red-600 text-lg font-semibold mb-2">Error loading resources</p>
                                <p class="text-gray-600 mb-6">${error.message}</p>
                                <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg">
                                    <i class="fas fa-redo mr-2"></i>
                                    Try Again
                                </button>
                            </div>
                        `;
                    });
            },

            render() {
                this.dom.listContainer.innerHTML = '';

                if (this.allGroups.length === 0) {
                    this.dom.listContainer.innerHTML = `
                        <div class="text-center py-20">
                            <i class="fas fa-inbox text-gray-400 text-5xl mb-4"></i>
                            <p class="text-gray-600 text-lg">No resources found for the selected account.</p>
                        </div>
                    `;
                    return;
                }

                this.allGroups.forEach(group => {
                    const groupElement = this.createGroupElement(group);
                    this.dom.listContainer.appendChild(groupElement);
                });
            },

            createGroupElement(group) {
                const container = document.createElement('div');
                container.className = 'service-group rounded-xl shadow-md border';
                const isExpanded = this.expandedGroups.has(group.serviceType);

                const iconPath = this.getServiceIcon(group.serviceType);
                const resourcesHtml = group.resources.map(res => this.createResourceRow(res)).join('');

                container.innerHTML = `
                    <div class="service-header p-5 flex items-center justify-between" onclick="app.toggleGroup('${group.serviceType}', this)">
                        <div class="flex items-center space-x-4">
                            <i class="fas fa-chevron-right chevron-icon text-gray-400 text-sm ${isExpanded ? 'rotated' : ''}"></i>
                            <div class="service-icon bg-gradient-to-br from-blue-500 to-cyan-400 shadow-md">
                                <img src="icons/${iconPath}" alt="${group.serviceType}" class="w-full h-full rounded-xl object-cover">
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg">${group.serviceType}</h3>
                                <p class="text-sm text-gray-500">${group.resources.length} resource${group.resources.length !== 1 ? 's' : ''}</p>
                            </div>
                        </div>
                        <div class="resource-count-badge">${group.resources.length}</div>
                    </div>
                    <div class="resources-container ${isExpanded ? 'expanded' : ''}" style="${isExpanded ? 'max-height: 2000px;' : 'max-height: 0;'}">
                        <div class="bg-gray-50/50 border-t">
                            ${resourcesHtml}
                        </div>
                    </div>
                `;

                return container;
            },

            toggleGroup(serviceType, headerElement) {
                const isExpanded = this.expandedGroups.has(serviceType);
                const container = headerElement.nextElementSibling;
                const chevron = headerElement.querySelector('.chevron-icon');

                if (isExpanded) {
                    this.expandedGroups.delete(serviceType);
                    container.classList.remove('expanded');
                    container.style.maxHeight = '0';
                    chevron.classList.remove('rotated');
                } else {
                    this.expandedGroups.add(serviceType);
                    container.classList.add('expanded');
                    container.style.maxHeight = '2000px';
                    chevron.classList.add('rotated');
                }
            },

            createResourceRow(resource) {
                return `
                    <div class="resource-row grid grid-cols-12 items-center p-4 pl-20 text-sm border-b border-gray-200/60 last:border-b-0">
                        <div class="col-span-4 font-semibold text-gray-700 flex items-center">
                            <i class="fas fa-circle text-blue-400 text-xs mr-3"></i>
                            ${resource.name || 'N/A'}
                        </div>
                        <div class="col-span-4 text-gray-600 text-xs truncate font-mono" title="${resource.id || 'N/A'}">
                            ${resource.id || 'N/A'}
                        </div>
                        <div class="col-span-2 text-gray-600 flex items-center">
                            <i class="fas fa-map-marker-alt text-gray-400 text-xs mr-2"></i>
                            ${resource.region || 'Global'}
                        </div>
                        <div class="col-span-2 flex justify-end">
                            <span class="state-badge px-3 py-1.5 text-xs font-semibold rounded-full ${this.getStateClass(resource.state)}">
                                ${resource.state || 'Unknown'}
                            </span>
                        </div>
                    </div>
                `;
            },

            getStateClass(state) {
                const s = (state || '').toLowerCase();
                if (s.includes('running') || s.includes('succeeded') || s.includes('available') || s.includes('active') || s.includes('online')) {
                    return 'bg-green-100 text-green-800 border-green-200';
                }
                if (s.includes('stopped') || s.includes('deallocated') || s.includes('failed') || s.includes('deleted')) {
                    return 'bg-red-100 text-red-800 border-red-200';
                }
                if (s.includes('pending') || s.includes('updating') || s.includes('creating') || s.includes('starting')) {
                    return 'bg-yellow-100 text-yellow-800 border-yellow-200';
                }
                return 'bg-gray-100 text-gray-800 border-gray-200';
            },

            // âœ… Azure Service Icon Mapping - Using EXISTING icon filenames
           // Azure Service Icon Mapping - Each service has its own dedicated icon
getServiceIcon(serviceType) {
    const iconMap = {
        // Compute
        'Virtual Machines': 'azure-virtual-machine.png',
        'Virtual Machine Scale Sets': 'azure-vmss.png',
        'Availability Sets': 'azure-availability-sets.png',
        'Container Instances': 'azure-container-instance.png',
        'Kubernetes Services': 'azure-kubernetes-service.png',
        'App Services': 'azure-app-service.png',
        
        // Storage
        'Storage Accounts': 'azure-storage-account.png',
        'Disks': 'azure-disk-storage.png',
        'Snapshots': 'azure-snapshot.png',
        
        // Networking
        'Virtual Networks': 'azure-virtual-network.png',
        'Load Balancers': 'azure-load-balancer.png',
        'Application Gateways': 'azure-application-gateway.png',
        'VPN Gateways': 'azure-vpn-gateway.png',
        'ExpressRoute Circuits': 'azure-expressroute.png',
        'Public IP Addresses': 'azure-public-ip.png',
        'Network Security Groups': 'azure-nsg.png',
        'Network Interfaces': 'azure-network-interface.png',
        'DNS Zones': 'azure-dns.png',
        'Traffic Manager': 'azure-traffic-manager.png',
        
        // Databases
        'SQL Databases': 'azure-sql-database.png',
        'CosmosDB': 'azure-cosmos-db.png',
        'Redis Cache': 'azure-redis-cache.png',
        
        // Integration
        'Service Bus': 'azure-service-bus.png',
        'Event Hubs': 'azure-event-hubs.png',
        
        // Containers
        'Container Registries': 'azure-container-registry.png',
        
        // Search
        'Search Services': 'azure-search.png',
        
        // Functions
        'Function Apps': 'azure-function-app.png',
        
        // Static Web Apps
        'Static Web Apps': 'azure-static-web-app.png',
    };
    
    return iconMap[serviceType] || 'default-icon.png';
},

        };

        window.app = app;
        app.init();
    });
</script>

</body>
</html>
