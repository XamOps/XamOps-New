<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xammer - Cloudlist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="icon" href="/icons/XamOps.png" sizes="32x32" type="image/png">
<link rel="apple-touch-icon" href="/icons/XamOps.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script type="module" src="/src/main.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        .hidden { display: none !important; }
        .rotate-90 { transform: rotate(90deg); }
        .transition-all { transition: all 0.3s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        main {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 0 0 0 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .form-input, .form-select {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.8);
        }
        .form-input:focus, .form-select:focus {
            background: rgba(255, 255, 255, 1);
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .resource-row {
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .resource-row:hover {
            transform: translateX(4px);
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.03) 0%, rgba(102, 126, 234, 0.08) 100%);
        }
        .resource-row::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #667eea, #764ba2);
            transform: scaleY(0);
            transition: transform 0.2s ease;
        }
        .resource-row:hover::before {
            transform: scaleY(1);
        }
        .service-group {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .service-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            border-color: rgba(102, 126, 234, 0.3);
        }
        .service-group::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        .service-group:hover::before {
            transform: scaleX(1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(102, 126, 234, 0.4);
        }
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        .btn-primary:hover::before {
            left: 100%;
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.8);
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 1);
            border-color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .state-badge {
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .state-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }
        .state-badge:hover::before {
            left: 100%;
        }
        .header-gradient {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(229, 231, 235, 0.8);
        }
        .empty-state {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 2px dashed rgba(156, 163, 175, 0.5);
            transition: all 0.3s ease;
        }
        .empty-state:hover {
            border-color: rgba(102, 126, 234, 0.3);
            background: rgba(255, 255, 255, 0.9);
        }
        .pulse-dot {
            animation: pulse-dot 2s infinite;
        }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .filter-dropdown {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.8);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .service-icon {
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .service-icon:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .resource-counter {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }
        html {
            scroll-behavior: smooth;
        }
        .focus-ring:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }
    </style>
</head>
<body class="antialiased">

<div class="flex h-screen">
    <div data-include-sidebar></div>

    <main class="flex-1 flex flex-col">
        <header class="header-gradient h-20 flex-shrink-0 flex items-center justify-between px-8 sticky top-0 z-10">
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-list text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Cloudlist</h1>
                        <p class="text-sm text-gray-600">Manage your cloud resources</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div id="status-indicator-dot" class="w-2 h-2 bg-green-500 rounded-full pulse-dot"></div>
                    <span id="update-status" class="text-sm text-gray-600">Ready</span>
                </div>
                <button id="refresh-button" class="group flex items-center space-x-2 px-4 py-2 text-sm font-semibold text-indigo-600 hover:text-white bg-white hover:bg-indigo-600 rounded-lg border border-indigo-200 hover:border-indigo-600 transition-all duration-200 hover:shadow-md">
                    <i class="fas fa-sync-alt transition-transform group-hover:rotate-180"></i>
                    <span id="refresh-button-text">Refresh</span>
                </button>
            </div>
        </header>

        <div id="main-content" class="flex-1 overflow-y-auto p-8">
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-6 mb-8 border border-gray-200/50 shadow-lg">
                <div class="flex flex-wrap items-center justify-between gap-6">
                    <div class="flex items-center space-x-4 flex-1">
                        <div class="relative">
                            <i class="fas fa-globe absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <select id="region-filter" class="form-select pl-10 pr-4 py-3 rounded-xl border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 min-w-[200px]">
                                <option value="">All Regions</option>
                            </select>
                        </div>
                        <div class="relative flex-1 min-w-[350px]">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="search-input" placeholder="Search resources by name or ID..." class="form-input w-full pl-12 pr-4 py-3 rounded-xl border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200">
                        </div>
                    </div>
                     <div class="flex items-center space-x-4">
                        <p id="resource-count" class="text-sm text-gray-600 font-medium"></p>
                        <button id="export-button" class="btn-primary px-6 py-3 text-sm font-semibold text-white rounded-xl shadow-md hover:shadow-lg focus-ring">
                            <i class="fas fa-file-excel mr-2"></i>Export Data
                        </button>
                    </div>
                </div>
            </div>

            <div id="resource-list-container" class="space-y-6">
                 <div id="loading-state" class="w-full space-y-4">
                    <div class="h-24 bg-gray-200 rounded-lg skeleton"></div>
                    <div class="h-24 bg-gray-200 rounded-lg skeleton"></div>
                    <div class="h-24 bg-gray-200 rounded-lg skeleton"></div>
                    <div class="h-24 bg-gray-200 rounded-lg skeleton"></div>
                </div>

                <div id="empty-state" class="empty-state hidden text-center py-20 px-8 rounded-2xl mt-8">
                </div>
            </div>
             <div id="pagination-controls" class="text-center py-8 hidden">
                <button id="load-more-button" class="btn-secondary px-8 py-3 text-sm font-semibold rounded-xl hover:bg-gray-100 transition-all">
                    <span id="load-more-text">Load More</span>
                    <div id="load-more-spinner" class="loading-spinner inline-block ml-2 hidden"></div>
                </button>
            </div>
        </div>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const app = {
            allGroups: [],
            totalResources: 0,
            isRefreshing: false,
            isLoadingMore: false,
            currentPage: 0,
            servicesPerPage: 5,
            totalServices: 0,
            hasNextPage: true,
            selectedAccountId: null,
            stompClient: null,
            dom: {
                mainContent: document.getElementById('main-content'),
                searchInput: document.getElementById('search-input'),
                regionFilter: document.getElementById('region-filter'),
                listContainer: document.getElementById('resource-list-container'),
                loadingState: document.getElementById('loading-state'),
                emptyState: document.getElementById('empty-state'),
                refreshButton: document.getElementById('refresh-button'),
                refreshButtonText: document.getElementById('refresh-button-text'),
                refreshButtonIcon: document.getElementById('refresh-button').querySelector('i'),
                updateStatus: document.getElementById('update-status'),
                statusIndicatorDot: document.getElementById('status-indicator-dot'),
                paginationControls: document.getElementById('pagination-controls'),
                loadMoreButton: document.getElementById('load-more-button'),
                loadMoreText: document.getElementById('load-more-text'),
                loadMoreSpinner: document.getElementById('load-more-spinner'),
                resourceCount: document.getElementById('resource-count'),
                exportButton: document.getElementById('export-button'),
            },

            init() {
                const urlParams = new URLSearchParams(window.location.search);
                this.selectedAccountId = urlParams.get('accountIds');

                if (!this.selectedAccountId) {
                    const storedIds = JSON.parse(sessionStorage.getItem('selectedAccountIds') || '[]');
                    if (storedIds.length > 0) {
                        this.selectedAccountId = storedIds.join(',');
                    }
                }

                this.setupEventListeners();
                this.connectWebSocket();
                this.loadInitialResources();
            },

            connectWebSocket() {
                const socket = new SockJS('/ws');
                this.stompClient = Stomp.over(socket);
                this.stompClient.connect({}, (frame) => {
                     this.stompClient.subscribe(`/topic/cloudlist-refresh`, (message) => {
                        const body = JSON.parse(message.body);
                        if (body.accountId === this.selectedAccountId) {
                            if (body.status === 'refresh-complete') {
                                this.isRefreshing = false;
                                this.dom.refreshButton.disabled = false;
                                this.loadInitialResources(false);
                            } else if (body.status === 'refresh-failed') {
                                this.setReadyState('Refresh failed', 'red');
                                this.isRefreshing = false;
                                this.dom.refreshButton.disabled = false;
                            }
                        }
                    });
                }, (error) => {
                    this.setReadyState('Real-time connection failed.', 'red');
                });
            },

            setupEventListeners() {
                this.dom.searchInput.addEventListener('input', () => this.debounce(this.render, 300)());
                this.dom.regionFilter.addEventListener('change', () => this.render());
                this.dom.refreshButton.addEventListener('click', () => {
                    if (!this.isRefreshing) {
                        this.loadInitialResources(true);
                    }
                });
                this.dom.loadMoreButton.addEventListener('click', () => this.loadMoreResources());

                window.addEventListener('storage', (e) => {
                    if (e.key === 'selectedAccountIds') {
                        const storedIds = JSON.parse(e.target.sessionStorage.getItem('selectedAccountIds') || '[]');
                        this.selectedAccountId = storedIds.join(',');
                        this.loadInitialResources(true);
                    }
                });
                this.dom.exportButton.addEventListener('click', () => this.exportData());
            },

            setReadyState(message, color = 'green') {
                this.dom.updateStatus.innerHTML = message;
                this.dom.statusIndicatorDot.className = `w-2 h-2 bg-${color}-500 rounded-full`;
                if (color === 'green') {
                    this.dom.statusIndicatorDot.classList.add('pulse-dot');
                } else {
                    this.dom.statusIndicatorDot.classList.remove('pulse-dot');
                }
            },

            setUpdatingState() {
                this.dom.updateStatus.innerHTML = '<div class="loading-spinner inline-block mr-2"></div><span>Updating...</span>';
                this.dom.statusIndicatorDot.className = 'w-2 h-2 bg-yellow-500 rounded-full';
                this.dom.statusIndicatorDot.classList.remove('pulse-dot');
            },

            async loadInitialResources(forceRefresh = false) {
                this.currentPage = 0;
                this.allGroups = [];
                this.totalResources = 0;
                this.totalServices = 0;
                this.hasNextPage = true;
                this.dom.listContainer.innerHTML = '';
                this.dom.listContainer.appendChild(this.dom.loadingState);
                this.dom.loadingState.classList.remove('hidden');
                this.dom.emptyState.classList.add('hidden');
                this.dom.paginationControls.classList.add('hidden');
                await this.loadResources(forceRefresh, false);
            },

            async loadMoreResources() {
                if (this.isLoadingMore || !this.hasNextPage) return;
                this.isLoadingMore = true;
                this.dom.loadMoreText.classList.add('hidden');
                this.dom.loadMoreSpinner.classList.remove('hidden');
                this.dom.loadMoreButton.disabled = true;

                this.currentPage++;
                await this.loadResources(false, true);

                this.isLoadingMore = false;
                this.dom.loadMoreText.classList.remove('hidden');
                this.dom.loadMoreSpinner.classList.add('hidden');
                this.dom.loadMoreButton.disabled = false;
            },

            async loadResources(forceRefresh = false, isPaginatedLoad = false) {
                 if (!this.selectedAccountId) {
                    this.dom.loadingState.classList.add('hidden');
                    this.dom.emptyState.classList.remove('hidden');
                    this.dom.emptyState.innerHTML = `
                        <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-mouse-pointer text-white text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">No Account Selected</h3>
                        <p class="text-gray-600">Please use the sidebar to select a cloud account to view its resources.</p>
                    `;
                    this.setReadyState('Please select an account.', 'yellow');
                    return;
                }

                 if (forceRefresh && !isPaginatedLoad) {
                    this.isRefreshing = true;
                    this.setUpdatingState();
                    this.dom.refreshButton.disabled = true;
                    try {
                        // This just triggers the backend refresh, the WebSocket message will trigger the actual reload.
                        await fetch(`/api/xamops/cloudlist/resources?accountIds=${this.selectedAccountId}&forceRefresh=true`);
                    } catch (error) {
                         console.error('Error starting refresh:', error);
                        this.setReadyState('Error starting refresh.', 'red');
                        this.isRefreshing = false;
                        this.dom.refreshButton.disabled = false;
                    }
                    return;
                }

                 try {
                    const apiUrl = `/api/xamops/cloudlist/services-paginated?accountId=${this.selectedAccountId}&page=${this.currentPage}&servicesPerPage=${this.servicesPerPage}`;
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const pageData = await response.json();

                    if (!pageData || (pageData.services.length === 0 && !isPaginatedLoad)) {
                         this.allGroups = [];
                         this.totalResources = 0;
                         this.render();
                         return;
                    }

                    const newServiceGroups = pageData.services.map(s => ({ serviceType: s.serviceType, resources: s.resources }));

                    this.allGroups.push(...newServiceGroups);
                    this.hasNextPage = pageData.hasNext;
                    this.totalServices = pageData.totalServices;

                    // Recalculate total resources based on all loaded groups
                    this.totalResources = this.allGroups.reduce((acc, group) => acc + group.resources.length, 0);


                    this.setReadyState(`Updated: ${new Date().toLocaleTimeString()}`, 'green');
                    this.render();
                } catch (error) {
                    console.error('Error fetching resources:', error);
                    this.setReadyState(`Update failed`, 'red');
                    if (!isPaginatedLoad) {
                        this.allGroups = [];
                        this.totalResources = 0;
                    }
                    this.render();
                } finally {
                     this.dom.loadingState.classList.add('hidden');
                }
            },

            exportData() {
                const headers = ["ID", "Name", "Type", "Region", "State", "Launch Time", "Details"];
                const rows = this.getFilteredData().flatMap(group =>
                    group.resources.map(res => [
                        `"${res.id || ''}"`,
                        `"${res.name || ''}"`,
                        `"${res.type || ''}"`,
                        `"${res.region || ''}"`,
                        `"${res.state || ''}"`,
                        `"${res.launchTime ? new Date(res.launchTime).toLocaleString() : 'N/A'}"`,
                        `"${JSON.stringify(res.details || {}).replace(/"/g, '""')}"`
                    ])
                );

                let csvContent = "data:text/csv;charset=utf-8,"
                    + headers.join(",") + "\n"
                    + rows.map(e => e.join(",")).join("\n");

                var encodedUri = encodeURI(csvContent);
                var link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "cloudlist_export.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            debounce(func, delay) {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), delay);
                };
            },

            render() {
                this.dom.loadingState.classList.add('hidden');
                const listContainer = this.dom.listContainer;

                // If it's not a paginated load, clear the container.
                if (!this.isLoadingMore) {
                   listContainer.innerHTML = '';
                }

                this.populateRegionFilter(this.allGroups);
                const filteredGroups = this.getFilteredData();
                const displayedResourceCount = filteredGroups.reduce((acc, group) => acc + group.resources.length, 0);

                this.dom.resourceCount.textContent = `Showing ${displayedResourceCount} resources from ${this.allGroups.length} services`;

                if (this.allGroups.length === 0 && !this.isRefreshing) {
                    this.dom.emptyState.classList.remove('hidden');
                    listContainer.appendChild(this.dom.emptyState);
                     this.dom.emptyState.innerHTML = `
                        <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-search-minus text-white text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">No Resources Found</h3>
                        <p class="text-gray-600">No cloud resources were found for the selected account.</p>
                    `;
                    this.dom.paginationControls.classList.add('hidden');
                } else {
                    this.dom.emptyState.classList.add('hidden');

                    // Create a fragment to batch DOM insertions
                    const fragment = document.createDocumentFragment();
                    filteredGroups.forEach(group => {
                        // Avoid re-rendering groups that are already in the DOM
                        if (!listContainer.querySelector(`[data-group-id="${group.serviceType}"]`)) {
                           const groupElement = this.createGroupElement(group);
                           fragment.appendChild(groupElement);
                        }
                    });
                    listContainer.appendChild(fragment);

                     if (this.hasNextPage) {
                        this.dom.paginationControls.classList.remove('hidden');
                    } else {
                        this.dom.paginationControls.classList.add('hidden');
                    }
                }
                this.addEventListenersForToggles();
            },


            populateRegionFilter(groups) {
                const regions = [...new Set(groups.flatMap(g => g.resources.map(r => r.region)))].filter(Boolean);
                regions.sort();

                const currentSelection = this.dom.regionFilter.value;
                this.dom.regionFilter.innerHTML = '<option value="">All Regions</option>';

                if (regions.includes('Global')) {
                     this.dom.regionFilter.innerHTML += '<option value="Global">Global</option>';
                }
                 if (regions.includes('Regional')) {
                     this.dom.regionFilter.innerHTML += '<option value="Regional">Regional</option>';
                }

                regions.forEach(region => {
                    if(region !== 'Global' && region !== 'Regional') {
                        const option = document.createElement('option');
                        option.value = region;
                        option.textContent = region;
                        this.dom.regionFilter.appendChild(option);
                    }
                });
                this.dom.regionFilter.value = currentSelection;
            },

            getFilteredData() {
                const searchTerm = this.dom.searchInput.value.toLowerCase();
                const region = this.dom.regionFilter.value;

                return this.allGroups.map(group => {
                    const matchingResources = group.resources.filter(res => {
                        const regionMatch = (region === "") || (res.region === region);
                        const searchMatch = (searchTerm === "") ||
                            (res.name && res.name.toLowerCase().includes(searchTerm)) ||
                            (res.id && res.id.toLowerCase().includes(searchTerm));
                        return regionMatch && searchMatch;
                    });
                    return { ...group, resources: matchingResources };
                }).filter(group => group.resources.length > 0);
            },

            createGroupElement(group) {
                const container = document.createElement('div');
                container.className = 'service-group rounded-2xl shadow-lg overflow-hidden border border-gray-200/50 transition-all';
                container.dataset.groupId = group.serviceType; // Add dataset for tracking
                const groupId = `group-content-${group.serviceType.replace(/[^a-zA-Z0-9]/g, '')}`;

                container.innerHTML = `
                    <div class="flex items-center justify-between p-6 cursor-pointer toggle-button" data-target="#${groupId}">
                        <div class="flex items-center space-x-4 flex-1">
                            <i class="fas fa-chevron-right text-gray-400 w-5 text-center transition-all duration-200"></i>
                            <div class="service-icon w-12 h-12 flex items-center justify-center rounded-xl">
                                <img src="/icons/${this.getServiceIcon(group.serviceType)}" alt="${group.serviceType}" class="w-full h-full rounded-xl object-cover">
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold text-gray-800 text-lg">${group.serviceType}</h3>
                                <p class="text-sm text-gray-600">AWS Service</p>
                            </div>
                            <div class="resource-counter text-sm font-bold px-4 py-2 rounded-full">
                                ${group.resources.length}
                            </div>
                        </div>
                    </div>
                    <div id="${groupId}" class="resource-content hidden bg-gradient-to-r from-gray-50/30 to-gray-100/30 backdrop-blur-sm">
                        ${group.resources.map(res => this.createResourceRow(res, group.serviceType)).join('')}
                    </div>
                `;
                return container;
            },

            createResourceRow(resource, serviceType) {
                const detailsId = `details-${resource.id.replace(/[^a-zA-Z0-9]/g, '')}`;
                const hasDetails = resource.details && Object.keys(resource.details).length > 0;

                let detailsHtml = '';
                if (hasDetails) {
                    detailsHtml = `
                        <div id="${detailsId}" class="resource-details hidden p-6 pl-24 text-sm text-gray-700 bg-gray-50/50 border-t border-gray-200">
                            <h4 class="font-semibold text-base mb-3">Resource Details:</h4>
                            <div class="grid grid-cols-2 gap-2">
                    `;
                    for (const key in resource.details) {
                        detailsHtml += `
                                <div class="flex items-center">
                                    <span class="font-medium text-gray-600 mr-2">${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}:</span>
                                    <span>${resource.details[key] || 'N/A'}</span>
                                </div>
                        `;
                    }
                    detailsHtml += `
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="resource-row border-t border-gray-200/50" data-service="${serviceType}" data-id="${resource.id}">
                        <div class="grid grid-cols-12 items-center p-6 pl-16 text-sm hover:bg-white/50 transition-all duration-200 toggle-resource-details" data-target="#${detailsId}" data-has-details="${hasDetails}">
                            <div class="col-span-6 flex items-center space-x-4">
                                <i class="fas fa-chevron-right text-gray-400 w-5 text-center transition-all duration-200 ${hasDetails ? '' : 'invisible'}"></i>
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2">
                                        <p class="font-bold text-gray-800">${resource.name || 'N/A'}</p>
                                        <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
                                        <p class="font-mono text-xs text-gray-500">${resource.id || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-span-2 flex items-center space-x-2">
                                <i class="fas fa-map-marker-alt text-gray-400 text-xs"></i>
                                <span class="font-semibold text-gray-600">${resource.region || 'Global'}</span>
                            </div>
                            <div class="col-span-2">
                                <span class="state-badge px-3 py-1 inline-flex text-xs leading-5 font-bold rounded-full capitalize ${this.getStateClass(resource.state)}">
                                    ${resource.state || 'Unknown'}
                                </span>
                            </div>
                            <div class="col-span-2 text-right pr-4">
                                ${hasDetails ? `
                                <button class="btn-secondary px-4 py-2 text-sm font-semibold rounded-lg hover:bg-gray-100 transition-all view-details-button">
                                    <i class="fas fa-info-circle mr-2"></i>Details
                                </button>
                                ` : `
                                <div class="flex items-center justify-end space-x-2">
                                     <i class="fas fa-external-link-alt text-gray-400 text-xs"></i>
                                     <span class="text-xs text-gray-500">No Extra Details</span>
                                </div>
                                `}
                            </div>
                        </div>
                        ${detailsHtml}
                    </div>
                `;
            },

            addEventListenersForToggles() {
                this.dom.listContainer.querySelectorAll('.toggle-button').forEach(button => {
                    if(button.dataset.listenerAttached) return;
                    button.dataset.listenerAttached = true;

                    button.addEventListener('click', (e) => {
                        if (e.target.closest('.btn-secondary')) return;
                        const targetSelector = button.getAttribute('data-target');
                        const content = this.dom.listContainer.querySelector(targetSelector);
                        const icon = button.querySelector('.fa-chevron-right');

                        if (content) {
                            content.classList.toggle('hidden');
                            icon.classList.toggle('rotate-90');
                        }
                    });
                });

                this.dom.listContainer.querySelectorAll('.toggle-resource-details').forEach(rowHeader => {
                    if(rowHeader.dataset.listenerAttached) return;
                    rowHeader.dataset.listenerAttached = true;
                    rowHeader.addEventListener('click', (e) => {
                        if (e.target.closest('.view-details-button') || e.target.closest('.fa-external-link-alt')) return;
                        const hasDetails = rowHeader.getAttribute('data-has-details') === 'true';

                        if (hasDetails) {
                            const targetSelector = rowHeader.getAttribute('data-target');
                            const content = this.dom.listContainer.querySelector(targetSelector);
                            const icon = rowHeader.querySelector('.fa-chevron-right');

                            if (content) {
                                content.classList.toggle('hidden');
                                icon.classList.toggle('rotate-90');
                            }
                        }
                    });
                });

                this.dom.listContainer.querySelectorAll('.view-details-button').forEach(button => {
                     if(button.dataset.listenerAttached) return;
                     button.dataset.listenerAttached = true;
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const rowHeader = button.closest('.toggle-resource-details');
                        const targetSelector = rowHeader.getAttribute('data-target');
                        const content = this.dom.listContainer.querySelector(targetSelector);
                        const icon = rowHeader.querySelector('.fa-chevron-right');

                        if (content) {
                            content.classList.toggle('hidden');
                            icon.classList.toggle('rotate-90');
                        }
                    });
                });
            },

            getStateClass(state) {
                const s = (state || '').toLowerCase();
                if (['running', 'available', 'active', 'in-use', 'issued'].includes(s)) return 'bg-green-100 text-green-800 border-green-200';
                if (['stopped', 'terminated', 'deleting', 'inactive', 'expired'].includes(s)) return 'bg-red-100 text-red-800 border-red-200';
                if (['pending', 'stopping', 'pending_validation'].includes(s)) return 'bg-yellow-100 text-yellow-800 border-yellow-200';
                return 'bg-gray-100 text-gray-800 border-gray-200';
            },

           getServiceIcon(serviceType) {
                const iconMap = {
                    'EC2 Instance': 'ec2-instances.png',
                    'EBS Volume': 'aws-ebs.png',
                    'RDS Instance': 'rds-instance.png',
                    'Lambda Function': 'aws-lambda.png',
                    'S3 Bucket': 's3-bucket.png',
                    'Load Balancer': 'load-balanceraws.png',
                    'Auto Scaling Group': 'autoscaling.png',
                    'VPC': 'vpc.png',
                    'Security Group': 'security-group.png',
                    'Route 53 Zone': 'aws-route53.png',
                    'EKS Cluster': 'aws-eks.png',
                    'ECS Cluster': 'aws-ecs.png',
                    'Certificate Manager': 'certificate-manager.png',
                    'CloudTrail': 'cloudtrail.png',
                    'CloudWatch Log Group': 'cloudwatch-log-group.png',
                    'ECR Repository': 'ecr-repository.png',
                    'SNS Topic': 'sns-topic.png',
                    'SQS Queue': 'sqs-queue.png',
                    'Lightsail Instance': 'lightsail.png',
                    'Amplify App': 'amplify.png',
                    'AWS Step Functions': 'step-functions.png',
                    'Amazon ElastiCache': 'elasticache.png',
                    'AWS Config': 'config.png',
                    'AWS Security Hub': 'security-hub.png',
                    'AWS Glue': 'glue.png',
                    'Amazon Athena': 'athena.png',
                    'Amazon Cognito': 'cognito.png',
                    'Amazon CloudWatch Events': 'cloudwatch-events.png',
                    'AWS WAF': 'waf.png',
                    'CloudFront': 'cloudfront.png',
                    'DynamoDB Table': 'dynamodb.png',
                    'Bedrock': 'bedrock.png',
                    'Amazon Textract': 'textract.png',
                    'SageMaker': 'sagemaker.png',
                    'Amazon Elastic File System': 'efs.png',
                    'AWS Systems Manager': 'systems-manager.png',
                    'Amazon DataZone': 'datazone.png',
                    'KMS': 'kms.png',
                    'AWS Cloud Map': 'cloud-map.png',
                    'EFS File System': 'efs.png',
                    'SSM Managed Instance': 'ssm.png',
                    'NAT Gateway': 'Res_Amazon-VPC_NAT-Gateway_48_Light.png',
                    'Internet Gateway': 'Res_Amazon-VPC_Internet-Gateway_48_Light.png',
                    'Network Interface (ENI)':'eni.png',
                    'Elastic IP':'elastic-ip.png',
                    'EBS Snapshot':'snapshot.png',
                    'Security Hub':'security-hub.png',
                    'CloudFormation Stack': 'cloudformation.png',
                    'DataZone Domain': 'datazone.png',
                    'Textract Project': 'textract.png',
                    'EventBridge Bus': 'eventbridge.png',
                    'Kinesis Stream': 'kinesis.png',
                    'CodePipeline': 'codepipeline.png',
                    'CodeBuild Project': 'codebuild.png',
                    'CodeCommit Repository': 'codecommit.png',
                    'AWS Shield Protection': 'shield.png',
                    'Organization Account': 'organizations.png',
                    'Control Tower Control': 'controltower.png',
                    'Elastic Beanstalk Environment': 'elasticbeanstalk.png',
                    'API Gateway': 'api-gateway.png'
                };
                return iconMap[serviceType] || 'default-icon.png';
            },
        };

        app.init();
    });
</script>

</body>
</html>